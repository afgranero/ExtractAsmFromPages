<!DOCTYPE html>
<html lang="en"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="description" content="TRS-80 Revived Site by Ira Goldklang's is an archive of everything related to the Tandy Radio Shack TRS-80 microcomputer lines. Site contains emulators, programs, manuals, books, patches, games, hints, discussions, and tons more.">
	<meta name="author" content="Ira Goldklang">
	<meta name="robots" content="index, follow">
	<link rel="icon" href="https://www.trs-80.com/icon.ico" type="image/x-icon">
	<link rel="canonical" href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm">
	<meta property="og:title" content="TRS-80 Revived Site - Ira Goldklang's TRS-80 Archive">
	<meta property="og:description" content="Complete archive of TRS-80 emulators, programs, manuals, books, and games for Tandy Radio Shack TRS-80 computers.">
	<meta property="og:type" content="website">
	<meta property="og:url" content="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm">
	<meta name="twitter:card" content="summary">
	<meta name="twitter:title" content="TRS-80 Revived Site">
	<meta name="twitter:description" content="Complete archive of TRS-80 emulators, programs, and resources.">
	<title>Model III ROM Explained - Part 3</title>
	<!-- Load your existing CSS file -->
	<link rel="stylesheet" href="Model%20III%20ROM%20Explained%20-%20Part%203_files/trs80-css.css">
	<link rel="stylesheet" href="Model%20III%20ROM%20Explained%20-%20Part%203_files/trs80-hamburger.css">
	<!-- Fancybox CSS -->
	<link rel="stylesheet" href="Model%20III%20ROM%20Explained%20-%20Part%203_files/fancybox.css">
	<!-- Load the component loader -->
	<script src="Model%20III%20ROM%20Explained%20-%20Part%203_files/trs80-loader.js"></script>
	<script src="Model%20III%20ROM%20Explained%20-%20Part%203_files/trs80-hamburger.js"></script>
</head>
<body class="trs80-loaded"><button id="hamburger-btn" class="hamburger-menu" aria-label="Toggle menu">
            <span></span>
            <span></span>
            <span></span>
        </button>
	<div class="site-container">
		<!-- Header will be loaded here -->
		<div id="header"><style>
    .trs80-header-grid {
        display: grid;
        /* 'auto' lets the images take only needed space, '1fr' gives the rest to the text */
        grid-template-columns: auto 1fr auto;
        grid-template-rows: 1fr;
        grid-column-gap: 20px;
        grid-row-gap: 0;
        background-color: #003399;
        margin-top: 10px;
        padding: 10px;
        /* This ensures all items in the grid (images and text) are aligned to the top */
        align-items: start;
    }

    .trs80-header-left { grid-area: 1 / 1 / 2 / 2; display: flex; align-items: start; }
    .trs80-header-center { grid-area: 1 / 2 / 2 / 3; text-align: center; }
    .trs80-header-right { grid-area: 1 / 3 / 2 / 4; display: flex; align-items: start; justify-content: flex-end; }

    .trs80-title { color: white !important; font-size: 170%; text-align: center; margin: 0 0 10px 0; font-weight: bold; }

    .trs80-description {
        color: white !important;
        font-size: 120%;
        text-align: center;
        margin: 0 auto 15px auto;
        padding: 0 10px;
        line-height: 1.4;
    }

    .trs80-header-grid img { border: 0 !important; margin: 0 2px; }
    .trs80-img-60 { width: 60px; }
    .trs80-img-80 { width: 80px; }
    .trs80-img-90 { width: 90px; }
    .trs80-img-100 { width: 100px; }

    /* Search Button Styling */
    .header-search-container {
        margin-bottom: 10px;
    }

    .header-search-link {
        display: inline-block;
        background: #ffcc00; /* Retro TRS-80 Amber */
        color: #003399 !important;
        padding: 6px 15px;
        border-radius: 4px;
        font-weight: bold;
        font-size: 0.9em;
        text-decoration: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        transition: transform 0.2s, background 0.2s;
    }

    .header-search-link:hover {
        background: #ffe066;
        transform: scale(1.05);
        text-decoration: none;
    }

    @media screen and (max-width: 768px) {
        .trs80-header-grid {
            grid-template-columns: 1fr;
            grid-template-rows: auto auto auto;
            text-align: center;
            justify-items: center;
        }
        .trs80-header-left { grid-area: 1 / 1 / 2 / 2; justify-content: center; }
        .trs80-header-center { grid-area: 2 / 1 / 3 / 2; }
        .trs80-header-right { grid-area: 3 / 1 / 4 / 2; justify-content: center; }
        .trs80-title { font-size: 130%; }
        .trs80-description { font-size: 100%; text-align: center; }
        .trs80-img-60 { width: 50px; }
        .trs80-img-80 { width: 65px; }
        .trs80-img-90 { width: 75px; }
        .trs80-img-100 { width: 80px; }
    }
</style>

<div class="trs80-header-grid">
    <div class="trs80-header-left">
        <img src="Model%20III%20ROM%20Explained%20-%20Part%203_files/computer-model1-keyboardandscreen-100.png" alt="[Model I]" class="trs80-img-60">
        <img src="Model%20III%20ROM%20Explained%20-%20Part%203_files/computer-model3-rsc05-blur-x100.png" alt="[Model III]" class="trs80-img-60">
        <img src="Model%20III%20ROM%20Explained%20-%20Part%203_files/computer-model4-rsc10-x100.png" alt="[Model 4]" class="trs80-img-90">
    </div>

    <div class="trs80-header-center">
        <p class="trs80-title">Welcome To Ira Goldklang's TRS-80 Revived Site</p>

        <p class="trs80-description">
            TRS-80 Revived Site is an archive of everything related to 
the Tandy Radio Shack TRS-80 home microcomputer lines. Site contains 
emulators, programs, manuals, books, patches, games, hints, discussions,
 and tons more.
        </p>

        <div class="header-search-container">
            <a href="https://www.trs-80.com/main-search-site.htm" class="header-search-link">
                <span class="search-icon">üîç</span> SEARCH THIS SITE
            </a>
        </div>
    </div>

    <div class="trs80-header-right">
        <img src="Model%20III%20ROM%20Explained%20-%20Part%203_files/computer-model-4p-sideways-view-x100.png" alt="[Model 4P]" class="trs80-img-90">
        <img src="Model%20III%20ROM%20Explained%20-%20Part%203_files/computer-model100-ccf836-x100.png" alt="[Model 100]" class="trs80-img-80">
        <img src="Model%20III%20ROM%20Explained%20-%20Part%203_files/computer-pc2-rsc07-x100.png" alt="[Pocket Computer]" class="trs80-img-100">
    </div>
</div>
</div>
		<!-- Content wrapper with sidebar and main content -->
		<div class="content-wrapper">
			<!-- Left Navigation will be loaded here -->
			<aside class="sidebar" id="navbar"><div class="navigationpanelv2">
	<div class="nav-entry-block">
		<h2>FIRST TIME VISITORS</h2>
		<p style="font-size:150%; margin-top:0; text-align:center; color:red;"><a href="https://www.trs-80.com/main-welcome.htm">Visit the WELCOME page</a></p>
	</div>

	<div class="nav-entry-block">
		<h2>Services</h2>
		<ul>
			<li><a href="https://www.trs-80.com/main-faq-reading-disks.htm" style="color:red !important;">Do you have TRS-80 Disks?  Send them in for Preservation and Conversion for use in an Emulator</a></li>
			<li><a href="https://www.trs-80.com/main-disketterequest.htm">Request Real DOS Disks</a></li>
		</ul>
	</div>

	<div class="nav-entry-block">
		<h2>General</h2>
		<ul>
			<li><a href="https://www.trs-80.com/index.html">Site News</a></li>
			<li><a href="https://www.trs-80.com/main-introduction-to-emulators.htm">Intro to Emulation</a></li>
			<li>
				<span class="submenu-toggle"><a href="https://www.trs-80.com/main-interviews.htm">Interviews</a></span>
				<ul>
					<li><a href="https://americanhistory.si.edu/comphist/gates.htm">Bill Gates</a></li>
					<li><a href="http://www.trs-80.org/interview-bill-hogue/">Bill Hogue</a></li>
					<li><a href="http://www.trs-80.org/interview-dan-gookin/">Dan Gookin</a></li>
					<li><a href="https://www.trs-80.com/sub-interview-don-french.htm">Don French</a></li>
					<li><a href="https://bluebilby.com/dubois-mcnamara/">Dubouis &amp; McNamara</a></li>
					<li><a href="http://www.trs-80.org/interview-j-weaver/">J. Weaver Jr.</a></li>
					<li><a href="http://www.trs-80.org/interview-jack-crenshaw/">Jack Crenshaw</a></li>
					<li><a href="http://www.trs-80.org/interview-jim-stutsman/">Jim Stutsman</a></li>
					<li><a href="http://www.48k.ca/JoshLavinsky.html">Josh Lavinsky</a></li>
					<li><a href="http://www.trs-80.org/interview-kevin-tschudi/">Kevin Tschudi</a></li>
					<li><a href="http://www.trs-80.org/interview-paul-andreasen/">Paul Andreasen</a></li>
					<li><a href="https://www.trs-80.com/sub-interview-steve-leininger.htm">Steven W. Leininger</a></li>
					<li><a href="https://www.trs-80.com/sub-interview-bill-demas.htm">William Demas</a></li>
				</ul>
			</li>
			<li><a href="https://www.trs-80.com/main-shipping.htm">Shipping a TRS-80</a></li>
			<li><a href="https://www.trs-80.com/main-lore.htm">Radio Shack Lore</a></li>
			<li><a href="https://www.trs-80.com/main-fun-stuff.htm">Fun Stuff</a></li>
		</ul>
		<p class="donatev2"><a href="https://www.trs-80.com/main-donate.htm">Support the Site</a></p>
	</div>

	<div class="nav-entry-block">
		<h2>Help The Site!</h2>
		<ul>
			<li><a href="https://www.trs-80.com/main-missing-software.htm">Missing Software</a></li>
			<li><a href="https://www.trs-80.com/main-missing-magazines.htm">Missing Magazines</a></li>
			<li><a href="https://www.trs-80.com/main-faq-reading-disks.htm">Send in Your Disks for Archiving</a></li>
		</ul>
	</div>

	<div class="nav-entry-block">
		<h2>Searches</h2>
		<ul>
			<li><a href="https://www.trs-80.com/main-search-site.htm">Site-Wide Search</a></li>
			<li><a href="https://www.trs-80.com/main-search-software.htm">Software Search</a></li>
			<li><a href="https://www.trs-80.com/main-search-magazines.htm">Magazine Search</a></li>
			<li><a href="https://www.trs-80.com/main-search-rs-catalogs.htm">Catalog Search</a></li>
		</ul>
	</div>

	<div class="nav-entry-block">
		<h2>Emulation and Virtual Media</h2>
		<span>Info and Downloads:</span>
		<ul>
			<li><a href="https://www.trs-80.com/main-emulators.htm">Emulators</a></li>
			<li><a href="https://www.trs-80.com/main-emulation-tape-utilities.htm">Virtual Tape Utilities</a></li>
			<li><a href="https://www.trs-80.com/main-emulation-disk-utilities.htm">Virtual Disk Utilities</a></li>
			<li><a href="https://www.trs-80.com/main-emulation-misc-utilities.htm">Misc TRS-80 Utilities</a></li>
		</ul>
		<span>How To Convert:</span>
		<ul>
			<li><a href="https://www.trs-80.com/main-emulation-conversion-tapes.htm">Tapes to Virtual</a></li>
			<li><a href="https://www.trs-80.com/main-emulation-conversion-disks.htm">Disks to Virtual</a></li>
			<li><a href="https://www.classic-computers.org.nz/system-80/software_esf_archive-imaging.htm">Stringy Floppy to Virtual</a></li>
		</ul>
	</div>

	<div class="nav-entry-block">
		<h2>Advanced</h2>
		<span>Internal Operations</span>
		<ul>
			<li>
				<span class="submenu-toggle">ROM/Z-80 Info</span>
				<ul>
					<li><a href="https://www.trs-80.com/main-internal-rom-related.htm#compared">ROMs Compared</a></li>
					<li><a href="https://www.trs-80.com/sub-disassem-rom-level-1.htm">Model I Level 1 ROM</a></li>
					<li><a href="https://www.trs-80.com/sub-disassem-rom-m1-part-1.htm">Model I Level II ROM</a></li>
					<li><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm">Model III Level II ROM</a></li>
					<li><a href="https://github.com/kiwisincebirth/TRS-80">Model III Level II Compilable Source</a></li>
					<li><a href="https://www.trs-80.com/sub-disassem-rom-m4.htm">Model 4 ROM</a></li>
					<li><a href="https://www.trs-80.com/sub-disassem-rom-m4-xdrom-main.htm">Model 4 XDROM</a></li>
					<li><a href="https://www.trs-80.com/sub-disassem-rom-m4p.htm">Model 4P Boot ROM</a></li>
					<li><a href="https://www.trs-80.com/sub-disassem-rom-network-4.htm">Network 4 ROM</a></li>
					<li><a href="https://www.gatesnotes.com/microsoft-original-source-code">Orig Source Code</a></li>
					<li><a href="https://www.trs-80.com/sub-rom-bugs.htm">Bugs</a></li>
					<li><a href="https://www.trs-80.com/sub-rom-rom-addresses.htm">Memory map and address reference</a></li>
					<li><a href="https://www.trs-80.com/sub-rom-entry-points.htm">Entry Points to routines</a></li>
					<li><a href="https://www.trs-80.com/sub-rom-io-and-misc-routines.htm">I/O and Misc ROM routines</a></li>
					<li><a href="https://www.trs-80.com/sub-rom-math-calls.htm">Math Routines</a></li>
					<li><a href="https://www.trs-80.com/sub-rom-rst-vectors.htm">RST vectors and Disk BASIC entry points</a></li>
					<li><a href="https://www.trs-80.com/sub-rom-z80-info.htm">Reference for Z-80 opcodes and undocumented command</a></li>
				</ul>
			</li>
			<li><a href="https://www.trs-80.com/main-internal-ram-addresses-and-routines.htm">RAM Addresses/Routines</a></li>
			<li><a href="https://www.trs-80.com/main-internal-ports-and-i-o.htm">Ports and I/O Devices</a></li>
			<li><a href="https://www.trs-80.com/sub-rom-dcbs.htm">Device Control Blocks (DCB's)</a></li>
			<li><a href="https://www.trs-80.com/main-internal-keyboard-map.htm">Keyboard Map</a></li>
		</ul>

		<span>Disassemblies</span>
		<ul>
			<li>
				<span class="submenu-toggle"><a href="https://www.trs-80.com/main-disassemblies.htm">Disassemblies</a></span>
				<ul>
					<li><a href="https://www.trs-80.com/sub-disassem-rom-level-1.htm">Level I ROM</a></li>
					<li><a href="https://www.trs-80.com/sub-disassem-rom-m1-part-1.htm">Level II ROM</a></li>
					<li><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm">Model III ROM</a></li>
					<li><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-4-durda.htm">Frank Durda Modified C-ROM</a></li>
					<li><a href="https://www.trs-80.com/sub-disassem-rom-m4.htm">Model 4 ROM</a></li>
					<li><a href="https://www.trs-80.com/sub-disassem-rom-m4p.htm">Model 4P Bootstrap ROM</a></li>
					<li><a href="https://www.trs-80.com/sub-disassem-rom-m4-xdrom-main.htm">XDROM - Frank Durda's Model 4 ROM C replacement</a></li>
					<li><a href="https://www.trs-80.com/sub-disassem-dos-nd80-m1-main.htm">NEWDOS/80 v2.0</a></li>
					<li><a href="https://www.trs-80.com/sub-disassem-dos-td13-main.htm">TRSDOS v1.3</a></li>
					<li><a href="https://www.trs-80.com/sub-disassem-dos-td23-main.htm">TRSDOS v2.3</a></li>
					<li><a href="https://www.trs-80.com/sub-disassem-rom-network-4.htm">Network 4 Transporter ROM code analysis</a></li>
				</ul>
			</li>
		</ul>

		<span>Zaps/Patches/Fixes</span>
		<ul>
			<li>
				<span class="submenu-toggle"><a href="https://www.trs-80.com/main-zaps-and-patches.htm">Zaps and Patches</a></span>
				<ul>
					<li><a href="https://www.trs-80.com/main-zaps-and-patches.htm#dos">DOS</a></li>
					<li><a href="https://www.trs-80.com/sub-zaps-sw-electric-pencil.htm">Electric Pencil</a></li>
					<li><a href="https://www.trs-80.com/sub-zaps-sw-general.htm">Other Software</a></li>
					<li><a href="https://www.trs-80.com/main-zaps-and-patches.htm#software-zaps-and">ZIPs of Patches</a></li>
				</ul>
			</li>
			<li>
				<span class="submenu-toggle"><a href="https://www.trs-80.com/main-tips-and-tricks.htm">Tips and Tricks</a></span>
				<ul>
					<li><a href="https://www.trs-80.com/sub-tips-hard-drive.htm">Hard Drive Tips and Tricks</a></li>
					<li><a href="https://www.trs-80.com/sub-tips-packing.htm">String Packing and USR Routines</a></li>
					<li><a href="https://www.trs-80.com/sub-tips-level2.htm">Level II Tips and Tricks</a></li>
					<li><a href="https://www.trs-80.com/sub-reference-dos-newdos80-main.htm#tips">NEWDOS/80 Tips and Tricks</a></li>
					<li><a href="https://www.trs-80.com/sub-tips-dos.htm">Other DOS Tips and Tricks</a></li>
					<li><a href="https://www.trs-80.com/sub-tips-graphics.htm">TRS-80 Graphics</a></li>
					<li><a href="https://www.trs-80.com/sub-tips-file-formats.htm">Tape and File Formats/Structures</a></li>
					<li><a href="https://www.trs-80.com/sub-tips-easter-eggs.htm">Bugs and Easter Eggs</a></li>
					<li><a href="https://www.trs-80.com/sub-tips-misc.htm">Misc Tips and Tricks</a></li>
					<li><a href="https://www.trs-80.com/sub-tips-model-3.htm">Model III Tips and Tricks</a></li>
					<li><a href="https://www.trs-80.com/sub-tips-model-4.htm">Model 4 Tips and Tricks</a></li>
					<li><a href="https://www.trs-80.com/sub-tips-model-4p.htm">Model 4P Tips and Tricks</a></li>
				</ul>
			</li>
		</ul>
		<p class="donatev2"><a href="https://www.trs-80.com/main-donate.htm">Support the Site</a></p>
	</div>

	<div class="nav-entry-block">
		<h2>TRS-80 Models</h2>
		<ul>
			<li><a href="https://www.trs-80.com/main-models.htm">Timeline</a></li>
			<li><a href="https://www.trs-80.com/sub-models-model1.htm">Model I</a></li>
			<li><a href="https://www.trs-80.com/sub-models-model2.htm">Model II</a></li>
			<li><a href="https://www.trs-80.com/sub-models-model3.htm">Model III</a></li>
			<li><a href="https://www.trs-80.com/sub-models-model4.htm">Model 4/4P/4D</a></li>
			<li><a href="https://www.trs-80.com/sub-models-coco.htm">Color (Coco 1-3, MC-10)</a></li>
			<li><a href="https://www.trs-80.com/sub-models-laptops.htm">Laptops (100/200/600)</a></li>
			<li><a href="https://www.trs-80.com/sub-models-pocket.htm">Pocket (PC-1 to PC-8)</a></li>
			<li><a href="https://www.trs-80.com/sub-models-clones.htm">Clones</a></li>
			<li><a href="https://www.trs-80.com/sub-models-printers.htm">Printers</a></li>
		</ul>
		<p class="donatev2"><a href="https://www.trs-80.com/main-donate.htm">Support the Site</a></p>
	</div>

	<div class="nav-entry-block">
		<h2>Reference</h2>
		<ul>
			<li><a href="https://www.trs-80.com/sub-reference-dos-trsdos-main.htm">TRSDOS</a></li>
			<li><a href="https://www.trs-80.com/sub-reference-dos-dosplus.htm">DOSPlus</a></li>
			<li><a href="https://www.trs-80.com/sub-reference-dos-newdos80-main.htm">NEWDOS/80</a></li>
			<li><a href="https://www.trs-80.com/sub-reference-multidos.htm">MULTIDOS</a></li>
			<li><a href="https://www.trs-80.com/sub-reference-dos-cpm.htm">CP/M</a></li>
			<li><a href="https://www.trs-80.com/sub-reference-level-2-basic.htm">Level II BASIC Ref</a></li>
		</ul>
	</div>

	<div class="nav-entry-block">
		<h2>Detailed Products</h2>
		<ul>
			<li><a href="https://www.trs-80.com/sub-details-orchestra.htm">ORCH-80/85/90</a></li>
			<li><a href="https://www.trs-80.com/sub-details-speed-up-boards.htm">Speed-Up Boards</a></li>
			<li><a href="https://www.trs-80.com/sub-details-scott-adams.htm">Scott Adams Adventures</a></li>
		</ul>
	</div>

	<div class="nav-entry-block">
		<h2>Tandy Publications</h2>
		<ul>
			<li><a href="https://www.trs-80.com/sub-publications-rs-csbs.htm">Customer Service Bulletins</a></li>
			<li><a href="https://www.trs-80.com/sub-publications-rs-memos.htm">Memos / Bulletins / Releases</a></li>
			<li><a href="https://www.trs-80.com/sub-publications-rs-cc-answers.htm">Comp Center Answers</a></li>
			<li><a href="https://www.trs-80.com/sub-publications-rs-catalogs.htm">Catalogs</a></li>
			<li><a href="https://www.trs-80.com/sub-publications-rs-comics.htm">Comic Books</a></li>
		</ul>
		<span>Microcomputer News</span>
		<ul>
			<li><a href="https://www.trs-80.com/sub-publications-rs-micronewsletter-usa.htm">USA Edition</a></li>
			<li><a href="https://www.trs-80.com/sub-publications-rs-micronewsletter-aus.htm">Australian Edition</a></li>
			<li><a href="https://www.trs-80.com/sub-publications-rs-micronewsletter-other.htm">Other Editions</a></li>
		</ul>
	</div>

	<div class="nav-entry-block">
		<h2>Publications</h2>
		<ul>
			<li><a href="https://www.trs-80.com/sub-publications-books.htm">Books</a></li>
			<li>
				<span class="submenu-toggle"><a href="https://www.trs-80.com/main-magazine-main-menu.htm">Magazines (Non-Tandy)</a></span>
				<ul>
					<li><a href="https://www.trs-80.com/sub-mag-80micro-main.htm">80 Microcomputing</a></li>
					<li><a href="https://www.trs-80.com/sub-mag-80-notebook.htm">80 Notebook</a></li>
					<li><a href="https://www.trs-80.com/sub-mag-80us-detail.htm">80 U.S. Journal</a></li>
					<li><a href="https://www.trs-80.com/sub-mag-alternatesource-detail.htm">The Alternate Source</a></li>
					<li><a href="https://www.trs-80.com/sub-mag-baron.htm">Baron's Microcomputing</a></li>
					<li><a href="https://www.trs-80.com/sub-mag-cie.htm">C.I.E.</a></li>
					<li><a href="https://www.trs-80.com/sub-mag-cload.htm">CLOAD</a></li>
					<li><a href="https://www.trs-80.com/sub-mag-codeworks.htm">CodeWorks</a></li>
					<li><a href="https://www.trs-80.com/sub-mag-computernews80.htm">Computer News 80</a></li>
					<li><a href="https://www.trs-80.com/sub-mag-computer-user.htm">Computer User</a></li>
					<li><a href="https://www.trs-80.com/sub-mag-creative.htm">Creative Computing</a></li>
					<li><a href="https://www.trs-80.com/sub-mag-hecomputronics-detail.htm">H&amp;E Computronics</a></li>
					<li><a href="https://www.trs-80.com/sub-mag-lsi-journal.htm">LDOS / LSI</a></li>
					<li><a href="https://www.trs-80.com/sub-mag-micro80.htm">Micro-80</a></li>
					<li><a href="https://www.trs-80.com/sub-mag-misosys-notes.htm">Misosys Notes</a></li>
					<li><a href="https://www.trs-80.com/sub-mag-misosys-quarterly.htm">Misosys Quarterly</a></li>
					<li><a href="https://www.trs-80.com/sub-mag-softside-detail.htm">Softside</a></li>
					<li><a href="https://www.trs-80.com/sub-mag-the8ighty.htm">The 8ighty</a></li>
					<li><a href="https://www.trs-80.com/sub-mag-trace.htm">Trace</a></li>
					<li><a href="https://www.trs-80.com/sub-mag-trs8bit.htm">TRS8Bit</a></li>
					<li><a href="https://www.trs-80.com/sub-mag-trstimes.htm">TRSTimes</a></li>
					<li><a href="https://www.trs-80.com/sub-mag-other.htm">Other Magazines</a></li>
				</ul>
			</li>
			<li><a href="https://www.trs-80.com/sub-publications-manuals-software-1.htm">Software Manuals</a></li>
			<li><a href="https://www.trs-80.com/sub-publications-user-groups-1.htm">User's Group Newsletters</a></li>
			<li><a href="https://www.trs-80.com/sub-publications-catalogs.htm">Catalogs (Non-Tandy)</a></li>
			<li><a href="https://www.trs-80.com/sub-publications-flyers.htm">Product Flyers</a></li>
			<li><a href="https://www.trs-80.com/sub-publications-company-news.htm">Company Newsletters</a></li>
		</ul>
	</div>

	<div class="nav-entry-block">
		<h2>This Section for TRS-80 Hardware Owners</h2>
		<span>TRS-80 Upgrades/Parts:</span>
		<ul>
			<li><a href="https://www.trs-80.com/main-upgrades.htm">Upgrades and Parts</a></li>
			<li><a href="https://www.trs-80.com/sub-repairs-parts-thingverse.htm">Schematics/3-D Printable Parts</a></li>
		</ul>
		<span>TRS-80 Repairs:</span>
		<ul>
			<li class="navbumpv2"><a href="https://www.trs-80.com/main-repairs.htm">Main Repair Page</a></li>
			<li><a href="https://www.trs-80.com/sub-repairs-repair-people.htm">Repair People</a></li>
			<li><a href="https://www.trs-80.com/sub-repairs-how-to-open.htm">Opening a TRS-80</a></li>
			<li><a href="https://www.trs-80.com/sub-repairs-eprom.htm">Using an EPROM</a></li>
		</ul>
		<span>Hardware Mods and Hacks:</span>
		<ul>
			<li><a href="https://www.trs-80.com/sub-tips-modifications-model-1.htm">Model I</a></li>
			<li><a href="https://www.trs-80.com/sub-tips-modifications-model-3.htm">Model III</a></li>
			<li><a href="https://www.trs-80.com/sub-tips-modifications-model-4.htm">Model 4</a></li>
		</ul>
		<span>Other Items ...</span>
		<ul>
			<li><a href="https://www.trs-80.com/sub-publications-manuals-hardware-1.htm">Hardware Manuals</a></li>
			<li><a href="https://www.trs-80.com/sub-publications-manuals-service.htm">Service Manuals</a></li>
			<li><a href="https://voidstar.blog/tandy-radio-shack-computer-cassette-recorder-trs-ccr-usage/">Using a Computer / Tablet / Smartphone for Cassette I/O</a></li>
		</ul>
	</div>

	<div class="nav-entry-block">
		<h2>Misc</h2>
		<ul>
			<li><a href="https://www.trs-80.com/main-emailme.htm">Send Me Email</a></li>
			<li><a href="https://www.trs-80.com/main-old-news.htm">Archived News and Guestbook</a></li>
			<li><a href="https://www.trs-80.com/main-personalstories.htm">Personal Stories Submitted</a></li>
			<li><a href="https://www.trs-80.com/main-emaillinks.htm">Email and other TRS-80 Sites</a></li>
			<li><a href="https://www.trs-80.com/main-copyrights.htm">Copyrights</a></li>
		</ul>
		<p class="donatev2"><a href="https://www.trs-80.com/main-donate.htm">Support the Site</a></p>
	</div>
</div></aside>
			<!-- Main Content -->
			<main class="main-content">

				<div class="main-page-container">
					<h1>Model III ROM Explained - Part 3</h1>
					<div class="section-wrapper">
						<br><h2 id="2003-ue-error-entry">2003 - UE ERROR entry point.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
						<div class="section-content">
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2003-2004</div><div>LD E,26H</div><div>Load register E with the ERROR code for a <span class="code">?UE ERROR</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2005-2007</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#19A2" class="memory-link">JP 19A2H</a></div><div>Go to the Level II BASIC error routine and display the appropriate error message.</div></div>
								</div>
							</div>

							<br><h2 id="2008-2038-level-ii">2008-2038 - LEVEL II BASIC AUTO ROUTINE<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2008-200A</div><div>LD DE,000AH</div><div>Load DE with a default starting line number of ten.</div></div>
									<div class="assembly-row-combined model1"><div>200B</div><div>PUSH DE</div><div>Save the default stack line number in DE to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>200C-200D</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2025" class="memory-link">JR Z,2025H</a></div><div>Jump down to 2025H if this is the end of the <span class="code">AUTO</span> statement (meaning that no parameters were provided).</div></div>
									<div class="assembly-row-combined model1"><div>200E-2010</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1E4F" class="memory-link">CALL 1E4FH</a></div><div>If we are here, then there were parameters after the <span class="code">AUTO</span>
 statement so we need to GOSUB to 1E4FH to evaluate the line number at 
the current location of the BASIC program pointer in HL and return with 
the result in DE.</div></div>
									<div class="assembly-row-combined model1"><div>2011</div><div>EX DE,HL</div><div>Since there is no such Z-80 command as <span class="code">EX (SP),DE</span>
 we now need to do some swapping to get DE into (SP).  First, exchange 
the value of the line number in DE with the value of the current BASIC 
program pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2012</div><div>EX (SP),HL</div><div>Next,
 exchange the default line number (to the stack from the above push of 
DE) with the line number that the user provided (in HL).</div></div>
									<div class="assembly-row-combined model1"><div>2013-2014</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2026" class="memory-link">JR Z,2026H</a></div><div>Jump down to 2026H if this is the end of the <span class="code">AUTO</span> statement (meaning that only 1 parameter was provided).</div></div>
									<div class="assembly-row-combined model1"><div>2015</div><div>EX DE,HL</div><div>Load HL with the value of the current BASIC program pointer in DE.</div></div>
									<div class="assembly-row-combined model1"><div>2016-2017</div><div>RST 08H ‚áí  2C</div><div>If we are here, then we have an <span class="code">AUTO</span>
 command with one parameter (starting line number) and we have not 
finished with the command. Since the only valid addition to that would 
be a trailing <span class="code">,</span>, we need to test the current BASIC program pointer in HL for a COMMA (=2CH), by calling the COMPARE SYMBOL at RST 08H.<br><br><span class="bold nobottomborder">NOTE:</span>
 The RST 08H routine compares the symbol in the input string pointed to 
by HL register to the value in the location following the RST 08 call.<ul><li>If
 there is a match, control is returned to the next execution address 
(i.e, the RST 08H instruction + 2) with the next symbol in the A 
Register and HL incremented by one.</li><li>If the two characters do not match, a syntax error message is given and control returns to the Input Phase).</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2018</div><div>EX DE,HL</div><div>If we are here, then it matched (a <span class="code">?SN ERROR</span> would have occurred otherwise) so load DE with the value of the current BASIC program pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2019-201B</div><div>LD HL,(40E4H)</div><div>Load HL with the last <span class="code">AUTO</span> increment value.<br>Note: 40E4H-40E5H holds <span class="code">AUTO</span> increment.</div></div>
									<div class="assembly-row-combined model1"><div>201C</div><div>EX DE,HL</div><div>Exchange the value of the current BASIC program pointer in DE with the last <span class="code">AUTO</span> increment value in HL.</div></div>
									<div class="assembly-row-combined model1"><div>201D-201E</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2025" class="memory-link">JR Z,2025H</a></div><div>Jump to 2025H if this is the end of the BASIC statement (meaning, we got <span class="code">AUTO nn,</span> but no further parameter).</div></div>
									<div class="assembly-row-combined model1"><div>201F-2021</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1E5A" class="memory-link">CALL 1E5AH</a></div><div>If we are here, there was a second parameter so we GOSUB to 1E5AH.<br><b>NOTE:</b>
 The routine at 1E5A converts the ASCII string pointed to by HL to an 
integer deposited into DE.  If the routine finds a non-numerica 
character, the conversion is stopped.</div></div>
									<div class="assembly-row-combined model1"><div>2022-2024</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1997" class="memory-link">JP NZ,1997H</a></div><div>If that prior GOSUB found a non-numeric character it aborted with a NZ, so if there is a NZ, jump to 1997H to show a <span class="code">?SN ERROR</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2025</div><div>EX DE,HL</div><div>Exchange the <span class="code">AUTO</span> increment number in DE with the value of the current BASIC program pointer in HL.</div></div>
									<div class="assembly-row-combined model1" id="2026"><div>2026</div><div>LD A,H</div><div>Load register A with the MSB of the <span class="code">AUTO</span> increment number in register H. (This is step 1 of a test to see if HL is zero)</div></div>
									<div class="assembly-row-combined model1"><div>2027</div><div>OR L</div><div>Combine the LSB of the <span class="code">AUTO</span> increment number in register L with the MSB of the <span class="code">AUTO</span> increment number in register A. (This is step 2 of a test to see if HL is zero)</div></div>
									<div class="assembly-row-combined model1"><div>2028-202A</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1E4A" class="memory-link">JP Z,1E4AH</a></div><div>That all tested the value of HL to see if it was zero. If it was, jupm to 1E4AH to show a <span class="code">?FC ERROR</span> message.</div></div>
									<div class="assembly-row-combined model1"><div>202B-202D</div><div>LD (40E4H),HL</div><div>Save the value of the <span class="code">AUTO</span> increment number in HL.<br>Note: 40E4H-40E5H holds <span class="code">AUTO</span> increment.</div></div>
									<div class="assembly-row-combined model1"><div>202E-2030</div><div>LD (40E1H),A</div><div>Set the <span class="code">AUTO</span> flag to non-zero. We know A is non-zero because we would have jumped 2 instruction ago if it was.</div></div>
									<div class="assembly-row-combined model1"><div>2031</div><div>POP HL</div><div>Get the starting line number from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2032-2034</div><div>LD (40E2H),HL</div><div>Save the line number in HL as the next AUTO line number.<br>Note: 40E2H-40E3H holds Current BASIC line number.</div></div>
									<div class="assembly-row-combined model1"><div>2035</div><div>POP BC</div><div>Clean up the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2036-2038</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1A33" class="memory-link">JP 1A33H</a></div><div>Jump to the Level II BASIC command mode.</div></div>
								</div>
							</div>

							<br><h2 id="2039-2066-level-ii">2039-2066 - LEVEL II BASIC <span class="code">IF</span> ROUTINE<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2039-203B</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2337" class="memory-link">CALL 2337H</a></div><div>GOSUB to 2337H to evaluate the BASIC expression pointed to by HL and return with the result in REG 1.</div></div>
									<div class="assembly-row-combined model1"><div>203C</div><div>LD A,(HL)</div><div>Load register A with the character at the location of the current BASIC program pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>203D-203E</div><div>CP 2CH</div><div>Check to see if the character at the location of the current BASIC program pointer in register A is a <span class="code">,</span>.<br><p class="bold" style="margin-bottom:0px;">Notes:</p><ul><li>2C is a <span class="code">,</span> in ASCII</li><li>A CP will return Z if there is a match against Register A, and NZ if not a match against Register A.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>203F-2041</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1D78" class="memory-link">CALL Z,1D78H</a></div><div>If the character at the location of the current BASIC program pointer in register A is a <span class="code">,</span> then go bump the value of the current BASIC program pointer in HL until it points to the next character.</div></div>
									<div class="assembly-row-combined model1"><div>2042-2043</div><div>CP CAH</div><div>Check to see if the character at the location of the current BASIC program pointer in register A is a <span class="code">THEN</span> token<br><p class="bold" style="margin-bottom:0px;">Notes:</p><ul><li>CAH is a <span class="code">THEN</span> token.</li><li>A CP will return Z if there is a match against Register A, and NZ if not a match against Register A.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2044-2046</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1D78" class="memory-link">CALL Z,1D78H</a></div><div>If Z flag is set, the character at the location of the current BASIC program pointer in register A is a <span class="code">THEN</span> token, so we need to bump the value of the current BASIC program pointer until it points to the next character.</div></div>
									<div class="assembly-row-combined model1"><div>2047</div><div>DEC HL</div><div>Decrement the value of the current BASIC program pointer in HL so that we are still positioned at the <span class="code">THEN</span> token.</div></div>
									<div class="assembly-row-combined model1"><div>2048</div><div>PUSH HL</div><div>Save the value of the current BASIC program pointer to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2049-204B</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0994" class="memory-link">CALL 0994H</a></div><div>GOSUB to 0994H to see if the expression after the <span class="code">IF</span> token was true or false.</div></div>
									<div class="assembly-row-combined model1"><div>204C</div><div>POP HL</div><div>Restore the address of the current position in the current statement (from the stack) into HL.</div></div>
									<div class="assembly-row-combined model1"><div>204D-204E</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2056" class="memory-link">JR Z,2056H</a></div><div>Jump down to 2056H if the expression was false.</div></div>
									<div class="assembly-row-combined model1"><div>204F</div><div>RST 10H</div><div>We need the next character in the BASIC program so call the EXAMINE NEXT SYMBOL routine at RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The
 RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2050-2052</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1EC2" class="memory-link">JP C,1EC2H</a></div><div>Jump to the <span class="code">GOTO</span> routine if the character at the location of the current BASIC program pointer in HL is numeric.</div></div>
									<div class="assembly-row-combined model1"><div>2053-2055</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1D5F" class="memory-link">JP 1D5FH</a></div><div>Jump to the execution driver at 1D5FH to evaluate the rest of the statement string.</div></div>
									<div class="assembly-row-combined model1" id="2056"><div>2056-2057</div><div>LD D,01H</div><div>Load register D with the scan counter (as we will need to count the number of times to scan to the end of line).</div></div>
									<div class="assembly-row-combined model1" id="2058"><div>2058-205A</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1F05" class="memory-link">CALL 1F05H</a></div><div>Go scan the BASIC statement.</div></div>
									<div class="assembly-row-combined model1"><div>205B</div><div>OR A</div><div>Check to see if this is the end of the BASIC instruction.</div></div>
									<div class="assembly-row-combined model1"><div>205C</div><div>RET Z</div><div>Return if this is the end of the BASIC statement.</div></div>
									<div class="assembly-row-combined model1" id="205D"><div>205D</div><div>RST 10H</div><div>We need the next character in the BASIC program so call the EXAMINE NEXT SYMBOL routine at RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The
 RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>205E-205F</div><div>CP 95H</div><div>Check to see if the character at the location of the current BASIC program pointer in register A is an <span class="code">ELSE</span> token.<p class="bold" style="margin-bottom:0px;">Notes:</p><ul><li>95H is a <span class="code">ELSE</span> in ASCII</li><li>A CP will return Z if there is a match against Register A, and NZ if not a match against Register A.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2060-2061</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2058" class="memory-link">JR NZ,2058H</a></div><div>Loop back to 2058H until an <span class="code">ELSE</span> token is found.</div></div>
									<div class="assembly-row-combined model1"><div>2062</div><div>DEC D</div><div>Decrement the value of the scan counter.</div></div>
									<div class="assembly-row-combined model1"><div>2063-2064</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2058" class="memory-link">JR NZ,2058H</a></div><div>Loop back to 2058H until all of the <span class="code">ELSE</span> tokens have been found.</div></div>
									<div class="assembly-row-combined model1"><div>2065-2066</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#204F" class="memory-link">JR 204FH</a></div><div>Jump to 204FH to evaluate the rest of the expression.</div></div>
								</div>
							</div>

							<br><h2 id="2067-206e-level-ii">2067-206E - LEVEL II BASIC LPRINT ROUTINE<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2067-2068</div><div>LD A,01H</div><div>Load register A with the output device code for the printer.</div></div>
									<div class="assembly-row-combined model1"><div>2069-206B</div><div>LD (409CH),A</div><div>Save the value in register A as the current output device type number.<br><ul><li>Note: 409CH holds the current output device flag:<ul><li>-1=cassette,</li><li>0=video; or</li><li>1=printer.</li></ul></li></ul></div></div>
									<div class="assembly-row-combined model3"><div>*206C-206E</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#207C" class="memory-link">JP 207CH</a></div><div>Skip a few instructions and pick up at 207CH.<br>Differences
 between M1 and M3 ROMs: All of the changes from 206DH - 20F7H first 
appeared in the "new" ROMs of the Model I. The changes were made to 
allow the use of multiple @'s in a PRINT statement.</div></div>
								</div>
							</div>

							<br><h2 id="206f-2177-level-ii">206F-2177 - LEVEL II BASIC PRINT ROUTINE<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>206F-2071</div><div><a href="#41CA" class="memory-link">CALL 41CAH</a></div><div>Call the DOS exit link at 41CAH.</div></div>
									<div class="assembly-row-combined model3"><div>*2072-2073</div><div>CP '#'</div><div>Check the character at the location of the current BASIC program pointer in register A to see if it's an <span class="code">#</span>.</div></div>
									<div class="assembly-row-combined model3"><div>*2074-2075</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#207C" class="memory-link">JR NZ,207CH</a></div><div>Jump to 207CH if it is not a <span class="code">#</span>.</div></div>
									<div class="assembly-row-combined model3"><div>*2076-2078</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0284" class="memory-link">CALL 0284H</a></div><div>GOSUB to 0284H to [Turn the tape on, no header].</div></div>
									<div class="assembly-row-combined model3"><div>*2079-207B</div><div>LD (409CH),A</div><div>Load the memory location at 409CH with A, to route output to cassette.</div></div>
									<div class="assembly-row-combined model3" id="207C"><div>*207C</div><div>DEC HL</div><div>Decrement HL to back up.</div></div>
									<div class="assembly-row-combined model3"><div>*207D</div><div>RST 10H</div><div>We
 need to check for the end of the statement as the next character in the
 BASIC program so call the EXAMINE NEXT SYMBOL routine at RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The
 RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model3"><div>*207E-2080</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#20FE" class="memory-link">CALL Z,20FEH</a></div><div>GOSUB to 20FEH if it was the end of statement, so we can process a new line.</div></div>
									<div class="assembly-row-combined model3"><div>*2081-2083</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2169" class="memory-link">JP Z,2169H</a></div><div>And if it was the end of the statement then JUMP to 2169H to finish up.</div></div>
									<div class="assembly-row-combined model3"><div>*2084</div><div>OR 20H</div><div>With this MASK, we are getting readh to check to see if it was a <span class="code">@</span>.</div></div>
									<div class="assembly-row-combined model3"><div>*2086</div><div>CP 60H</div><div>Compare against a "'" (which is actually a <span class="code">@</span> on the TRS-80).</div></div>
									<div class="assembly-row-combined model3"><div>*2088-2089</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#20A5" class="memory-link">JR NZ,20A5H</a></div><div>JUMP to 20A5H if it is not a <span class="code">@</span>.</div></div>
									<div class="assembly-row-combined model3"><div>*208A</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2B01" class="memory-link">CALL 2B01H</a></div><div>GOSUB to 2B01H to evaluate the <span class="code">PRINT@</span> expression (which is at the location of the current BASIC program pointer in HL and return with the result in DE).</div></div>
									<div class="assembly-row-combined model3"><div>*208D</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1023" class="memory-link">CP 04</a></div><div>Check
 to see if the location in DE is greater than 1023H. A CP will return Z 
if there is a match against Register A, and NZ if not a match against 
Register A.</div></div>
									<div class="assembly-row-combined model3"><div>*208F</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1E4A" class="memory-link">JP NC,1E4AH</a></div><div>If that check resulted in no CARRY flag, jump to 1E4AH to show a <span class="code">?FC error</span>.</div></div>
									<div class="assembly-row-combined model3"><div>*2092</div><div>PUSH HL</div><div>Push the current code string address (held in HL) to the stack.</div></div>
									<div class="assembly-row-combined model3"><div>*2093</div><div>LD HL,3C00H</div><div>Load HL with the start of the display area.</div></div>
									<div class="assembly-row-combined model3"><div>*2096</div><div>ADD HL,DE</div><div>Add DE to HL so that HL now will be the start of the diplay area PLUS the <span class="code">PRINT@</span> offset position.</div></div>
									<div class="assembly-row-combined model3"><div>*2097</div><div>LD (4020H),HL</div><div>Store the cursor position of the screen address matching the <span class="code">PRINT@</span> position into the display DCB held in memory location 4020H.<br><ul><li>4020H-4021H: Holds the video memory address of the current cursor position.</li></ul></div></div>
									<div class="assembly-row-combined model3"><div>*209A</div><div>LD A,E</div><div>E is the current position within the line.</div></div>
									<div class="assembly-row-combined model3"><div>*209B</div><div>AND 3FH</div><div>Make it not exceed 63 and then save it ....</div></div>
									<div class="assembly-row-combined model3"><div>*209D</div><div>LD (40A6H),A</div><div>... into the current cursor offset (which is held in 40A6H).</div></div>
									<div class="assembly-row-combined model3"><div>*20A0</div><div>POP HL</div><div>Restore the code string address to HL</div></div>
									<div class="assembly-row-combined model3"><div>*20A2</div><div>RST 08H ‚áí  2C</div><div>At this point we have a <span class="code">PRINT@nnnn</span> so the only valid next character is a <span class="code">,</span> so we need to call RST 08H to check against 2C, the code for comma.<br><br><span class="bold nobottomborder">NOTE:</span>
 The RST 08H routine compares the symbol in the input string pointed to 
by HL register to the value in the location following the RST 08 call.<ul><li>If
 there is a match, control is returned to the next execution address 
(i.e, the RST 08H instruction + 2) with the next symbol in the A 
Register and HL incremented by one.</li><li>If the two characters do not match, a syntax error message is given and control returns to the Input Phase).</li></ul></div></div>
									<div class="assembly-row-combined model3"><div>*20A3-20A4</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#206C" class="memory-link">JR 206CH</a><br>2C</div><div>JUMP to 206CH to [NEXT ITEM].</div></div>
									<div class="assembly-row-combined model3"><div>*20A5</div><div>LD	A,(HL)<br>2C</div><div>Put the next token (held in the memory location pointed to by HL) into A.</div></div>
									<div class="assembly-row-combined model3"><div>*20A6-20A7</div><div>CP 0BFH</div><div>Compare the device flag.<br><b>NOTE:</b> A <span class="code">CP</span> will return Z if there is a match against Register A, and NZ if not a match against Register A.</div></div>
									<div class="assembly-row-combined model3"><div>*20A8-20AA</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2CBD" class="memory-link">JP Z,2CBDH</a></div><div>... and return to the execution driver.</div></div>
									<div class="assembly-row-combined model3"><div>*20AB-20AC</div><div>CP BCH</div><div>Test for a <span class="code">TAB</span> token.<p class="bold" style="margin-bottom:0px;">Notes:</p><ul><li>BCH is a <span class="code">TAB</span> in ASCII</li><li>A CP will return Z if there is a match against Register A, and NZ if not a match against Register A.</li></ul></div></div>
									<div class="assembly-row-combined model3"><div>*20AD-20AF</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2137" class="memory-link">JP Z,2137H</a></div><div>and if it is a <span class="code">TAB</span> token (meaning the command is <span class="code">PRINT TAB</span>, jump down to 2137H.</div></div>
									<div class="assembly-row-combined model3"><div>*20B0</div><div>PUSH HL</div><div>Continuing on a <span class="code">PRINT#</span>, save the current position in the input stream into the stack.</div></div>
									<div class="assembly-row-combined model3"><div>*20B1-20B2</div><div>CP 2CH</div><div>Test for a <span class="code">,</span>.<p class="bold" style="margin-bottom:0px;">Notes:</p><ul><li>2CH is a <span class="code">,</span> in ASCII</li><li>A CP will return Z if there is a match against Register A, and NZ if not a match against Register A.</li></ul></div></div>
									<div class="assembly-row-combined model3"><div>*20B3-20B4</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2108" class="memory-link">JR Z,2108H</a></div><div>If there is a comma, jump down to 2108H to get the next item.</div></div>
									<div class="assembly-row-combined model3"><div>*20B5-20B6</div><div>CP 3BH</div><div>Since its not a comma, next we need to check for a <span class="code">;</span>.<p class="bold" style="margin-bottom:0px;">Notes:</p><ul><li>3BH is a <span class="code">;</span> in ASCII</li><li>A CP will return Z if there is a match against Register A, and NZ if not a match against Register A.</li></ul></div></div>
									<div class="assembly-row-combined model3"><div>*20B7-20B8</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2117" class="memory-link">JR Z,2117H</a></div><div>If it is a <span class="code">;</span>, jump down to 2117H to process.</div></div>
									<div class="assembly-row-combined model3"><div>*20B9</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2337" class="memory-link">CALL 2337H</a></div><div>GOSUB to 2337H [to evaluate the expression].</div></div>
									<div class="assembly-row-combined model3"><div>*20BC</div><div>EX	(SP),HL</div><div>Swap (SP) for HL to restore the position.</div></div>
									<div class="assembly-row-combined model1"><div>20BD</div><div>RST 20H</div><div>Check its data type with a call to RST 20H.<br><span class="nobottomborder bold">NOTE:</span>
  The RST 20H routine determines the type of the current value in REG 1 
and returns a combination of STATUS flags and unique numeric values in 
the A Register according to the data mode flag (40AFH).<br><br>The results are returned as follows:<table style="border-collapse: collapse; border: 1px solid black;"><tbody><tr style="background-color: #f0f0f0;"><td style="border: 1px solid black; padding: 8px;">If the Variable Type is ...</td><td style="border: 1px solid black; padding: 8px;">and the Flags<br>are set ...</td><td style="border: 1px solid black; padding: 8px;">... then Register<br>A will be set ...</td></tr><tr><td style="border: 1px solid black; padding: 8px;">Integer</td><td style="border: 1px solid black; padding: 8px;">NZ/C/M/E</td><td style="border: 1px solid black; padding: 8px;">-1</td></tr><tr><td style="border: 1px solid black; padding: 8px;">String</td><td style="border: 1px solid black; padding: 8px;">Z/C/P/E</td><td style="border: 1px solid black; padding: 8px;">0</td></tr><tr><td style="border: 1px solid black; padding: 8px;">Single Precision</td><td style="border: 1px solid black; padding: 8px;">NZ/C/P/O</td><td style="border: 1px solid black; padding: 8px;">1</td></tr><tr><td style="border: 1px solid black; padding: 8px;">Double Precision</td><td style="border: 1px solid black; padding: 8px;">NZ/NC/P/E</td><td style="border: 1px solid black; padding: 8px;">5</td></tr></tbody></table></div></div>
									<div class="assembly-row-combined model1"><div>20BE</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#20F2" class="memory-link">JR Z,20F2H</a></div><div>If it is a string, jump down to 20F2H.</div></div>
									<div class="assembly-row-combined model1"><div>20C0</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0FBD" class="memory-link">CALL 0FBDH</a></div><div>GOSUB to the routine at 0FBDH to convert the binary to ASCII and move to the print buffer.</div></div>
									<div class="assembly-row-combined model1"><div>20C3</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2865" class="memory-link">CALL 2865H</a></div><div>GOSUB to the routine at 2865H to build a literal string pool entry for the ASCII number.</div></div>
									<div class="assembly-row-combined model1"><div>20C6</div><div><a href="#41CD" class="memory-link">CALL 41CDH</a></div><div>GOSUB to a DOS exit if needed</div></div>
									<div class="assembly-row-combined model1"><div>20C9</div><div>LD HL,(4121H)</div><div>Put the address of the current print string into HL.</div></div>
									<div class="assembly-row-combined model1"><div>20CC</div><div>LD A,(409CH)</div><div>Get the output device type flag and put it into A.<br><ul><li>Note: 409CH holds the current output device flag:<ul><li>-1=cassette,</li><li>0=video; or</li><li>1=printer.</li></ul></li></ul></div></div>
									<div class="assembly-row-combined model1"><div>20CF</div><div>OR A</div><div>Test the output device type flag.</div></div>
									<div class="assembly-row-combined model1"><div>20D0</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#20E9" class="memory-link">JP M,20E9H</a></div><div>If we writing to a cassette (i.e., <span class="code">PRINT#</span>) jump to 20E9H.</div></div>
									<div class="assembly-row-combined model1"><div>20D3</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#20DD" class="memory-link">JR Z,20DDH</a></div><div>If, instead, we do NOT have a <span class="code">LPRINT</span>, jump down to 20DDH.</div></div>
									<div class="assembly-row-combined model1"><div>20D5-20D7</div><div>LD A,(409BH)</div><div>If we are here, we have a <span class="code">LPRINT</span> so load A with the current carriage position.<br>Note: 409BH holds the printer carriage position.</div></div>
									<div class="assembly-row-combined model1"><div>20D8</div><div>ADD A,(HL)</div><div>Add
 the length of the string to be sent to the printer at the location of 
the memory pointer in HL to the current carriage position in register A.</div></div>
									<div class="assembly-row-combined model1"><div>20D9-20DA</div><div>CP 84H</div><div>Check to see if the adjusted length in register A is greater than 132.<br><b>NOTE:</b> A <span class="code">CP</span> will return Z if there is a match against Register A, and NZ if not a match against Register A.</div></div>
									<div class="assembly-row-combined model1"><div>20DB-20DC</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#20E6" class="memory-link">JR 20E6H</a></div><div>Jump forward to 20E6H.</div></div>
									<div class="assembly-row-combined model1"><div>20DD-20DF</div><div>LD A,(409DH)</div><div>Load register A with the video line size.<br>Note: 409DH holds the size of line on the video display.</div></div>
									<div class="assembly-row-combined model1"><div>20E0</div><div>LD B,A</div><div>Load register B with the video line size in register A.</div></div>
									<div class="assembly-row-combined model1"><div>20E1-20E3</div><div>LD A,(40A6H)</div><div>Load register A with the current video line position.<br>Note: 40A6H holds the current cursor line position.</div></div>
									<div class="assembly-row-combined model1"><div>20E4</div><div>ADD A,(HL)</div><div>Add
 the length of the string to be sent to the video display at the 
location of the memory pointer in HL to the value of the current video 
line position in register A.</div></div>
									<div class="assembly-row-combined model1"><div>20E5</div><div>CP B</div><div>Check to see if the length in register A is greater than the video line length.<br><b>NOTE:</b> A <span class="code">CP</span> will return Z if there is a match against Register A, and NZ if not a match against Register A.</div></div>
									<div class="assembly-row-combined model1" id="20E6"><div>20E6-20E8</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#20FE" class="memory-link">CALL NC,20FEH</a></div><div>If NC is set, the new line will overflow the buffer so send a carriage return to the current output device.</div></div>
									<div class="assembly-row-combined model1"><div>20E9-20EB</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#28AA" class="memory-link">CALL 28AAH</a></div><div>Go send the string to the current output device.</div></div>
									<div class="assembly-row-combined model1"><div>20EC-20ED</div><div>LD A,20H</div><div>Load register A with a space.</div></div>
									<div class="assembly-row-combined model1"><div>20EE-20F0</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#032A" class="memory-link">CALL 032AH</a></div><div>Go send the space in register A to the current output device.</div></div>
									<div class="assembly-row-combined model1"><div>20F1</div><div>OR A</div><div>Check to see if register A is equal to zero.</div></div>
									<div class="assembly-row-combined model1"><div>20F2-20F4</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#28AA" class="memory-link">CALL Z,28AAH</a></div><div>If necessary go send the string to the current output device.</div></div>
									<div class="assembly-row-combined model1"><div>20F5</div><div>POP HL</div><div>Restore the current code string to HL</div></div>
									<div class="assembly-row-combined model1"><div>20F6-20F8</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#207C" class="memory-link">JP 207CH</a></div><div>Loop to 207CH until an end of statement code is found. Going all the way back to 207CH will also test for a <span class="code">PRINT @</span>, thus permitting a <span class="code">PRINT @</span> to appear other than first.</div></div>
									<div class="assembly-row-combined model1"><div>20F9-20FB</div><div>LD A,(40A6H)</div><div>Load register A with the number of characters printed on the current line.<br>Note: 40A6H holds the current cursor line position.</div></div>
									<div class="assembly-row-combined model1"><div>20FC</div><div>OR A</div><div>Check to see if any characters have been printed on the current line.</div></div>
									<div class="assembly-row-combined model1"><div>20FD</div><div>RET Z</div><div>Return out of this routine if we are at the start of a line.</div></div>
								</div>
							</div>

							<br><h2 id="20fe-this-routine">20FE - This routine outputs a carriage return (0DH) to a device determined by flag stored at (409CH).<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<p>NOTE: This routine may be CALLed at 20F9H, in which case it 
will not perform the above action if the video display cursor is already
 positioned at the beginning of a line, as determined by checking the 
contents of the cursor position flag at 40A6H (if zero, cursor is at 
start of line). This routine CALLs the routine at 032AH and also CALLs a
 Disk BASIC link at 41D0H.</p>
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>20FE-20FF</div><div>LD A,0DH</div><div>Otherwise, we need to skip to the next line so load register A with a carriage return.</div></div>
									<div class="assembly-row-combined model1"><div>2100-2102</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#032A" class="memory-link">CALL 032AH</a></div><div>Go send the carriage return in register A to the current output device.</div></div>
									<div class="assembly-row-combined model1"><div>2103-2105</div><div><a href="#41D0" class="memory-link">CALL 41D0H</a></div><div>Call the DOS link at 41D0H.<br>In NEWDOS 2.1, this is called when skipping to next line on a video during a BASIC output operation.</div></div>
									<div class="assembly-row-combined model1"><div>2106</div><div>XOR A</div><div>Zero register A and the carry flags.</div></div>
									<div class="assembly-row-combined model1"><div>2107</div><div>RET</div><div>Return back to the calling routine.</div></div>
								</div>
							</div>

							<br><h2 id="2108-this-is-the">2108 - This is the jump point for a continuation of the <span class="code">PRINT#</span> code.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2108-210A</div><div><a href="#41D3" class="memory-link">CALL 41D3H</a></div><div>Call the DOS link at 4103H.<br>In NEWDOS 2.1, this is called at the start of PRINT on cassette and during PRINT TAB.</div></div>
									<div class="assembly-row-combined model1"><div>210B-210D</div><div>LD A,(409CH)</div><div>Load register A with the value of the current output device flag..<br><ul><li>Note: 409CH holds the current output device flag:<ul><li>-1=cassette,</li><li>0=video; or</li><li>1=printer.</li></ul></li></ul></div></div>
									<div class="assembly-row-combined model1"><div>210E</div><div>OR A</div><div>Test the value of the current output device flag in register A.<br><ul><li>M will be set if the value in A is negative.</li><li>P will be set if the value in A is positive or zero.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>210F-2111</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2119" class="memory-link">JP P,2119H</a></div><div>Jump down a few instructions to 2119H if the printer or the video display is the current output device.</div></div>
									<div class="assembly-row-combined model1"><div>2112-2113</div><div>LD A,2CH</div><div>So now that we know the current device is cassette, we will load register A with a <span class="code">,</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2114-2116</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#032A" class="memory-link">CALL 032AH</a></div><div>Send the <span class="code">,</span>
 in register A to current output device.  In this case, it is the 
cassette recorder because we otherwise would have jumped away at 210FH.</div></div>
									<div class="assembly-row-combined model1"><div>2117-2118</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2164" class="memory-link">JR 2164H</a></div><div>Jump forward to 2164H to fetch the next character from the code string.</div></div>
									<div class="assembly-row-combined model1"><div>2119-211A</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2123" class="memory-link">JR Z,2123H</a></div><div>We
 landed here from 210FH knowing that the current output device flag was 
either video or printer. Now we need to break that down too, so if the 
device flag is the video display, jump down to 2123H.</div></div>
									<div class="assembly-row-combined model1"><div>211B-211D</div><div>LD A,(409BH)</div><div>We're here because the output device is a printer. First, load register A with the current carriage position.<br>Note: 409BH holds the printer carriage position.</div></div>
									<div class="assembly-row-combined model1"><div>211E-211F</div><div>CP 70H</div><div>Check to see if the current carriage position in register A is greater than 112.<br><b>NOTE:</b> A <span class="code">CP</span> will return Z if there is a match against Register A, and NZ if not a match against Register A.</div></div>
									<div class="assembly-row-combined model1"><div>2120-2122</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#212B" class="memory-link">JP 212BH</a></div><div>Jump forward a few instructions to 212BH.</div></div>
									<div class="assembly-row-combined model1"><div>2123-2125</div><div>LD A,(409EH)</div><div>We were jumped to this point because the output device is the video display. So load register A with the video line length.<br>Note: 409EH holds the size of line on the printer.</div></div>
									<div class="assembly-row-combined model1"><div>2126</div><div>LD B,A</div><div>Load register B with the video line length in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2127-2129</div><div>LD A,(40A6H)</div><div>Load register A with the current video line position.<br>Note: 40A6H holds the current cursor line position.</div></div>
									<div class="assembly-row-combined model1"><div>212A</div><div>CP B</div><div>Test
 to see if there is room on this line by checking to see if the current 
video line position in register A is equal to the video line length in 
register B.<br><b>NOTE:</b> A <span class="code">CP</span> will return Z if there is a match against Register A, and NZ if not a match against Register A.</div></div>
									<div class="assembly-row-combined model1" id="212B"><div>212B-212D</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#20FE" class="memory-link">CALL NC,20FEH</a></div><div>If
 the NC is set, there is no room on the current line, so we need to 
GOSUB to 20FEH to print a carriage return on the current output device.</div></div>
									<div class="assembly-row-combined model1" id="212E"><div>212E-212F</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2164" class="memory-link">JR NC,2164H</a></div><div>If this is the end of the line on the current output device jump forward to 2164H.</div></div>
									<div class="assembly-row-combined model1"><div>2130-2131</div><div>SUB 10H</div><div>Check to see if there are at least 16 spaces left on the current line for the current output device.</div></div>
									<div class="assembly-row-combined model1" id="2132"><div>2132-2133</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2130" class="memory-link">JR NC,2130H</a></div><div>Loop back until there are at least 16 spaces left on the current line.</div></div>
									<div class="assembly-row-combined model1"><div>2134</div><div>CPL</div><div>Figure the number of spaces to be sent to the current output device.</div></div>
									<div class="assembly-row-combined model1"><div>2135-2136</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#215A" class="memory-link">JR 215AH</a></div><div>Jump to 215AH to print those spaces/blanks.</div></div>
								</div>
							</div>

							<br><h2 id="2137-tab-logic">2137 - TAB logic.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<p>This routine is the TAB function for video or printer 
(determined by flag at 409CH). On entry: E register contains desired TAB
 position, HL points to start of message to be displayed (or zero byte 
if no message). This routine does extensive string processing and may 
not be the most efficient method of achieving the desired result, 
particularly if it is desired only to tab over a number of spaces. Also,
 this routine CALLs several Disk BASIC links which may have to be 
"plugged". 2169 - Reset device type flag at 409CH to zero (output to 
video display), also turns off cassette drive if necessary. CALLs Disk 
BASIC link at 41BEH prior to return.</p>
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2137-2139</div><div><a href="#409C" class="memory-link">CALL 2B1BH</a></div><div>GOSUB
 forward to 2B1BH to evaluate the tab number at the location of the 
current BASIC program pointer in HL and return with the result in 
register A.</div></div>
									<div class="assembly-row-combined model1"><div>213A-213B</div><div>AND 3FH</div><div>The results are in A so mask the tab number in register A so that it doesn't exceed 63.<br>Difference
 between M1 and M3 ROMs: This also first appeared in the "new" ROMs of 
the Model I, as part of an AND 7FH instruction located at 213AH. In the 
original version the instruction was AND 3FH. The operand of the 
instruction sets the maximum argument for the TAB function, thus the 
early TRS-80's could only handle a maximum TAB (63) while the latest 
Models can go as high as TAB (127).</div></div>
									<div class="assembly-row-combined model1"><div>213C</div><div>LD B,A</div><div>Load register B with the value of the tab number from register A.</div></div>
									<div class="assembly-row-combined model1"><div>213D-213E</div><div>RST 08H ‚áí  29</div><div>At this point, we have a <span class="code">TAB(nn</span>, so the next character needs to be a <span class="code">)</span>.
 Since the character at the location of the current BASIC program 
pointer in HL must be a ")", call the COMPARE SYMBOL at RST 08H.<br><br><span class="bold nobottomborder">NOTE:</span>
 The RST 08H routine compares the symbol in the input string pointed to 
by HL register to the value in the location following the RST 08 call.<ul><li>If
 there is a match, control is returned to the next execution address 
(i.e, the RST 08H instruction + 2) with the next symbol in the A 
Register and HL incremented by one.</li><li>If the two characters do not match, a syntax error message is given and control returns to the Input Phase).</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>213F</div><div>DEC HL</div><div>Decrement the value of the current BASIC program pointer in HL so that it points to the <span class="code">(</span>.</div></div>
									<p class="debug-note">
										To use a ROM call to locate the cursor at position n on the 
current display line, where n is an integer between 0 and 3FH, 
inclusive, first load the E register with the value of n and then load 
the HL register pair with the address of a zero byte in memory.  Once 
that's done CALL 213FH.
										</p><ul>
										<li>NOTE 1: The cursor position cannot be moved backward by 
this procedure. If n is not greater than the current cursor position on 
the line, no change will occur.</li>
										<li>NOTE 2: To locate the cursor at a given position on the 
screen (the function of the PRINT@ command in BASIC), the simplest 
procedure is to modify the cursor position bytes, which are located at 
4020H-4021H. The address contained in these memory cells is that of the 
position in video memory (3C00H-3FFFH) at which the (abstract) cursor 
resides. This cursor position controls subsequent printing via the 
subroutine at 28A7H</li>
										<li>DISK SYSTEM CAUTION: The subroutine at 213FH has three 
exits to DISK BASIC, with RAM transfer points at 41BEH, 41C1H, and 
41D3H. To use this routine safely, either be certain that DISK BASIC is 
in place, or have your assembly language program fill locations 41BEH, 
41C1H, and 41D3H with RET's (C9H), before calling the routine.</li>
										</ul>
									<p></p>
									<div class="assembly-row-combined model1"><div>2140</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#213F" class="memory-link">PUSH HL</a></div><div>Save the value of the current BASIC program pointer in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2141-2143</div><div><a href="#41D3" class="memory-link">CALL 41D3H</a></div><div>Call the DOS link at 41DCH.</div></div>
									<div class="assembly-row-combined model1"><div>2144-2146</div><div>LD A,(409CH)</div><div>Load register A with the value of the current output device flag..<br><ul><li>Note: 409CH holds the current output device flag:<ul><li>-1=cassette,</li><li>0=video; or</li><li>1=printer.</li></ul></li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2147</div><div>OR A</div><div>Test the value of the current output device flag in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2148-214A</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1E4A" class="memory-link">JP M,1E4AH</a></div><div>Display a <span class="code">?FC ERROR</span> message if the current output device is the cassette recorder.</div></div>
									<div class="assembly-row-combined model1"><div>214B-214D</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2153" class="memory-link">JP Z,2153H</a></div><div>Jump forward a few instructions to 2153H if the current output device is the video display.</div></div>
									<div class="assembly-row-combined model1"><div>214E-2150</div><div>LD A,(409BH)</div><div>Since
 we have already jumped away if the current output device is to cassette
 or screen, if we are here we know that this is to go to the printer, so
 load register A with the current carriage position.<br>Note: 409BH holds the printer carriage position.</div></div>
									<div class="assembly-row-combined model1"><div>2151-2152</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2156" class="memory-link">JR 2156H</a></div><div>Jump over the next instruction (which is a video instruction).</div></div>
									<div class="assembly-row-combined model1"><div>2154-2155</div><div>LD A,(40A6H)</div><div>Load register A with the current video line position.<br>Note: 40A6H holds the current cursor line position.</div></div>
									<div class="assembly-row-combined model1"><div>2156</div><div>CPL</div><div>When
 we land here, A holds either the current carriage position (printer) or
 the current line position (video). Regardless, complement (make 
negative) that value.</div></div>
									<div class="assembly-row-combined model1"><div>2157</div><div>ADD A,E</div><div>Add the tab number in register B to the adjusted line position in register A so that A=-current position + tab.</div></div>
									<div class="assembly-row-combined model1" id="2158"><div>2158-2159</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2164" class="memory-link">JR NC,2164H</a></div><div>Jump
 forward a few instructions to 2164H to skip over the actual TAB 
effectuation routine if the tab number in register B is less than the 
line position in register A.</div></div>
									<div class="assembly-row-combined model1"><div>215A</div><div>INC A</div><div>Bump the number of spaces to be printed in register A.</div></div>
									<div class="assembly-row-combined model1"><div>215B</div><div>LD B,A</div><div>Load register B with the number of spaces to be printed in register A.</div></div>
									<div class="assembly-row-combined model1"><div>215C-215D</div><div>LD A,20H</div><div>Load register A with a space.</div></div>
									<div class="assembly-row-combined model1"><div>215E-2160</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#032A" class="memory-link">CALL 032AH</a></div><div>Send the space in register A to the current output device.</div></div>
									<div class="assembly-row-combined model1"><div>2161</div><div>DEC B</div><div>Decrement the value of the space counter in register B.</div></div>
									<div class="assembly-row-combined model1"><div>2162-2163</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#215E" class="memory-link">JR NZ,215EH</a></div><div>Loop back to 215EH until all of the spaces have been displayed/printed.</div></div>
									<div class="assembly-row-combined model1" id="2164"><div>2164</div><div>POP HL</div><div>Restore the position in of the current BASIC program pointer (from the stack) into HL.</div></div>
									<div class="assembly-row-combined model1"><div>2165</div><div>RST 10H</div><div>We need the next character in the BASIC program so call the EXAMINE NEXT SYMBOL routine at RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The
 RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model3"><div>*2166-2168</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2081" class="memory-link">JP 2081H</a></div><div>Jump back to 2081H to process the rest of the <span class="code">PRINT TAB</span> statement.<br>Difference between M1 and M3 ROMs:  This corrects a jump back into the revised PRINT command routine.</div></div>
								</div>
							</div>

							<br><h2 id="2169-this-routine">2169 - This routine resets the 
device type flag at 409CH to zero (output to video display), also turns 
off cassette drive if necessary. CALLs Disk BASIC link at 41BEH prior to
 return.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2169-216B</div><div>LD A,(409CH)</div><div>If
 we land here, we need to turn off the cassette and reset the current 
output device to be video. To do this we first load register A with the 
current output device flag..<br><ul><li>Note: 409CH holds the current output device flag:<ul><li>-1=cassette,</li><li>0=video; or</li><li>1=printer.</li></ul></li></ul></div></div>
									<div class="assembly-row-combined model1"><div>216C</div><div>OR A</div><div>Test the value of the current output device flag in register A.  If the M flag is set, A was negative.</div></div>
									<div class="assembly-row-combined model1"><div>216D-216F</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#01F8" class="memory-link">CALL M,01F8H</a></div><div>If the current output device flag is the cassette recorder, GOSUB to 01F8H to turn it off.</div></div>
									<div class="assembly-row-combined model1"><div>2170</div><div>XOR A</div><div>Clear Register A (which will set A to 0) and clear the status flags.</div></div>
									<div class="assembly-row-combined model1"><div>2171-2173</div><div>LD (409CH),A</div><div>Save the value in register A (which is 0) as the current value of the output device flag.<br><ul><li>Note: 409CH holds the current output device flag:<ul><li>-1=cassette,</li><li>0=video; or</li><li>1=printer.</li></ul></li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2174-2176</div><div><a href="#41BE" class="memory-link">CALL 41BEH</a></div><div>Call the DOS link at 41BEH.<br>In NEWDOS 2.1, this initializes the system output device.</div></div>
									<div class="assembly-row-combined model1"><div>2177</div><div>RET</div><div>Return.</div></div>
								</div>
							</div>

							<br><h2 id="2178-217e-message">2178-217E - MESSAGE STORAGE LOCATION FOR REDO MESSAGE<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2178-217E</div><div>"?REDO"</div><div>The ?REDO message is stored here.</div></div>
								</div>
							</div>

							<br><h2 id="217f-2285-level-ii">217F-2285 - LEVEL II BASIC INPUT AND READ ROUTINES<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>217F-2181</div><div>LD A,(40DEH)</div><div>Load register A with the read flag.<br>Note: 40DEH holds READ flag.</div></div>
									<div class="assembly-row-combined model1"><div>2182</div><div>OR A</div><div>Check to see if the read flag is set.</div></div>
									<div class="assembly-row-combined model1"><div>2183-2185</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1991" class="memory-link">JP NZ,1991H</a></div><div>If the read flag is set, go give a <span class="code">?SN ERROR</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2186-2188</div><div>LD A,(40A9H)</div><div>Now we know the read flag is NOT set, so we need to load register A with the input type flag.<br>Note: 40A9H holds Cassette input flag.</div></div>
									<div class="assembly-row-combined model1"><div>2189</div><div>OR A</div><div>Check to see if the cassette recorder is the current input device.</div></div>
									<div class="assembly-row-combined model1"><div>218A-218B</div><div>LD E,2AH</div><div>Load register E with the <span class="code">?FD ERROR</span> code.</div></div>
									<div class="assembly-row-combined model1"><div>218C-218E</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#19A2" class="memory-link">JP Z,19A2H</a></div><div>If the current input device is the cassette recorder, go give a <span class="code">?FD ERROR</span>.</div></div>
									<div class="assembly-row-combined model1"><div>218F</div><div>POP BC</div><div>Clean up the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2190-2192</div><div>LD HL,2178H</div><div>Load HL with the starting address of the <span class="code">?REDO</span> message.</div></div>
									<div class="assembly-row-combined model1"><div>2193-2195</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#28A7" class="memory-link">CALL 28A7H</a></div><div>We need to display the <span class="code">?REDO</span>, so we call the WRITE MESSAGE routine at 28A7H.<br><span class="bold">NOTE:</span><br><ul><li>The routine at 28A7 displays the message pointed to by HL on current system output device (usually video).</li><li>The string to be displayed must be terminated by a byte of machine zeros or a carriage return code 0D.</li><li>If terminated with a carriage return, control is returned to the caller after taking the DOS exit at 41D0H (JP 5B99H).</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2196-2198</div><div>LD HL,(40E6H)</div><div>Get the value of the current BASIC program pointer in HL.<br>Note: 40E6H-40E7H holds Temporary storage location.</div></div>
									<div class="assembly-row-combined model1"><div>2199</div><div>RET</div><div>Return out of this routine.</div></div>
								</div>
							</div>

							<br><h2 id="219a-input-logic">219A - INPUT logic<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>219A-219C</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2828" class="memory-link">CALL 2828H</a></div><div>Check to see if there is an illegal direct in the input statement.</div></div>
									<div class="assembly-row-combined model1"><div>219D</div><div>LD A,(HL)</div><div>Load register A with the character at the location of the current BASIC program pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>219E-21A0</div><div><a href="#41D6" class="memory-link">CALL 41D6H</a></div><div>Call the DOS link at 41D6H.<br>In NEWDOS 2.1 this is called at the beginning of INPUT processing.</div></div>
									<div class="assembly-row-combined model1"><div>21A1-21A2</div><div>SUB 23H</div><div>Check to see if the character at the location of the current BASIC program pointer in register A is a <span class="code">#</span>.</div></div>
									<div class="assembly-row-combined model1"><div>21A3-21A5</div><div>LD (40A9H),A</div><div>Set the current input device flag for the cassette recorder.<br>Note: 40A9H holds cassette input flag.</div></div>
									<div class="assembly-row-combined model1"><div>21A6</div><div>LD A,(HL)</div><div>Load register A with the character at the location of the current BASIC program pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>21A7-21A8</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#21C9" class="memory-link">JR NZ,21C9H</a></div><div>Jump to 21C9H if there is keyboard input.</div></div>
									<div class="assembly-row-combined model1"><div>21A9-21AB</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0293" class="memory-link">CALL 0293H</a></div><div>If
 we are here, then the input is coming from the cassette, so GOSUB to 
0293H to read the cassette leader and find the sync byte.</div></div>
									<div class="assembly-row-combined model1"><div>21AC</div><div>PUSH HL</div><div>Save the current BASIC program pointer in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>21AD-21AE</div><div>LD B,FAH</div><div>Load register B with the size of the input buffer.</div></div>
									<div class="assembly-row-combined model1"><div>21AF-21B1</div><div>LD HL,(40A7H)</div><div>Load HL with the starting address of the input buffer.<br>Note: 40A7H-40A8H holds the input Buffer pointer.</div></div>
									<div class="assembly-row-combined model1"><div>21B2-21B4</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0235" class="memory-link">CALL 0235H</a></div><div>Calls
 the READ ONE BYTE FROM CASSETTE routine at 0235H (which reads one byte 
from the cassette drive specified in register A, and returns the byte in
 register A).</div></div>
									<div class="assembly-row-combined model1"><div>21B5</div><div>LD (HL),A</div><div>Save the byte read from the cassette recorder in register A at the location of the input buffer pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>21B6</div><div>INC HL</div><div>Bump the value of the input buffer pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>21B7-21B8</div><div>CP 0DH</div><div>Check to see if the character read from the cassette recorder in register A is a carriage return.<p class="bold" style="margin-bottom:0px;">Notes:</p><ul><li>0DH is a <kbd>ENTER</kbd> in ASCII</li><li>A CP will return Z if there is a match against Register A, and NZ if not a match against Register A.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>21B9-21BA</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#21BD" class="memory-link">JR Z,21BDH</a></div><div>Jump out of this routine if the character read from the cassette recorder in register A is a carriage return.</div></div>
									<div class="assembly-row-combined model1"><div>21BB-21BC</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#21B2" class="memory-link">DJNZ 21B2H</a></div><div>Loop back to 21B2H until the input buffer is full.</div></div>
									<div class="assembly-row-combined model1" id="21BD"><div>21BD</div><div>DEC HL</div><div>Decrement the value of the input buffer pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>21BE-21BF</div><div>LD (HL),00H</div><div>Save a zero at the location of the input buffer pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>21C0-21C2</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#01F8" class="memory-link">CALL 01F8H</a></div><div>GOSUB to 01F8H to put a 00H at the end of the tape and turn the cassette recorder off.</div></div>
									<div class="assembly-row-combined model1"><div>21C3-21C5</div><div>LD HL,(40A7H)</div><div>Load HL with the starting address of the input buffer.<br>Note: 40A7H-40A8H holds the input Buffer pointer.</div></div>
									<div class="assembly-row-combined model1"><div>21C6</div><div>DEC HL</div><div>Decrement the value of the input buffer pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>21C7-21C8</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#21EB" class="memory-link">JR 21EBH</a></div><div>Jump to 21EBH to store a comma there so we can use the READ processing.</div></div>
									<div class="assembly-row-combined model1" id="21DB"><div>21C9-21CB</div><div>LD BC,21DBH</div><div>Load BC with a return address of 21DBH.</div></div>
									<div class="assembly-row-combined model1"><div>21CC</div><div>PUSH BC</div><div>Save the value of the return address in BC to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>21CD-21CE</div><div>CP 22H</div><div>Check to see if the character at the location of the current BASIC program pointer in register A is a quote.<p class="bold" style="margin-bottom:0px;">Notes:</p><ul><li>22H is a <span class="code">"</span> in ASCII</li><li>A CP will return Z if there is a match against Register A, and NZ if not a match against Register A.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>21CF</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#21DB" class="memory-link">RET NZ</a></div><div>Return to 21DBH if the character at the location of the current BASIC program pointer in register A isn't a quote.</div></div>
									<div class="assembly-row-combined model1" id="21D0"><div>21D0-21D2</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2866" class="memory-link">CALL 2866H</a></div><div>Go set up pointers for the prompting message in the temporary string work area.</div></div>
									<div class="assembly-row-combined model1"><div>21D3-21D4</div><div>RST 08H ‚áí  3B</div><div>Since
 the character at the location of the current BASIC program pointer in 
HL must be a ";", call the COMPARE SYMBOL routine at RST 08H.<br><br><span class="bold nobottomborder">NOTE:</span>
 The RST 08H routine compares the symbol in the input string pointed to 
by HL register to the value in the location following the RST 08 call.<ul><li>If
 there is a match, control is returned to the next execution address 
(i.e, the RST 08H instruction + 2) with the next symbol in the A 
Register and HL incremented by one.</li><li>If the two characters do not match, a syntax error message is given and control returns to the Input Phase).</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>21D5</div><div>PUSH HL</div><div>Save the value of the current BASIC program pointer in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>21D6-21D8</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#28AA" class="memory-link">CALL 28AAH</a></div><div>Go display the prompting message.</div></div>
									<div class="assembly-row-combined model1"><div>21D9</div><div>POP HL</div><div>Restore the code string address (from the stack) into HL.</div></div>
									<div class="assembly-row-combined model1"><div>21DA</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#21DB" class="memory-link">RET</a></div><div>Return to 21DBH.</div></div>
									<div class="assembly-row-combined model1" id="21DB"><div>21DB</div><div>PUSH HL</div><div>Save the value of the current BASIC program pointer in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>21DC-21DE</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1BB3" class="memory-link">CALL 1BB3H</a></div><div>Print the <span class="code">? </span> prompt and get the input from the keyboard.</div></div>
									<div class="assembly-row-combined model1"><div>21DF</div><div>POP BC</div><div>Get the value of the current BASIC program pointer from the stack and put it in BC.</div></div>
									<div class="assembly-row-combined model1"><div>21E0-21E2</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1DBE" class="memory-link">JP C,1DBEH</a></div><div>Jump back to 1DBEH if the BREAK key was pressed.</div></div>
									<div class="assembly-row-combined model1"><div>21E3</div><div>INC HL</div><div>Bump the value of the input buffer pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>21E4</div><div>LD A,(HL)</div><div>Load register A with the character at the location of the input buffer pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>21E5</div><div>OR A</div><div>Test the value of the character at the location of the input buffer pointer in register A.</div></div>
									<div class="assembly-row-combined model1"><div>21E6</div><div>DEC HL</div><div>Decrement the value of the input buffer pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>21E7</div><div>PUSH BC</div><div>Save the value of the current BASIC program pointer in BC to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>21E8-21EA</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1F04" class="memory-link">JP Z,1F04H</a></div><div>Jump if the character at the location of the input buffer pointer in register A is an end of the input character.</div></div>
									<div class="assembly-row-combined model1"><div>21EB-21EC</div><div>LD (HL),2CH</div><div>Save a comma at the location of the current input buffer pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>21ED-21EE</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#21F4" class="memory-link">JR 21F4H</a></div><div>Jump to 21F4H (which address uses a Z-80 trick).</div></div>
								</div>
							</div>

							<br><h2 id="21ef-span">21EF - <span class="code">READ</span> logic<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>21EF</div><div>PUSH HL</div><div>Save the current BASIC program pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>21F0-21F2</div><div>LD HL,(40FFH)</div><div>Load HL with the location of the last DATA statement read.<br>Note: 40FFH-4100H holds <span class="code">READ</span> pointer.</div></div>
									<div class="assembly-row-combined model1"><div>21F3-21F4</div><div>OR AFH</div><div>Set register A to a non-zero value if entered from the <span class="code">READ</span> routine and zero if entered from the <span class="code">INPUT</span> routine.</div></div>
									<div class="assembly-row-combined model1"><div>21F5-21F7</div><div>LD (40DEH),A</div><div>Save the value of the input type flag in register A.<br>Note: 40DEH holds READ flag.</div></div>
									<div class="assembly-row-combined model1"><div>21F8</div><div>EX (SP),HL</div><div>Exchange the start of the input pointer in HL with the current BASIC program pointer to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>21F9-21FA</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#21FD" class="memory-link">JR 21FDH</a></div><div>Skip over the next instruction.</div></div>
									<div class="assembly-row-combined model1"><div>21FB-21FC</div><div>RST 08H ‚áí  2C</div><div>Since the character at the location of the current BASIC program pointer in HL must be a <span class="code">,</span>, call the COMPARE SYMBOL at RST 08H.<br><br><span class="bold nobottomborder">NOTE:</span>
 The RST 08H routine compares the symbol in the input string pointed to 
by HL register to the value in the location following the RST 08 call.<ul><li>If
 there is a match, control is returned to the next execution address 
(i.e, the RST 08H instruction + 2) with the next symbol in the A 
Register and HL incremented by one.</li><li>If the two characters do not match, a syntax error message is given and control returns to the Input Phase).</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>21FD-21FF</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#260D" class="memory-link">CALL 260DH</a></div><div>Call
 the FIND ADDRESS OF VARIABLE routine at 260DH which searches the 
Variable List Table for a variable name which matches the name in the 
string pointed to in HL, and return the address of that variable in DE 
(and if there is no variable, it creates it, zeroes it, and returns THAT
 location).</div></div>
									<div class="assembly-row-combined model1"><div>2200</div><div>EX (SP),HL</div><div>Exchange the value of the current BASIC program pointer in HL with the start of the input buffer pointer to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2201</div><div>PUSH DE</div><div>Save the variable's address in DE to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2202</div><div>LD A,(HL)</div><div>Load register A with the character at the location of the input buffer pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2203-2204</div><div>CP 2CH</div><div>Check to see if the character at the location of the input buffer pointer register A is a <span class="code">,</span>.<br><b>NOTE:</b> A <span class="code">CP</span> will return Z if there is a match against Register A, and NZ if not a match against Register A.</div></div>
									<div class="assembly-row-combined model1"><div>2205-2206</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#222D" class="memory-link">JR Z,222DH</a></div><div>Jump to 222DH if the character at the location of the input buffer pointer in register A is a <span class="code">,</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2207-2209</div><div>LD A,(40DEH)</div><div>Load register A with the input type flag.<br>Note: 40DEH holds READ flag.</div></div>
									<div class="assembly-row-combined model1"><div>220A</div><div>OR A</div><div>Check for READ or INPUT.</div></div>
									<div class="assembly-row-combined model1"><div>220B-220D</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2296" class="memory-link">JP NZ,2296H</a></div><div>Jump to 2296H if the input type flag in register A indicates READ.</div></div>
									<div class="assembly-row-combined model1"><div>220E-2210</div><div>LD A,(40A9H)</div><div>Load register A with the value of the cassette input flag.<br>Note: 40A9H holds Cassette input flag.</div></div>
									<div class="assembly-row-combined model1"><div>2211</div><div>OR A</div><div>Check to see if the input is from the cassette recorder.</div></div>
									<div class="assembly-row-combined model1"><div>2212-2213</div><div>LD E,06H</div><div>Load register E with an <span class="code">?OD ERROR</span> code.</div></div>
									<div class="assembly-row-combined model1"><div>2214-2216</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#19A2" class="memory-link">JP Z,19A2H</a></div><div>Go to the Level II BASIC error routine and display an <span class="code">?OD ERROR</span> message if the input is from the cassette recorder.</div></div>
									<div class="assembly-row-combined model1"><div>2217-2218</div><div>LD A,3FH</div><div>Load register A with a "?".</div></div>
									<div class="assembly-row-combined model1"><div>2219-221B</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#032A" class="memory-link">CALL 032AH</a></div><div>GOSUB
 to 032AH which is a general purpose output routine that outputs a byte 
from the A register to video, tape or printer (based on what is in 
409CH).</div></div>
									<div class="assembly-row-combined model1"><div>221C-221E</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1BB3" class="memory-link">CALL 1BB3H</a></div><div>Go get the keyboard input.</div></div>
									<div class="assembly-row-combined model1"><div>221F</div><div>POP DE</div><div>Get the address of the variable to be set from the stack and put it in DE.</div></div>
									<div class="assembly-row-combined model1"><div>2220</div><div>POP BC</div><div>Get the value of the current BASIC program pointer from the stack and put it in BC.</div></div>
									<div class="assembly-row-combined model1"><div>2221-2223</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1DBE" class="memory-link">JP C,1DBEH</a></div><div>Jump to 1DBEH if the BREAK key was pressed.</div></div>
									<div class="assembly-row-combined model1"><div>2224</div><div>INC HL</div><div>Bump the value of the input buffer pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2225</div><div>LD A,(HL)</div><div>Load register A with the character at the location of the input buffer pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2226</div><div>OR A</div><div>Check to see if the character at the location of the input buffer pointer in register A is an end of the input character.</div></div>
									<div class="assembly-row-combined model1"><div>2227</div><div>DEC HL</div><div>Decrement the value of the input buffer pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2228</div><div>PUSH BC</div><div>Save the value of the current BASIC program pointer in BC to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2229-222B</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1F04" class="memory-link">JP Z,1F04H</a></div><div>Jump if the character at the location of the input buffer pointer in register A is an end of the input character.</div></div>
									<div class="assembly-row-combined model1"><div>222C</div><div>PUSH DE</div><div>Save the variable's address in DE to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>222D-222F</div><div><a href="#41DC" class="memory-link">CALL 41DCH</a></div><div>Call the DOS link at 41DCH.<br>In NEWDOS 2.1, this is called during READ processing when a variable has been read.</div></div>
									<div class="assembly-row-combined model1"><div>2230</div><div>RST 20H</div><div>We need to check the value of the current number type flag, so we call the TEST DATA MODE routine at RST 20H.<br><span class="nobottomborder bold">NOTE:</span>
  The RST 20H routine determines the type of the current value in REG 1 
and returns a combination of STATUS flags and unique numeric values in 
the A Register according to the data mode flag (40AFH).<br><br>The results are returned as follows:<table style="border-collapse: collapse; border: 1px solid black;"><tbody><tr style="background-color: #f0f0f0;"><td style="border: 1px solid black; padding: 8px;">If the Variable Type is ...</td><td style="border: 1px solid black; padding: 8px;">and the Flags<br>are set ...</td><td style="border: 1px solid black; padding: 8px;">... then Register<br>A will be set ...</td></tr><tr><td style="border: 1px solid black; padding: 8px;">Integer</td><td style="border: 1px solid black; padding: 8px;">NZ/C/M/E</td><td style="border: 1px solid black; padding: 8px;">-1</td></tr><tr><td style="border: 1px solid black; padding: 8px;">String</td><td style="border: 1px solid black; padding: 8px;">Z/C/P/E</td><td style="border: 1px solid black; padding: 8px;">0</td></tr><tr><td style="border: 1px solid black; padding: 8px;">Single Precision</td><td style="border: 1px solid black; padding: 8px;">NZ/C/P/O</td><td style="border: 1px solid black; padding: 8px;">1</td></tr><tr><td style="border: 1px solid black; padding: 8px;">Double Precision</td><td style="border: 1px solid black; padding: 8px;">NZ/NC/P/E</td><td style="border: 1px solid black; padding: 8px;">5</td></tr></tbody></table></div></div>
									<div class="assembly-row-combined model1"><div>2231</div><div>PUSH AF</div><div>Save the number type of the variable to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2232-2233</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#224D" class="memory-link">JR NZ,224DH</a></div><div>If that test shows we do NOT have a STRING, jump to 224DH.</div></div>
									<div class="assembly-row-combined model1"><div>2234</div><div>RST 10H</div><div>We need the next character in the BASIC program so call the EXAMINE NEXT SYMBOL routine at RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The
 RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2235</div><div>LD D,A</div><div>Load register D with the character at the location of the input buffer pointer in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2236</div><div>LD B,A</div><div>Load register B with the character at the location of the input buffer pointer in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2237-2238</div><div>CP 22H</div><div>Check to see if the character at the location of the input buffer pointer in register A is a quote.<br><b>NOTE:</b> A <span class="code">CP</span> will return Z if there is a match against Register A, and NZ if not a match against Register A.</div></div>
									<div class="assembly-row-combined model1"><div>2230-223A</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2240" class="memory-link">JR Z,2240H</a></div><div>Jump to 2240H if the character at the location of the input buffer pointer in register A is a quote.</div></div>
									<div class="assembly-row-combined model1"><div>223B-223C</div><div>LD D,3AH</div><div>Load D with the character <span class="code">:</span>.</div></div>
									<div class="assembly-row-combined model1"><div>223D-223E</div><div>LD B,2CH</div><div>Load register B with the character <span class="code">,</span> (the scan character).</div></div>
									<div class="assembly-row-combined model1"><div>223F</div><div>DEC HL</div><div>Decrement the value of the input buffer pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2240-2242</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2869" class="memory-link">CALL 2869H</a></div><div>Go set up the pointers for the temporary string work area.</div></div>
									<div class="assembly-row-combined model1"><div>2243</div><div>POP AF</div><div>Get the number type for the variable from the stack and put it in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2244</div><div>EX DE,HL</div><div>Load DE with the value of the input buffer pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2245-2247</div><div>LD HL,225AH</div><div>Load HL with the value of the return address.</div></div>
									<div class="assembly-row-combined model1"><div>2248</div><div>EX (SP),HL</div><div>Exchange the value of the return address in HL with the value of the current BASIC program pointer to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2249</div><div>PUSH DE</div><div>Save the value of the input buffer pointer in DE to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>224A-224C</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1F33" class="memory-link">JP 1F33H</a></div><div>Go set the variable to the value of the string.</div></div>
									<div class="assembly-row-combined model1" id="224D"><div>224D</div><div>RST 10H</div><div>We need the next character in the BASIC program so call the EXAMINE NEXT SYMBOL routine at RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The
 RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>224E</div><div>POP AF</div><div>Load register A with the number type for the variable to be set.</div></div>
									<div class="assembly-row-combined model1"><div>224F</div><div>PUSH AF</div><div>Save the value in AF to the stack.</div></div>
									<div class="assembly-row-combined model1" id="2250"><div>2250-2252</div><div>LD BC,2243H</div><div>Load BC with the value of the return address.</div></div>
									<div class="assembly-row-combined model1"><div>2253</div><div>PUSH BC</div><div>Save the return address in BC to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2254-2256</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0E6C" class="memory-link">JP C,0E6CH</a></div><div>If
 the current number type is integer or single precision, call the ASCII 
TO BINARY routine at 0E6C (which converts the ASCII string pointed to by
 HL to binary with the result in REG 1 and the mode flag will have 
changed).</div></div>
									<div class="assembly-row-combined model1"><div>2257-2259</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0E65" class="memory-link">JP NC,0E65H</a></div><div>If the current number type is double precision, jump to the ASCII TO DOUBLE routine at 0E65H.<br><ul><li>NOTE: 0E65H converts the ASCII string pointed to by HL to its double precision equivalent; with output left in REG 1).</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>225A</div><div>DEC HL</div><div>Decrement the value of the input buffer pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>225B</div><div>RST 10H</div><div>We need the next character in the BASIC program so call the EXAMINE NEXT SYMBOL routine at RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The
 RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>225C-225D</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2263" class="memory-link">JR Z,2263H</a></div><div>Jump to 2263H if the character at the location of the input buffer pointer in HL is an end of the input character.</div></div>
									<div class="assembly-row-combined model1"><div>225E-225F</div><div>CP 2CH</div><div>Check to see if the character at the location of the input buffer pointer in register A is a comma.<br><b>NOTE:</b> A <span class="code">CP</span> will return Z if there is a match against Register A, and NZ if not a match against Register A.</div></div>
									<div class="assembly-row-combined model1"><div>2260-2262</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#217F" class="memory-link">JP NZ,217FH</a></div><div>Jump to 217FH if the character at the location of the input buffer pointer in register A isn't a comma.</div></div>
									<div class="assembly-row-combined model1"><div>2263</div><div>EX (SP),HL</div><div>Exchange the value of the input buffer pointer in HL with the value of the current BASIC program pointer to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2264</div><div>DEC HL</div><div>Decrement the value of the current BASIC program pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2265</div><div>RST 10H</div><div>We need the next character in the BASIC program so call the EXAMINE NEXT SYMBOL routine at RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The
 RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2266-2268</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#21FB" class="memory-link">JP NZ,21FBH</a></div><div>Go
 examine the next variable if the character at the location of the 
current BASIC program pointer in HL isn't an end of the BASIC statement 
character.</div></div>
									<div class="assembly-row-combined model1"><div>2269</div><div>POP DE</div><div>Clean up the stack.</div></div>
								</div>
							</div>

							<br><h2 id="226a-226e-for-rom">226A-226E - For ROM v1.2 - Replaced with NOPS<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>226F-2271</div><div>LD A,(40DEH)</div><div>Load register A with the value of the input type flag.<br>Note: 40DEH holds READ flag.</div></div>
									<div class="assembly-row-combined model1"><div>2272</div><div>OR A</div><div>Check to see if the input type is <span class="code">READ</span> or <span class="code">INPUT</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2273</div><div>EX DE,HL</div><div>Load DE with the value of the current BASIC program pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2274-2276</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1D96" class="memory-link">JP NZ,1D96H</a></div><div>Jump if the input type flag is set for READ .</div></div>
									<div class="assembly-row-combined model1"><div>2277</div><div>PUSH DE</div><div>Save the current BASIC program pointer in DE to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2278-227A</div><div><a href="#41DF" class="memory-link">CALL 41DFH</a></div><div>Call the DOS link at 41DFH.<br>In NEWDOS 2.1 this is called at the end of <span class="code">READ</span> processing.</div></div>
									<div class="assembly-row-combined model1"><div>227B</div><div>OR (HL)</div><div>Check to see if this is the end of the input.</div></div>
									<div class="assembly-row-combined model1"><div>227C-227E</div><div>LD HL,2286H</div><div>Load HL with the starting address of the <span class="code">?EXTRA IGNORED</span> message.</div></div>
									<div class="assembly-row-combined model1"><div>227F-2281</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#28A7" class="memory-link">CALL NZ,28A7H</a></div><div>We need to display the <span class="code">?EXTRA IGNORED</span> message, so we call the WRITE MESSAGE routine at 28A7H.<br><span class="bold">NOTE:</span><br><ul><li>The routine at 28A7 displays the message pointed to by HL on current system output device (usually video).</li><li>The string to be displayed must be terminated by a byte of machine zeros or a carriage return code 0D.</li><li>If terminated with a carriage return, control is returned to the caller after taking the DOS exit at 41D0H (JP 5B99H).</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2282</div><div>POP HL</div><div>Get the value of the current BASIC program pointer from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2283-2285</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2169" class="memory-link">JP 2169H</a></div><div>Go turn off the cassette recorder and return to the BASIC interpreter.</div></div>
								</div>
							</div>

							<br><h2 id="2286-2295-message">2286-2295 - MESSAGE STORAGE LOCATION<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2286-2295</div><div>"?Extra ignored"</div><div>The EXTRA IGNORED message is stored here.</div></div>
								</div>
							</div>

							<br><h2 id="2296-22b5-find-the">2296-22B5 - FIND THE NEXT DATA STATEMENT ROUTINE<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2296-2298</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1F05" class="memory-link">CALL 1F05H</a></div><div>Go find the next DATA statement.</div></div>
									<div class="assembly-row-combined model1"><div>2299</div><div>OR A</div><div>Check to see if this is the end of the BASIC line.</div></div>
									<div class="assembly-row-combined model1"><div>229A-229B</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#22AE" class="memory-link">JR NZ,22AEH</a></div><div>Jump to 22AEH if the BASIC statement is terminated with a <span class="code">:</span>.</div></div>
									<div class="assembly-row-combined model1"><div>229C</div><div>INC HL</div><div>Bump the value of the current BASIC program pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>229D</div><div>LD A,(HL)</div><div>Load register A with the LSB of the line address at the location of the current BASIC program pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>229E</div><div>INC HL</div><div>Bump the value of the current BASIC program pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>229F</div><div>OR (HL)</div><div>Combine
 the MSB of the line address at the location of the current BASIC 
program in HL with the LSB of the line address in register A.</div></div>
									<div class="assembly-row-combined model1"><div>22A0-22A1</div><div>LD E,06H</div><div>Load register E with an <span class="code">?OD ERROR</span> code.</div></div>
									<div class="assembly-row-combined model1"><div>22A2-22A4</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#19A2" class="memory-link">JP Z,19A2H</a></div><div>Go to the Level II BASIC error routine and display an OD ERROR message if this is the end of the BASIC program.</div></div>
									<div class="assembly-row-combined model1"><div>22A5</div><div>INC HL</div><div>Bump the value of the current BASIC program pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>22A6</div><div>LD E,(HL)</div><div>Load register E with the LSB of the BASIC line number at the location of the current BASIC program pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>22A7</div><div>INC HL</div><div>Bump the value of the current BASIC program pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>22A8</div><div>LD D,(HL)</div><div>Load register D with the MSB of the BASIC line number at the location of the current BASIC program pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>22A9</div><div>EX DE,HL</div><div>Exchange the value of the current BASIC program pointer in HL with the value of the BASIC line number in DE.</div></div>
									<div class="assembly-row-combined model1"><div>22AA-22AC</div><div>LD (40DAH),HL</div><div>Save the BASIC line number in HL.<br>Note: 40DAH-40DBH holds DATA line number.</div></div>
									<div class="assembly-row-combined model1"><div>22AD</div><div>EX DE,HL</div><div>Exchange the value of the current BASIC program pointer in DE with the value of the BASIC line number in HL.</div></div>
									<div class="assembly-row-combined model1"><div>22AE</div><div>RST 10H</div><div>We need the next character in the BASIC program so call the EXAMINE NEXT SYMBOL routine at RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The
 RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>22AF-22B0</div><div>CP 88H</div><div>Check to see if the character at the location of the current BASIC program pointer in register A is a DATA token.<br><b>NOTE:</b> A <span class="code">CP</span> will return Z if there is a match against Register A, and NZ if not a match against Register A.</div></div>
									<div class="assembly-row-combined model1"><div>22B1-22B2</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2296" class="memory-link">JR NZ,2296H</a></div><div>Jump
 to 2296H (=find the next DATA statement routine) if the character at 
the location of the current BASIC program pointer in register A isn't a 
DATA token.</div></div>
									<div class="assembly-row-combined model1"><div>22B3-22B5</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#222D" class="memory-link">JP 222DH</a></div><div>Now we know that the current BASIC program pointer is pointing to a DATA token, so jump to 222DH.</div></div>
								</div>
							</div>

							<br><h2 id="22b6-2336-level-ii">22B6-2336 - LEVEL II BASIC <span class="code">NEXT</span> ROUTINE<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>22B6-22B8</div><div>LD DE,0000H</div><div>Load DE with the default variable address.</div></div>
									<div class="assembly-row-combined model1"><div>22B9-22BB</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#260D" class="memory-link">CALL NZ,260DH</a></div><div>To see if there is a variable which follows the <span class="code">NEXT</span>
 token, call the FIND ADDRESS OF VARIABLE routine at 260DH which 
searches the Variable List Table for a variable name which matches the 
name in the string pointed to in HL, and return the address of that 
variable in DE (and if there is no variable, it creates it, zeroes it, 
and returns THAT location).</div></div>
									<div class="assembly-row-combined model1"><div>22BC-22BE</div><div>LD (40DFH),HL</div><div>Save the value of the current BASIC program pointer (contained in 40DFH) in HL.<br>Note: 40DFH-40E0H holds Used by DOS.</div></div>
									<div class="assembly-row-combined model1"><div>22BF-22C1</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1936" class="memory-link">CALL 1936H</a></div><div>Go search the stack for the appropriate FOR push.</div></div>
									<div class="assembly-row-combined model1"><div>22C2-22C4</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#199D" class="memory-link">JP NZ,199DH</a></div><div>Display a NF ERROR message if the appropriate FOR push wasn't found.</div></div>
									<div class="assembly-row-combined model1"><div>22C5</div><div>LD SP,HL</div><div>Load the stack pointer with the value of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>22C6-22C8</div><div>LD (40E8H),HL</div><div>Save the value in HL.<br>Note: 40E8H-40E9H holds Stack pointer pointer.</div></div>
									<div class="assembly-row-combined model1"><div>22C9</div><div>PUSH DE</div><div>Save the variable's address in DE to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>22CA</div><div>LD A,(HL)</div><div>Load register A with the value of the sign for the <span class="code">STEP</span> value.</div></div>
									<div class="assembly-row-combined model1"><div>22CB</div><div>INC HL</div><div>Bump the value of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>22CC</div><div>PUSH AF</div><div>Save the value of the sign for the <span class="code">STEP</span> value in register A to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>22CD</div><div>PUSH DE</div><div>Save the variable's address in DE to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>22CE</div><div>LD A,(HL)</div><div>Load register A with the number type flag for the <span class="code">STEP</span> value.</div></div>
									<div class="assembly-row-combined model1"><div>22CF</div><div>INC HL</div><div>Bump the value of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>22D0</div><div>OR A</div><div>Check the value of the number type flag for the <span class="code">STEP</span> flag in register A.</div></div>
									<div class="assembly-row-combined model1"><div>22D1-22D3</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#22EA" class="memory-link">JP M,22EAH</a></div><div>Jump to 22EAH if the <span class="code">STEP</span> value is an integer.</div></div>
									<div class="assembly-row-combined model1"><div>22D4-22D6</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#09B1" class="memory-link">CALL 09B1H</a></div><div>Call 09B1H (which moves a SINGLE PRECISION number pointed to by HL to REG 1).</div></div>
									<div class="assembly-row-combined model1"><div>22D7</div><div>EX (SP),HL</div><div>Exchange the value of the variable's address to the stack with the value of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>22D8</div><div>PUSH HL</div><div>Save the value of the variable's address in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>22D9-22DB</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#070B" class="memory-link">CALL 070BH</a></div><div>Go add the sin le precision value at the location of the memory pomter in HL to the single precision <span class="code">STEP</span> value in register pairs BC and DE. Return with the result in REG 1.</div></div>
									<div class="assembly-row-combined model1"><div>22DC</div><div>POP HL</div><div>Get the value of the variable's address from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>22DD-22DF</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#09CB" class="memory-link">CALL 09CBH</a></div><div>Go move the single precision result from REG 1 to the variable's address in HL.</div></div>
									<div class="assembly-row-combined model1"><div>22E0</div><div>POP HL</div><div>Get the value of the memory pointer from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>22E1-22E3</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#09C2" class="memory-link">CALL 09C2H</a></div><div>Call 09C2H (which loads a SINGLE PRECISION value pointed to by HL into register pairs BC and DE).</div></div>
									<div class="assembly-row-combined model1"><div>22E4</div><div>PUSH HL</div><div>Save the value of the memory pointer in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>22E5-22E7</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0A0C" class="memory-link">CALL 0A0CH</a></div><div>Call the SINGLE PRECISION COMPARISON routine at 0A0CH.<br><br><span class="nobottomborder bold">NOTE:</span>  The routine at 0A0CH algebraically compares the single precision value in BC/DE to the single precision value REG 1.<br>The results are stored in A as follows:<ul><li>A=0 if REG 1 = BCDE</li><li>A=1 if REG 1&gt;BCDE; and </li><li>A=FFH if REG 1&lt;BCDE.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>22E8-22E9</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2313" class="memory-link">JR 2313H</a></div><div>Jump forward to to 2313H.</div></div>
									<div class="assembly-row-combined model1"><div>22EA</div><div>INC HL</div><div>We need to backspace the stack by 4 bytes to skip over the area which would hold the single precision <span class="code">TO</span> value to do this we have to bump the value of the memory pointer in HL 4 times.</div></div>
									<div class="assembly-row-combined model1"><div>22EB</div><div>INC HL</div><div>Bump the value of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>22EC</div><div>INC HL</div><div>Bump the value of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>22ED</div><div>INC HL</div><div>Bump the value of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>22EE</div><div>LD C,(HL)</div><div>Load register C with the LSB of the <span class="code">STEP</span> value (held at the location of the memory pointer in HL).</div></div>
									<div class="assembly-row-combined model1"><div>22EF</div><div>INC HL</div><div>Bump the value of the memory pointer in HL to be the MSB of the <span class="code">STEP</span> value.</div></div>
									<div class="assembly-row-combined model1"><div>22F0</div><div>LD B,(HL)</div><div>Load register B with the MSB of the <span class="code">STEP</span> value at the location of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>22F1</div><div>INC HL</div><div>Bump the value of the memory pointer in HL so that it is the stack address of the <span class="code">TO</span> limit.</div></div>
									<div class="assembly-row-combined model1"><div>22F2</div><div>EX (SP),HL</div><div>Exchange
 HL and the value of the stack pointer so that HL will have the address 
of the index and the value at the stack pointer will have the ending 
address of the <span class="code">TO</span> limit.</div></div>
									<div class="assembly-row-combined model1"><div>22F3</div><div>LD E,(HL)</div><div>Load register E with the LSB of the index.</div></div>
									<div class="assembly-row-combined model1"><div>22F4</div><div>INC HL</div><div>Bump the value of the memory pointer in HL to point to the MSB of the index.</div></div>
									<div class="assembly-row-combined model1"><div>22F5</div><div>LD D,(HL)</div><div>Load register D with the MSB of the index.</div></div>
									<div class="assembly-row-combined model1"><div>22F6</div><div>PUSH HL</div><div>Save the value of the memory pointer in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>22F7</div><div>LD L,C</div><div>Load register L with the LSB of the <span class="code">STEP</span> value in register C.</div></div>
									<div class="assembly-row-combined model1"><div>22F8</div><div>LD H,B</div><div>Load register H with the MSB of the <span class="code">STEP</span> value in register B.</div></div>
									<div class="assembly-row-combined model1"><div>22F9-22FB</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0BD2" class="memory-link">CALL 0BD2H</a></div><div>With the <span class="code">STEP</span>
 value in HL, call the INTEGER ADD routine at 0BD2H (which adds the 
integer value in DE to the integer in HL. The sum is left in HL and the 
orginal contents of DE are preserved. If overflow occurs (sum exceeds 
2**15), both values are converted to single precision and then added. 
The result would be left in REG 1 and the mode flag would be updated).</div></div>
									<div class="assembly-row-combined model1"><div>22FC-22FE</div><div>LD A,(40AFH)</div><div>Load register A with the current value of the data type flag.<br>Note: 40AFH holds Current number type flag.</div></div>
									<div class="assembly-row-combined model1"><div>22FF</div><div>CP 04H</div><div>Check to see if the current value in REG 1 is single precision.<br><b>NOTE:</b> A <span class="code">CP</span> will return Z if there is a match against Register A, and NZ if not a match against Register A.</div></div>
									<div class="assembly-row-combined model1"><div>2301-2303</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#07B2" class="memory-link">JP Z,07B2H</a></div><div>Show an <span class="code">?OV ERROR</span> message if the current value in REG 1 is single precision.</div></div>
									<div class="assembly-row-combined model1"><div>2304</div><div>EX DE,HL</div><div>Load DE with the index as an integer (from HL).</div></div>
									<div class="assembly-row-combined model1"><div>2305</div><div>POP HL</div><div>Restore the address of the index in the variable area to HL.</div></div>
									<div class="assembly-row-combined model1"><div>2306</div><div>LD (HL),D</div><div>Save the MSB of the result in register D at the location of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2307</div><div>DEC HL</div><div>Decrement the value of the memory pointer in reg? ister pair HL.</div></div>
									<div class="assembly-row-combined model1"><div>2308</div><div>LD (HL),E</div><div>Save the LSB of the result in register E at the location of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2309</div><div>POP HL</div><div>Restore the address of the <span class="code">TO</span> value in the <span class="code">FOR</span> statement to HL.</div></div>
									<div class="assembly-row-combined model1"><div>230A</div><div>PUSH DE</div><div>Save the index in DE to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>230B</div><div>LD E,(HL)</div><div>Load register E with the LSB of the <span class="code">TO</span> value at the location of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>230C</div><div>INC HL</div><div>Bump the value of the memory pointer in HL to point to the MSB of the <span class="code">TO</span> value.</div></div>
									<div class="assembly-row-combined model1"><div>230D</div><div>LD D,(HL)</div><div>Load register D with the MSB of the <span class="code">TO</span> value at the location of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>230E</div><div>INC HL</div><div>Bump the value of the memory pointer in HL so now it points to the line number.</div></div>
									<div class="assembly-row-combined model1"><div>230F</div><div>EX (SP),HL</div><div>Swap the <span class="code">TO</span> value at the memory location pointed to by the stack with the address of the binary line number for the <span class="code">FOR</span> statement (now in HL).</div></div>
									<div class="assembly-row-combined model1"><div>2310-2312</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0A39" class="memory-link">CALL 0A39H</a></div><div>We
 need to compare the new index to the limit so we call the INTEGER 
COMPARISON routine at 0A39H (which algebraically compares two integer 
values in DE and HL. The contents of DE and HL are left intact. The 
result of the comparison is left in the A register and status register 
as:<br> If DE &gt; HL then A will be -1;<br> If DE &lt; HL then A will b +1; and<br> If DE = HL then A will be 0.</div></div>
									<div class="assembly-row-combined model1" id="2313"><div>2313</div><div>POP HL</div><div>Restore the address of the binary line number of the <span class="code">FOR</span> statement back into HL.</div></div>
									<div class="assembly-row-combined model1"><div>2314</div><div>POP BC</div><div>Get the value of the sign from the stack and put it in BC.</div></div>
									<div class="assembly-row-combined model1"><div>2315</div><div>SUB B</div><div>We
 need to see if the sign is the sign we expected so we subtract the 
value of the sign in register B from the value in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2316-2318</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#09C2" class="memory-link">CALL 09C2H</a></div><div>Call 09C2H (which loads a SINGLE PRECISION value pointed to by HL into register pairs BC and DE).</div></div>
									<div class="assembly-row-combined model1"><div>2319-231A</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2324" class="memory-link">JR Z,2324H</a></div><div>Jump to 2324H if the index does not equal the <span class="code">TO</span> limit (meaning the FOR ... NEXT loop has not been completed).</div></div>
									<div class="assembly-row-combined model1"><div>231B</div><div>EX DE,HL</div><div>Load HL with the BASIC line number of the <span class="code">FOR</span> statement in DE.</div></div>
									<div class="assembly-row-combined model1"><div>231C-231E</div><div>LD (40A2H),HL</div><div>Save the BASIC line number in HL as the current BASIC line number.<br><b>NOTE:</b>40A2H-40A3H holds the current BASIC line number.</div></div>
									<div class="assembly-row-combined model1"><div>231F</div><div>LD L,C</div><div>Load register L with the LSB of the current BASIC program pointer in register C.</div></div>
									<div class="assembly-row-combined model1"><div>2320</div><div>LD H,B</div><div>Load register H with the MSB of the current BASIC program pointer in register B.</div></div>
									<div class="assembly-row-combined model1"><div>2321-2323</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1D1A" class="memory-link">JP 1D1AH</a></div><div>Jump to 1D1AH to continue execution and restore the <span class="code">FOR</span> token and GAP for FOR</div></div>
									<div class="assembly-row-combined model1"><div>2324</div><div>LD SP,HL</div><div>Restore the stack pointer - Start of expression evaluation</div></div>
									<div class="assembly-row-combined model1"><div>2325-2327</div><div>LD (40E8H),HL</div><div>Load HL with the value of the current BASIC program pointer.<br>Note: 40E8H-40E9H holds Stack pointer pointer.</div></div>
									<div class="assembly-row-combined model1"><div>2328-232A</div><div>LD HL,(40DFH)</div><div>Save the value of the current BASIC program pointer in HL.<br>Note: 40DFH-40E0H holds Used by DOS.</div></div>
									<div class="assembly-row-combined model1"><div>232B</div><div>LD A,(HL)</div><div>Load register A with the next token (i.e., the character at the location of the current BASIC program pointer in HL).</div></div>
									<div class="assembly-row-combined model1"><div>232C-232D</div><div>CP 2CH</div><div>Check to see if the character at the location of the current BASIC program pointer in register A is a <span class="code">,</span>.<br><b>NOTE:</b> A <span class="code">CP</span> will return Z if there is a match against Register A, and NZ if not a match against Register A.</div></div>
									<div class="assembly-row-combined model1"><div>232E-2330</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1D1E" class="memory-link">JP NZ,1D1EH</a></div><div>Jump back to 1D1EH if the character at the location of the current BASIC program pointer in register A isn't a <span class="code">,</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2331</div><div>RST 10H</div><div>We need the next character in the BASIC program so call the EXAMINE NEXT SYMBOL routine at RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The
 RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2332-2334</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#22B9" class="memory-link">CALL 22B9H</a></div><div>GOSUB to 22B9H to process <span class="code">NEXT</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2335</div><div>RST 08H ‚áí  28</div><div>Since the character at the location of the current BASIC program pointer in HL must be a <span class="code">(</span>, call the COMPARE SYMBOL routine at RST 08H.<br><br><span class="bold nobottomborder">NOTE:</span>
 The RST 08H routine compares the symbol in the input string pointed to 
by HL register to the value in the location following the RST 08 call.<ul><li>If
 there is a match, control is returned to the next execution address 
(i.e, the RST 08H instruction + 2) with the next symbol in the A 
Register and HL incremented by one.</li><li>If the two characters do not match, a syntax error message is given and control returns to the Input Phase).</li></ul></div></div>
								</div>
							</div>

							<br><h2 id="2337-27c8-evaluate">2337-27C8 - EVALUATE EXPRESSION<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<p>This routine evaluates a BASIC expression pointed to by the 
HL and stores the result in the ACC. The expression must be terminated 
with zero byte, comma, right bracket or colon. After execution, HL will 
point to the delimiter and, in the case of string expressions, the ACC 
will contain the address of the first of three bytes that contain string
 length and string address. Note that the stack is used frequently and 
the machine should be formatted for RUN mode in order to use this 
routine.</p>
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2337</div><div>DEC HL</div><div>Decrement the value of the current BASIC program pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2338-2339</div><div>LD D,00H</div><div>Load register D with zero.</div></div>
									<div class="assembly-row-combined model1"><div>233A</div><div>PUSH DE</div><div>Save the value in DE to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>233B-233C</div><div>LD C,01H</div><div>Load register C with the number of bytes of memory required.</div></div>
									<div class="assembly-row-combined model1"><div>233D-233F</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1963" class="memory-link">CALL 1963H</a></div><div>Go do a memory check.</div></div>
									<div class="assembly-row-combined model1"><div>2340-2342</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#249F" class="memory-link">CALL 249FH</a></div><div>Go get the value of the next part of the expression at the location of the current BASIC program pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2343-2345</div><div>LD (40F3H),HL</div><div>Save the value of the current BASIC program pointer (i.e., the next token) in HL.<br>Note: 40F3H-40F4H holds temporary storage location.</div></div>
									<div class="assembly-row-combined model1"><div>2346-2348</div><div>LD HL,(40F3H)</div><div>Load HL with the value of the current BASIC program pointer.<br>Note: 40F3H-40F4H holds temporary storage location.</div></div>
									<div class="assembly-row-combined model1"><div>2349</div><div>POP BC</div><div>Get the last precedence value from the stack and put it in BC.</div></div>
									<div class="assembly-row-combined model1"><div>234A</div><div>LD A,(HL)</div><div>Load register A with the character at the location of the current BASIC program pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>234B-234C</div><div>LD D,00H</div><div>Load register D with zero.</div></div>
									<div class="assembly-row-combined model1"><div>234D-234E</div><div>SUB D4H</div><div>Check
 to see if the character at the location of the current BASIC program 
pointer in register A is an arithmetic or logical token (by subtracting 
212 from it).</div></div>
									<div class="assembly-row-combined model1" id="234F"><div>234F-2350</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2364" class="memory-link">JR C,2364H</a></div><div>Jump to 2364H if the character at the location of the current BASIC program pointer in register A is <span class="code">+</span>, <span class="code">-</span>, <span class="code">*</span>, <span class="code">/</span>, <span class="code">?</span>, <span class="code">AND</span> or <span class="code">OR</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2351-2352</div><div>CP 03H</div><div>Check to see if the character at the location of the current BASIC program pointer in register A is a <span class="code">&gt;</span>, <span class="code">=</span>, or <span class="code">&lt;</span>.<br><b>NOTE:</b> A <span class="code">CP</span> will return Z if there is a match against Register A, and NZ if not a match against Register A.</div></div>
									<div class="assembly-row-combined model1" id="2353"><div>2353-2354</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2364" class="memory-link">JR NC,2364H</a></div><div>Jump if the character at the location of the current BASIC program pointer in register A isn't a <span class="code">&gt;</span>, <span class="code">=</span>, or <span class="code">&lt;</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2355-2356</div><div>CP 01H</div><div>Set the Carry flag if <span class="code">&gt;</span>. Then test for <span class="code">&lt;=</span> or <span class="code">&gt;=</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2357</div><div>RLA</div><div>Adjust the value in register A to give <span class="code">&gt;</span> as 1, <span class="code">=</span> as 2, or <span class="code">&lt;</span> as 4.</div></div>
									<div class="assembly-row-combined model1"><div>2358</div><div>XOR D</div><div>Combine the current value in register A with the value of the last token examined to see if this is a legal combination of <span class="code">&lt;=</span> or <span class="code">=&gt;</span> or illegal combination of <span class="code">&lt;&lt;</span>, <span class="code">==</span>, or <span class="code">&gt;&gt;</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2359</div><div>CP D</div><div>Check for an illegal combination of operators.</div></div>
									<div class="assembly-row-combined model1"><div>235A</div><div>LD D,A</div><div>Load register D with the value in register A.</div></div>
									<div class="assembly-row-combined model1"><div>235B-235D</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1997" class="memory-link">JP C,1997H</a></div><div>Display a <span class="code">?SN ERROR</span> if this is an illegal combination of operators.</div></div>
									<div class="assembly-row-combined model1"><div>235E-2360</div><div>LD (40D8H),HL</div><div>Save the address of the <span class="code">&gt;</span>, <span class="code">=</span>, or <span class="code">&lt;</span> token (held in HL) to 40D8H.<br>Note: 40D8H-40D9H holds Temporary storage location.</div></div>
									<div class="assembly-row-combined model1"><div>2361</div><div>RST 10H</div><div>We need the next token so call the EXAMINE NEXT SYMBOL routine at RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The
 RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2362-2363</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#234D" class="memory-link">JR 234DH</a></div><div>Jump back to 234DH.</div></div>
									<div class="assembly-row-combined model1"><div>2364</div><div>LD A,D</div><div>Load register A with the value of the operator in register D.</div></div>
									<div class="assembly-row-combined model1"><div>2365</div><div>OR A</div><div>Test the value of the operator in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2366-2368</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#23EC" class="memory-link">JP NZ,23ECH</a></div><div>Jump if the operator in register A is <span class="code">&gt;</span>, <span class="code">=</span>, or <span class="code">&lt;</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2369</div><div>LD A,(HL)</div><div>Load register A with the character at the location of the current BASIC program pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>236A-236C</div><div>LD (40D8H),HL</div><div>Save the address of the current BASIC program pointer in HL (which is an arithmetic operator) to 40D8H.<br>Note: 40D8H-40D9H holds Temporary storage location.</div></div>
									<div class="assembly-row-combined model1"><div>236D-236E</div><div>SUB 0CDH</div><div>Check to see if the operator at the location of the current BASIC program pointer in register A is an arithmetic token.</div></div>
									<div class="assembly-row-combined model1"><div>236F</div><div>RET C</div><div>Return if the character at the location of the current BASIC program pointer in register A isn't an arithmetic token.</div></div>
									<div class="assembly-row-combined model1" id="2370"><div>2370-2371</div><div>CP 07H</div><div>Check to see if the character at the location of the current BASIC program pointer in register A is a <span class="code">+</span> to <span class="code">OR</span> token.</div></div>
									<div class="assembly-row-combined model1"><div>2372</div><div>RET NC</div><div>Return if the character at the location of the current BASIC program pointer in register A isn't a <span class="code">+</span> to <span class="code">OR</span> token.</div></div>
									<div class="assembly-row-combined model1" id="2373"><div>2373</div><div>LD E,A</div><div>Load register E with the operator value in register A (which would be between 0 and 7).<br> E&nbsp;&nbsp;&nbsp;Token<br> 0&nbsp;&nbsp;&nbsp;<span class="code">+</span><br> 1&nbsp;&nbsp;&nbsp;<span class="code">-</span><br> 2&nbsp;&nbsp;&nbsp;<span class="code">*</span><br> 3&nbsp;&nbsp;&nbsp;<span class="code">/</span><br> 4&nbsp;&nbsp;&nbsp;<span class="code">@@</span><br> 5&nbsp;&nbsp;&nbsp;<span class="code">AND</span><br> 6&nbsp;&nbsp;&nbsp;<span class="code">OR</span></div></div>
									<div class="assembly-row-combined model1"><div>2374-2376</div><div>LD A,(40AFH)</div><div>Load register A with the current value of the number type flag.<br>Note: 40AFH holds Current number type flag.</div></div>
								</div>
							</div>

							<br><h2 id="2377-print-logic">2377 - PRINT @ logic.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2377-2378</div><div>SUB 03H</div><div>Adjust
 the value of the number type flag to get a -1 if integer, 0 for a 
string, 1 for single precision, and 5 for double precision.</div></div>
									<div class="assembly-row-combined model1"><div>2379</div><div>OR E</div><div>Combine the operator value in register E with the adjusted number type flag in register A.</div></div>
									<div class="assembly-row-combined model1"><div>237A-237C</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#298F" class="memory-link">JP Z,298FH</a></div><div>Jump
 down to 298FH if the combination of the adjusted number type flag in 
register A and the operator value in register E indicates string 
addition.</div></div>
									<div class="assembly-row-combined model1"><div>237D-237F</div><div>LD HL,189AH</div><div>Load HL with the starting address of the table of precedence operator values.</div></div>
									<div class="assembly-row-combined model1"><div>2380</div><div>ADD HL,DE</div><div>Add the value of the operator in DE to the table of precedence values pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2381</div><div>LD A,B</div><div>Load register A with the precedence value for the last operator in register B.</div></div>
									<div class="assembly-row-combined model1"><div>2382</div><div>LD D,(HL)</div><div>Load register D with the precedence value for the current operator.</div></div>
									<div class="assembly-row-combined model1"><div>2383</div><div>CP D</div><div>Compare
 the precedence value for the current operator in register D with the 
precedence value for the last operator in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2384</div><div>RET NC</div><div>Return
 out of this routine if the precedence value for the current operator in
 register D is greater than the precedence value for the last operator 
in register A.</div></div>
									<div class="assembly-row-combined model1" id="2385"><div>2385</div><div>PUSH BC</div><div>Save the precedence value and the token for the last operator in BC to the stack.</div></div>
									<div class="assembly-row-combined model1" id="2346"><div>2386-2388</div><div>LD BC,2346H</div><div>Load BC with the return address in case there is a break in precedence.</div></div>
									<div class="assembly-row-combined model1"><div>2389</div><div>PUSH BC</div><div>Save the return address in BC to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>238A</div><div>LD A,D</div><div>Load register A with the precedence value for the current operator in register D.</div></div>
									<div class="assembly-row-combined model1"><div>238B-238C</div><div>CP 7FH</div><div>Check to see if the precedence value for the current operator in register A indicates an exponential operator.</div></div>
									<div class="assembly-row-combined model1"><div>238D-238F</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#23D4" class="memory-link">JP Z,23D4H</a></div><div>Jump down to 23D4H if the precedence value for the current operator in register A indicates an exponential operator.</div></div>
									<div class="assembly-row-combined model1"><div>2390-2391</div><div>CP 51H</div><div>Check to see if the precedence value for the current operator in register A indicates a logical operator.</div></div>
									<div class="assembly-row-combined model1" id="23E1"><div>2392-2394</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#23E1" class="memory-link">JP C,23E1H</a></div><div>Jump if the precedence value for the current operator in register A indicates a logical operator.</div></div>
									<div class="assembly-row-combined model1"><div>2395-2397</div><div>LD HL,4121H</div><div>Load HL with the address of REG 1.</div></div>
									<div class="assembly-row-combined model1"><div>2398</div><div>OR A</div><div>Clear the flags.</div></div>
									<div class="assembly-row-combined model1"><div>2399-239B</div><div>LD A,(40AFH)</div><div>Load register A with the current value of the number type flag.<br>Note: 40AFH holds Current number type flag.</div></div>
									<div class="assembly-row-combined model1"><div>239C</div><div>DEC A</div><div>Adjust the current number type flag in register A.</div></div>
									<div class="assembly-row-combined model1"><div>239D</div><div>DEC A</div><div>Adjust the current number type flag in register A.</div></div>
									<div class="assembly-row-combined model1"><div>239E</div><div>DEC A</div><div>Adjust the current number type flag in register A. Now A will be -1=Integer, 0=String, 1=Single Precision, 5=Double Precision</div></div>
									<div class="assembly-row-combined model1"><div>239F-23A1</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0AF6" class="memory-link">JP Z,0AF6H</a></div><div>Display a <span class="code">?TM ERROR</span> if the current value in REG 1 is a string.</div></div>
									<div class="assembly-row-combined model1"><div>23A2</div><div>LD C,(HL)</div><div>Get the value at the location of the memory pointer in HL and put it in register C.</div></div>
									<div class="assembly-row-combined model1"><div>23A3</div><div>INC HL</div><div>Bump the value of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>23A4</div><div>LD B,(HL)</div><div>Load register B with the value at the location of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>23A5</div><div>PUSH BC</div><div>Save the value in BC to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>23A6-23A8</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#23C5" class="memory-link">JP M,23C5H</a></div><div>Jump down to 23C5H if the current number type is an integer.</div></div>
									<div class="assembly-row-combined model1"><div>23A9</div><div>INC HL</div><div>It's not an integer, so lets get the rest of the value by bumping the value of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>23AA</div><div>LD C,(HL)</div><div>Load register C with the value at the location of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>23AB</div><div>INC HL</div><div>Bump the value of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>23AC</div><div>LD B,(HL)</div><div>Load register B with the value at the location of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>23AD</div><div>PUSH BC</div><div>Save the value in BC (the rest of the digit) to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>23AE</div><div>PUSH AF</div><div>Save the value in AF (the type - 3) to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>23AF</div><div>OR A</div><div>Reset the status flags so that we can test if the current number type is double precision.</div></div>
									<div class="assembly-row-combined model1"><div>23B0-23B2</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#23C4" class="memory-link">JP PO,23C4H</a></div><div>Jump down to 23C4H if the current number type is single precision.</div></div>
									<div class="assembly-row-combined model1"><div>23B3</div><div>POP AF</div><div>Clear the stack.</div></div>
									<div class="assembly-row-combined model1"><div>23B4</div><div>INC HL</div><div>Bump the value of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1" id="23B5"><div>23B5-23B6</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#23BA" class="memory-link">JR C,23BAH</a></div><div>Skip the next instruction if the current number type is single precision.</div></div>
									<div class="assembly-row-combined model1"><div>23B7-23B9</div><div>LD HL,411DH</div><div>Reset HL to start of REG 1.<br>Note: 411DH-4124H holds REG l.</div></div>
									<div class="assembly-row-combined model1"><div>23BA</div><div>LD C,(HL)</div><div>Load register C with the rest of the double precision value (held at the location of the memory pointer in HL).</div></div>
									<div class="assembly-row-combined model1"><div>23BB</div><div>INC HL</div><div>Bump the value of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>23BC</div><div>LD B,(HL)</div><div>Load register B with the next digit LSB (at the location of the memory pointer in HL).</div></div>
									<div class="assembly-row-combined model1"><div>23BD</div><div>INC HL</div><div>Bump the value of the memory pointer in HL to the next digit.</div></div>
									<div class="assembly-row-combined model1"><div>23BE</div><div>PUSH BC</div><div>Save the LSB/NMSB of the double precision value (held in BC) to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>23BF</div><div>LD C,(HL)</div><div>Load register C with the value at the location of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>23C0</div><div>INC HL</div><div>Bump the value of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>23C1</div><div>LD B,(HL)</div><div>Load register B with the value at the location of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>23C2</div><div>PUSH BC</div><div>Save the value in BC to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>23C3</div><div>LD B,0F1H<br>06 F1</div><div>Z-80 Trick to nullify the next opcode if passing through.</div></div>
									<div class="assembly-row-combined model1"><div>23C4</div><div>POP AF</div><div>Clear the type -3 and the status push.</div></div>
									<div class="assembly-row-combined model1" id="23C5"><div>23C5-23C6</div><div>ADD A,03H</div><div>Adjust the number type in register A up 3.</div></div>
									<div class="assembly-row-combined model1"><div>23C7</div><div>LD C,E</div><div>Load register C with the value of the current operator token in register E (0-7).</div></div>
									<div class="assembly-row-combined model1"><div>23C8</div><div>LD B,A</div><div>Load register B with the number type flag in register A.</div></div>
									<div class="assembly-row-combined model1"><div>23C9</div><div>PUSH BC</div><div>Save the value in BC to the stack.</div></div>
									<div class="assembly-row-combined model1" id="23CA"><div>23CA-23CC</div><div>LD BC,2406H</div><div>Load BC with the return address of 2406H.</div></div>
									<div class="assembly-row-combined model1"><div>23CD</div><div>PUSH BC</div><div>Save the return address in BC to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>23CE-23D0</div><div>LD HL,(40D8H)</div><div>Load HL with the value of the current BASIC program pointer.<br>Note: 40D8H-40D9H holds Temporary storage location.</div></div>
									<div class="assembly-row-combined model1"><div>23D1-23D3</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#233A" class="memory-link">JP 233AH</a></div><div>Jump back to 233AH.</div></div>
									<div class="assembly-row-combined model1"><div>23D4-23D6</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0AB1" class="memory-link">CALL 0AB1H</a></div><div>Call
 the CONVERT TO SINGLE PRECISION routine at 0AB1H (which converts the 
contents of REG 1 from integer or double precision into single 
precision).</div></div>
									<div class="assembly-row-combined model1"><div>23D7-23D9</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#09A4" class="memory-link">CALL 09A4H</a></div><div>Call 09A4 which moves the SINGLE PRECISION value in REG 1 to the stack (stored in LSB/MSB/Exponent order).</div></div>
									<div class="assembly-row-combined model1"><div>23DA-23DC</div><div>LD BC,13F2H</div><div>Load BC with the address of the exponential X<span class="code">^</span>Y routine at 13F2H.</div></div>
									<div class="assembly-row-combined model1"><div>23DD-23DE</div><div>LD D,7FH</div><div>Load register D with the precedence value for an exponential operator.</div></div>
									<div class="assembly-row-combined model1"><div>23DF-23E0</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#23CD" class="memory-link">JR 23CDH</a></div><div>Jump back to 23CDH to continue expression evaluation.</div></div>
									<div class="assembly-row-combined model1"><div>23E1</div><div>PUSH DE</div><div>Save the precedence value and the operator token in DE to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>23E2-23E4</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0A7F" class="memory-link">CALL 0A7FH</a></div><div>Call
 the CONVERT TO INTEGER routine at 0A7FH (where the contents of REG 1 
are converted from single or double precision to integer and deposited 
into HL).</div></div>
									<div class="assembly-row-combined model1"><div>23E5</div><div>POP DE</div><div>Get the precedence value and the operator token from the stack and put it in DE.</div></div>
									<div class="assembly-row-combined model1"><div>23E6</div><div>PUSH HL</div><div>Save the integer value in HL to the stack.</div></div>
									<div class="assembly-row-combined model1" id="23E7"><div>23E7-23E9</div><div>LD BC,25E9H</div><div>Load BC with a return address of 25E9H.</div></div>
									<div class="assembly-row-combined model1"><div>23EA-23EB</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#23CD" class="memory-link">JR 23CDH</a></div><div>Jump back to 23CDH to continue the syntax analysis.</div></div>
									<div class="assembly-row-combined model1"><div>23EC</div><div>LD A,B</div><div>Load register A with the precedence value for the last operator in register B.</div></div>
									<div class="assembly-row-combined model1"><div>23ED-23EE</div><div>CP 64H</div><div>Check to see if the last operator was a logical operator.</div></div>
									<div class="assembly-row-combined model1"><div>23EF</div><div>RET NC</div><div>Return out of this routine if the last operator was a logical operator.</div></div>
									<div class="assembly-row-combined model1" id="23F0"><div>23F0</div><div>PUSH BC</div><div>Save the precedence value and the operator token for the last operator in BC to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>23F1</div><div>PUSH DE</div><div>Save the precedence value and the token for the current operator from DE (either a 6, 5, or 3) to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>23F2-23F4</div><div>LD DE,6404H</div><div>Load DE with the precedence value and the token for the new operator.</div></div>
									<div class="assembly-row-combined model1"><div>23F5-23F7</div><div>LD HL,25B8H</div><div>Load HL with the address of the routine to compare logical quantities ...</div></div>
									<div class="assembly-row-combined model1"><div>23F8</div><div>PUSH HL</div><div>and push it to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>23F9</div><div>RST 20H</div><div>We need to check the value of the current number type flag, so we call the TEST DATA MODE routine at RST 20H.<br><span class="nobottomborder bold">NOTE:</span>
  The RST 20H routine determines the type of the current value in REG 1 
and returns a combination of STATUS flags and unique numeric values in 
the A Register according to the data mode flag (40AFH).<br><br>The results are returned as follows:<table style="border-collapse: collapse; border: 1px solid black;"><tbody><tr style="background-color: #f0f0f0;"><td style="border: 1px solid black; padding: 8px;">If the Variable Type is ...</td><td style="border: 1px solid black; padding: 8px;">and the Flags<br>are set ...</td><td style="border: 1px solid black; padding: 8px;">... then Register<br>A will be set ...</td></tr><tr><td style="border: 1px solid black; padding: 8px;">Integer</td><td style="border: 1px solid black; padding: 8px;">NZ/C/M/E</td><td style="border: 1px solid black; padding: 8px;">-1</td></tr><tr><td style="border: 1px solid black; padding: 8px;">String</td><td style="border: 1px solid black; padding: 8px;">Z/C/P/E</td><td style="border: 1px solid black; padding: 8px;">0</td></tr><tr><td style="border: 1px solid black; padding: 8px;">Single Precision</td><td style="border: 1px solid black; padding: 8px;">NZ/C/P/O</td><td style="border: 1px solid black; padding: 8px;">1</td></tr><tr><td style="border: 1px solid black; padding: 8px;">Double Precision</td><td style="border: 1px solid black; padding: 8px;">NZ/NC/P/E</td><td style="border: 1px solid black; padding: 8px;">5</td></tr></tbody></table></div></div>
									<div class="assembly-row-combined model1"><div>23FA-23FC</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2395" class="memory-link">JP NZ,2395H</a></div><div>If that test shows we do NOT have a STRING, jump back to 2395H.</div></div>
									<div class="assembly-row-combined model1"><div>23FD-23FF</div><div>LD HL,(4121H)</div><div>Load HL with the string address held at the memory location pointed to by REG 1.</div></div>
									<div class="assembly-row-combined model1"><div>2400</div><div>PUSH HL</div><div>Save the string's address in HL to the stack.</div></div>
									<div class="assembly-row-combined model1" id="2401"><div>2401-2303</div><div>LD BC,258CH</div><div>Load BC with the address of the string comparison routine.</div></div>
									<div class="assembly-row-combined model1"><div>2404-2405</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#23CD" class="memory-link">JR 23CDH</a></div><div>Jump back to 23CDH.</div></div>
									<div class="assembly-row-combined model1"><div>2406</div><div>POP BC</div><div>Get the precedence value and the token for the last operator from the stack and put it in BC.</div></div>
									<div class="assembly-row-combined model1"><div>2407</div><div>LD A,C</div><div>Load register A with the operator token in register C.</div></div>
									<div class="assembly-row-combined model1"><div>2408-240A</div><div>LD (40B0H),A</div><div>Save the operator token in register A.<br>Note: 40B0H holds Temporary storage location.</div></div>
									<div class="assembly-row-combined model1"><div>240B</div><div>LD A,B</div><div>Load register A with the precedence value in register B.</div></div>
									<div class="assembly-row-combined model1"><div>240C-240D</div><div>CP 08H</div><div>Check the number type for the precedence value in register A.</div></div>
									<div class="assembly-row-combined model1"><div>240E-240F</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2438" class="memory-link">JR Z,2438H</a></div><div>Jump forward to 2438H if the number type in register A (the first operand) is double prec1sion.</div></div>
									<div class="assembly-row-combined model1"><div>2410-2412</div><div>LD A,(40AFH)</div><div>Load register A with the number type for the current result in REG 1.<br>Note: 40AFH holds Current number type flag.</div></div>
									<div class="assembly-row-combined model1"><div>2413-2414</div><div>CP 08H</div><div>Check to see if the current result in REG 1 is double precision.</div></div>
									<div class="assembly-row-combined model1"><div>2415-2417</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2460" class="memory-link">JP Z,2460H</a></div><div>Jump forward to 2460H if the current value in REG 1 is double precision.</div></div>
									<div class="assembly-row-combined model1"><div>2418</div><div>LD D,A</div><div>Load register D with the current data type flag in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2419</div><div>LD A,B</div><div>Load register A with the precedence value for the last operator in register B.</div></div>
									<div class="assembly-row-combined model1"><div>241A-241B</div><div>CP 04H</div><div>Check to see if the number type for the precedence value in register A is single precision.</div></div>
									<div class="assembly-row-combined model1"><div>241C-241E</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2472" class="memory-link">JP Z,2472H</a></div><div>Jump forward to 2472H if the number type for the precedence value in register A is single precision.</div></div>
									<div class="assembly-row-combined model1"><div>241F</div><div>LD A,D</div><div>Load register A with the number type flag for the value in REG 1.</div></div>
									<div class="assembly-row-combined model1"><div>2420-2421</div><div>CP 03H</div><div>Check to see if the current value in REG 1 is a string.</div></div>
									<div class="assembly-row-combined model1"><div>2422-2424</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0AF6" class="memory-link">JP Z,0AF6H</a></div><div>Display a <span class="code">?TM ERROR</span> message if the current value in REG 1 is a string.</div></div>
									<div class="assembly-row-combined model1" id="2325"><div>2325-2427</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#247C" class="memory-link">JP NC,247CH</a></div><div>Jump forward to 247CH if the current value in REG 1 is single precision.</div></div>
									<div class="assembly-row-combined model1"><div>2428-242A</div><div>LD HL,18BFH</div><div>Load HL with the starting address of the arithmetic jump table.</div></div>
									<div class="assembly-row-combined model1"><div>242B-242C</div><div>LD B,00H</div><div>Load register B with zero.</div></div>
									<div class="assembly-row-combined model1"><div>242D</div><div>ADD HL,BC</div><div>Add the operator's token in BC to the value of the arithmetic jump table pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>242E</div><div>ADD HL,BC</div><div>Add the operator's token in BC to the value of the arithmetic jump table pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>242F</div><div>LD C,(HL)</div><div>Load register C with the LSB of the jump address at the location of the arithmetic jump table pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2430</div><div>INC HL</div><div>Bump the value of the arithmetic jump table pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2431</div><div>LD B,(HL)</div><div>Load register B with the MSB of the jump address at the location of the arithmetic jump table pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2432</div><div>POP DE</div><div>Get the value for the previous result from the stack and put it in DE.</div></div>
									<div class="assembly-row-combined model1"><div>2433-2435</div><div>LD HL,(4121H)</div><div>Get the value for the current result from REG 1 and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2436</div><div>PUSH BC</div><div>Save the arithmetic routine's jump address in regis? ter pair BC to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2437</div><div>RET</div><div>Return.</div></div>
									<div class="assembly-row-combined model1" id="2438"><div>2438-243A</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0ADB" class="memory-link">CALL 0ADBH</a></div><div>Call
 the CONVERT TO DOUBLE PRECISION routine at 0ADBH (where the contents of
 REG 1 are converted from integer or single precision to double 
precision).</div></div>
									<div class="assembly-row-combined model1"><div>243B-243D</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#09FC" class="memory-link">CALL 09FCH</a></div><div>Go convert the current result in REG 1 to single precision.</div></div>
									<div class="assembly-row-combined model1"><div>243E</div><div>POP HL</div><div>Get the value from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>243F-244l</div><div>LD (411FH),HL</div><div>Save the value in HL near the end of REG 1.</div></div>
									<div class="assembly-row-combined model1"><div>2442</div><div>POP HL</div><div>Get the value from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2443-2445</div><div>LD (411DH),HL</div><div>Save the value in HL in REG 1.<br>Note: 411DH-4124H holds REG l.</div></div>
									<div class="assembly-row-combined model1"><div>2446</div><div>POP BC</div><div>Get the value from the stack and put it in BC.</div></div>
									<div class="assembly-row-combined model1"><div>2447</div><div>POP DE</div><div>Get the value from the stack and put it in DE.</div></div>
									<div class="assembly-row-combined model1"><div>2448-244A</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#09B4" class="memory-link">CALL 09B4H</a></div><div>Call 09B4H (which moves the SINGLE PRECISION value in DC/DE into REG 1). This moves DE to (4121H) and BC to (4123H).</div></div>
									<div class="assembly-row-combined model1" id="244B"><div>244B-244D</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0ADB" class="memory-link">CALL 0ADBH</a></div><div>Convert
 the first value to double precision by calling the CONVERT TO DOUBLE 
PRECISION routine at 0ADBH (where the contents of REG 1 are converted 
from integer or single precision to double precision).</div></div>
									<div class="assembly-row-combined model1"><div>244E-2450</div><div>LD HL,18ABH</div><div>Load HL with the double precision arithmetic jump table's starting address.</div></div>
									<div class="assembly-row-combined model1"><div>2451-2453</div><div>LD A,(40B0H)</div><div>Load register A with the operator token in register A.<br>Note: 40B0H holds Temporary storage location.</div></div>
									<div class="assembly-row-combined model1"><div>2454</div><div>RLCA</div><div>Multiply the value of the operator token in register A by two.</div></div>
									<div class="assembly-row-combined model1"><div>2455</div><div>PUSH BC</div><div>Save the value in BC to the stack so we can use it for 16 bit arithmetic.</div></div>
									<div class="assembly-row-combined model1"><div>2456</div><div>LD C,A</div><div>Load register C with the adjusted value of the operator token in register A (i.e., 2 x token).</div></div>
									<div class="assembly-row-combined model1"><div>2457-2458</div><div>LD B,00H</div><div>Load register B with zero.</div></div>
									<div class="assembly-row-combined model1"><div>2459</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#18AB" class="memory-link">ADD HL,BC</a></div><div>Add
 the value of the adjusted operator token in BC (which is token value * 
2) to 18ABH (which is the double precision arithmetic jump table's 
starting address) in HL.</div></div>
									<div class="assembly-row-combined model1"><div>245A</div><div>POP BC</div><div>Restore BC from the stack and put it in BC.</div></div>
									<div class="assembly-row-combined model1"><div>245B</div><div>LD A,(HL)</div><div>Load register A with the LSB of the jump address at the location of the arithmetic jump table pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>245C</div><div>INC HL</div><div>Bump the value of the arithmetic jump table pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>245D</div><div>LD H,(HL)</div><div>Load register H with the MSB of the jump address at the location of the arithmetic jump table pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>245E</div><div>LD L,A</div><div>Load register L with the LSB of the jump address in register A.</div></div>
									<div class="assembly-row-combined model1"><div>245F</div><div>JP (HL)</div><div>Jump to the arithmetic routine whose address is in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2460</div><div>PUSH BC</div><div>Save the precedence value and the operator token in BC to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2461-2463</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#09FC" class="memory-link">CALL 09FCH</a></div><div>Move the current result to the a storage area.</div></div>
									<div class="assembly-row-combined model1"><div>2464</div><div>POP AF</div><div>Load register A with the value of the current number type flag.</div></div>
									<div class="assembly-row-combined model1"><div>2465-2467</div><div>LD (40AFH),A</div><div>Save the value of the current number type flag in register A.<br>Note: 40AFH holds Current number type flag.</div></div>
									<div class="assembly-row-combined model1"><div>2468-2469</div><div>CP 04H</div><div>Check to see if the current result in REG 1 is single precision.</div></div>
									<div class="assembly-row-combined model1"><div>246A-246B</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2446" class="memory-link">JR Z,2446H</a></div><div>Jump back to 2446H if the current result in REG 1 is single precision.</div></div>
									<div class="assembly-row-combined model1"><div>246C</div><div>POP HL</div><div>Get the integer value from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>246D-246F</div><div>LD (4121H),HL</div><div>Save the integer value in HL in REG 1.</div></div>
									<div class="assembly-row-combined model1"><div>2470-2471</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#244B" class="memory-link">JR 244BH</a></div><div>Jump back to 244BH.</div></div>
									<div class="assembly-row-combined model1"><div>2472-2474</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0AB1" class="memory-link">CALL 0AB1H</a></div><div>Call
 the CONVERT TO SINGLE PRECISION routine at 0AB1H (which converts the 
contents of REG 1 from integer or double precision into single 
precision).</div></div>
									<div class="assembly-row-combined model1"><div>2475</div><div>POP BC</div><div>Get the value from the stack and put it in BC.</div></div>
									<div class="assembly-row-combined model1"><div>2476</div><div>POP DE</div><div>Get the value from the stack and put it in DE.</div></div>
									<div class="assembly-row-combined model1"><div>2477-2479</div><div>LD HL,18B5H</div><div>Load HL with the starting address of the single precision arithmetic jump table.</div></div>
									<div class="assembly-row-combined model1"><div>247A-247B</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2451" class="memory-link">JR 2451H</a></div><div>Jump back to 2451H to perform the operation.</div></div>
									<div class="assembly-row-combined model1"><div>247C</div><div>POP HL</div><div>Get the integer value from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>247D-247F</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#09A4" class="memory-link">CALL 09A4H</a></div><div>Call 09A4 which moves the SINGLE PRECISION value in REG 1 to the stack (stored in LSB/MSB/Exponent order).</div></div>
									<div class="assembly-row-combined model1"><div>2480-2482</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0ACF" class="memory-link">CALL 0ACFH</a></div><div>Go convert the integer value in HL to single precision.</div></div>
									<div class="assembly-row-combined model1"><div>2483-2485</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#09BF" class="memory-link">CALL 09BFH</a></div><div>Call 09BF which loads the SINGLE PRECISION value in REG 1 into BC/DE.</div></div>
									<div class="assembly-row-combined model1"><div>2486</div><div>POP HL</div><div>Get the LSB/NMSB from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2487-2489</div><div>LD (4123H),HL</div><div>Save the value in HL in REG 1</div></div>
									<div class="assembly-row-combined model1"><div>248A</div><div>POP HL</div><div>Get the MSB and exponent from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>248B-248D</div><div>LD (4121H),HL</div><div>Save the value in HL in REG 1.</div></div>
									<div class="assembly-row-combined model1"><div>248E-248F</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2477" class="memory-link">JR 2477H</a></div><div>Jump back to 2477H to perform the operation.</div></div>
								</div>
							</div>

							<br><h2 id="2490-integer-divide">2490 - Integer divide<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<p>(ACC=DE / HL) Result will be in single-precision (NTF=4) and will be in the ACC.<br>Divides
 DE by HL. Both values are converted to single precision before the 
division is started. The quotient is left in REG l; the mode flag is 
updated. The orginal contents of the DE and HL register sets are lost.</p>
								<p>Note: To use a ROM call to divide two integers store the 
dividend in the DE register pair, and store the divisor in HL and then 
CALL 2490H.  The result is stored in single precision format (since it 
is not likely to be an integer) in 4121H-4124Hin approximately 5.1 
milliseconds.</p>
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2490H<span class="origrom2">IDIV</span></div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2490" class="memory-link">PUSH HL</a></div><div>Save the integer value in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2491</div><div>EX DE,HL</div><div>We need to convert DE to SP so first do this swap to set up the variables for the call which follows.</div></div>
									<div class="assembly-row-combined model1"><div>2492-2494</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0ACF" class="memory-link">CALL 0ACFH</a></div><div>Go convert the integer value in HL to single precision and return with the result in REG 1.</div></div>
									<div class="assembly-row-combined model1"><div>2495</div><div>POP HL</div><div>Get the integer value from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2496-2498</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#09A4" class="memory-link">CALL 09A4H</a></div><div>Call 09A4 which moves the SINGLE PRECISION value in REG 1 to the stack (stored in LSB/MSB/Exponent order).</div></div>
									<div class="assembly-row-combined model1"><div>2499-249B</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0ACF" class="memory-link">CALL 0ACFH</a></div><div>Go convert the integer value in HL to single precision and return with the result in REG 1.</div></div>
									<div class="assembly-row-combined model1"><div>249C-249E</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#08A0" class="memory-link">JP 08A0H</a></div><div>Go do a single precision divide.</div></div>
									<div class="assembly-row-combined model1"><div>249F</div><div>RST 10H</div><div>We need the next character in the BASIC program so call the EXAMINE NEXT SYMBOL routine at RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The
 RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>24A0-24A1</div><div>LD E,28H</div><div>Load register E with a <span class="code">?MO ERROR</span> code.</div></div>
									<div class="assembly-row-combined model1"><div>24A2-24A4</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#19A2" class="memory-link">JP Z,19A2H</a></div><div>Display a <span class="code">?MO ERROR</span> if we are at the end of the string.</div></div>
									<div class="assembly-row-combined model1"><div>24A5-24A7</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0E6C" class="memory-link">JP C,0E6CH</a></div><div>If
 the character at the location of the current BASIC program pointer in 
HL is numeric, call the ASCII TO BINARY routine at 0E6C (which converts 
the ASCII string pointed to by HL to binary with the result in REG 1 and
 the mode flag will have changed).</div></div>
									<div class="assembly-row-combined model1"><div>24A8-24AA</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1E3D" class="memory-link">CALL 1E3DH</a></div><div>Check to see if the character at the location of the current BASIC program pointer in HL is alphabetic.</div></div>
									<div class="assembly-row-combined model1" id="24AB"><div>24AB-24AD</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2540" class="memory-link">JP NC,2540H</a></div><div>Jump if the character at the location of the current BASIC program pointer in HL is alphabetic.</div></div>
									<div class="assembly-row-combined model1"><div>24AE-24AF</div><div>CP 0CDH</div><div>Check to see if the character at the location of the current BASIC program pointer in register A is a <span class="code">+</span> token.<br><p class="bold" style="margin-bottom:0px;">Notes:</p><ul><li>CDH is a <span class="code">+</span> in ASCII</li><li>A CP will return Z if there is a match against Register A, and NZ if not a match against Register A.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>24B0-24B1</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#249F" class="memory-link">JR Z,249FH</a></div><div>Jump if the character at the location of the current BASIC program pointer in register A is a <span class="code">+</span> token.</div></div>
									<div class="assembly-row-combined model1"><div>24B2-24B3</div><div>CP 2EH</div><div>Check to see if the character at the location of the current BASIC program pointer in register A is a decimal point.<br><p class="bold" style="margin-bottom:0px;">Notes:</p><ul><li>2EH is a <span class="code">.</span> in ASCII</li><li>A CP will return Z if there is a match against Register A, and NZ if not a match against Register A.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>24B4-24B6</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0E6C" class="memory-link">JP Z,0E6CH</a></div><div>If
 the character at the location of the current BASIC program pointer in 
HL is a decimal point, call the ASCII TO BINARY routine at 0E6C (which 
converts the ASCII string pointed to by HL to binary with the result in 
REG 1 and the mode flag will have changed).</div></div>
									<div class="assembly-row-combined model1"><div>24B7-24B8</div><div>CP 0CEH</div><div>Check to see if the character at the location of the current BASIC program pointer in register A is a <span class="code">-</span> token.<br><p class="bold" style="margin-bottom:0px;">Notes:</p><ul><li>CEH is a <span class="code">-</span> in ASCII</li><li>A CP will return Z if there is a match against Register A, and NZ if not a match against Register A.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>24B9-24BB</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2532" class="memory-link">JP Z,2532H</a></div><div>Jump to 2532H if the character at the location of the current BASIC program pointer in register A is a <span class="code">-</span> token.</div></div>
									<div class="assembly-row-combined model1"><div>24BC-24BD</div><div>CP 22H</div><div>Check to see if the character at the location of the current BASIC program pointer in register A is a <span class="code">"</span>.<br><p class="bold" style="margin-bottom:0px;">Notes:</p><ul><li>22H is a <span class="code">"</span> in ASCII</li><li>A CP will return Z if there is a match against Register A, and NZ if not a match against Register A.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>24BE-24C0</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2866" class="memory-link">JP Z,2866H</a></div><div>Jump to 2866H if the character at the location of the current BASIC program pointer in register A is a <span class="code">"</span>.</div></div>
									<div class="assembly-row-combined model1"><div>24C1-24C2</div><div>CP 0CBH</div><div>Check to see if the character at the location of the current BASIC program pointer in register A is a <span class="code">NOT</span> token.<br><p class="bold" style="margin-bottom:0px;">Notes:</p><ul><li>CBH is a <span class="code">NOT</span> token.</li><li>A CP will return Z if there is a match against Register A, and NZ if not a match against Register A.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>24C3-24C5</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#25C4" class="memory-link">JP Z,25C4H</a></div><div>Jump to 25C4H if the character at the location of the current BASIC program pointer in register A is a <span class="code">NOT</span> token.</div></div>
									<div class="assembly-row-combined model1"><div>24C6-24C7</div><div>CP 26H</div><div>Check to see if the character at the location of the current BASIC program pointer in register A is a &amp;.<br><p class="bold" style="margin-bottom:0px;">Notes:</p><ul><li>26H is a <span class="code">&amp;</span> in ASCII</li><li>A CP will return Z if there is a match against Register A, and NZ if not a match against Register A.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>24C8-24CA</div><div><a href="#4194" class="memory-link">JP Z,4194H</a></div><div>Jump to 4194H (which is DOS) if the character at the location of the current BASIC program pointer in register A is a &amp;.</div></div>
									<div class="assembly-row-combined model1"><div>24CB-24CC</div><div>CP 0C3H</div><div>Check to see if the character at the location of the current BASIC program pointer in register A is an <span class="code">ERR</span> token.<br><p class="bold" style="margin-bottom:0px;">Notes:</p><ul><li>C3H is a <span class="code">ERR</span> token.</li><li>A CP will return Z if there is a match against Register A, and NZ if not a match against Register A.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>24CD-24CE</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#24D9" class="memory-link">JR NZ,24D9H</a></div><div>Jump to 24D9H if the character at the location of the current BASIC program pointer in register A isn't an <span class="code">ERR</span> token.</div></div>
									<div class="assembly-row-combined model1"><div>24CF</div><div>RST 10H</div><div>We
 now need bump the value of the current BASIC program pointer until it 
points to the next character, call the EXAMINE NEXT SYMBOL routine at 
RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The 
RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>24D0-24D2</div><div>LD A,(409AH)</div><div>Load register A with the value of the current error number.<br>Note: 409AH holds the <span class="code">RESUME</span> flag.</div></div>
									<div class="assembly-row-combined model1"><div>24D3</div><div>PUSH HL</div><div>Save the value of the current BASIC program pointer in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>24D4-24D6</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#27F8" class="memory-link">CALL 27F8H</a></div><div>Go save the value of the current error number in register A (as an integer) as the current result in REG l.</div></div>
									<div class="assembly-row-combined model1"><div>24D7</div><div>POP HL</div><div>Get the value of the current BASIC program pointer from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>24D8</div><div>RET</div><div>Return.</div></div>
									<div class="assembly-row-combined model1" id="24D9"><div>24D9-24DA</div><div>CP C2H</div><div>Check to see if the character at the location of the current BASIC program pointer in register A is a <span class="code">ERL</span> token.</div></div>
									<div class="assembly-row-combined model1"><div>24DB-24DC</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#24E7" class="memory-link">JR NZ,24E7H</a></div><div>Jump to 24E7H if the character at the location of the current BASIC program pointer in register A isn't an <span class="code">ERL</span> token.</div></div>
									<div class="assembly-row-combined model1"><div>24DD</div><div>RST 10H</div><div>We need the next character in the BASIC program so call the EXAMINE NEXT SYMBOL routine at RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The
 RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>24DE</div><div>PUSH HL</div><div>Save the value of the current BASIC program pointer in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>24DF-24El</div><div>LD HL,(40EAH)</div><div>Load HL with the current error line number.<br>Note: 40EAH-40EBH holds the line number with error.</div></div>
									<div class="assembly-row-combined model1"><div>24E2-24E3</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0C66" class="memory-link">CALL 0C66H</a></div><div>Go save the error line number in HL as the current result in REG 1.</div></div>
									<div class="assembly-row-combined model1"><div>24E5</div><div>POP HL</div><div>Get the value of the current BASIC program pointer from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>24E6</div><div>RET</div><div>Return.</div></div>
								</div>
							</div>

							<br><h2 id="24e7-24fespan">24E7-24FE<span class="code">VARPTR</span> logic.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>24E7-24E8</div><div>CP 0C0H</div><div>Check to see if the character at the location of the current BASIC program pointer in register A is a <span class="code">VARPTR</span> token.</div></div>
									<div class="assembly-row-combined model1"><div>24E9-24EA</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#24FF" class="memory-link">JR NZ,24FFH</a></div><div>Jump back to 24FFH if the character at the location of the current BASIC program pointer in register A isn't a <span class="code">VARPTR</span> token.</div></div>
									<div class="assembly-row-combined model1"><div>24EB</div><div>RST 10H</div><div>We need the next character in the BASIC program so call the EXAMINE NEXT SYMBOL routine at RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The
 RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>24EC-24ED</div><div>RST 08H ‚áí 28</div><div>Since the character at the location of the current BASIC program pointer in HL must be a <span class="code">(</span>, call the COMPARE SYMBOL routine at RST 08H.<br><br><span class="bold nobottomborder">NOTE:</span>
 The RST 08H routine compares the symbol in the input string pointed to 
by HL register to the value in the location following the RST 08 call.<ul><li>If
 there is a match, control is returned to the next execution address 
(i.e, the RST 08H instruction + 2) with the next symbol in the A 
Register and HL incremented by one.</li><li>If the two characters do not match, a syntax error message is given and control returns to the Input Phase).</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>24EE-24F0</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#24BC" class="memory-link">JR Z,24BCH</a></div><div>Jump to 24BCH to evaluate the variable name at the location of the current BASIC program pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>24Fl-24F2</div><div>RST 08H ‚áí 29</div><div>Since the character at the location of the current BASIC program pointer in HL must be a <span class="code">)</span>,
 call the COMPARE SYMBOL routine which compares the symbol in the input 
string pointed to by HL register to the value in the location following 
the RST 08 call. If there is a match, control is returned to address of 
the RST 08 instruction + 2 with the next symbol in the A register and HL
 incremented by one. If the two characters do not match, a syntax error 
message is given and control returns to the Input Phase).</div></div>
									<div class="assembly-row-combined model1"><div>24F3</div><div>PUSH HL</div><div>Save the value of the current BASIC program pointer in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>24F4</div><div>EX DE,HL</div><div>Load HL with the variable's address in DE.</div></div>
									<div class="assembly-row-combined model1"><div>24F5</div><div>LD A,H</div><div>Load register A with MSB of the variable's address in register H.</div></div>
									<div class="assembly-row-combined model1"><div>24F6</div><div>OR L</div><div>Combine
 the LSB of the variable's address in register L with the MSB of the 
variable's address in register A. This type of pattern is used to check 
for something being zero.</div></div>
									<div class="assembly-row-combined model1"><div>24F7-24F9</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1E4A" class="memory-link">JP Z,1E4AH</a></div><div>Display a <span class="code">?FC ERROR</span> if the variable's address in HL is equal to zero, meaning that the variable is undefined.</div></div>
									<div class="assembly-row-combined model1"><div>24FA-24FC</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0A9A" class="memory-link">CALL 0A9AH</a></div><div>Save the variable's address in HL as the current result in REG l.</div></div>
									<div class="assembly-row-combined model1"><div>24FD</div><div>POP HL</div><div>Get the value of the current BASIC program pointer from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>24FE</div><div>RET</div><div>Return to the execution driver.</div></div>
								</div>
							</div>

							<br><h2 id="24ff-other-function">24FF - Other Function Routine.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>24FF-2500</div><div>CP 0C1H</div><div>Check to see if the character at the location of the current BASIC program pointer in register A is a <span class="code">USR</span> token.</div></div>
									<div class="assembly-row-combined model1"><div>2501-2503</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#27FE" class="memory-link">JP Z,27FEH</a></div><div>Jump to 27FEH if the character at the location of the current BASIC program pointer in register A is a <span class="code">USR</span> token.</div></div>
									<div class="assembly-row-combined model1"><div>2504-2505</div><div>CP 0C5H</div><div>Check to see if the character at the location of the current BASIC program pointer in register A is a <span class="code">INSTR</span> token</div></div>
									<div class="assembly-row-combined model1"><div>2506-2508</div><div><a href="#419D" class="memory-link">JP Z,419DH</a></div><div>Jump to the DOS address of 419DH if the character at the location of the current BASIC program pointer in register A is an <span class="code">INSTR</span> token.</div></div>
									<div class="assembly-row-combined model1"><div>2509-250A</div><div>CP 0C8H</div><div>Check to see if the character at the location of the current BASIC program pointer in register A is a <span class="code">MEM</span> token.</div></div>
									<div class="assembly-row-combined model1"><div>250B-250D</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#27C9" class="memory-link">JP Z,27C9H</a></div><div>If the character at the location of the current BASIC program pointer in register A is a <span class="code">MEM</span>
 token, jump to the RETURN AMOUNT OF FREE MEMORY routine at 27C9H which 
computes the amount of memory remaining between the end of the variable 
list and the end of the stack and puts the result in REG 1 as a SINGLE 
PRECISION number.</div></div>
									<div class="assembly-row-combined model1"><div>250E-250F</div><div>CP 0C7H</div><div>Check to see if the character at the location of the current BASIC program pointer in register A is a <span class="code">TIME$</span> token.</div></div>
									<div class="assembly-row-combined model1"><div>2510-2512</div><div><a href="#4176" class="memory-link">JP Z,4176H</a></div><div>Jump
 to the DOS address of 4176H if the character at the location of the 
current BASIC program pointer in register A is a TIME$ token.</div></div>
									<div class="assembly-row-combined model1"><div>2513-2514</div><div>CP 0C6H</div><div>Check to see if the character at the location of the current BASIC program pointer in register A is a <span class="code">POINT</span> token.</div></div>
									<div class="assembly-row-combined model1"><div>2515-2517</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0132" class="memory-link">JP Z,0132H</a></div><div>Jump to 0132H if the character at the location of the current BASIC program pointer in register A is a <span class="code">POINT</span> token.</div></div>
									<div class="assembly-row-combined model1"><div>2518-2519</div><div>CP 0C9H</div><div>Check to see if the character at the location of the current BASIC program pointer in register A is an <span class="code">INKEY$</span> token.</div></div>
									<div class="assembly-row-combined model1"><div>251A-251C</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#019D" class="memory-link">JP Z,019DH</a></div><div>Jump to 019DH if the character at the location of the current BASIC program pointer in register A is an <span class="code">INKEY$</span> token.</div></div>
									<div class="assembly-row-combined model1"><div>251D-251E</div><div>CP 0C4H</div><div>Check to see if the character at the location of the current BASIC program pointer in register A is a <span class="code">STRING$</span> token.</div></div>
									<div class="assembly-row-combined model1"><div>241F-2421</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2A2F" class="memory-link">JP Z,2A2FH</a></div><div>Jump to 2A2FH if the character at the location of the current BASIC program pointer in register A is a <span class="code">STRING$</span> token.</div></div>
									<div class="assembly-row-combined model1"><div>2522-2523</div><div>CP 0BEH</div><div>Check to see if the character at the location of the current BASIC program pointer in register A is a <span class="code">FN</span> token.</div></div>
									<div class="assembly-row-combined model1"><div>2524-2526</div><div><a href="#4155" class="memory-link">JP Z,4155H</a></div><div>Jump to the DOS address of 4155H if the character at the location of the current BASIC program pointer in register A is a <span class="code">FN</span> token.</div></div>
									<div class="assembly-row-combined model1"><div>2527-2528</div><div>SUB 0D7H</div><div>Check to see if the character at the location of the current BASIC program pointer in register A is a <span class="code">SGN</span> to <span class="code">MID$</span> token.</div></div>
									<div class="assembly-row-combined model1" id="254E"><div>2529-252B</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#254E" class="memory-link">JP NC,254EH</a></div><div>Jump to 254EH if the character at the location of the current BASIC program pointer in register A is a <span class="code">SGN</span> to <span class="code">MID$</span> token.</div></div>
									<div class="assembly-row-combined model1"><div>252C-252E</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2335" class="memory-link">CALL 2335H</a></div><div>GOSUB to 2335H to evaluate the expression at the location of the current BASIC program pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>252F-2530</div><div>RST 08H ‚áí 29H</div><div>Since the character at the location of the current BASIC program pointer in HL must be a <span class="code">)</span>, call the COMPARE SYMBOL routine at RST 08H.<br><br><span class="bold nobottomborder">NOTE:</span>
 The RST 08H routine compares the symbol in the input string pointed to 
by HL register to the value in the location following the RST 08 call.<ul><li>If
 there is a match, control is returned to the next execution address 
(i.e, the RST 08H instruction + 2) with the next symbol in the A 
Register and HL incremented by one.</li><li>If the two characters do not match, a syntax error message is given and control returns to the Input Phase).</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2531</div><div>RET</div><div>Return out of this routine.</div></div>
								</div>
							</div>

							<br><h2 id="2532-binary-minus">2532 - Binary Minus Routine.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2532</div><div>LD D,7DH</div><div>Load register D with the precedence value.</div></div>
									<div class="assembly-row-combined model1"><div>2534-2536</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#233A" class="memory-link">CALL 233AH</a></div><div>GOSUB to 233AH to evaluate the variable at the location of the current BASIC program pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2537-2539</div><div>LD HL,(40F3H)</div><div>Load HL with the value of the current BASIC program pointer.<br>Note: 40F3H-40F4H holds Temporary storage location.</div></div>
									<div class="assembly-row-combined model1"><div>253A</div><div>PUSH HL</div><div>Save the value of the current BASIC program pointer in HL to the stack so we know where to continue.</div></div>
									<div class="assembly-row-combined model1"><div>253B-253D</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#097B" class="memory-link">CALL 097BH</a></div><div>Invert the sign of the current value in REG 1.</div></div>
									<div class="assembly-row-combined model1"><div>253E</div><div>POP HL</div><div>Restore the code string address from the stack and put it in HL. We need this because we return here after executing functions <span class="code">SNG(</span> to <span class="code">MID$(</span>.</div></div>
									<div class="assembly-row-combined model1"><div>253F</div><div>RET</div><div>Return to the expression evaluation.</div></div>
								</div>
							</div>

							<br><h2 id="2540-this-routine">2540 - This routine loads a variable to the ACC and sets the NTF.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<p> The HL must point to the ASCII variable name. After 
execution the HL will point to the character following the last 
character of the variable used. The value of the variable will be loaded
 in the ACC. For strings however (NTF=3), the ACC will contain the 
address of the first three bytes which contain the string length and 
string address (see Level II BASIC manual). Also note that if the 
variable cannot be found it will be created and given a value of zero.</p>
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2540-2542</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#260D" class="memory-link">CALL 260DH</a></div><div>Call
 the FIND ADDRESS OF VARIABLE routine at 260DH which searches the 
Variable List Table for a variable name which matches the name in the 
string pointed to in HL, and return the address of that variable in DE 
(and if there is no variable, it creates it, zeroes it, and returns THAT
 location).</div></div>
									<div class="assembly-row-combined model1"><div>2543</div><div>PUSH HL</div><div>Save the value of the current BASIC program pointer in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2544</div><div>EX DE,HL</div><div>Move the address of the variable to HL.</div></div>
									<div class="assembly-row-combined model1"><div>2545-2547</div><div>LD (4121H),HL</div><div>Save the variable's address in HL in REG 1.</div></div>
									<div class="assembly-row-combined model1"><div>2548</div><div>RST 20H</div><div>We need to check the value of the current number type flag, so we call the TEST DATA MODE routine at RST 20H.<br><span class="nobottomborder bold">NOTE:</span>
  The RST 20H routine determines the type of the current value in REG 1 
and returns a combination of STATUS flags and unique numeric values in 
the A Register according to the data mode flag (40AFH).<br><br>The results are returned as follows:<table style="border-collapse: collapse; border: 1px solid black;"><tbody><tr style="background-color: #f0f0f0;"><td style="border: 1px solid black; padding: 8px;">If the Variable Type is ...</td><td style="border: 1px solid black; padding: 8px;">and the Flags<br>are set ...</td><td style="border: 1px solid black; padding: 8px;">... then Register<br>A will be set ...</td></tr><tr><td style="border: 1px solid black; padding: 8px;">Integer</td><td style="border: 1px solid black; padding: 8px;">NZ/C/M/E</td><td style="border: 1px solid black; padding: 8px;">-1</td></tr><tr><td style="border: 1px solid black; padding: 8px;">String</td><td style="border: 1px solid black; padding: 8px;">Z/C/P/E</td><td style="border: 1px solid black; padding: 8px;">0</td></tr><tr><td style="border: 1px solid black; padding: 8px;">Single Precision</td><td style="border: 1px solid black; padding: 8px;">NZ/C/P/O</td><td style="border: 1px solid black; padding: 8px;">1</td></tr><tr><td style="border: 1px solid black; padding: 8px;">Double Precision</td><td style="border: 1px solid black; padding: 8px;">NZ/NC/P/E</td><td style="border: 1px solid black; padding: 8px;">5</td></tr></tbody></table></div></div>
									<div class="assembly-row-combined model1"><div>2549-254B</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#09F7" class="memory-link">CALL NZ,09F7H</a></div><div>If that test shows we do NOT have a STRING, call 09F7H to move data.</div></div>
									<div class="assembly-row-combined model1"><div>254C</div><div>POP HL</div><div>Get the address of the next symbol in the input string from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>254D</div><div>RET</div><div>Return to the caller.</div></div>
								</div>
							</div>

							<br><h2 id="254e-this-routine">254E - This routine is for <span class="code">SNG(</span> to <span class="code">MID$(</span>.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>254E-254F</div><div>LD B,00H</div><div>Load register B with zero.</div></div>
									<div class="assembly-row-combined model1"><div>2550</div><div>RLCA</div><div>Set A to be 2 * (token - D7H)</div></div>
									<div class="assembly-row-combined model1"><div>2551</div><div>LD C,A</div><div>Save the new token.</div></div>
									<div class="assembly-row-combined model1"><div>2552</div><div>PUSH BC</div><div>Save 0/2*(token-D7) on stack.</div></div>
									<div class="assembly-row-combined model1"><div>2553</div><div>RST 10H</div><div>Get the next character from the tokenized string by calling RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The
 RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2554</div><div>LD A,C</div><div>Prepare to look for <span class="code">SGN(</span> to <span class="code">CHR$(</span> token.</div></div>
									<div class="assembly-row-combined model1"><div>2555</div><div>CP 41H</div><div>Test for the adjusted token.</div></div>
									<div class="assembly-row-combined model1"><div>2557</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#256F" class="memory-link">JR C,256FH</a></div><div>.Jump to 256FH if the token is <span class="code">SGN(</span> to <span class="code">CHR$(</span>. If not, it is a <span class="code">LEFT$</span> - <span class="code">MID$</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2559</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2335" class="memory-link">CALL 2335H</a></div><div>Otherwise, GOSUB to 2335H to evaluate the expression part of the calling sequence (which requires 2 or parameters).</div></div>
									<div class="assembly-row-combined model1"><div>255C</div><div>RST 08H ‚áí 2CH</div><div>Use RST 08H to test for a <span class="code">,</span>.</div></div>
									<div class="assembly-row-combined model1"><div>255E</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0AF4" class="memory-link">CALL 0AF4H</a></div><div>GOSUB to 0AF4H to ensure the current variable is a string, otherwise it is an error.</div></div>
									<div class="assembly-row-combined model1"><div>2561</div><div>EX DE,HL</div><div>Make
 sure the current variable is a string - DE is the current position in 
the program statement and HL is the address of the string.</div></div>
									<div class="assembly-row-combined model1"><div>2562</div><div>LD HL,(4121H)</div><div>Load HL with the string address held at the memory location pointed to by REG 1.</div></div>
									<div class="assembly-row-combined model1"><div>2565</div><div>EX (SP),HL</div><div>Put the string address to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2566</div><div>PUSH HL</div><div>Save the 00 / 2*(token-D7H) to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2567</div><div>EX DE,HL</div><div>Move the program statement position to HL.</div></div>
									<div class="assembly-row-combined model1"><div>2568</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2B1C" class="memory-link">CALL 2B1CH</a></div><div>Evaluate n portion of the string function.</div></div>
									<div class="assembly-row-combined model1"><div>256B</div><div>EX DE,HL</div><div>Set DE to be the current position in the statement and set HL to be n.</div></div>
									<div class="assembly-row-combined model1"><div>256C</div><div>EX (SP),HL</div><div>Move n to stack. HL will be 2 * (token - D7H).</div></div>
									<div class="assembly-row-combined model1"><div>256D</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2583" class="memory-link">JR 2583H</a></div><div>Jump down to 2583H to process the token.</div></div>
									<div class="assembly-row-combined model1"><div>256F-2571</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#252C" class="memory-link">CALL 252CH</a></div><div>The
 below is a single variable parameter call. First, GOSUB to 252CH to 
evaluate the expression at the location of the current BASIC program 
pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2572</div><div>EX (SP),HL</div><div>Exchange
 the value of the current BASIC program pointer in HL with the operator 
value to the stack. HL will be 0 + 2 * (token - D7H).</div></div>
									<div class="assembly-row-combined model1"><div>2573</div><div>LD A,L</div><div>Load register A with the operator token in register L. A will be 2 * (token - D7H).</div></div>
									<div class="assembly-row-combined model1"><div>2574-2575</div><div>CP 0CH</div><div>Check to see if the operator token in register A is <span class="code">SGN</span> to <span class="code">SQR</span>.</div></div>
									<div class="assembly-row-combined model1" id="2576"><div>2576-2577</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#257F" class="memory-link">JR C,257FH</a></div><div>Jump down to 257FH if the operator token in register A is <span class="code">SGN</span> to <span class="code">SQR</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2578-2579</div><div>CP 1BH</div><div>Check the value of the adjusted operator token in register A.</div></div>
									<div class="assembly-row-combined model1"><div>257A</div><div>PUSH HL</div><div>Save the adjusted token (0 + 2*(token - D7H)) in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>257B-257D</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0AB1" class="memory-link">CALL C,0AB1H</a></div><div>If the operator token in register A is <span class="code">SQR</span> to <span class="code">ATN</span>,
 call the CONVERT TO SINGLE PRECISION routine at 0AB1H (which converts 
the contents of REG 1 [4121H] from integer or double precision into 
single precision).</div></div>
									<div class="assembly-row-combined model1"><div>257E</div><div>POP HL</div><div>Restore the adjusted token from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>257F-2581</div><div>LD DE,253EH</div><div>Load DE with a return address of 253EH for once the function is executed.</div></div>
									<div class="assembly-row-combined model1"><div>2582</div><div>PUSH DE</div><div>Save the value of the return address in DE to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2583-2585</div><div>LD BC,1608H</div><div>Load BC with the <span class="code">SGN</span> to <span class="code">MID$</span> jump table address.</div></div>
									<div class="assembly-row-combined model1"><div>2586</div><div>ADD HL,BC</div><div>Add the jump table pointer in BC with the value of the operator token in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2587</div><div>LD C,(HL)</div><div>Load register C with the LSB of the jump address at the location of the jump table pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2588</div><div>INC HL</div><div>Bump the value of the jump table pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2589</div><div>LD H,(HL)</div><div>Load register H with the MSB of the jump address at the location of the jump table pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>258A</div><div>LD L,C</div><div>Load register L with the LSB of the jump address in register C.</div></div>
									<div class="assembly-row-combined model1"><div>258B</div><div>JP (HL)</div><div>Jump to the calculated address (which is the <span class="code">SGN</span>-<span class="code">MID$</span> function) in HL.</div></div>
								</div>
							</div>

							<br><h2 id="258c-this-routine">258C - This routine will do a relational comparison of two strings.<br>It
 will load A with the length of the first string and BC with the 
string's address. Then it will load D with the length of the second 
string and HL with the string's address.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>258C-258E</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#29D7" class="memory-link">CALL 29D7H</a></div><div>GOSUB to 29D7H to check to see if there is enough memory for the string.</div></div>
									<div class="assembly-row-combined model1"><div>258F</div><div>LD A,(HL)</div><div>Load register A with the length of the string at the location of the string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2590</div><div>INC HL</div><div>Bump the value of the string's VARPTR in HL so that HL points to the LSB of the string address.</div></div>
									<div class="assembly-row-combined model1"><div>2591</div><div>LD C,(HL)</div><div>Load register C with the LSB of the string's address at the location of the string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2592</div><div>INC HL</div><div>Bump the value of the string's VARPTR in HL so that HL points to the MSB of the string address.</div></div>
									<div class="assembly-row-combined model1"><div>2594</div><div>LD B,(HL)</div><div>Load register B with the MSB of the string's address at the location of the string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2595</div><div>POP DE</div><div>Save the value of the string's address in BC to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2596</div><div>PUSH BC</div><div>Save the string's length in register A to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2597-2599</div><div>PUSH AF</div><div>Load HL with the second string's VARPTR.</div></div>
									<div class="assembly-row-combined model1"><div>259A</div><div>POP DE</div><div>Get the length of the first string from the stack and put it in register D.</div></div>
									<div class="assembly-row-combined model1"><div>259B</div><div>LD E,(HL)</div><div>Load register E with the second string's length at the location of the second string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1"><div>259C</div><div>INC HL</div><div>Bump the value of the second string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1"><div>259D</div><div>LD C,(HL)</div><div>Load register C with the LSB of the second string's address at the location of the second string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1"><div>259E</div><div>INC HL</div><div>Bump the value of the second string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1"><div>259F</div><div>LD B,(HL)</div><div>Load register B with the MSB of the second string's address at the location of the second string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1"><div>25A0</div><div>POP HL</div><div>Get the first string's address from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>25Al</div><div>LD A,E</div><div>Load register A with the length of the second string in register E.</div></div>
									<div class="assembly-row-combined model1"><div>25A2</div><div>OR D</div><div>Combine the first string's length in register D with the second string's length in register A.</div></div>
									<div class="assembly-row-combined model1"><div>25A3</div><div>RET Z</div><div>Return out of the routine if there aren't any characters left in either string to be compared.</div></div>
									<div class="assembly-row-combined model1" id="25A4"><div>25A4</div><div>LD A,D</div><div>Load register A with the first string's length in register D.</div></div>
									<div class="assembly-row-combined model1"><div>25A5-25A6</div><div>SUB 01H</div><div>Check to see if the first string's length in register A is equal to zero.</div></div>
									<div class="assembly-row-combined model1"><div>25A7</div><div>RET C</div><div>Return if there are no more characters in the first string to be compared.</div></div>
									<div class="assembly-row-combined model1" id="25A8"><div>25A8</div><div>XOR A</div><div>Load register A with zero.</div></div>
									<div class="assembly-row-combined model1"><div>25A9</div><div>CP E</div><div>Check to see if the second string's length in register E is equal to zero.</div></div>
									<div class="assembly-row-combined model1"><div>25AA</div><div>INC A</div><div>Bump the value in register A.</div></div>
									<div class="assembly-row-combined model1"><div>25AB</div><div>RET NC</div><div>Return if there aren't anymore characters in the second string to be compared.</div></div>
									<div class="assembly-row-combined model1" id="25AC"><div>25AC</div><div>DEC D</div><div>Decrement the value of the first string's length in register D.</div></div>
									<div class="assembly-row-combined model1"><div>25AD</div><div>DEC E</div><div>Decrement the value of the second string's length in register E.</div></div>
									<div class="assembly-row-combined model1"><div>25AE</div><div>LD A,(BC)</div><div>Load register A with the character at the location of the second string pointer in BC.</div></div>
									<div class="assembly-row-combined model1"><div>25AF</div><div>CP (HL)</div><div>Compare
 the character at the location of the second string pointer in register A
 with the character at the location of the first string pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>25B0</div><div>INC HL</div><div>Bump the value of the first string pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>25Bl</div><div>INC BC</div><div>Bump the value of the second string pointer in BC.</div></div>
									<div class="assembly-row-combined model1"><div>25B2-25B3</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#25A1" class="memory-link">JR Z,25A1H</a></div><div>Loop back to 25A1H to keep going if the characters match.</div></div>
									<div class="assembly-row-combined model1"><div>25B4</div><div>CCF</div><div>Since they are not equal, reverse the CARRY flag so 960 will give a +1 or -1.</div></div>
									<div class="assembly-row-combined model1"><div>25B5-25B7</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0960" class="memory-link">JP 0960H</a></div><div>Jump back to 0960H.</div></div>
									<div class="assembly-row-combined model1"><div>25B8</div><div>INC A</div><div>Bump the value of the current precedence value in register A.</div></div>
									<div class="assembly-row-combined model1"><div>25B9</div><div>ADC A,A</div><div>Adjust the value of the current precedence value in register A. This will give a 1 with a NC if 0 or a 0 with C if FF.</div></div>
									<div class="assembly-row-combined model1"><div>25BA</div><div>POP BC</div><div>Get the last operator value from the stack and put it in BC.</div></div>
									<div class="assembly-row-combined model1"><div>25BB</div><div>AND B</div><div>Combine the precedence value in register B with the precedence value in register A.</div></div>
									<div class="assembly-row-combined model1"><div>25BC-25BD</div><div>ADD A,FFH</div><div>Adjust the value in register A. This will give a 0 if both are equal and a CARRY if they are unequal.</div></div>
									<div class="assembly-row-combined model1"><div>25BE</div><div>SBC A,A</div><div>Check to see if the precedence values in registers A and B match. This will set A=0 if equal, and A+1 if unequal.</div></div>
									<div class="assembly-row-combined model1"><div>25BF-25Cl</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#098D" class="memory-link">CALL 098DH</a></div><div>Call to 098DH. This will set the current value to 00 if A is positive, and to FF if A is negative.<br>If the values match, set the current result in zero. If they do not match, set the current result to -1.</div></div>
									<div class="assembly-row-combined model1"><div>25C2-25CJ</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#25D6" class="memory-link">JR 25D6H</a></div><div>Jump forward to 25D6H to continue with the expression evaluation.</div></div>
								</div>
							</div>

							<br><h2 id="25c4-span">25C4 - <span class="code">NOT</span> Routine.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>25C4-25C5</div><div>LD D,5AH</div><div>Load register D with the precedence value.</div></div>
									<div class="assembly-row-combined model1"><div>25C6-25C8</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#233A" class="memory-link">CALL 233AH</a></div><div>Go evaluate the expression.</div></div>
									<div class="assembly-row-combined model1"><div>25C9-25CB</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0A7F" class="memory-link">CALL 0A7FH</a></div><div>Call
 the CONVERT TO INTEGER routine at 0A7FH (where the contents of REG 1 
are converted from single or double precision to integer and deposited 
into HL).</div></div>
									<div class="assembly-row-combined model1"><div>25CC</div><div>LD A,L</div><div>Load register A with the LSB of the integer value.</div></div>
									<div class="assembly-row-combined model1"><div>25CD</div><div>CPL</div><div>Compliment the LSB of the integer value in register A.</div></div>
									<div class="assembly-row-combined model1"><div>25CE</div><div>LD L,A</div><div>Load register L with the adjusted LSB of the integer value in register A.</div></div>
									<div class="assembly-row-combined model1"><div>25CF</div><div>LD A,H</div><div>Load register A with the MSB of the integer value in register H.</div></div>
									<div class="assembly-row-combined model1"><div>25D0</div><div>CPL</div><div>Compliment the MSB of the integer value in register A.</div></div>
									<div class="assembly-row-combined model1"><div>25Dl</div><div>LD H,A</div><div>Load register H with the adjusted MSB of the integer value in register A.</div></div>
									<div class="assembly-row-combined model1"><div>25D2-25D4</div><div>LD (4121H),HL</div><div>Save the complimented integer value in HL as the current result in REG 1</div></div>
									<div class="assembly-row-combined model1"><div>25D5</div><div>POP BC</div><div>Clean up the stack.</div></div>
									<div class="assembly-row-combined model1"><div>25D6-25D8</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2346" class="memory-link">JP 2346H</a></div><div>Jump back to 2346H to continue with the expression evaluation.</div></div>
								</div>
							</div>

							<br><h2 id="25d9-the-rst-20h">25D9 - The RST 20H code is located 
here. - This is the TEST DATA MODE, which determines the type of the 
current value in REG 1 and returns a combination of STATUS flags and 
unique numeric values in the A Register according to the data mode flag 
(40AFH).<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<p><font face="Courier" size="-1">
								
TYPE&nbsp;&nbsp;&nbsp;CODE&nbsp;&nbsp;&nbsp;ZERO&nbsp;&nbsp;&nbsp;CARRY&nbsp;&nbsp;&nbsp;NEG&nbsp;&nbsp;&nbsp;PARITY&nbsp;&nbsp;&nbsp;A-
Register<br>
								
INT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;02&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NZ&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;N&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;E&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-1<br>
								
STR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;03&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Z&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;P&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;E&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0<br>
								
SNG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;04&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NZ&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;C&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;P&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;O&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1<br>
								
DBL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;08&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NZ&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;P&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;E&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5

								</font></p>
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>25D9-25DBH<span class="origrom2">TSTYP</span></div><div>LD A,(40AFH)</div><div>Load register A with the current value of the number type flag.<br>Note: 40AFH holds Current number type flag.</div></div>
									<div class="assembly-row-combined model1"><div>25DC-25DD</div><div>CP 08H</div><div>Check to see if the current value in REG 1 is double precision (02=INT, 03=STR, 04=SNG, 08=DBL).</div></div>
									<div class="assembly-row-combined model1" id="25DE"><div>25DE-25DF</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#25E5" class="memory-link">JR NC,25E5H</a></div><div>If that test shows that we have a DOUBLE PRECISION number, jump forward to 25E5H.</div></div>
									<div class="assembly-row-combined model1"><div>25E0-25El</div><div>SUB 03H</div><div>If the number is not double precision, subtract 3.</div></div>
									<div class="assembly-row-combined model1"><div>25E2</div><div>OR A</div><div>Set the status flags of the adjusted number type flag in register A.</div></div>
									<div class="assembly-row-combined model1"><div>24E3</div><div>SCF</div><div>Set the Carry flag.</div></div>
									<div class="assembly-row-combined model1"><div>25E4</div><div>RET</div><div>Return.</div></div>
									<div class="assembly-row-combined model1" id="25E5"><div>25E5-25E6</div><div>SUB 03H</div><div>We are dealing with a double precision number so adjust the value of the current number type flag in register A.</div></div>
									<div class="assembly-row-combined model1"><div>25E7</div><div>OR A</div><div>Test the value of the current number type flag in register A, which will exit without the CARRY flag set.</div></div>
									<div class="assembly-row-combined model1"><div>25E8</div><div>RET</div><div>Return.</div></div>
									<div class="assembly-row-combined model1" id="25E9"><div>25E9</div><div>PUSH BC</div><div>B has he precision alue for the last operator. Save BC to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>25EA-25EC</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0A7F" class="memory-link">CALL 0A7FH</a></div><div>Call
 the CONVERT TO INTEGER routine at 0A7FH (where the contents of REG 1 
are converted from single or double precision to integer and deposited 
into HL).</div></div>
									<div class="assembly-row-combined model1"><div>25ED</div><div>POP AF</div><div>Get the operator value from the stack and put it in register A.</div></div>
									<div class="assembly-row-combined model1"><div>25EE</div><div>POP DE</div><div>Get the return address from the stack and put it in DE.</div></div>
									<div class="assembly-row-combined model1" id="25EF"><div>25EF-25F1</div><div>LD BC,27FAH</div><div>Load BC with a return address of 27FAH.</div></div>
									<div class="assembly-row-combined model1"><div>25F2</div><div>PUSH BC</div><div>Save the value of the return address in BC to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>25F3-25F4</div><div>CP 46H</div><div>Check to see if the operator value in register A is an <span class="code">OR</span> token. A CP returns Z if the test matches A and NZ otherwise.</div></div>
									<div class="assembly-row-combined model1"><div>25F5-25F6</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#25FD" class="memory-link">JR NZ,25FDH</a></div><div>Jump forward a few instructions to 25FDH (to the <span class="code">AND</span> code) if the operator value in register A isn't an <span class="code">OR</span> token.</div></div>
								</div>
							</div>

							<br><h2 id="25f7-span">25F7 - <span class="code">OR</span> logic.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>25F7</div><div>LD A,E</div><div>Load register A with the LSB of the first value in register E.</div></div>
									<div class="assembly-row-combined model1"><div>25F8</div><div>OR L</div><div>Combine the LSB of the first value in register A with the LSB of the second value in register L.</div></div>
									<div class="assembly-row-combined model1"><div>25F9</div><div>LD L,A</div><div>Load register L with the ORed value in register A.</div></div>
									<div class="assembly-row-combined model1"><div>25FA</div><div>LD A,H</div><div>Load register A with the MSB of the second value in register H.</div></div>
									<div class="assembly-row-combined model1"><div>25FB</div><div>OR D</div><div>Combine the MSB of the first value in register D with the MSB of the second value in register A.</div></div>
									<div class="assembly-row-combined model1"><div>25FC</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#27FA" class="memory-link">RET</a></div><div>Return to 27FAH (=convert the result to integer and return that integer calue to 2346H).</div></div>
								</div>
							</div>

							<br><h2 id="25fd-span">25FD - <span class="code">AND</span> logic.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>25FD</div><div>LD A,E</div><div>Load register A with the LSB of the first value in register E.</div></div>
									<div class="assembly-row-combined model1"><div>25FE</div><div>AND L</div><div>Combine the LSB of the first value in register A with the LSB of the second value in register L.</div></div>
									<div class="assembly-row-combined model1"><div>25FF</div><div>LD L,A</div><div>Load register L with the ANDed value in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2600</div><div>LD A,H</div><div>Load register A with the MSB of the second value in register H.</div></div>
									<div class="assembly-row-combined model1"><div>2601</div><div>AND D</div><div>Combine the MSB of the first value in register D with the MSB of the second value in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2602</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#27FA" class="memory-link">RET</a></div><div>Return to 27FAH (=Make the result an integer and return to 2346H).</div></div>
									<div class="assembly-row-combined model1" id="2603"><div>2603</div><div>DEC HL</div><div>Decrement the value of the BASIC program pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2604</div><div>RST 10H</div><div>We need the next character in the BASIC program so call the EXAMINE NEXT SYMBOL routine at RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The
 RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2605</div><div>RET Z</div><div>Return if this is the end of the BASIC statement.</div></div>
									<div class="assembly-row-combined model1" id="2606"><div>2606-2607</div><div>RST 08H ‚áí 2CH</div><div>Since the character at the location of the current BASIC program pointer in HL must be a <span class="code">,</span>, call the COMPARE SYMBOL routine at RST 08H.<br><br><span class="bold nobottomborder">NOTE:</span>
 The RST 08H routine compares the symbol in the input string pointed to 
by HL register to the value in the location following the RST 08 call.<ul><li>If
 there is a match, control is returned to the next execution address 
(i.e, the RST 08H instruction + 2) with the next symbol in the A 
Register and HL incremented by one.</li><li>If the two characters do not match, a syntax error message is given and control returns to the Input Phase).</li></ul></div></div>
								</div>
							</div>

							<br><h2 id="2608-span">2608 - <span class="code">DIM</span> logic.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2608-260A</div><div>LD BC,2603H</div><div>Load BC with a return address of 2603H.</div></div>
									<div class="assembly-row-combined model1"><div>260B</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2603" class="memory-link">PUSH BC</a></div><div>Save the return address of 2603H (in BC) to the stack.</div></div>
								</div>
							</div>

							<br><h2 id="260d-this-is-the">260D - This is the variable location and creation logic.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<p>This routine will return the address of a variable in memory 
or create it if it is not found. In order to use this routine, the HL 
must point to the variable name (ASCII). Then, after execution, HL will 
point to the character following the variable name and the location of 
the variable will be returned in the DE register pair. For integer, 
single or doubleprecision (NTF=2, 4 or 8) the address returned in DE 
will be the same as for the VARPTR command under BASIC. (see Level II 
BASIC manual on VARPTR) For strings (NTF=3) however the address returned
 in DE will point to the first of three bytes containing the string 
length and string address.<br>This entry point searches the Variable 
List Table (VLT) for a variable name which matches the name in the 
string pointed to by HL. If the variable exists, its address is returned
 in DE. If it is not defined, then it is created with an initial value 
ofzero and its address is returned in DE. Dimensioned and 
non-dimensioned variables may be located, and suffixs for data mode may 
be included in the name string. A byte of machine zeros must terminate 
the name string. All registers are used.</p>
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>260C-260D</div><div>OR AFH</div><div>Reset the value in register A.</div></div>
									<div class="assembly-row-combined model1"><div>260E-2610</div><div>LD (40AEH),A</div><div>Save the value in register A as the current variable location/creation flag.<br>Note: 40AEH holds LOCATE/CREATE variable flag.</div></div>
									<div class="assembly-row-combined model1"><div>2611</div><div>LD B,(HL)</div><div>Load register B with the first character of the variable name.</div></div>
									<div class="assembly-row-combined model1"><div>2612-2614</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1E3D" class="memory-link">CALL 1E3DH</a></div><div>GOSUB to 1E3DH to make sure the first character of the variable name is a letter.</div></div>
									<div class="assembly-row-combined model1"><div>2615-2617</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1997" class="memory-link">JP C,1997H</a></div><div>Display a <span class="code">?SN ERROR</span> if the first character of the variable name isn't a letter.</div></div>
									<div class="assembly-row-combined model1"><div>2618</div><div>XOR A</div><div>Zero register A.</div></div>
									<div class="assembly-row-combined model1"><div>2619</div><div>LD C,A</div><div>Zero register C.</div></div>
									<div class="assembly-row-combined model1"><div>261A</div><div>RST 10H</div><div>We need the next character in the BASIC program so call the EXAMINE NEXT SYMBOL routine at RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The
 RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1" id="2622"><div>261B-261C</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2622" class="memory-link">JR C,2622H</a></div><div>Jump to 2622H if the character at the location of the current BASIC program pointer in register A is numeric.</div></div>
									<div class="assembly-row-combined model1"><div>261D-261F</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1E3D" class="memory-link">CALL 1E3DH</a></div><div>GOSUB to 1E3DH to check to see if the character at the location of the current BASIC program pointer is a letter.</div></div>
									<div class="assembly-row-combined model1" id="262B"><div>2620-2621</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#262B" class="memory-link">JR C,262BH</a></div><div>Jump to 262BH if the character at the location of the current BASIC program pointer in register A isn't a letter.</div></div>
									<div class="assembly-row-combined model1"><div>2622</div><div>LD C,A</div><div>Load register C with the second character of the variable name in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2623</div><div>RST 10H</div><div>We
 now need bump the value of the current BASIC program pointer until it 
points to the next character, call the EXAMINE NEXT SYMBOL routine at 
RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The 
RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1" id="2623"><div>2624-2625</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2623" class="memory-link">JR C,2623H</a></div><div>Loop back one optcode until a nonnumeric character is found.</div></div>
									<div class="assembly-row-combined model1"><div>2626-2628</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1E3D" class="memory-link">CALL 1E3DH</a></div><div>Go check to see if the character at the location of the current BASIC program pointer in HL is alphabetic.</div></div>
									<div class="assembly-row-combined model1" id="2623"><div>2629-262A</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2623" class="memory-link">JR NC,2623H</a></div><div>Jump back to 2623H if the character at the location of the current BASIC program pointer in HL is alphabetic.</div></div>
									<div class="assembly-row-combined model1"><div>262B-262D</div><div>LD DE,2652H</div><div>Load DE with a return address of 2652H.</div></div>
									<div class="assembly-row-combined model1"><div>262E</div><div>PUSH DE</div><div>Save the value of the return address in DE to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>262F-2630</div><div>LD D,02H</div><div>Load register D with an integer number type flag.</div></div>
									<div class="assembly-row-combined model1"><div>2631-2632</div><div>CP 25H</div><div>Check to see if the character at the location of the current BASIC program pointer in register A is a <span class="code">%</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2633</div><div>RET Z</div><div>Return if the character at the location of the current BASIC program pointer in register A is a <span class="code">%</span>.</div></div>
									<div class="assembly-row-combined model1" id="2634"><div>2634</div><div>INC D</div><div>Bump register D so that it will be equal to a string number type flag (02=INT, 03=STR, 04=SNG, 08=DBL).</div></div>
									<div class="assembly-row-combined model1"><div>2635-2636</div><div>CP 24H</div><div>Check to see if the character at the location of the current BASIC program pointer in register A is a <span class="code">$</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2637</div><div>RET Z</div><div>Return if the character at the location of current BASIC program pointer in register A is a <span class="code">$</span>.</div></div>
									<div class="assembly-row-combined model1" id="2638"><div>2638</div><div>INC D</div><div>Bump register D so that it will be equal to a single precision number type flag (02=INT, 03=STR, 04=SNG, 08=DBL).</div></div>
									<div class="assembly-row-combined model1"><div>2639-263A</div><div>CP 21H</div><div>Check to see if the character at the location of the current BASIC program pointer in register A is a <span class="code">!</span>.</div></div>
									<div class="assembly-row-combined model1"><div>263B</div><div>RET Z</div><div>Return if the character at the location of the current BASIC program pointer in register A is a <span class="code">!</span>.</div></div>
									<div class="assembly-row-combined model1" id="263C"><div>263C-263D</div><div>LD D,08H</div><div>Load
 register D with a double precision number type flag. We have to do this
 because 04H (SNG) would bump to 05H if we just did another INC, but we 
need 08H for DBL.</div></div>
									<div class="assembly-row-combined model1"><div>263E-263F</div><div>CP 23H</div><div>Check to see if the character at the location of the current BASIC program pointer in register A is a <span class="code">#</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2640</div><div>RET Z</div><div>Return if the character at the location of the current BASIC program pointer in register A is a <span class="code">#</span>.</div></div>
									<div class="assembly-row-combined model1" id="2641"><div>2641</div><div>LD A,B</div><div>Load register A with the first character of the variable name in register B.</div></div>
									<div class="assembly-row-combined model1"><div>2642-2643</div><div>SUB 41H</div><div>Adjust the value of the first character of the variable name in register A so that it is in the range of 0 to 25.</div></div>
									<div class="assembly-row-combined model1"><div>2644-2645</div><div>AND 7FH</div><div>Make sure the sign bit in register A isn't set by ANDing it against 0111 1111.</div></div>
									<div class="assembly-row-combined model1"><div>2646</div><div>LD E,A</div><div>Load register E with the adjusted first character of the variable name in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2647-2648</div><div>LD D,00H</div><div>Load register D with zero.</div></div>
									<div class="assembly-row-combined model1"><div>2649</div><div>PUSH HL</div><div>Save the value of the current BASIC program pointer in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>264A-264C</div><div>LD HL,4101H</div><div>Load HL with the starting address of the variable declaration table.<br><span class="nobottomborder bold">NOTE:</span> 4101H-411AH holds Variable Declaration Table.</div></div>
									<div class="assembly-row-combined model1"><div>264D</div><div>ADD HL,DE</div><div>Add the value of the first character of the variable name in DE to the starting address of the variable declaration table in HL.</div></div>
									<div class="assembly-row-combined model1"><div>264E</div><div>LD D,(HL)</div><div>Load register D with the number type value at the location of the variable declaration table pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>264F</div><div>POP HL</div><div>Get the value of the current BASIC program pointer from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2650</div><div>DEC HL</div><div>Decrement the value of the current BASIC program pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2651</div><div>RET</div><div>Return with data type in D.</div></div>
									<div class="assembly-row-combined model1" id="2652"><div>2652</div><div>LD A,D</div><div>Load register A with the value of the number type flag in register D.</div></div>
									<div class="assembly-row-combined model1"><div>2653-2655</div><div>LD (40AFH),A</div><div>Save the number type flag for the current variable name in register A.<br><span class="nobottomborder bold">NOTE:</span> 40AFH holds Current number type flag.</div></div>
									<div class="assembly-row-combined model1"><div>2656</div><div>RST 10H</div><div>We need the next character in the BASIC program so call the EXAMINE NEXT SYMBOL routine at RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The
 RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2657-2659</div><div>LD A,(40DCH)</div><div>Load register A with the <span class="code">FOR</span> flag.<br>Note: 40DCH holds <span class="code">FOR</span> flag.</div></div>
									<div class="assembly-row-combined model1"><div>265A</div><div>OR A</div><div>Test the value of the <span class="code">FOR</span> flag in register A.</div></div>
									<div class="assembly-row-combined model1"><div>265B-265D</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2664" class="memory-link">JP NZ,2664H</a></div><div>Jump to 2664H if a <span class="code">FOR</span> statement is being processed.</div></div>
									<div class="assembly-row-combined model1"><div>265E</div><div>LD A,(HL)</div><div>Re-
fetch the next element of the code string by loading register A with the
 character at the location of the current BASIC program pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>265F-2660</div><div>SUB 28H</div><div>Check to see if the character at the location of the current BASIC program pointer in register A is a <span class="code">(</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2661-2663</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#26E9" class="memory-link">JP Z,26E9H</a></div><div>Jump to 26E9H if the character at the location of the current BASIC program pointer in register A is a <span class="code">(</span> (meaning, it is a subscripted variable).</div></div>
									<div class="assembly-row-combined model1"><div>2664</div><div>XOR A</div><div>Zero register A.</div></div>
									<div class="assembly-row-combined model1"><div>2665-2667</div><div>LD (40DCH),A</div><div>Set the array flag to 'no subscript'.<br>Note: 40DCH holds <span class="code">FOR</span> flag.</div></div>
									<div class="assembly-row-combined model1"><div>2668</div><div>PUSH HL</div><div>Save the value of the current BASIC program pointer in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2669</div><div>PUSH DE</div><div>Save the number type flag for the variable in DE to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>266A-266C</div><div>LD HL,(40F9H)</div><div>Load HL with the value of the simple variables pointer.<br><ul><li>Note: 40F9H-40FAH holds the starting address of the simple variable storage area.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>266D</div><div>EX DE,HL</div><div>Load DE with the simple variables pointer in HL. We don't care what happens to HL.</div></div>
									<div class="assembly-row-combined model1"><div>266E-2670</div><div>LD HL,(40FBH)</div><div>Load HL with the array variables pointer.<br><ul><li>Note: 40FBH-40FCH holds the starting address of the BASIC array variable storage area.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2671</div><div>RST 18H</div><div>Now
 we need to compare the value of the simple variables pointer in DE with
 the array variables pointer in HL, so we call the COMPARE DE:HL routine
 at RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The
 RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2672</div><div>POP HL</div><div>Get the number type flag for the variable from stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2673-2674</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#268E" class="memory-link">JR Z,268EH</a></div><div>Jump
 to 268EH if the simple variables pointer in DE is greater than or equal
 to the array variables pointer (meaning the variable wasn't defined).</div></div>
									<div class="assembly-row-combined model1"><div>2675</div><div>LD A,(DE)</div><div>Load register A with the number type flag for the variable at the location of the simple variables pointer in DE.</div></div>
									<div class="assembly-row-combined model1"><div>2676</div><div>LD L,A</div><div>Load register L with the number type flag in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2677</div><div>CP H</div><div>Compare the number type flag for the variable in register H to the number type flag in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2678</div><div>INC DE</div><div>Bump the value of the current simple variables pointer in DE to the 2nd character name for this entry.</div></div>
									<div class="assembly-row-combined model1"><div>2679-267A</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2686" class="memory-link">JR NZ,2686H</a></div><div>Jump to 2686H (i..e, the next variable in the list) if the number type flags don't match.</div></div>
									<div class="assembly-row-combined model1"><div>267B</div><div>LD A,(DE)</div><div>Since
 the type matches, compare the 2nd character of the name by loading 
register A with the first character of variable name at the location of 
the simple variables pointer in DE.</div></div>
									<div class="assembly-row-combined model1"><div>267C</div><div>CP C</div><div>Compare
 the character at the location of the simple variables pointer in 
register A with the first character of the variable name in register C.</div></div>
									<div class="assembly-row-combined model1"><div>267D-2637</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2686" class="memory-link">JR NZ,2686H</a></div><div>Jump to 2686H if the first characters of the variable names don't match.</div></div>
									<div class="assembly-row-combined model1"><div>267F</div><div>INC DE</div><div>Bump the value of the current simple variables pointer in DE.</div></div>
									<div class="assembly-row-combined model1"><div>2680</div><div>LD A,(DE)</div><div>Load register A with the second character of the variable name at the location of the simple variables pointer in DE.</div></div>
									<div class="assembly-row-combined model1"><div>2681</div><div>CP B</div><div>Compare
 the character at the location of the simple variables pointer in 
register A with the first character of the variable name in register B.</div></div>
									<div class="assembly-row-combined model1"><div>2682-2684</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#26CC" class="memory-link">JP Z,26CCH</a></div><div>Jump
 to 26CCH if the character at the location of the simple variables 
pointer in register A matches the first character of the variable name 
in register B.</div></div>
									<div class="assembly-row-combined model1"><div>2685-2686</div><div>LD A,13H</div><div>Z-80 Trick to skip the next INC DE if continuing through.</div></div>
									<div class="assembly-row-combined model1"><div>2686</div><div>INC DE</div><div>Bump to the next entry in the simple variable list part 1.</div></div>
									<div class="assembly-row-combined model1"><div>2687</div><div>INC DE</div><div>Bump the value of the simple variables pointer in DE part 2.</div></div>
									<div class="assembly-row-combined model1"><div>2688</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2672" class="memory-link">PUSH HL</a></div><div>Save the number type flag for the variable in HL to the stack so that it can be re-loaded at 2672H.</div></div>
									<div class="assembly-row-combined model1"><div>2689-268A</div><div>LD H,00H</div><div>Load register H with zero.</div></div>
									<div class="assembly-row-combined model1"><div>268B</div><div>ADD HL,DE</div><div>Add the value of the simple variables pointer in DE to the value of the number type flag in HL.</div></div>
									<div class="assembly-row-combined model1"><div>268C-268D</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#266D" class="memory-link">JR 266DH</a></div><div>Loop back to 266DH.</div></div>
									<div class="assembly-row-combined model1"><div>268E</div><div>LD A,H</div><div>Load register A with the number type flag for the variable in register H.</div></div>
									<div class="assembly-row-combined model1"><div>268F</div><div>POP HL</div><div>Get the value of the current BASIC program pointer from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2690</div><div>EX (SP),HL</div><div>Exchange the value of the current BASIC program pointer in HL with the value to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2691</div><div>PUSH AF</div><div>Save the number type flag for the variable in register A to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2692</div><div>PUSH DE</div><div>Save the start of the array variables pointer in DE to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2693-2695</div><div>LD DE,24F1H</div><div>Load DE with a VARPTR locator return address of 24F1H.</div></div>
									<div class="assembly-row-combined model1"><div>2696</div><div>RST 18H</div><div>Now we need to compare the return address in DE with the return address in HL, so we call the COMPARE DE:HL routine at RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The
 RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2697-2698</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#26CF" class="memory-link">JR Z,26CFH</a></div><div>Jump forward to 26CFH if this routine is called from the VARPTR routine.</div></div>
									<div class="assembly-row-combined model1"><div>2699-269B</div><div>LD DE,2543H</div><div>Load DE with a return address of the find address of variables routine at 2543H.</div></div>
									<div class="assembly-row-combined model1"><div>269C</div><div>RST 18H</div><div>We
 need to see if we were called from the 'find address of variable' 
routine so we need to compare the return address in DE with the return 
address in HL, so we call the COMPARE DE:HL routine at RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The
 RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>269D</div><div>POP DE</div><div>Get the value of the array variables pointer from the stack and put it in DE.</div></div>
									<div class="assembly-row-combined model1"><div>269E-269F</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#26D5" class="memory-link">JR Z,26D5H</a></div><div>Jump to 26D5H if this routine is called to locate the variables address.</div></div>
									<div class="assembly-row-combined model1"><div>26A0</div><div>POP AF</div><div>Clear the stack and put the value of the number type flag for the variable from the stack and put it in register A.</div></div>
									<div class="assembly-row-combined model1"><div>26Al</div><div>EX (SP),HL</div><div>Exchange the value of the current BASIC program pointer to the stack with the value of the return address in HL.</div></div>
									<div class="assembly-row-combined model1"><div>26A2</div><div>PUSH HL</div><div>Save the value of the current BASIC program pointer in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>26A3</div><div>PUSH BC</div><div>Save the variable's name in BC to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>26A4</div><div>LD C,A</div><div>Load register C with the value of the number type flag for the variable in register A.</div></div>
									<div class="assembly-row-combined model1"><div>26A5-26A6</div><div>LD B,00H</div><div>Load register B with zero.</div></div>
									<div class="assembly-row-combined model1"><div>26A7</div><div>PUSH BC</div><div>Save the variable's number type flag in BC to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>26A8</div><div>INC BC</div><div>Bump the value of the variable's number type flag in BC.</div></div>
									<div class="assembly-row-combined model1"><div>26A9</div><div>INC BC</div><div>Bump the value of the variable's number type flag in BC.</div></div>
									<div class="assembly-row-combined model1"><div>26AA</div><div>INC BC</div><div>Bump
 the value of the variable's number type flag in BC. Now that we are 
done bumping BC, we have the type + 3 (which is 3 bytes of overhead and a
 spare for the variable).</div></div>
									<div class="assembly-row-combined model1"><div>26AB-26AD</div><div>LD HL,(40FDH)</div><div>Load HL with the value of the free memory pointer.<br>Note: 40FDH-40FEH holds Free memory pointer.</div></div>
									<div class="assembly-row-combined model1"><div>26AE</div><div>PUSH HL</div><div>Save the value of the free memory pointer in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>26AF</div><div>ADD HL,BC</div><div>Add the value of the variable's number type flag in BC to the value of the free memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>26B0</div><div>POP BC</div><div>Get the value of the free memory pointer from the stack and put it in BC.</div></div>
									<div class="assembly-row-combined model1"><div>26Bl</div><div>PUSH HL</div><div>Save the value of the new free memory pointer in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>26B2-26B4</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1955" class="memory-link">CALL 1955H</a></div><div>Move the array variables up in memory.</div></div>
									<div class="assembly-row-combined model1"><div>26B5</div><div>POP HL</div><div>Get the value of the new free memory pointer from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>26B6-26B8</div><div>LD (40FDH),HL</div><div>Save the value of the new free memory pointer in HL to lock in that variable space.<br><span class="nobottomborder bold">NOTE:</span> 40FDH-40FEH holds Free memory pointer.</div></div>
									<div class="assembly-row-combined model1"><div>26B9</div><div>LD H,B</div><div>Load register H with the MSB of the new array variables pointer in register B.</div></div>
									<div class="assembly-row-combined model1"><div>26BA</div><div>LD L,C</div><div>Load register L with the LSB of the new array variables pointer in register C.</div></div>
									<div class="assembly-row-combined model1"><div>26BB-26BD</div><div>LD (40FBH),HL</div><div>Save the value of the new array variables pointer in HL.<br><ul><li>Note: 40FBH-40FCH holds the starting address of the BASIC array variable storage area.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>26BE</div><div>DEC HL</div><div>Decrement the value of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>26BF-26C0</div><div>LD (HL),00H</div><div>Zero the location of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>26Cl</div><div>RST 18H</div><div>Now we need to check to see if the variable has been completely zeroed, so we call the COMPARE DE:HL routine at RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The
 RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>26C2-26CJ</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#26BE" class="memory-link">JR NZ,26BEH</a></div><div>Loop back to 26BEH until the variable has been cleared.</div></div>
									<div class="assembly-row-combined model1"><div>26C4</div><div>POP DE</div><div>Get the value of the variable's number type flag from the stack and put it in DE.</div></div>
									<div class="assembly-row-combined model1"><div>26C5</div><div>LD (HL),E</div><div>Save the value of the number type flag in register E at the location of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>26C6</div><div>INC HL</div><div>Bump the value of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>26C7</div><div>POP DE</div><div>Get the 2nd character of the variable's name from the stack and put it in DE.</div></div>
									<div class="assembly-row-combined model1"><div>26C8</div><div>LD (HL),E</div><div>Save the first character of the variable's name in register E at the location of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>26C9</div><div>INC HL</div><div>Bump the value of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>26CA</div><div>LD (HL),D</div><div>Save the first character of the variable's name in register D at the location of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>26CB</div><div>EX DE,HL</div><div>Load DE with the value of the variable pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>26CC</div><div>INC DE</div><div>Bump the value of the variable pointer in DE.</div></div>
									<div class="assembly-row-combined model1"><div>26CD</div><div>POP HL</div><div>Get the value of the current BASIC program pointer from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>26CE</div><div>RET</div><div>Return.</div></div>
									<div class="assembly-row-combined model1" id="26CF"><div>26CF</div><div>LD D,A</div><div>Load register D with the value of the current number type flag in register A.</div></div>
									<div class="assembly-row-combined model1"><div>26D0</div><div>LD E,A</div><div>Load register E with the value of the current number type flag in register A.</div></div>
									<div class="assembly-row-combined model1"><div>26D1</div><div>POP AF</div><div>Clean up the stack.</div></div>
									<div class="assembly-row-combined model1"><div>26D2</div><div>POP AF</div><div>Clean up the stack.</div></div>
									<div class="assembly-row-combined model1"><div>26D3</div><div>EX (SP),HL</div><div>Exchange the value of the return address in HL with the value of the current BASIC program pointer to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>26D4</div><div>RET</div><div>Return to the <span class="code">VARPTR</span> routine.</div></div>
								</div>
							</div>

							<br><h2 id="26d5-this-routine">26D5 - This routine is to locate a subscripted variable.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>26D5-26D7</div><div>LD (4124H),A</div><div>Zero REG 1.</div></div>
									<div class="assembly-row-combined model1"><div>26D8</div><div>POP BC</div><div>Clean up the stack.</div></div>
									<div class="assembly-row-combined model1"><div>26D9</div><div>LD H,A</div><div>Zero register H.</div></div>
									<div class="assembly-row-combined model1"><div>26DA</div><div>LD L,A</div><div>Zero register L.</div></div>
									<div class="assembly-row-combined model1"><div>26DB-26DD</div><div>LD (4121H),HL</div><div>Zero the string pointer location in REG 1.</div></div>
									<div class="assembly-row-combined model1"><div>26DE</div><div>RST 20H</div><div>We need to check the value of the current number type flag, so we call the TEST DATA MODE routine at RST 20H.<br><span class="nobottomborder bold">NOTE:</span>
  The RST 20H routine determines the type of the current value in REG 1 
and returns a combination of STATUS flags and unique numeric values in 
the A Register according to the data mode flag (40AFH).<br><br>The results are returned as follows:<table style="border-collapse: collapse; border: 1px solid black;"><tbody><tr style="background-color: #f0f0f0;"><td style="border: 1px solid black; padding: 8px;">If the Variable Type is ...</td><td style="border: 1px solid black; padding: 8px;">and the Flags<br>are set ...</td><td style="border: 1px solid black; padding: 8px;">... then Register<br>A will be set ...</td></tr><tr><td style="border: 1px solid black; padding: 8px;">Integer</td><td style="border: 1px solid black; padding: 8px;">NZ/C/M/E</td><td style="border: 1px solid black; padding: 8px;">-1</td></tr><tr><td style="border: 1px solid black; padding: 8px;">String</td><td style="border: 1px solid black; padding: 8px;">Z/C/P/E</td><td style="border: 1px solid black; padding: 8px;">0</td></tr><tr><td style="border: 1px solid black; padding: 8px;">Single Precision</td><td style="border: 1px solid black; padding: 8px;">NZ/C/P/O</td><td style="border: 1px solid black; padding: 8px;">1</td></tr><tr><td style="border: 1px solid black; padding: 8px;">Double Precision</td><td style="border: 1px solid black; padding: 8px;">NZ/NC/P/E</td><td style="border: 1px solid black; padding: 8px;">5</td></tr></tbody></table></div></div>
									<div class="assembly-row-combined model1"><div>26DF-26E0</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#26E7" class="memory-link">JR NZ,26E7H</a></div><div>If that test shows we do NOT have a STRING, jump to 26E7H.</div></div>
									<div class="assembly-row-combined model1"><div>26E1-26E3</div><div>LD HL,1928H</div><div>Load HL with the starting address of the Level II BASIC READY message.</div></div>
									<div class="assembly-row-combined model1"><div>26E4-26E6</div><div>LD (4121H),HL</div><div>Save the value in HL as the current string pointer.</div></div>
									<div class="assembly-row-combined model1"><div>26E7</div><div>POP HL</div><div>Get the value of the current BASIC program pointer from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>26E8</div><div>RET</div><div>Return.</div></div>
								</div>
							</div>

							<br><h2 id="26e9-this-routine">26E9 - This routine locates the address of a subscripted variable.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<p>On entry D = the type of variable, B = the 1st character of 
the variable name, C = the 2nd character of the variable name, and HL = 
the current position in the input string.</p>
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>26E9</div><div>PUSH HL</div><div>Save the value of the current BASIC program pointer in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>26EA-26EC</div><div>LD HL,(40AEH)</div><div>Load HL with the value of the locate/create flag.<br>Note: 40AEH holds LOCATE/CREATE variable flag and will be a 0 if in locate mode and anything other than zero if in create mode.</div></div>
									<div class="assembly-row-combined model1"><div>26ED</div><div>EX (SP),HL</div><div>Exchange the value of the locate/create flag in HL with the value of the current BASIC program pointer to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>26EE</div><div>LD D,A</div><div>Zero register D.</div></div>
									<div class="assembly-row-combined model1"><div>26EF</div><div>PUSH DE</div><div>Save the variable's number type flag in DE to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>26F0</div><div>PUSH BC</div><div>Save the variable's name in BC to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>26Fl-26F3</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1E45" class="memory-link">CALL 1E45H</a></div><div>Go evaluate the array subscript at the location of the current BASIC program pointer in HL up to a <span class="code">)</span> or <span class="code">,</span>. Return with the binary value in DE.</div></div>
									<div class="assembly-row-combined model1"><div>26F4</div><div>POP BC</div><div>Get the variable's name from the stack (1st and 2nd character) and put it in BC.</div></div>
									<div class="assembly-row-combined model1"><div>26F5</div><div>POP AF</div><div>Get the variable's number type flag from the stack and put it in register A.</div></div>
									<div class="assembly-row-combined model1"><div>26F6</div><div>EX DE,HL</div><div>Exchange the value of the array subscript in DE with the value of the current BASIC program pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>26F7</div><div>EX (SP),HL</div><div>Exchange the value of the array subscript in HL with the value of the locate/create flag to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>26F8</div><div>PUSH HL</div><div>Save the value of the locate/create flag in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>26F9</div><div>EX DE,HL</div><div>Exchange the value of the locate/create flag in HL with the value of the current BASIC program pointer in DE.</div></div>
									<div class="assembly-row-combined model1"><div>26FA</div><div>INC A</div><div>Bump the number of subscripts evaluated in register A.</div></div>
									<div class="assembly-row-combined model1"><div>26FB</div><div>LD D,A</div><div>Load register D with the number of subscripts evaluated in register A.</div></div>
									<div class="assembly-row-combined model1"><div>26FC</div><div>LD A,(HL)</div><div>Load register A with the character at the location of the current BASIC program pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>26FD-26FE</div><div>CP 2CH</div><div>Check to see if the character at the location of the current BASIC program pointer in register A is a <span class="code">,</span>.</div></div>
									<div class="assembly-row-combined model1"><div>26FF-2700</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#26EF" class="memory-link">JR Z,26EFH</a></div><div>Jump if the character at the location of the current BASIC program pointer in register A is a <span class="code">,</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2701-2702</div><div>RST 08H ‚áí 29H</div><div>Since the character at the location of the current BASIC program pointer in HL must be a <span class="code">)</span>, call the COMPARE SYMBOL routine at RST 08H.<br><br><span class="bold nobottomborder">NOTE:</span>
 The RST 08H routine compares the symbol in the input string pointed to 
by HL register to the value in the location following the RST 08 call.<ul><li>If
 there is a match, control is returned to the next execution address 
(i.e, the RST 08H instruction + 2) with the next symbol in the A 
Register and HL incremented by one.</li><li>If the two characters do not match, a syntax error message is given and control returns to the Input Phase).</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2703-2705</div><div>LD (40F3H),HL</div><div>Save the value of the current BASIC program pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2706</div><div><a href="#40F3" class="memory-link">POP HL</a></div><div>Get the value of the locate/ create flag from the stack and put it in HL.<br><span class="nobottomborder bold">NOTE:</span> 40F3H-40F4H holds Temporary storage location.</div></div>
									<div class="assembly-row-combined model1"><div>2707-2709</div><div>LD (40AEH),HL</div><div>Save the value of the locate/create flag in HL.<br><span class="nobottomborder bold">NOTE:</span> 40AEH holds LOCATE/CREATE variable flag.</div></div>
									<div class="assembly-row-combined model1"><div>270A</div><div>PUSH DE</div><div>Save the number of subscripts evaluated in DE.</div></div>
									<div class="assembly-row-combined model1"><div>270B-270D</div><div>LD HL,(40FBH)</div><div>Load HL with the value of the array variables pointer.<br><ul><li>Note: 40FBH-40FCH holds the starting address of the BASIC array variable storage area.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>270E-270F</div><div>LD A,19H</div><div>Z-80 Trick to skip the next command of ADD HL, DE if falling through.</div></div>
									<div class="assembly-row-combined model1"><div>270F</div><div><a href="#40FB" class="memory-link">ADD HL,DE</a></div><div>Figure the end of the array. Note: 40FBH-40FCH holds the array variables pointer.</div></div>
									<div class="assembly-row-combined model1"><div>2710</div><div>EX DE,HL</div><div>Load DE with the value of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2711-2713</div><div>LD HL,(40FDH)</div><div>Load HL with the value of the free memory pointer.<br>Note: 40FDH-40FEH holds Free memory pointer.</div></div>
									<div class="assembly-row-combined model1"><div>2714</div><div>EX DE,HL</div><div>Exchange the value of the free memory pointer in HL with the value of the array variables pointer in DE.</div></div>
									<div class="assembly-row-combined model1"><div>2715</div><div>RST 18H</div><div>Now
 we need to compare the value of the free memory pointer in DE to the 
value of the array variables pointer in HL, so we call the COMPARE DE:HL
 routine at RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The
 RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2716-2718</div><div>LD A,(40AFH)</div><div>Load register A with the value of the current number type flag.<br>Note: 40AFH holds Current number type flag.</div></div>
									<div class="assembly-row-combined model1"><div>2719-271A</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2742" class="memory-link">JR Z,2742H</a></div><div>Jump
 forward out of this loop to 2742H if the array variables pointer in HL 
is greater than or equal to the value of the free memory pointer in DE.</div></div>
									<div class="assembly-row-combined model1"><div>271B</div><div>CP (HL)</div><div>Compare
 the value of the variable's number type flag in register A with the 
value of the number type flag at the location of the array variables 
pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>271C</div><div>INC HL</div><div>Bump the value of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>271D-271E</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2727" class="memory-link">JR NZ,2727H</a></div><div>Jump forward (but still in this loop) to 2727H if the number type flags don't match.</div></div>
									<div class="assembly-row-combined model1"><div>271F</div><div>LD A,(HL)</div><div>Load register A with the first character of the variable name at the location of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2720</div><div>CP C</div><div>Check
 to see if the first character of the variable at the location of the 
array variable pointer in register A matches the first character of the 
variable name in register C.</div></div>
									<div class="assembly-row-combined model1"><div>2721</div><div>INC HL</div><div>Bump the value of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2722-2723</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2728" class="memory-link">JR NZ,2728H</a></div><div>Jump forward (but still in this loop) to 2728H if the first characters of the variable names don't match.</div></div>
									<div class="assembly-row-combined model1"><div>2724</div><div>LD A,(HL)</div><div>Load register A with the second character of the variable name at the location of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2725</div><div>CP B</div><div>Compare
 the second character of the variable name at the location of the array 
variables pointer in register A matches the second character of the 
variable name in register B.</div></div>
									<div class="assembly-row-combined model1"><div>2727</div><div>LD A,23H</div><div>Bump the value of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2728</div><div>INC HL</div><div>Bump the value of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2729</div><div>LD E,(HL)</div><div>Load register E with the LSB of the offset to the next array at the location of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>272A</div><div>INC HL</div><div>Bump the value of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>272B</div><div>LD D,(HL)</div><div>Load register D with the MSB of the offset to the next array at the location of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>272C</div><div>INC HL</div><div>Bump the value of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>272D-272E</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#270F" class="memory-link">JR NZ,270FH</a></div><div>Jump back to 270FH if the variables' names don't match.</div></div>
									<div class="assembly-row-combined model1"><div>272F-2731</div><div>LD A,(40AEH)</div><div>Load register A with the value of the locate/create flag.<br>Note: 40AEH holds LOCATE/CREATE variable flag.</div></div>
									<div class="assembly-row-combined model1"><div>2732</div><div>OR A</div><div>Check the status of the locate/create flag in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2733-2734</div><div>LD E,12H</div><div>Load register E with the <span class="code">?DD ERROR</span> code.</div></div>
									<div class="assembly-row-combined model1"><div>2735-2737</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#19A2" class="memory-link">JP NZ,19A2H</a></div><div>Display a <span class="code">?DD ERROR</span> message if the locate/create flag in register A indicates the create mode since that variable already exists.</div></div>
									<div class="assembly-row-combined model1"><div>2738</div><div>POP AF</div><div>Get the number of subscripts evaluated from the stack and put it in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2739</div><div>SUB (HL)</div><div>Compare
 the number of subscripts evaluated in register A with the number of 
subscripts for the array at the location of the array variables pointer 
in HL (meaning, the number which was <span class="code">DIM</span>med).</div></div>
									<div class="assembly-row-combined model1"><div>273A-273C</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2795" class="memory-link">JP Z,2795H</a></div><div>Jump
 down to 2795H if the number of subscripts evaluated in register A 
matches the number of subscripts for the array at the location of the 
array variables pointer in HL.</div></div>
								</div>
							</div>

							<br><h2 id="273d-bs-error-entry">273D - BS ERROR entry point.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>273D-273E</div><div>LD E,10H</div><div>Load register E with a <span class="code">?BS ERROR</span> code.</div></div>
									<div class="assembly-row-combined model1"><div>273F-2741</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#19A2" class="memory-link">JP 19A2H</a></div><div>Display a <span class="code">?BS ERROR</span>
 message if the number of subscripts evaluated in register A doesn't 
match the number of subscripts for the array at the location of the 
array variable pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2742</div><div>LD (HL),A</div><div>Save the number of subscripts for the array in register A at the location of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2743</div><div>INC HL</div><div>Bump
 the value of the array variables pointer in HL so it points to the 2nd 
character in the variable name (since they are saved in last, first 
order).</div></div>
									<div class="assembly-row-combined model1"><div>2744</div><div>LD E,A</div><div>Load register E with the number type flag for the current variable.</div></div>
									<div class="assembly-row-combined model1"><div>2745-2746</div><div>LD D,00H</div><div>Zero register D.</div></div>
									<div class="assembly-row-combined model1"><div>2747</div><div>POP AF</div><div>Get the number of subscripts evaluated from the stack and put it in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2748</div><div>LD (HL),C</div><div>Save the second character of the variable's name in register C at the location of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2749</div><div>INC HL</div><div>Bump
 the value of the array variables pointer in HL to now point to the 1st 
character in the variable name (since they are saved in last, first 
order).</div></div>
									<div class="assembly-row-combined model1"><div>274A</div><div>LD (HL),B</div><div>Save the first character of the variable's name in register B at the location of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>274B</div><div>INC HL</div><div>Bump the value of the array variables pointer in HL to the LSB of the offset to the next entry.</div></div>
									<div class="assembly-row-combined model1"><div>274C</div><div>LD C,A</div><div>Load register C with the number of subscripts evaluated in register A.</div></div>
									<div class="assembly-row-combined model1"><div>274D-274F</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1963" class="memory-link">CALL 1963H</a></div><div>Figure the amount of memory space left between HL and the free memory.</div></div>
									<div class="assembly-row-combined model1"><div>2750</div><div>INC HL</div><div>Bump the value of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2751</div><div>INC HL</div><div>Bump the value of the array variables pointer in HL. These 2 INC's skip over the offset entry.</div></div>
									<div class="assembly-row-combined model1"><div>2752-2754</div><div>LD (40D8H),HL</div><div>Save the value of the array variables pointer in HL to 40D8H (which is the address of the maximum number of indices).<br>Note: 40D8H-40D9H holds temporary storage location.</div></div>
									<div class="assembly-row-combined model1"><div>2755</div><div>LD (HL),C</div><div>Save the number of subscripts evaluated in register C (1, 2, or 3) at the location of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2756</div><div>INC HL</div><div>Bump the value of the array variables pointer in HL to point to the first subscript entry in the array table.</div></div>
									<div class="assembly-row-combined model1"><div>2757-2759</div><div>LD A,(40AEH)</div><div>Load register A with the value of the locate/create flag.<br>Note: 40AEH holds LOCATE/CREATE variable flag.</div></div>
									<div class="assembly-row-combined model1"><div>275A</div><div>RLA</div><div>Set the CARRY flag to be 0 for locate and 1 for create.</div></div>
									<div class="assembly-row-combined model1"><div>275B</div><div>LD A,C</div><div>Load register A with the number of subscripts evaluated in register C.</div></div>
									<div class="assembly-row-combined model1"><div>275C-275E</div><div>LD BC,000BH</div><div>Load BC with the default number of 11, which is the most entries an array can have without a <span class="code">DIM</span>.</div></div>
									<div class="assembly-row-combined model1" id="275F"><div>275F-2760</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2763" class="memory-link">JR NC,2763H</a></div><div>Jump forward to 2763H if the array is being created because it certainly wasn't found.</div></div>
									<div class="assembly-row-combined model1"><div>2761</div><div>POP BC</div><div>Get a subscript from the stack and put it in BC.</div></div>
									<div class="assembly-row-combined model1"><div>2762</div><div>INC BC</div><div>Bump the value of the subscript in BC.</div></div>
									<div class="assembly-row-combined model1"><div>276J</div><div>LD (HL),C</div><div>Save the LSB of the subscript's value in register C at the location of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2764</div><div>INC HL</div><div>Bump the value of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2765</div><div>LD (HL),B</div><div>Save the MSB of the subscript's value in register B at the location of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2766</div><div>INC HL</div><div>Bump the value of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2767</div><div>PUSH AF</div><div>Save the number of subscripts evaluated in register A to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2768-276A</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0BAA" class="memory-link">CALL 0BAAH</a></div><div>Go
 multiply the size of the subscript by the value of the number type flag
 to determine the amount of memory necessary for the subscript.</div></div>
									<div class="assembly-row-combined model1"><div>276B</div><div>POP AF</div><div>Get the number of subscripts evaluated from the stack and put it in register A.</div></div>
									<div class="assembly-row-combined model1"><div>276C</div><div>DEC A</div><div>Check to see if there are anymore subscripts to be evaluated.</div></div>
									<div class="assembly-row-combined model1"><div>276D-276E</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#275C" class="memory-link">JR NZ,275CH</a></div><div>Jump back to 275CH if there are anymore subscripts to be evaluated.</div></div>
									<div class="assembly-row-combined model1"><div>276F</div><div>PUSH AF</div><div>Save the number of subscripts to be evaluated in register A to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2770</div><div>LD B,D</div><div>Load register B with the MSB of the array's length in register D.</div></div>
									<div class="assembly-row-combined model1"><div>2771</div><div>LD C,E</div><div>Load register C with the LSB of the array's length in register E. Now BC = length of the array in bytes.</div></div>
									<div class="assembly-row-combined model1"><div>2772</div><div>EX DE,HL</div><div>Load DE with the value of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2773</div><div>ADD HL,DE</div><div>Add the length of the array in HL to the value of the array variable pointer in DE.</div></div>
									<div class="assembly-row-combined model1" id="2774"><div>2774-2775</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#273D" class="memory-link">JR C,273DH</a></div><div>Jump back to 273DH if overflow occurred.</div></div>
									<div class="assembly-row-combined model1"><div>2776-2778</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#196C" class="memory-link">CALL 196CH</a></div><div>Go check to see if there is enough memory for the array.</div></div>
									<div class="assembly-row-combined model1"><div>2779-277B</div><div>LD (40FDH),HL</div><div>Get the end of the array and put it in HL.<br>Note: 40FDH-40FEH holds free memory pointer.</div></div>
									<div class="assembly-row-combined model1"><div>277C</div><div>DEC HL</div><div>Decrement the value of the array pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>277D-277E</div><div>LD (HL),00H</div><div>Zero the location of the array pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>277F</div><div>RST 18H</div><div>Now
 we need to compare the array pointer in HL with the array variables 
pointer in DE, so we call the COMPARE DE:HL routine at RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The
 RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2780-2781</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#277C" class="memory-link">JR NZ,277CH</a></div><div>Loop until the array has been cleared.</div></div>
									<div class="assembly-row-combined model1"><div>2782</div><div>INC BC</div><div>Load BC with the array's length in bytes plus one.</div></div>
									<div class="assembly-row-combined model1"><div>2783</div><div>LD D,A</div><div>Zero register D.</div></div>
									<div class="assembly-row-combined model1"><div>2784-2786</div><div>LD HL,(40D8H)</div><div>Load HL with the array variables pointer (=the number of indices).<br>Note: 40D8H-40D9H holds Temporary storage location.</div></div>
									<div class="assembly-row-combined model1"><div>2787</div><div>LD E,(HL)</div><div>Load register E with the number of subscripts for the array at the location of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2788</div><div>EX DE,HL</div><div>Exchange the value of the array variables pointer in HL with the number of subscripts for the array in DE.</div></div>
									<div class="assembly-row-combined model1"><div>2789</div><div>ADD HL,HL</div><div>Multiply the number of subscripts for the array in HL by two.</div></div>
									<div class="assembly-row-combined model1"><div>278A</div><div>ADD HL,BC</div><div>Add the length of the array in BC to the number of subscripts times two in HL.</div></div>
									<div class="assembly-row-combined model1"><div>278B</div><div>EX DE,HL</div><div>Exchange the array's length in HL with the array variables pointer in DE.</div></div>
									<div class="assembly-row-combined model1"><div>278C</div><div>DEC HL</div><div>Decrement the value of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>278D</div><div>DEC HL</div><div>Decrement the value of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>278E</div><div>LD (HL),E</div><div>Save the LSB of the offset to the next array in register E at the location of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>278F</div><div>INC HL</div><div>Bump the value of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2790</div><div>LD (HL),D</div><div>Save the MSB of the offset to the next array in register D at the location of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2791</div><div>INC HL</div><div>Bump the value of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2792</div><div>POP AF</div><div>Get the value of the locate/ create flag from the stack and put it in register A.</div></div>
									<div class="assembly-row-combined model1" id="2793"><div>2793-2794</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#27C5" class="memory-link">JR C,27C5H</a></div><div>Jump forward to 27C5H if the array is being created.</div></div>
									<div class="assembly-row-combined model1"><div>2795</div><div>LD B,A</div><div>Zero register B.</div></div>
									<div class="assembly-row-combined model1"><div>2796</div><div>LD C,A</div><div>Zero register C.</div></div>
									<div class="assembly-row-combined model1"><div>2797</div><div>LD A,(HL)</div><div>Load register A with the number of subscripts for the array at the location of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2798</div><div>INC HL</div><div>Bump the value of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2799</div><div>16H E1</div><div>Z-80 Trick to hide the next instruction (POP HL) if proceeding downward.</div></div>
									<div class="assembly-row-combined model1"><div>279A</div><div>POP HL</div><div>Get the array variables pointer from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>279B</div><div>LD E,(HL)</div><div>Load register E with the LSB of the subscript limit at the location of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>279C</div><div>INC HL</div><div>Bump the value of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>279D</div><div>LD D,(HL)</div><div>Load register D with the MSB of the subscript limit at the location of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>279E</div><div>INC HL</div><div>Bump the value of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>279F</div><div>EX (SP),HL</div><div>Exchange the value of the array variables pointer in HL with the subscript to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>27A0</div><div>PUSH AF</div><div>Save the number of subscripts for the array in register A to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>27A1</div><div>RST 18H</div><div>Now
 we need to compare the subscript limit in DE with the subscript for the
 array in HL, so we call the COMPARE DE:HL routine at RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The
 RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1" id="27A2"><div>27A2-27A4</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#273D" class="memory-link">JP NC,273DH</a></div><div>Jump back to 273DH if the subscript for the array in HL is greater than the subscript limit in DE.</div></div>
									<div class="assembly-row-combined model1"><div>27A5-27A7</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0BAA" class="memory-link">CALL 0BAAH</a></div><div>Multiply the previous subscript by the subscript limit.</div></div>
									<div class="assembly-row-combined model1"><div>27A8</div><div>ADD HL,DE</div><div>Add the subscript limit for the array in DE to the array pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>27A9</div><div>POP AF</div><div>Get the number of subscripts for the array from the stack and put it in register A.</div></div>
									<div class="assembly-row-combined model1"><div>27AA</div><div>DEC A</div><div>Check to see if there are anymore subscripts to be evaluated.</div></div>
									<div class="assembly-row-combined model1"><div>27AB</div><div>LD B,H</div><div>Load register B with the MSB of the subscript pointer in register H.</div></div>
									<div class="assembly-row-combined model1"><div>27AC</div><div>LD C,L</div><div>Load register C with the LSB of the subscript pointer in register L.</div></div>
									<div class="assembly-row-combined model1"><div>27AD-27AE</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#279A" class="memory-link">JR NZ,279AH</a></div><div>Loop back to 279AH until all of the subscripts have been evaluated.</div></div>
									<div class="assembly-row-combined model1"><div>27AF-27B1</div><div>LD A,(40AFH)</div><div>Get the number type flag for the current array.<br><span class="nobottomborder bold">NOTE:</span> 40AFH holds Current number type flag.</div></div>
									<div class="assembly-row-combined model1"><div>27B2</div><div>LD B,H</div><div>Load register B with the MSB of the subscript pointer in register H.</div></div>
									<div class="assembly-row-combined model1"><div>27B3</div><div>LD C,L</div><div>Load register C with the LSB of the subscript pointer in register L.</div></div>
									<div class="assembly-row-combined model1"><div>27B4</div><div>ADD HL,HL</div><div>Multiply the subscript pointer in HL by two.</div></div>
									<div class="assembly-row-combined model1"><div>27B5-27B6</div><div>SUB 04H</div><div>Check the value of the number type flag in register A.</div></div>
									<div class="assembly-row-combined model1" id="27BD"><div>27B7-27B8</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#27BD" class="memory-link">JR C,27BDH</a></div><div>Jump forward to 27BDH if the current number type is an integer or string.</div></div>
									<div class="assembly-row-combined model1"><div>27B9</div><div>ADD HL,HL</div><div>It isn't an integer or a string so once again multiply the subscript pointer in HL by two (so now it is multiplied by 4).</div></div>
									<div class="assembly-row-combined model1"><div>27BA-27BB</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#27C2" class="memory-link">JR Z,27C2H</a></div><div>Jump forward to 27C2H if the current number type is single precision.</div></div>
									<div class="assembly-row-combined model1"><div>27BC</div><div>ADD HL,HL</div><div>It must be double precision, so once again multiply the subscript pointer in HL by two (so now it is multiplied by 8).</div></div>
									<div class="assembly-row-combined model1"><div>27BD</div><div>OR A</div><div>Set the flags.</div></div>
									<div class="assembly-row-combined model1"><div>27BE-27C0</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#27C2" class="memory-link">JP PO,27C2H</a></div><div>Jump forward to 27C2H if the current number type isn't a string.</div></div>
									<div class="assembly-row-combined model1"><div>27C1</div><div>ADD HL,BC</div><div>The current number type is a string so add the value of the original subscript pointer in BC to the subscript pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>27C2</div><div>POP BC</div><div>Get the value of the array variables pointer from the stack and put it in BC.</div></div>
									<div class="assembly-row-combined model1"><div>27C3</div><div>ADD HL,BC</div><div>Add the value of the array variables pointer in BC to the subscript pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>27C4</div><div>EX DE,HL</div><div>Load DE with the variable pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>27C5-27C7</div><div>LD HL,(40F3H)</div><div>Get the value of the current BASIC program pointer and put it in HL.<br>Note: 40F3H-40F4H holds Temporary storage location.</div></div>
									<div class="assembly-row-combined model1"><div>27C8</div><div>RET</div><div>Return.</div></div>
								</div>
							</div>

							<br><h2 id="27c9-27d3-level-ii">27C9-27D3 - LEVEL II BASIC MEM ROUTINE<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<p>This is the RETURN AMOUNT OF FREE MEMORY routine at 27C9H 
which computes the amount of memory remaining between the end of the 
variable list and the end of the stack and puts the result in REG 1 as a
 SINGLE PRECISION number.</p>
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>27C9</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#27C9" class="memory-link">XOR A</a></div><div>Zero register A and the status flags.</div></div>
									<div class="assembly-row-combined model1"><div>27CA</div><div>PUSH HL</div><div>Save the value of the current BASIC program pointer in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>27CB-27CD</div><div>LD (40AFH),A</div><div>Zero the number type flag.<br><span class="nobottomborder bold">NOTE:</span> 40AFH holds Current number type flag.</div></div>
									<div class="assembly-row-combined model1"><div>27CE-27D0</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#27D4" class="memory-link">CALL 27D4H</a></div><div>GOSUB to the <span class="code">FRE</span> routine at 27D4H.</div></div>
									<div class="assembly-row-combined model1"><div>27D1</div><div>POP HL</div><div>Get the value of the current BASIC program pointer from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>27D2</div><div>RST 10H</div><div>We need the next character in the BASIC program so call the EXAMINE NEXT SYMBOL routine at RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The
 RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>27D3</div><div>RET</div><div>Return to BASIC.</div></div>
								</div>
							</div>

							<br><h2 id="27d4-27f4-level-ii">27D4-27F4 - LEVEL II BASIC <span class="code">FRE</span> ROUTINE<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>27D4-27D6</div><div>LD HL,(40FDH)</div><div>Load HL with the start of free memory pointer.<br><span class="nobottomborder bold">NOTE:</span> 40FDH-40FEH holds Free memory pointer.</div></div>
									<div class="assembly-row-combined model1"><div>27D7</div><div>EX DE,HL</div><div>Load DE with the value of the free memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>27D8-27DA</div><div>LD HL,0000H</div><div>Zero HL.</div></div>
									<div class="assembly-row-combined model1"><div>27DB</div><div>ADD HL,SP</div><div>Add the value in HL (which is zero) to the current value of the stack pointer.</div></div>
									<div class="assembly-row-combined model1"><div>27DC</div><div>RST 20H</div><div>We need to check the value of the current number type flag, so we call the TEST DATA MODE routine at RST 20H.<br><span class="nobottomborder bold">NOTE:</span>
  The RST 20H routine determines the type of the current value in REG 1 
and returns a combination of STATUS flags and unique numeric values in 
the A Register according to the data mode flag (40AFH).<br><br>The results are returned as follows:<table style="border-collapse: collapse; border: 1px solid black;"><tbody><tr style="background-color: #f0f0f0;"><td style="border: 1px solid black; padding: 8px;">If the Variable Type is ...</td><td style="border: 1px solid black; padding: 8px;">and the Flags<br>are set ...</td><td style="border: 1px solid black; padding: 8px;">... then Register<br>A will be set ...</td></tr><tr><td style="border: 1px solid black; padding: 8px;">Integer</td><td style="border: 1px solid black; padding: 8px;">NZ/C/M/E</td><td style="border: 1px solid black; padding: 8px;">-1</td></tr><tr><td style="border: 1px solid black; padding: 8px;">String</td><td style="border: 1px solid black; padding: 8px;">Z/C/P/E</td><td style="border: 1px solid black; padding: 8px;">0</td></tr><tr><td style="border: 1px solid black; padding: 8px;">Single Precision</td><td style="border: 1px solid black; padding: 8px;">NZ/C/P/O</td><td style="border: 1px solid black; padding: 8px;">1</td></tr><tr><td style="border: 1px solid black; padding: 8px;">Double Precision</td><td style="border: 1px solid black; padding: 8px;">NZ/NC/P/E</td><td style="border: 1px solid black; padding: 8px;">5</td></tr></tbody></table></div></div>
									<div class="assembly-row-combined model1"><div>27DD-27DE</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#27EC" class="memory-link">JR NZ,27ECH</a></div><div>If that test shows we do NOT have a STRING (meaning this was really a <span class="code">MEM</span> call, jump to forward to 27ECH.</div></div>
									<div class="assembly-row-combined model1"><div>27DF-27E1</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#29DA" class="memory-link">CALL 29DAH</a></div><div>Get the address of the string into HL.</div></div>
									<div class="assembly-row-combined model1"><div>27E2-27E1</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#28E6" class="memory-link">CALL 28E6H</a></div><div>Go check to see how much string space remains.</div></div>
									<div class="assembly-row-combined model1"><div>27E5-27E7</div><div>LD HL,(40A0H)</div><div>Load HL with the start of string space pointer.<br><span class="nobottomborder bold">NOTE:</span> 40A0H-40A1H holds the start of string space pointer.</div></div>
									<div class="assembly-row-combined model1"><div>27E8</div><div>EX DE,HL</div><div>Load DE with the start of string space pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>27E9-27EB</div><div>LD HL,(40D6H)</div><div>Load HL with the next available location in string space pointer.<br><span class="nobottomborder bold">NOTE:</span> 40D6H-40D7H holds Next available location in string space pointer.</div></div>
									<div class="assembly-row-combined model1"><div>27EC</div><div>LD A,L</div><div>Load register A with the LSB of the next available location in string space pointer in register L.</div></div>
									<div class="assembly-row-combined model1"><div>27ED</div><div>SUB E</div><div>Subtract
 the LSB of the start of string space pointer in register E from the LSB
 of the next available location in string space pointer in register A.</div></div>
									<div class="assembly-row-combined model1"><div>27EE</div><div>LD L,A</div><div>Load register L with the LSB of the amount of string space remaining in register A.</div></div>
									<div class="assembly-row-combined model1"><div>27EF</div><div>LD A,H</div><div>Load register A with the MSB of the next available location in string space pointer in register H.</div></div>
									<div class="assembly-row-combined model1"><div>27F0</div><div>SBC A,D</div><div>Subtract
 the MSB of the string space pointer in register D from the MSB of the 
next available location of string space pointer in register A.</div></div>
									<div class="assembly-row-combined model1"><div>27F1</div><div>LD H,A</div><div>Load register H with the MSB of the amount of string space remaining in register A.</div></div>
									<div class="assembly-row-combined model1"><div>27F2-27F4</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0C66" class="memory-link">JP 0C66H</a></div><div>Jump to 0C66H to convert the difference between HL and DE to single precision and then RETurn out of the routine.</div></div>
								</div>
							</div>

							<br><h2 id="27f5-27fd-level-ii">27F5-27FD - LEVEL II BASIC <span class="code">POS(</span> ROUTINE<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>27F5-27F7</div><div>LD A,(40A6H)</div><div>Load register A with the current cursor line position.<br>Note: 40A6H holds the current cursor line position.</div></div>
									<div class="assembly-row-combined model1"><div>27F8</div><div>LD L,A</div><div>Load register L with the value of the current cursor line position in register A.</div></div>
									<div class="assembly-row-combined model1"><div>27F9</div><div>XOR A</div><div>Zero register A.</div></div>
									<div class="assembly-row-combined model1"><div>27FA</div><div>LD H,A</div><div>Load register H with zero, so now HL is 00 / cursor position.</div></div>
									<div class="assembly-row-combined model1"><div>27FB-27FD</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0A9A" class="memory-link">JP 0A9AH</a></div><div>Jump to 0A9AH.</div></div>
								</div>
							</div>

							<br><h2 id="27fe-2818-level-ii">27FE-2818 - LEVEL II BASIC <span class="code">USR(x)</span> ROUTINE<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>27FE-2800</div><div><a href="#41A9" class="memory-link">CALL 41A9H</a></div><div>Go call the DOS link at 41A9H.</div></div>
									<div class="assembly-row-combined model1"><div>2801</div><div>RST 10H</div><div>We need the next character so call the EXAMINE NEXT SYMBOL routine at RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The
 RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2802-2804</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#252C" class="memory-link">CALL 252CH</a></div><div>GOSUB
 to 252CH to evaluate the expression at the location of the current 
BASIC program pointer in HL and return with the result in REG 1.</div></div>
									<div class="assembly-row-combined model1"><div>2805</div><div>PUSH HL</div><div>Save the value of the current BASIC program pointer in HL (=the address of the next element in the code string) to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2806-2808</div><div>LD HL,0890H</div><div>Load HL with the return address of 0890H which will clear the stack before returning to BASIC.</div></div>
									<div class="assembly-row-combined model1"><div>2809</div><div>PUSH HL</div><div>Save the value of the return address in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>280A-280C</div><div>LD A,(40AFH)</div><div>Load register A with the value of the current number type flag.<br>Note: 40AFH holds Current number type flag.</div></div>
									<div class="assembly-row-combined model1"><div>280D</div><div>PUSH AF</div><div>Save the value of the current number type flag in register A.<br>(02=INT, 03=STR, 04=SNG, 08=DBL).</div></div>
									<div class="assembly-row-combined model1"><div>280E-280F</div><div>CP 03H</div><div>Check to see if the current value in REG l is a string.</div></div>
									<div class="assembly-row-combined model1"><div>2810-2812</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#29DA" class="memory-link">CALL Z,29DAH</a></div><div>If the current result in REG l is a string then GOSUB to 29DAH to get the string address into HL.</div></div>
									<div class="assembly-row-combined model1"><div>2813</div><div>POP AF</div><div>Restore the number type flag into register A.</div></div>
									<div class="assembly-row-combined model1"><div>2814</div><div>EX DE,HL</div><div>Load DE with the value of the string address in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2815-2817</div><div>LD HL,(408EH)</div><div>Load HL with the starting address of the machine language subroutine.<br><ul><li>Note: 408EH-408FH holds the entry address of a machine language program to be called by a USR command.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2818</div><div>JP (HL)</div><div>Jump to the address in HL.</div></div>
								</div>
							</div>

							<br><h2 id="2819-2827">2819-2827 - CONVERSION ROUTINE<br>Usually called by <span class="code">LET</span> to convert the result of arithmetic routines to the proper destination type.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2819</div><div>PUSH HL</div><div>Save the value in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>281A-281B</div><div>AND 07H</div><div>Mask the value of the current number type flag in register A.</div></div>
									<div class="assembly-row-combined model1"><div>281C-281E</div><div>LD HL,18A1H</div><div>Load HL with the address of the arithmetic conversion routines.</div></div>
									<div class="assembly-row-combined model1"><div>281F</div><div>LD C,A</div><div>Load register C with the value of the number type flag in register A.<br>(02=INT, 03=STR, 04=SNG, 08=DBL).</div></div>
									<div class="assembly-row-combined model1"><div>2820-2821</div><div>LD B,00H</div><div>Zero register B. Now BC holds 00 / type.</div></div>
									<div class="assembly-row-combined model1"><div>2822</div><div>ADD HL,BC</div><div>Add the offset (of BC) to the base arithmetic conversion routines, to find the right jump point.</div></div>
									<div class="assembly-row-combined model1"><div>2823-2825</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2586" class="memory-link">CALL 2586H</a></div><div>GOSUB to 2586H to convert the current result in REG l to its proper number type.</div></div>
									<div class="assembly-row-combined model1"><div>2826</div><div>POP HL</div><div>Get the value from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2827</div><div>RET</div><div>Return.</div></div>
								</div>
							</div>

							<br><h2 id="2828-2835-save-the">2828-2835 - Save the code string address<br>Usually called from the <span class="code">INPUT</span> routine. On entry HL has the current line number in binary.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2828</div><div>PUSH HL</div><div>Save the value of the current BASIC program pointer in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2829-282B</div><div>LD HL,(40A2H)</div><div>Load HL with the value of the current BASIC line number.<br><b>NOTE:</b>40A2H-40A3H holds the current BASIC line number.</div></div>
									<div class="assembly-row-combined model1"><div>282C</div><div>INC HL</div><div>Bump the value of the current BASIC line number in HL to enable us to test for a direct statement.</div></div>
									<div class="assembly-row-combined model1"><div>282D</div><div>LD A,H</div><div>Load register A with the MSB of the current BASIC line number in register H.</div></div>
									<div class="assembly-row-combined model1"><div>282E</div><div>OR L</div><div>Combine the LSB of the current BASIC line number in register L with the MSB of the current BASIC line number in register A.</div></div>
									<div class="assembly-row-combined model1"><div>282F</div><div>POP HL</div><div>Get the value of the current BASIC program pointer from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2830</div><div>RET NZ</div><div>Return if there is a line number (i.e., this isn't the command mode).</div></div>
								</div>
							</div>

							<br><h2 id="2831-id-error-entry">2831 - ID ERROR entry point.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2831-2832</div><div>LD E,16H</div><div>Load register E with the <span class="code">?ID ERROR</span> code.</div></div>
									<div class="assembly-row-combined model1"><div>2833-2835</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#19A2" class="memory-link">JP 19A2H</a></div><div>Display an <span class="code">?ID ERROR</span> if this is the command mode.</div></div>
								</div>
							</div>

							<br><h2 id="2836-2856-string">2836-2856 - STRING ROUTINE - <span class="code">STR$</span> logic.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2836-2838</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0FBD" class="memory-link">CALL 0FBDH</a></div><div>GOSUB to 0FBDH to convert the current result in REG 1 to an ASCII string.</div></div>
									<div class="assembly-row-combined model1"><div>2839-283B</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2865" class="memory-link">CALL 2865H</a></div><div>Go make a temporary string work area entry.</div></div>
									<div class="assembly-row-combined model1"><div>283C-283E</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#29DA" class="memory-link">CALL 29DAH</a></div><div>Load HL with the string's VARPTR.</div></div>
									<div class="assembly-row-combined model1" id="2A2B"><div>283F-2841</div><div>LD BC,2A2BH</div><div>Load BC with a return address of 2A2BH (which cleans the stack and then jumps to 2884H).</div></div>
									<div class="assembly-row-combined model1"><div>2842</div><div>PUSH BC</div><div>Save the value of the return address in BC to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2843</div><div>LD A,(HL)</div><div>Load register A with the string's length at the location of the string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2844</div><div>INC HL</div><div>Bump the value of the string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2845</div><div>PUSH HL</div><div>Save the value of the string's VARPTR in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2846-2848</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#28BF" class="memory-link">CALL 28BFH</a></div><div>GOSUB to 28BFH to test the remaining string area to make sure that the new string will fit.</div></div>
									<div class="assembly-row-combined model1"><div>2849</div><div>POP HL</div><div>Reload HL with the string's VARPTR.</div></div>
									<div class="assembly-row-combined model1"><div>284A</div><div>LD C,(HL)</div><div>Load register C with the LSB of the string's address at the location of the string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1"><div>284B</div><div>INC HL</div><div>Bump the value of the string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1"><div>284C</div><div>LD B,(HL)</div><div>Load register B with the MSB of the string's address at the location of the string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1"><div>284D-284F</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#285A" class="memory-link">CALL 285AH</a></div><div>GOSUB to 285AH to save the string's length and the string's address at 40D3H.</div></div>
									<div class="assembly-row-combined model1"><div>2850</div><div><a href="#40D3" class="memory-link">PUSH HL</a></div><div>Save the value in HL (which is 40D3H) to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2851</div><div>LD L,A</div><div>Load register L with the string's length (from register A).</div></div>
									<div class="assembly-row-combined model1"><div>2852-2854</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#29CE" class="memory-link">CALL 29CEH</a></div><div>GOSUB to 29CEH to move the string from the temp area (of BC) to the string data area (in DE).</div></div>
									<div class="assembly-row-combined model1"><div>2855</div><div>POP DE</div><div>Get the value from the stack (40D3H) and put it in DE.</div></div>
									<div class="assembly-row-combined model1"><div>2856</div><div>RET</div><div>Return.</div></div>
								</div>
							</div>

							<br><h2 id="2857-2864-string">2857-2864 - STRING ROUTINE - Set Up a String.  A needs to hold the length of the string to be created.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2857-2859</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#28BF" class="memory-link">CALL 28BFH</a></div><div>GOSUB
 to 28BFH to make sure that there is enough string space remaining for 
the string. Get the address of the next string area in DE. Then save A 
and DE at 40D3H-40D5H.</div></div>
									<div class="assembly-row-combined model1"><div>285A-285C</div><div>LD HL,40D3H</div><div>Load HL with the address of the temporary string parameter storage area.<br>Note: 40D3H-40D5H holds Used for temporary string VARPTR's.</div></div>
									<div class="assembly-row-combined model1"><div>285D</div><div>PUSH HL</div><div>Save the address of the temporary string parameter area in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>285E</div><div>LD (HL),A</div><div>Save the string's length in register A at the location of the temporary string parameter storage pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>285F</div><div>INC HL</div><div>Bump the value of the temporary string parameter storage pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2860</div><div>LD (HL),E</div><div>Save the LSB of the string's address in register E at the location of the temporary string parameter storage pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2861</div><div>INC HL</div><div>Bump the value of the temporary string parameter storage pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2862</div><div>LD (HL),D</div><div>Save the MSB of the string's address in register D at the location of the temporary string parameter storage pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2863</div><div>POP HL</div><div>Get the address of the temporary string parameter storage area from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2864</div><div>RET</div><div>Return.</div></div>
								</div>
							</div>

							<br><h2 id="2865-28a5-string">2865-28A5 - STRING ROUTINE<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<p>This is the quote routine. C will be a counter.</p>
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2865H<span class="origrom2">CSVEC</span></div><div>DEC HL</div><div>Decrement the value of the current BASIC program pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2866-2867</div><div>LD B,22H</div><div>Load register B with a <span class="code">"</span> (which is really the opening search character).</div></div>
									<div class="assembly-row-combined model1"><div>2868</div><div>LD D,B</div><div>Load register D with a <span class="code">"</span> (which is really the ending search character).</div></div>
									<div class="assembly-row-combined model1"><div>2869</div><div>PUSH HL</div><div>Save the address of the current BASIC program pointer in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>286A-286B</div><div>LD C,0FFH</div><div>Load register C with a -1.</div></div>
									<div class="assembly-row-combined model1"><div>286C</div><div>INC HL</div><div>Bump the value of the current BASIC program pointer in HL to skip over that initial <span class="code">"</span>.</div></div>
									<div class="assembly-row-combined model1"><div>286D</div><div>LD A,(HL)</div><div>Load register A with the character at the location of the current BASIC program pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>286E</div><div>INC C</div><div>Bump the counter in register C.</div></div>
									<div class="assembly-row-combined model1"><div>286F</div><div>OR A</div><div>Check
 to see if the character at the location of the current BASIC program 
pointer in register A is an end of the BASIC line character.</div></div>
									<div class="assembly-row-combined model1"><div>2870-2871</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2878" class="memory-link">JR Z,2878H</a></div><div>Jump
 to 2878H if the character at the location of the current BASIC program 
pointer in register A is an end of the BASIC line character.</div></div>
									<div class="assembly-row-combined model1"><div>2872</div><div>CP D</div><div>Check
 to see if the character at the location of the current BASIC program 
pointer in register A is the same as the terminating character in 
register D.</div></div>
									<div class="assembly-row-combined model1"><div>2873-2874</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2878" class="memory-link">JR Z,2878H</a></div><div>Jump
 to 2878H if the character at the location of the current BASIC program 
pointer in register A is the same as the terminating character in 
register D.</div></div>
									<div class="assembly-row-combined model1"><div>2875</div><div>CP B</div><div>Check
 to see if the character at the location of the current BASIC program 
point.er in register A is the same at the terminating character in 
register B.</div></div>
									<div class="assembly-row-combined model1"><div>2876-2877</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#286C" class="memory-link">JR NZ,286CH</a></div><div>Loop
 back to 286CH if the character at the location of the current BASIC 
program pointer in register A isn't the same as the terminating 
character in register B.</div></div>
									<div class="assembly-row-combined model1"><div>2878-2879</div><div>CP 22H</div><div>Check to see if the character at the location of the current BASIC program pointer in register A is a quote.</div></div>
									<div class="assembly-row-combined model1"><div>287A-287C</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1D78" class="memory-link">CALL Z,1D78H</a></div><div>If
 it was a quote, then GOSUB to 1D78H to bump the value of the current 
BASIC program pointer in HL until it points to the next character.</div></div>
									<div class="assembly-row-combined model1"><div>287D</div><div>EX (SP),HL</div><div>Exchange the value of the current BASIC program pointer in HL with the string's address to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>287E</div><div>INC HL</div><div>Bump the string's address in HL until it points to the first character of the string.</div></div>
									<div class="assembly-row-combined model1"><div>287F</div><div>EX DE,HL</div><div>Load DE with the string's address in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2880</div><div>LD A,C</div><div>Load register A with the string's length from register C.</div></div>
									<div class="assembly-row-combined model1"><div>2881-2883</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#285A" class="memory-link">CALL 285AH</a></div><div>GOSUB to 285AH to save the string's length and the string's address into 40D3H.</div></div>
									<div class="assembly-row-combined model1"><div>2884-2886</div><div>LD DE,40D3H</div><div>Load DE with the address of the string parameter storage area.<br>Note: 40D3H-40D5H holds Used for temporary string VARPTR's.</div></div>
									<div class="assembly-row-combined model1"><div>2887-2888</div><div>LD A,D5H</div><div>This seems to be garbage. Perhaps there is a jump to 2888 which would then be PUSH DE.</div></div>
									<div class="assembly-row-combined model1"><div>2889-288B</div><div>LD HL,(40B3H)</div><div>Load HL with the next available location in the temporary string work area in HL as the string's VARPTR in REG 1.<br>Note: 40B3H-40B4H holds Next available location in the temporary string work area pointer.</div></div>
									<div class="assembly-row-combined model1"><div>288C-288E</div><div>LD (4121H),HL</div><div>Save the value of the next available location in the temporary string work area in HL as the string's VARPTR in REG 1.</div></div>
									<div class="assembly-row-combined model1"><div>288F-2890</div><div>LD A,03H</div><div>Load register A with the string number type flag.</div></div>
									<div class="assembly-row-combined model1"><div>2891-2893</div><div>LD (40AFH),A</div><div>Save the value in register A as the current number type flag.<br>Note: 40AFH holds Current number type flag.</div></div>
									<div class="assembly-row-combined model1"><div>2894-2896</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#09D3" class="memory-link">CALL 09D3H</a></div><div>Add the length of the string to the next available location in the temporary string work area in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2897-2899</div><div>LD DE,40D6H</div><div>Load DE with the ending address of the temporary string work area.<br>Note: 40D6H-40D7H holds Next available location in string space pointer.</div></div>
									<div class="assembly-row-combined model1"><div>289A</div><div>RST 18H</div><div>Now
 we need to check to see if the updated temporary string work area 
location in HL isn't greater than the ending address of the temporary 
string work area in DE, so we call the COMPARE DE:HL routine at RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The
 RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>289B-289D</div><div>LD (40B3H),HL</div><div>Save the updated string work area location in HL as the next available location in the temporary string work area.<br>Note: 40B3H-40B4H holds Next available location in the temporary string work area pointer.</div></div>
									<div class="assembly-row-combined model1"><div>289E</div><div>POP HL</div><div>Get the value of the current BASIC program pointer from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>289F</div><div>LD A,(HL)</div><div>Load register A with the character at the location of the current BASIC program pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>28A0</div><div>RET NZ</div><div>Return
 if the updated temporary string work area location wasn't beyond the 
end of the temporary string work area (meaning it overflowed, because if
 it overflowed ...).</div></div>
								</div>
							</div>

							<br><h2 id="28a1-st-error-entry">28A1 - ST ERROR entry point.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>28A1-28A2</div><div>LD E,1EH</div><div>Load register E with a <span class="code">?ST ERROR</span> code.</div></div>
									<div class="assembly-row-combined model1"><div>28A3-28A5</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#19A2" class="memory-link">JP 19A2H</a></div><div>Display a <span class="code">?ST ERROR</span> message if the temporary string work area has overflowed.</div></div>
								</div>
							</div>

							<br><h2 id="28a6-28be-display">28A6-28BE - DISPLAY MESSAGE ROUTINE<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>28A6</div><div>INC HL</div><div>Bump the value of the current BASIC program pointer in HL.</div></div>
								</div>
							</div>

							<br><h2 id="28a7-this-is-a">28A7 - This is a general purpose output routine.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<p>It will output data to the display, printer or cassette, 
depending on the contents of 409CH. (0=video, -1=tape, 1=printer). The 
address of the first character in the string to be output must be in the
 HL register pair, and the string must end with a zero byte or a quote 
(22H).<br>Note: 409CH holds the current output device flag: -1=cassette, 0=video and 1=printer.<br>This
 is the WRITE MESSAGE routine, which displays message pointed to by HL 
on current system output device (usually video). The string to be 
displayed must be terminated by a byte of machine zeros or a carriage 
return code 0D. If terminated with a carriage return, control is 
returned to the caller after taking the DOS exit at 41D0 (JP 5B99H). 
This subroutine uses th literal string pool table and the string area. 
It should not be called if the communications region and the string area
 are not properly maintained.</p><br>
								<p>This routine has essentially the same effect as the routine 
at 2B75H, except that text may also end with a quotation mark (22H), 
creates string vector before output (destroys current contents of ACCUM,
 sets number type flag at 40AFH to 3 - see chapter two of this book), 
and also uses BC &amp; DE registers. Depends heavily on BASIC string 
management routines (use of 2B75H or other routines may be preferable). 
If string contains a carriage return (ODH) character, a CALL will be 
made to the Disk BASIC link at 41DOH. Used by BASIC PRINT statement. 
This routine may also be entered at 28A6H, in which case the HL register
 pair will be incremented prior to beginning to output string.</p>
								<p>To use a ROM call to display a string of characters starting 
at the current cursor position, and to update the cursor position,store 
the characters in consecutive memory locations, with a zero byte at the 
end, then load the HL register pair with the address of the first 
character of the string, and then CALL 28A7H.
								</p><p>EXAMPLE: Suppose that we have the following symbolic setup:<br>TITL DEFM 'INSIDE LEVEL II'<br>DEFB 0<br>Then, the instructions:<br>LD HL,TITL<br>CALL 28A7H<br>will cause "INSIDE LEVEL II" to be displayed at the current cursor position and the cursor position to be updated.</p>
								<p>NOTE: If the subroutine at 28A7H is used by an assembly 
language program that is itself entered by a USR call, the return from 
the assembly language program may encounter the embarrassment of a TM 
error, with control passing to the Level II monitor. This occurs because
 the subroutine at 28A7H leaves a 3 in location 40AFH, while the USR 
structure requires a 2 in 40AFH upon returning. The malady is cured by 
storing a 2 in 40AFH before returning, or by jumping to 0A9AH instead of
 executing the simple RET. The problem would not occur in the first 
place if the assembly language program returns the value of an integer 
variable to the BASIC program, and it might not occur if some other ROM 
routine is called after the subroutine at 28A7H and before returning ? 
if the other subroutine produces an integer output. DISK SYSTEM CAUTION:
 See the DISK SYSTEM CAUTION of Section 8.1 regarding the exits to DISK 
BASIC from the subroutine at 28A7H.</p>
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>28A7-28A9H<span class="origrom2">DSTR</span></div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#28A7" class="memory-link">CALL 2865H</a></div><div>Go build a temporary string work area entry for the message at the location of the current BASIC program pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>28AA-28AC</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#29DA" class="memory-link">CALL 29DAH</a></div><div>GOSUB to 29DAH to load HL with the string's VARPTR.</div></div>
									<div class="assembly-row-combined model1"><div>28AD-28AF</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#09C4" class="memory-link">CALL 09C4H</a></div><div>Go get the string's length in register D and the string's address in BC.</div></div>
									<div class="assembly-row-combined model1"><div>28B0</div><div>INC D</div><div>Bump the value of the string's length in register D in preparation for the following loop which starts with a DEC D.</div></div>
									<div class="assembly-row-combined model1"><div>28Bl</div><div>DEC D</div><div>Decrement the value of the string's length in register D.</div></div>
									<div class="assembly-row-combined model1"><div>28B2</div><div>RET Z</div><div>Return if all of the characters in the string have been sent to the current output device. </div></div>
									<div class="assembly-row-combined model1" id="28B3"><div>28B3</div><div>LD A,(BC)</div><div>Load register A with the character at the location of the string pointer in BC.</div></div>
									<div class="assembly-row-combined model1"><div>28B4-28B6</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#032A" class="memory-link">CALL 032AH</a></div><div>Go send the character in register A to the current output device.</div></div>
									<div class="assembly-row-combined model1"><div>28B7-28B8</div><div>CP 0DH</div><div>Check to see if the character in register A is a carriage return.</div></div>
									<div class="assembly-row-combined model1"><div>28B9-28BB</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2103" class="memory-link">CALL Z,2103H</a></div><div>Jump to 2103H if the character in register A is a carriage return.</div></div>
									<div class="assembly-row-combined model1"><div>28BC</div><div>INC BC</div><div>Bump the value of the string pointer in BC.</div></div>
									<div class="assembly-row-combined model1"><div>28BD-28BE</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#28B1" class="memory-link">JR 28B1H</a></div><div>Loop until all of the characters in the string have been sent to the current output device.</div></div>
								</div>
							</div>

							<br><h2 id="28bf-28d9-string">28BF-28D9 - STRING ROUTINE - Compute the amount of space remaining in the string area.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>28BF</div><div>OR A</div><div>Set the flags.</div></div>
									<div class="assembly-row-combined model1"><div>28C0-28Cl</div><div>0E F1</div><div>Z-80 Trick.</div></div>
									<div class="assembly-row-combined model1"><div>28Cl</div><div>POP AF</div><div>Get the string's length from the stack and put it in register A.</div></div>
									<div class="assembly-row-combined model1"><div>28C2</div><div>PUSH AF</div><div>Save the length of the string in register A to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>28C3-28C5</div><div>LD HL,(40A0H)</div><div>Load HL with the start of the string space pointer.<br><b>Note:</b> 40A0H-40A1H holds the start of string space pointer.</div></div>
									<div class="assembly-row-combined model1"><div>28C6</div><div>EX DE,HL</div><div>Move the start of the string space pointer into DE. We don't care what happens to HL.</div></div>
									<div class="assembly-row-combined model1"><div>28C7-28C9</div><div>LD HL,(40D6H)</div><div>Load HL with the next available location in string space pointer.<br>Note: 40D6H-40D7H holds Next available location in string space pointer.</div></div>
									<div class="assembly-row-combined model1"><div>28CA</div><div>CPL</div><div>Complement the string's length in register A so that it is negative.</div></div>
									<div class="assembly-row-combined model1"><div>28CB</div><div>LD C,A</div><div>Load register C with the negative string's length in register A.</div></div>
									<div class="assembly-row-combined model1"><div>28CC-28CD</div><div>LD B,0FFH</div><div>Load register B with a -1 so that BC will be the negative length of the string.</div></div>
									<div class="assembly-row-combined model1"><div>28CE</div><div>ADD HL,BC</div><div>Add the negative string's length in BC to the next available location in string space pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>28CF</div><div>INC HL</div><div>Bump the value of the adjusted next available location in string space pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>28D0</div><div>RST 18H</div><div>Now
 we need to check to see if the adjusted next available location in 
string space pointer in HL is less than the start of string space 
pointer in DE, so we call the COMPARE DE:HL routine at RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The
 RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1" id="28DA"><div>28D1-28D2</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#28DA" class="memory-link">JR C,28DAH</a></div><div>Jump
 forward to 28DAH if the adjusted next available location in string 
space pointer in HL is less than the start of string space pointer in 
DE.</div></div>
									<div class="assembly-row-combined model1"><div>28D3-28D5</div><div>LD (40D6H),HL</div><div>Save the value in HL as the next available location in string space pointer.<br>Note: 40D6H-40D7H holds Next available location in string space pointer.</div></div>
									<div class="assembly-row-combined model1"><div>28D6</div><div>INC HL</div><div>Bump the value of the next available location in string space pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>28D7</div><div>EX DE,HL</div><div>Load DE with the next available location in string space pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>28D8</div><div>POP AF</div><div>Get the string's length from the stack and put it in register A.</div></div>
									<div class="assembly-row-combined model1"><div>28D9</div><div>RET</div><div>Return.</div></div>
								</div>
							</div>

							<br><h2 id="28da-298e-string">28DA-298E - STRING ROUTINE<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>28DA</div><div>POP AF</div><div>Get
 the length of the string from the stack and put it in register A. This 
also gets the status flag to help us find out if reorganization has 
already been attempted.</div></div>
									<div class="assembly-row-combined model1"><div>28DB-28DC</div><div>LD E,1AH</div><div>Load register E with an <span class="code">?OS ERROR</span> code.</div></div>
									<div class="assembly-row-combined model1"><div>28DD-28DF</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#19A2" class="memory-link">JP Z,19A2H</a></div><div>Display a <span class="code">?OS ERROR</span> if there isn't enough string space available for the string and we had already reorganized string space.</div></div>
									<div class="assembly-row-combined model1"><div>28E0</div><div>CP A</div><div>Set the flags.</div></div>
									<div class="assembly-row-combined model1"><div>28El</div><div>PUSH AF</div><div>Save the string's length in register A to the stack.</div></div>
									<div class="assembly-row-combined model1" id="28C1"><div>28E2-28E4</div><div>LD BC,28C1H</div><div>Load BC with a return address of 28C1H (which would retry allocation).</div></div>
									<div class="assembly-row-combined model1"><div>28E5</div><div>PUSH BC</div><div>Save that return address to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>28E6-28E8</div><div>LD HL,(40B1H)</div><div>Load HL with the top of memory pointer.<br>Note: 40B1H-40B2H holds MEMORY SIZE? pointer.</div></div>
									<div class="assembly-row-combined model1"><div>28E9-28EB</div><div>LD (40D6H),HL</div><div>Save the top of BASIC memory pointer in HL as the next available location in string space pointer.<br>Note: 40D6H-40D7H holds Next available location in string space pointer.</div></div>
									<div class="assembly-row-combined model1"><div>28EC-28EE</div><div>LD HL,0000H</div><div>Zero HL.</div></div>
									<div class="assembly-row-combined model1"><div>28EF</div><div>PUSH HL</div><div>Save the value in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>28F0-28F2</div><div>LD HL,(40A0H)</div><div>Load HL with the start of string space pointer.<br><span class="nobottomborder bold">NOTE:</span> 40A0H-40A1H holds the start of string space pointer.</div></div>
									<div class="assembly-row-combined model1"><div>28F3</div><div>PUSH HL</div><div>Save the start of string space pointer in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>28F4-28F6</div><div>LD HL,40B5H</div><div>Load HL with the start of the temporary string work area pointer.<br>Note: 40B5H-40D2H holds Temporary string work area.</div></div>
									<div class="assembly-row-combined model1"><div>28F7</div><div>EX DE,HL</div><div>Load DE with the start of the temporary string work area pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>28F8-28FA</div><div>LD HL,(40B3H)</div><div>Load HL with the next available location in the temporary string work area pointer.<br><span class="nobottomborder bold">NOTE:</span> 40B3H-40B4H holds Next available location in the temporary string work area pointer.</div></div>
									<div class="assembly-row-combined model1"><div>28FB</div><div>EX DE,HL</div><div>Exchange
 the start of the temporary string work area pointer in DE with the next
 available location in the temporary string work area pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>28FC</div><div><a href="#40B3" class="memory-link">RST 18H</a></div><div>We
 need to see if 40B3H is pointing to the first entry (40B5H) - if the 
start of the temporary string work area pointer in HL is the same as the
 next available location in the temporary string work area pointer, so 
we call the COMPARE DE:HL routine at RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The
 RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1" id="28F7"><div>28FD-28FF</div><div>LD BC,28F7H</div><div>Load BC with a return address of 28F7H.</div></div>
									<div class="assembly-row-combined model1"><div>2900-2902</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#294A" class="memory-link">JP NZ,294AH</a></div><div>Jump to 294AH if the temporary string work area isn't empty.</div></div>
									<div class="assembly-row-combined model1"><div>2903</div><div>LD HL,(40F9H)</div><div>Load HL with the start of the simple variables pointer.<br><span class="nobottomborder bold">NOTE:</span> 40F9H-40FAH holds the starting address of the simple variable storage area.</div></div>
									<div class="assembly-row-combined model1"><div>2906</div><div>EX DE,HL</div><div>Load DE with the simple variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2907-2909</div><div>LD HL,(40FBH)</div><div>Load HL with the start of the array variables pointer.<br><ul><li>Note: 40FBH-40FCH holds the starting address of the BASIC array variable storage area.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>290A</div><div>EX DE,HL</div><div>Exchange the value of the simple variables pointer in DE with the value of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>290B</div><div>RST 18H</div><div>Now
 we need to check to see if the simple variables pointer in HL is the 
same as the array variables pointer in DE, so we call the COMPARE DE:HL 
routine at RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The
 RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>290C-290D</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2921" class="memory-link">JR Z,2921H</a></div><div>Jump forward to 2921H if the simple variables pointer in HL is the same as the array variables pointer in DE.</div></div>
									<div class="assembly-row-combined model1"><div>290E</div><div>LD A,(HL)</div><div>Load register A with the number type flag at the location of the simple variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>290F</div><div>INC HL</div><div>Bump the value of the simple variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2910</div><div>INC HL</div><div>Bump the simple variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2911</div><div>INC HL</div><div>Bump the value of the simple variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2912-2913</div><div>CP 03H</div><div>Check to see if the variable at the location of the simple variables pointer is a string.</div></div>
									<div class="assembly-row-combined model1"><div>2914-2915</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#291A" class="memory-link">JR NZ,291AH</a></div><div>Jump to 291AH if the variable at the location of the simple variables pointer in HL isn't a string.</div></div>
									<div class="assembly-row-combined model1"><div>2916-2918</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#294B" class="memory-link">CALL 294BH</a></div><div>GOSUB to 294BH to do string check.</div></div>
									<div class="assembly-row-combined model1"><div>2919</div><div>XOR A</div><div>Zero register A.</div></div>
									<div class="assembly-row-combined model1"><div>29lA</div><div>LD E,A</div><div>Zero register E.</div></div>
									<div class="assembly-row-combined model1"><div>291B-291C</div><div>LD D,00H</div><div>Zero register D.</div></div>
									<div class="assembly-row-combined model1"><div>29lD</div><div>ADD HL,DE</div><div>Add the value of the number type flag in DE to the simple variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>291E-291F</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2906" class="memory-link">JR 2906H</a></div><div>Loop back to 2906H until all of the simple variables have been checked.</div></div>
									<div class="assembly-row-combined model1"><div>2920</div><div>POP BC</div><div>Clean up the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2921</div><div>EX DE,HL</div><div>Load DE with the value of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2922-2924</div><div>LD HL,(40FDH)</div><div>Load HL with the start of free memory pointer.<br>Note: 40FDH-40FEH holds Free memory pointer.</div></div>
									<div class="assembly-row-combined model1"><div>2925</div><div>EX DE,HL</div><div>Exchange the value of the array variables pointer in DE with the value of the free memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2926</div><div>RST 18H</div><div>Now
 we need to check to see if the array variables pointer in HL is the 
same as the free memory pointer in DE, so we call the COMPARE DE:HL 
routine at RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The
 RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2927-2929</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#296B" class="memory-link">JP Z,296BH</a></div><div>Jump if the array variables pointer in register HL is the same as the start of the free memory pointer in DE.</div></div>
									<div class="assembly-row-combined model1"><div>292A</div><div>LD A,(HL)</div><div>Load register A with the number type flag at the location of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>292B</div><div>INC HL</div><div>Bump the value of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>292C-292E</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#09C2" class="memory-link">CALL 09C2H</a></div><div>Call 09C2H (which loads a SINGLE PRECISION value pointed to by HL into register pairs BC and DE).</div></div>
									<div class="assembly-row-combined model1"><div>292F</div><div>PUSH HL</div><div>Save the value of the array variables pointer in reg? ister pair HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2930</div><div>ADD HL,BC</div><div>Add the value of the offset to the next array in BC to the value of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2931-2932</div><div>CP 03H</div><div>Check to see if the array being examined is a string.</div></div>
									<div class="assembly-row-combined model1"><div>2933-2934</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2920" class="memory-link">JR NZ,2920H</a></div><div>Jump if the array being examined isn't a string.</div></div>
									<div class="assembly-row-combined model1"><div>2935-2937</div><div>LD (40D8H),HL</div><div>Save the address of the next array in HL.<br>Note: 40D8H-40D9H holds Temporary storage location.</div></div>
									<div class="assembly-row-combined model1"><div>2938</div><div>POP HL</div><div>Get the value of the array variables pointer from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2939</div><div>LD C,(HL)</div><div>Load register C with the number of subscripts for the array at the location of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>293A-293B</div><div>LD B,00H</div><div>Zero register B.</div></div>
									<div class="assembly-row-combined model1"><div>293C</div><div>ADD HL,BC</div><div>Add the number of subscripts in the array in BC to the value of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>293D</div><div>ADD HL,BC</div><div>Add the number of subscripts in the array in BC to the value of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>293E</div><div>INC HL</div><div>Bump the value of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>293F</div><div>EX DE,HL</div><div>Load DE with the value of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2940-2942</div><div>LD HL,(40D8H)</div><div>Load HL with the address of the next array.<br>Note: 40D8H-40D9H holds Temporary storage location.</div></div>
									<div class="assembly-row-combined model1"><div>2943</div><div>EX DE,HL</div><div>Exchange the value of the array variables pointer in DE with the address of the array in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2944</div><div>RST 18H</div><div>Now
 we need to check to see if the array variables pointer in HL is the 
same as the address of the next array in DE, so we call the COMPARE 
DE:HL routine at RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The
 RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2945-2946</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2921" class="memory-link">JR Z,2921H</a></div><div>Jump to 2921H if the array variables pointer in HL is the same as the address of the next array in DE.</div></div>
									<div class="assembly-row-combined model1" id="293F"><div>2947-2948</div><div>LD BC,293FH</div><div>Load BC with a return address of 293FH.</div></div>
									<div class="assembly-row-combined model1"><div>294A</div><div>PUSH BC</div><div>Save the value in BC to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>294B</div><div>XOR A</div><div>Zero register A.</div></div>
									<div class="assembly-row-combined model1"><div>294C</div><div>OR (HL)</div><div>Load register A with the length of the string at the location of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>294D</div><div>INC HL</div><div>Bump the value of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>294E</div><div>LD E,(HL)</div><div>Load register E with the LSB of the string's address at the location of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>294F</div><div>INC HL</div><div>Bump the value of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2950</div><div>LD D,(HL)</div><div>Load register D with the MSB of the string's address at the location of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2951</div><div>INC HL</div><div>Bump the value of the array variables pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2952</div><div>RET Z</div><div>Return if the string's length in register A is equal to zero.</div></div>
									<div class="assembly-row-combined model1" id="2953"><div>2953</div><div>LD B,H</div><div>Load register B with the MSB of the array variables pointer in register H.</div></div>
									<div class="assembly-row-combined model1"><div>2954</div><div>LD C,L</div><div>Load register C with the LSB of the array variables pointer in register L.</div></div>
									<div class="assembly-row-combined model1"><div>2955-2957</div><div>LD HL,(40D6H)</div><div>Load HL with the location of the next available location in string space pointer.<br><span class="nobottomborder bold">NOTE:</span> 40D6H-40D7H holds Next available location in string space pointer.</div></div>
									<div class="assembly-row-combined model1"><div>2958</div><div>RST 18H</div><div>Now we need to check to see if the string's address in DE is in string space, so we call the COMPARE DE:HL routine at RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The
 RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2959</div><div>LD H,B</div><div>Load register H with the MSB of the array variables pointer in register B.</div></div>
									<div class="assembly-row-combined model1"><div>295A</div><div>LD L,C</div><div>Load register L with the LSB of the array variables pointer in register C.</div></div>
									<div class="assembly-row-combined model1"><div>295B</div><div>RET C</div><div>Return if the string's address in DE is in string space.</div></div>
									<div class="assembly-row-combined model1" id="295C"><div>295C</div><div>POP HL</div><div>Get the return address from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>295D</div><div>EX (SP),HL</div><div>Exchange the value of the return address in HL with the start of string space pointer to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>295E</div><div>RST 18H</div><div>Now
 we need to check to see if the string's address in DE is below the 
start of string space pointer in HL, so we call the COMPARE DE:HL 
routine at RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The
 RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>295F</div><div>EX (SP),HL</div><div>Exchange the start of string space pointer in HL with the value of the return address to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2960</div><div>PUSH HL</div><div>Save the value of the return address in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2961</div><div>LD H,B</div><div>Load register H with the MSB of the array variables pointer in register B.</div></div>
									<div class="assembly-row-combined model1"><div>2962</div><div>LD L,C</div><div>Load register L with the LSB of the array variables pointer in register C.</div></div>
									<div class="assembly-row-combined model1"><div>2963</div><div>RET NC</div><div>Return if the string's address in DE is below the string space pointer.</div></div>
									<div class="assembly-row-combined model1" id="2964"><div>2964</div><div>POP BC</div><div>Get the return address from the stack and put it in BC.</div></div>
									<div class="assembly-row-combined model1"><div>2965</div><div>POP AF</div><div>Clean up the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2966</div><div>POP AF</div><div>Clean up the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2967</div><div>PUSH HL</div><div>Save the value of the array variables pointer in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2968</div><div>PUSH DE</div><div>Save the string's address in DE to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2969</div><div>PUSH BC</div><div>Save the value of the return address in BC to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>296A</div><div>RET</div><div>Return.</div></div>
									<div class="assembly-row-combined model1" id="296B"><div>296B</div><div>POP DE</div><div>Load DE with the address of the last string put into the temporary string work area.</div></div>
									<div class="assembly-row-combined model1"><div>296C</div><div>POP HL</div><div>Get the temporary string work area pointer from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>296D</div><div>LD A,L</div><div>Load register A with the LSB of the temporary string work area pointer in register L.</div></div>
									<div class="assembly-row-combined model1"><div>296E</div><div>OR H</div><div>Combine
 the MSB of the temporary string work area pointer in register H with 
the LSB of the temporary string work area pointer in register A.</div></div>
									<div class="assembly-row-combined model1"><div>296F</div><div>RET Z</div><div>Return if the temporary string work area is empty.</div></div>
									<div class="assembly-row-combined model1" id="2970"><div>2970</div><div>DEC HL</div><div>Decrement the value of the temporary string work area pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2971</div><div>LD B,(HL)</div><div>Load register B with the MSB of the string's address at the location of the temporary string work area pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2972</div><div>DEC HL</div><div>Decrement the value of the temporary string work area pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2973</div><div>LD C,(HL)</div><div>Load register C with the LSB of the string's address at the location of the temporary string work area pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2974</div><div>PUSH HL</div><div>Save the value of the temporary string work area pointer in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2975</div><div>DEC HL</div><div>Decrement the value of the temporary string work area pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2976</div><div>LD L,(HL)</div><div>Load register L with the string's length at the location of the temporary string work area pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2977-2978</div><div>LD H,00H</div><div>Zero register H.</div></div>
									<div class="assembly-row-combined model1"><div>2979</div><div>ADD HL,BC</div><div>Add the length of the string in HL to the string's address in BC.</div></div>
									<div class="assembly-row-combined model1"><div>297A</div><div>LD D,B</div><div>Load register D with the MSB of the string's address in register B.</div></div>
									<div class="assembly-row-combined model1"><div>297B</div><div>LD E,C</div><div>Load register E with the LSB of the string's address in register C.</div></div>
									<div class="assembly-row-combined model1"><div>297C</div><div>DEC HL</div><div>Decrement the value of the string's ending address in HL.</div></div>
									<div class="assembly-row-combined model1"><div>297D</div><div>LD B,H</div><div>Load register B with the MSB of the string's ending address in register H.</div></div>
									<div class="assembly-row-combined model1"><div>297E</div><div>LD C,L</div><div>Load register C with the LSB of the string's ending address in register L.</div></div>
									<div class="assembly-row-combined model1"><div>297F-2981</div><div>LD HL,(40D6H)</div><div>Load HL with the next available location in string space pointer.<br><span class="nobottomborder bold">NOTE:</span> 40D6H-40D7H holds Next available location in string space pointer.</div></div>
									<div class="assembly-row-combined model1"><div>2982-2984</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1958" class="memory-link">CALL 1958H</a></div><div>Move the string from the temporary storage location to string space.</div></div>
									<div class="assembly-row-combined model1"><div>2985</div><div>POP HL</div><div>Get the temporary string work area pointer from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2986</div><div>LD (HL),C</div><div>Save the LSB of the string's address in register Cat the location of the temporary string work area pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2987</div><div>INC HL</div><div>Bump the value of the temporary string work area pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2988</div><div>LD (HL),B</div><div>Save the MSB of the string's address in register B at the location of the temporary string work area pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2989</div><div>LD L,C</div><div>Load register L with the LSB of the string's address in register C.</div></div>
									<div class="assembly-row-combined model1"><div>298A</div><div>LD H,B</div><div>Load register H with the MSB of the string's address in register B.</div></div>
									<div class="assembly-row-combined model1"><div>298B</div><div>DEC HL</div><div>Decrement the string's address in HL.</div></div>
									<div class="assembly-row-combined model1"><div>298C-298E</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#28E9" class="memory-link">JP 28E9H</a></div><div>Jump to 28E9H.</div></div>
								</div>
							</div>

							<br><h2 id="298f-29c5-string">298F-29C5 - STRING ADDITION ROUTINE - Concatenate two strings.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>298F</div><div>PUSH BC</div><div>Save the operator value in BC to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2990</div><div>PUSH HL</div><div>Save the value of the current BASIC program pointer in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2991-2993</div><div>LD HL,(4121H)</div><div>Load HL with the first string's VARPTR (from REG 1).</div></div>
									<div class="assembly-row-combined model1"><div>2994</div><div>EX (SP),HL</div><div>Exchange the value of the first string's VARPTR in HL with the value of the current BASIC program to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2995-2997</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#249F" class="memory-link">CALL 249FH</a></div><div>GOSUB to 249FH to evaluate the expression at the location of the current BASIC program pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2998</div><div>EX (SP),HL</div><div>Exchange the value of the current BASIC program pointer in HL with the value of the first string's VARPTR to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2999-299B</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0AF4" class="memory-link">CALL 0AF4H</a></div><div>Go make sure the current result in REG 1 is a string.</div></div>
									<div class="assembly-row-combined model1"><div>299C</div><div>LD A,(HL)</div><div>Load register A with the first string's length at the location of the first string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1"><div>299D</div><div>PUSH HL</div><div>Save the value of the first string's VARPTR in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>299E-29A0</div><div>LD HL,(4121H)</div><div>Load HL with the second string's VARPTR in REG 1.</div></div>
									<div class="assembly-row-combined model1"><div>29A1</div><div>PUSH HL</div><div>Save the second string's VARPTR in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>29A2</div><div>ADD A,(HL)</div><div>Add
 the length of the second string at the location of the second string's 
VARPTR in HL to the length of the first string in register A.</div></div>
									<div class="assembly-row-combined model1"><div>29A3-29A4</div><div>LD E,1CH</div><div>Load register E with a <span class="code">?LS ERROR</span> code.</div></div>
									<div class="assembly-row-combined model1"><div>29A5-29A7</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#19A2" class="memory-link">JP C,19A2H</a></div><div>Display a <span class="code">?LS ERROR</span> message if the combined lengths of the strings is greater than 255.</div></div>
									<div class="assembly-row-combined model1"><div>29A8-29AA</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2857" class="memory-link">CALL 2857H</a></div><div>Go make sure that there is enough string space for the new string.</div></div>
									<div class="assembly-row-combined model1"><div>29AB</div><div>POP DE</div><div>Get the second string's VARPTR from the stack and put it in DE.</div></div>
									<div class="assembly-row-combined model1"><div>29AC-29AE</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#29DE" class="memory-link">CALL 29DEH</a></div><div>Go update the temporary string work area.</div></div>
									<div class="assembly-row-combined model1"><div>29AF</div><div>EX (SP),HL</div><div>Exchange the second string's VARPTR in HL with the first string's VARPTR to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>29B0-29B2</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#29DD" class="memory-link">CALL 29DDH</a></div><div>Go update the temporary string work area.</div></div>
									<div class="assembly-row-combined model1"><div>29B3</div><div>PUSH HL</div><div>Save the value of the first string's VARPTR in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>29B4-29B6</div><div>LD HL,(40D4H)</div><div>Load HL with the second string's address.</div></div>
									<div class="assembly-row-combined model1"><div>29B7</div><div>EX DE,HL</div><div>Load DE with the second string's address in HL.</div></div>
									<div class="assembly-row-combined model1"><div>29B8-29BA</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#29C6" class="memory-link">CALL 29C6H</a></div><div>Go move the first string to its temporary storage location.</div></div>
									<div class="assembly-row-combined model1"><div>29BB-29BD</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#29C6" class="memory-link">CALL 29C6H</a></div><div>Go move the second string to its temporary storage location.</div></div>
									<div class="assembly-row-combined model1"><div>29BE-29C0</div><div>LD HL,2349H</div><div>Load HL with the return address.</div></div>
									<div class="assembly-row-combined model1"><div>29C1</div><div>EX (SP),HL</div><div>Exchange the value of the return address in HL with the value of the current BASIC program pointer to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>29C2</div><div>PUSH HL</div><div>Save the value of the current BASIC program pointer in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>29C3-29C5</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2884" class="memory-link">JP 2884H</a></div><div>Jump to 2884H.</div></div>
								</div>
							</div>

							<br><h2 id="29c6-29d6-string">29C6-29D6 - STRING ROUTINE - This will move strings using the stack.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<p>On entry, the stack should have the count/source address and DE should have the destination address.</p>
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>29C6</div><div>POP HL</div><div>Load HL with the value of the return address to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>29C7</div><div>EX (SP),HL</div><div>Exchange the value of the return address in HL with the string's VARPTR to the stack.</div></div>
								</div>
							</div>

							<br><h2 id="29c8-string-move">29C8 - STRING MOVE ROUTINE<br>On 
entry HL points to the string control block for the string to be moved, 
and DE contains the destination address. All registers are used. The 
string length and address are not moved. String control blocks have the 
format: X=String Length; ADDR = String Address.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>29C8</div><div>LD A,(HL)</div><div>Load register A with the string's length at the location of the string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1"><div>29C9</div><div>INC HL</div><div>Bump the value of the string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1"><div>29CA</div><div>LD C,(HL)</div><div>Load register C with the LSB of the string's address at the location of the string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1"><div>29CB</div><div>INC HL</div><div>Bump the value of the string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1"><div>29CC</div><div>LD B,(HL)</div><div>Load register B with the MSB of the string's address at the location of the string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1"><div>29CD</div><div>LD L,A</div><div>Load register L with the string's length in register A.</div></div>
									<div class="assembly-row-combined model1"><div>29CE</div><div>INC L</div><div>Bump the value of the string's length in register L.</div></div>
									<div class="assembly-row-combined model1"><div>29CF</div><div>DEC L</div><div>Decrement the value of the string's length in register L.</div></div>
									<div class="assembly-row-combined model1"><div>29D0</div><div>RET Z</div><div>Return if all of the characters in the string have been moved.</div></div>
									<div class="assembly-row-combined model1" id="29D1"><div>29D1</div><div>LD A,(BC)</div><div>Load register A with the character at the location of the string pointer in BC.</div></div>
									<div class="assembly-row-combined model1"><div>29D2</div><div>LD (DE),A</div><div>Save the character in register A at the location of the string storage pointer in DE.</div></div>
									<div class="assembly-row-combined model1"><div>29D3</div><div>INC BC</div><div>Bump the value of the string pointer in BC.</div></div>
									<div class="assembly-row-combined model1"><div>29D4</div><div>INC DE</div><div>Bump the value of the string storage pointer in DE.</div></div>
									<div class="assembly-row-combined model1"><div>29D5-29D6</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#29CF" class="memory-link">JR 29CFH</a></div><div>Loop until the string has been completely moved.</div></div>
								</div>
							</div>

							<br><h2 id="29d7-29f4-string">29D7-29F4 - STRING ROUTINE<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<p>This routine is a contination of <span class="code">VAL</span>, <span class="code">FRE</span>, and <span class="code">PRINT</span> processing. A jump to here would include the need to get a string's VARPTR and put it in HL.</p>
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>29D7-29D9</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0AF4" class="memory-link">CALL 0AF4H</a></div><div>GOSUB to 0AF4H to make sure that the current result in REG l is a string.</div></div>
									<div class="assembly-row-combined model1" id="29DA"><div>29DA-29DC</div><div>LD HL,(4121H)</div><div>Load HL with the string's VARPTR in REG 1.</div></div>
									<div class="assembly-row-combined model1"><div>29DD</div><div>EX DE,HL</div><div>Load DE with the value of the string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1"><div>29DE-29E0</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#29F5" class="memory-link">CALL 29F5H</a></div><div>Check to see if the string is the last entry in the temporary string work area.</div></div>
									<div class="assembly-row-combined model1"><div>29E1</div><div>EX DE,HL</div><div>Load HL with the value of the string's VARPTR in DE.</div></div>
									<div class="assembly-row-combined model1"><div>29E2</div><div>RET NZ</div><div>Return if the string isn't the last entry in the temporary string work area.</div></div>
									<div class="assembly-row-combined model1" id="29E3"><div>29E3</div><div>PUSH DE</div><div>Save the value of the string's VARPTR in DE to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>29E4</div><div>LD D,B</div><div>Load register D with the MSB of the string's address in register B.</div></div>
									<div class="assembly-row-combined model1"><div>29E5</div><div>LD E,C</div><div>Load register E with the LSB of the string's address in register C.</div></div>
									<div class="assembly-row-combined model1"><div>29E6</div><div>DEC DE</div><div>Decrement the value of the string's address in DE.</div></div>
									<div class="assembly-row-combined model1"><div>29E7</div><div>LD C,(HL)</div><div>Load register C with the string's length at the location of the string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1"><div>29E8-29EA</div><div>LD HL,(40D6H)</div><div>Load HL with the next available location in string space pointer.<br>Note: 40D6H-40D7H holds Next available location in string space pointer.</div></div>
									<div class="assembly-row-combined model1"><div>29EB</div><div>RST 18H</div><div>We
 need to see if the current string is the last one defined in the string
 area by seeing if the string's address in DE is the same as the next 
available location in string space pointer in HL, so we call the COMPARE
 DE:HL routine at RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The
 RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>29EC-29ED</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#29F3" class="memory-link">JR NZ,29F3H</a></div><div>Jump forward to 29F3H if the string's address in DE isn't the same as the next available location in string space pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>29EE</div><div>LD B,A</div><div>If
 is the last one defined then we need to update the current string 
pointer so first we load register B with the value in register A.</div></div>
									<div class="assembly-row-combined model1"><div>29EF</div><div>ADD HL,BC</div><div>Add the length of the string in BC to the next available location in string space pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>29E0-29F2</div><div>LD (40D6H),HL</div><div>Save the adjusted next available location in string space pointer in HL.<br>Note: 40D6H-40D7H holds Next available location in string space pointer.</div></div>
									<div class="assembly-row-combined model1"><div>29F3</div><div>POP HL</div><div>Get the string's VARPTR from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>29F4</div><div>RET</div><div>Return.</div></div>
								</div>
							</div>

							<br><h2 id="29f5-2a02-string">29F5-2A02 - STRING ROUTINE<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>29F5-29F7</div><div>LD HL,(40B3H)</div><div>Load HL with the temporary string work area pointer.<br>Note: 40B3H-40B4H holds Next available location in the temporary string work area pointer.</div></div>
									<div class="assembly-row-combined model1"><div>29F8</div><div>DEC HL</div><div>Decrement the value of the temporary string work area pointer in HL which backs up two words.</div></div>
									<div class="assembly-row-combined model1"><div>29F9</div><div>LD B,(HL)</div><div>Load register B with the MSB of the string's address at the location of the temporary string work area pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>29FA</div><div>DEC HL</div><div>Decrement the value of the temporary string work area pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>29FB</div><div>LD C,(HL)</div><div>Load register C with the LSB of the string's address at the location of the temporary string work area pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>29FC</div><div>DEC HL</div><div>Decrement the value of the temporary string work area pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>29FD</div><div>RST 18H</div><div>Now
 we need to check to see if the string's VARPTR in DE matches the 
temporary string work area pointer in HL, so we call the COMPARE DE:HL 
routine at RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The
 RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>29FE</div><div>RET NZ</div><div>Return if the string's VARPTR in DE doesn't match the temporary string work area pointer in HL.</div></div>
									<div class="assembly-row-combined model1" id="29FF"><div>29FF-2A01</div><div>LD (40B3H),HL</div><div>Save the value of the temporary string work area pointer in HL.<br>Note: 40B3H-40B4H holds Next available location in the temporary string work area pointer.</div></div>
									<div class="assembly-row-combined model1"><div>2A02</div><div>RET</div><div>Return.</div></div>
								</div>
							</div>

							<br><h2 id="2a03-2a0e-level-ii">2A03-2A0E - LEVEL II BASIC <span class="code">LEN</span> ROUTINE<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1" id="27F8"><div>2A03-2A05</div><div>LD BC,27F8H</div><div>Load BC with the return address of 27F8H.</div></div>
									<div class="assembly-row-combined model1"><div>2A06</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#27F8" class="memory-link">PUSH BC</a></div><div>Save the return address of 27F8H (in BC) to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2A07-2A09</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#29D7" class="memory-link">CALL 29D7H</a></div><div>GOSUB to 29D7H to get the string's VARPTR and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2A0A</div><div>XOR A</div><div>Zero register A.</div></div>
									<div class="assembly-row-combined model1"><div>2A0B</div><div>LD D,A</div><div>Zero register D.</div></div>
									<div class="assembly-row-combined model1"><div>2A0C</div><div>LD A,(HL)</div><div>Load register A with the string's length at the location of the string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2A0D</div><div>OR A</div><div>Set the flags according to the string's length in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2A0E</div><div>RET</div><div>Return.</div></div>
								</div>
							</div>

							<br><h2 id="2a0f-2a1e-level-ii">2A0F-2A1E - LEVEL II BASIC <span class="code">ASC</span> ROUTINE<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1" id="27F8"><div>2A0F-2A11</div><div>LD BC,27F8H</div><div>Load BC with the return address of 27F8H.</div></div>
									<div class="assembly-row-combined model1"><div>2A12</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#27F8" class="memory-link">PUSH BC</a></div><div>Save the return address of 27F8H (in BC) to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2A13-2A15</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2A07" class="memory-link">CALL 2A07H</a></div><div>GOSUB to 2A07H (which itself is a GOSUB to 29D7H) to get string's VARPTR into HL and the string's length into register A.</div></div>
									<div class="assembly-row-combined model1"><div>2A16-2A18</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1E4A" class="memory-link">JP Z,1E4AH</a></div><div>Display a <span class="code">?FC ERROR</span> if the string's length in register A is equal to zero.</div></div>
									<div class="assembly-row-combined model1"><div>2A19</div><div>INC HL</div><div>Bump the value of the string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2A1A</div><div>LD E,(HL)</div><div>Load register E with the LSB of the string's address at the location of the string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2A1B</div><div>INC HL</div><div>Bump the value of the string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2A1C</div><div>LD D,(HL)</div><div>Load register D with the MSB of the string's address at the location of the string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2A1D</div><div>LD A,(DE)</div><div>Load register A with the first character at the location of the string pointer in DE.</div></div>
									<div class="assembly-row-combined model1"><div>2A1E</div><div>RET</div><div>Return.</div></div>
								</div>
							</div>

							<br><h2 id="2a1f-2a2e-level-ii">2A1F-2A2E - LEVEL II BASIC <span class="code">CHR$</span> ROUTINE<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2A1F-2A20</div><div>LD A,01H</div><div>Load register A with the length of the string to be created.</div></div>
									<div class="assembly-row-combined model1"><div>2A21-2A23</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2857" class="memory-link">CALL 2857H</a></div><div>GOSUB to 2857H to save the string's length in register A and value and set up the string's address.</div></div>
									<div class="assembly-row-combined model1"><div>2A24-2A26</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2B1F" class="memory-link">CALL 2B1FH</a></div><div>GOSUB
 to 2B1FH to evaluate the expression at the location of the current 
BASIC program pointer in HL and return with the integer result in DE.</div></div>
									<div class="assembly-row-combined model1"><div>2A27-2A29</div><div>LD HL,(40D4H)</div><div>Load HL with the temporary string's address.</div></div>
									<div class="assembly-row-combined model1"><div>2A2A</div><div>LD (HL),E</div><div>Save the character in register E at the location of the string pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2A2B</div><div>POP BC</div><div>Clean up the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2A2C-2A2E</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2884" class="memory-link">JP 2884H</a></div><div>Jump to 2884H.</div></div>
								</div>
							</div>

							<br><h2 id="2a2f-2a60-level-ii">2A2F-2A60 - LEVEL II BASIC <span class="code">STRING$</span> ROUTINE<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2A2F</div><div>RST 10H</div><div>We have the <span class="code">STRING$</span>
 command, but now we need the next character so we call a RST 10H to 
bump the value of the current BASIC program pointer until it points to 
the next character, call the EXAMINE NEXT SYMBOL routine at RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The
 RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2A30-2A31</div><div>RST 08H ‚áí 28H</div><div>Since the character at the location of the current BASIC program pointer in HL must be a <span class="code">(</span>, call the COMPARE SYMBOL routine at RST 08H.<br><br><span class="bold nobottomborder">NOTE:</span>
 The RST 08H routine compares the symbol in the input string pointed to 
by HL register to the value in the location following the RST 08 call.<ul><li>If
 there is a match, control is returned to the next execution address 
(i.e, the RST 08H instruction + 2) with the next symbol in the A 
Register and HL incremented by one.</li><li>If the two characters do not match, a syntax error message is given and control returns to the Input Phase).</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2A32-2A34</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2B1C" class="memory-link">CALL 2B1CH</a></div><div>This
 will get the string length required (which we will call "N") via a 
GOSUB to 2B1CH to evaluate the expression at the location of the current
 BASIC program pointer in HL and return with the integer result in DE.</div></div>
									<div class="assembly-row-combined model1"><div>2A34</div><div>DEC HL</div><div>Backspace the code string. This is a Z-80 trick because this code was part of the above call instruction.</div></div>
									<div class="assembly-row-combined model1"><div>2A35</div><div>PUSH DE</div><div>Save the string's length ("N") (currently in DE) to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2A36-2A37</div><div>RST 08 ‚áí 2CH</div><div>Now we have <span class="code">STRING$(nnn</span> so the next character needs to be a <span class="code">,</span>. To test for the character at the location of the current BASIC program pointer in HL being a <span class="code">,</span>,
 call the COMPARE SYMBOL routine which compares the symbol in the input 
string pointed to by HL register to the value in the location following 
the RST 08 call. If there is a match, control is returned to address of 
the RST 08 instruction + 2 with the next symbol in the A register and HL
 incremented by one. If the two characters do not match, a syntax error 
message is given and control returns to the Input Phase).</div></div>
									<div class="assembly-row-combined model1"><div>2A38-2A3A</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2337" class="memory-link">CALL 2337H</a></div><div>Now we have <span class="code">STRING$(xxx,</span>
 and an expression so GOSUB to 2337H to evaluate the expression at the 
location of the current BASIC program pointer in HL and return with the 
result in REG 1.</div></div>
									<div class="assembly-row-combined model1"><div>2A3B-2A3C</div><div>RST 08H ‚áí 29H</div><div>Now we have <span class="code">STRING$(nnn,X</span>. Since the character at the location of the current BASIC program pointer in HL must be a <span class="code">)</span>, call the COMPARE SYMBOL routine at RST 08H.<br><br><span class="bold nobottomborder">NOTE:</span>
 The RST 08H routine compares the symbol in the input string pointed to 
by HL register to the value in the location following the RST 08 call.<ul><li>If
 there is a match, control is returned to the next execution address 
(i.e, the RST 08H instruction + 2) with the next symbol in the A 
Register and HL incremented by one.</li><li>If the two characters do not match, a syntax error message is given and control returns to the Input Phase).</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2A3D</div><div>EX (SP),HL</div><div>We are now done with getting <span class="code">STRING$(nnn,X)</span>. Next we must exchange the value of the current BASIC program pointer in HL with the string's length ("N") in the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2A3E</div><div>PUSH HL</div><div>Save the string's length ("N") in HL to the stack so that we can test it to make sure it is an integer.</div></div>
									<div class="assembly-row-combined model1"><div>2A3F</div><div>RST 20H</div><div>We need to check the value of the current data type flag, so we call the TEST DATA MODE routine at RST 20H.<br><span class="nobottomborder bold">NOTE:</span>
  The RST 20H routine determines the type of the current value in REG 1 
and returns a combination of STATUS flags and unique numeric values in 
the A Register according to the data mode flag (40AFH).<br><br>The results are returned as follows:<table style="border-collapse: collapse; border: 1px solid black;"><tbody><tr style="background-color: #f0f0f0;"><td style="border: 1px solid black; padding: 8px;">If the Variable Type is ...</td><td style="border: 1px solid black; padding: 8px;">and the Flags<br>are set ...</td><td style="border: 1px solid black; padding: 8px;">... then Register<br>A will be set ...</td></tr><tr><td style="border: 1px solid black; padding: 8px;">Integer</td><td style="border: 1px solid black; padding: 8px;">NZ/C/M/E</td><td style="border: 1px solid black; padding: 8px;">-1</td></tr><tr><td style="border: 1px solid black; padding: 8px;">String</td><td style="border: 1px solid black; padding: 8px;">Z/C/P/E</td><td style="border: 1px solid black; padding: 8px;">0</td></tr><tr><td style="border: 1px solid black; padding: 8px;">Single Precision</td><td style="border: 1px solid black; padding: 8px;">NZ/C/P/O</td><td style="border: 1px solid black; padding: 8px;">1</td></tr><tr><td style="border: 1px solid black; padding: 8px;">Double Precision</td><td style="border: 1px solid black; padding: 8px;">NZ/NC/P/E</td><td style="border: 1px solid black; padding: 8px;">5</td></tr></tbody></table></div></div>
									<div class="assembly-row-combined model1"><div>2A40-2A41</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2A47" class="memory-link">JR Z,2A47H</a></div><div>If that test shows "N" is a a STRING, jump to down to 2A47H.</div></div>
									<div class="assembly-row-combined model1"><div>2A42-2A44</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2B1F" class="memory-link">CALL 2B1FH</a></div><div>We
 now know that "N" is at least a number, so we GOSUB to 2B1FH to convert
 the current result in REG 1 to an integer and return with the 8-bit 
result in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2A45-2A46</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2A4A" class="memory-link">JR 2A4AH</a></div><div>Skip the next instruction (which would load the string address and 1st character) by jumping to 2A4AH.</div></div>
									<div class="assembly-row-combined model1"><div>2A47-2A49</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2A13" class="memory-link">CALL 2A13H</a></div><div>Go get the first character in the string and return with it in register A. This is the character that will be repeated.</div></div>
									<div class="assembly-row-combined model1"><div>2A4A</div><div>POP DE</div><div>Get the "N" from the stack and put it in DE.</div></div>
									<div class="assembly-row-combined model1"><div>2A4B</div><div>PUSH AF</div><div>Save the character for the string (held in register A) to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2A4C</div><div>PUSH AF</div><div>and then save it to the stack again.</div></div>
									<div class="assembly-row-combined model1"><div>2A4D</div><div>LD A,E</div><div>Load register A with "N" (held in register E).</div></div>
									<div class="assembly-row-combined model1"><div>2A4E-2A4F</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2857" class="memory-link">CALL 2857H</a></div><div>GOSUB to 2857H to allocate N bytes in the temporary string work area .</div></div>
									<div class="assembly-row-combined model1"><div>2A51</div><div>LD E,A</div><div>Load register E with "N" (held in register A).</div></div>
									<div class="assembly-row-combined model1"><div>2A52</div><div>POP AF</div><div>Get the character for the string ("X") from the stack and put it in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2A53</div><div>INC E</div><div>To set the status flags we need to increase and then decrease E. First, bump the value of the string's length in register E ...</div></div>
									<div class="assembly-row-combined model1"><div>2A54</div><div>DEC E</div><div>... and then decrement the string's length in register E.</div></div>
									<div class="assembly-row-combined model1"><div>2A55-2A56</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2A2B" class="memory-link">JR Z,2A2BH</a></div><div>If "N" was zero (so that the string is now complete), jump back to 2A2BH.</div></div>
									<div class="assembly-row-combined model1"><div>2A57-2A59</div><div>LD HL,(40D4H)</div><div>If we are here, we have not finished building the <span class="code">STRING$</span> string so now we load HL with the string's address and get ready to loop.</div></div>
									<div class="assembly-row-combined model1"><div>2A5A</div><div>LD (HL),A</div><div>Save the character in register A ("X") at the location of the string pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2A5B</div><div>INC HL</div><div>Bump the value of the string pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2A5C</div><div>DEC E</div><div>Decrement the string's length in register E.</div></div>
									<div class="assembly-row-combined model1"><div>2A5D-2A5E</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2A5A" class="memory-link">JR NZ,2A5AH</a></div><div>Loop back to 2A5AH to keep filling (HL) until the string of X's has been completed.</div></div>
									<div class="assembly-row-combined model1"><div>2A5F-2A60</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2A2B" class="memory-link">JR 2A2BH</a></div><div>Jump back to 2A2BH.</div></div>
								</div>
							</div>

							<br><h2 id="2a61-2a90-level-ii">2A61-2A90 - LEVEL II BASIC <span class="code">LEFT$(</span> ROUTINE - On entry, HL=address of LEFT$, the stack = string address, stack+1 = n, and DE = code string address.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2A61-2A63</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2ADF" class="memory-link">CALL 2ADFH</a></div><div>Go check the syntax. The character at the location of the current BASIC program pointer in HL must be a <span class="code">)</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2A64</div><div>XOR A</div><div>Zero register A.</div></div>
									<div class="assembly-row-combined model1"><div>2A65</div><div>EX (SP),HL</div><div>Exchange the value of the current BASIC program pointer in HL with the string's VARPTR to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2A66</div><div>LD C,A</div><div>Zero register C.</div></div>
									<div class="assembly-row-combined model1"><div>2A67-2A68</div><div>3E E5</div><div>Z-80 Trick. By adding a 3E at 2A67, it masks out 2A68H if passing through by making the Z-80 think the instruction is <span class="code">LD A,0E5H</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2A68</div><div>LD H,A</div><div>Load register H with the value in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2A69</div><div>PUSH HL</div><div>Save the value of the string's VARPTR in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2A6A</div><div>LD A,(HL)</div><div>Load register A with the string's length at the location of the string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2A6B</div><div>CP B</div><div>Check to see if the new string's length in register B is greater than the string's length in register A.</div></div>
									<div class="assembly-row-combined model1" id="2A70"><div>2A6C-2A6D</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2A70" class="memory-link">JR C,2A70H</a></div><div>Jump to 2A70H if the new string's length in register B is greater than the string's length in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2A6E</div><div>LD A,B</div><div>Load register A with the new string's length in register B.</div></div>
									<div class="assembly-row-combined model1"><div>2A6F-2A71</div><div>11 0E 00</div><div>Z-80 Trick. This is a <span class="code">LD DE,000EH</span>
 which is irrelevant and only executed if continuing through. If, 
however, one was to jump to 2A70H instead, a proper opcode would occur.</div></div>
									<div class="assembly-row-combined model1"><div>2A70-2A7l</div><div>LD C,00H</div><div>Zero register C.</div></div>
									<div class="assembly-row-combined model1"><div>2A72</div><div>PUSH BC</div><div>Save the string's length in BC to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2A73-2A75</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#28BF" class="memory-link">CALL 28BFH</a></div><div>Go see if there is enough string space for the new string.</div></div>
									<div class="assembly-row-combined model1"><div>2A76</div><div>POP BC</div><div>Get the new string's length from the stack and put it in BC.</div></div>
									<div class="assembly-row-combined model1"><div>2A77</div><div>POP HL</div><div>Get the string's VARPTR from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2A78</div><div>PUSH HL</div><div>Save the string's VARPTR in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2A79</div><div>INC HL</div><div>Bump the value of the string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2A7A</div><div>LD B,(HL)</div><div>Load register B with the LSB of the string's address at the location of the string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2A7B</div><div>INC HL</div><div>Bump the value of the string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2A7C</div><div>LD H,(HL)</div><div>Load register H with the MSB of the string's address at the location of the string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2A7D</div><div>LD L,B</div><div>Load register L with the LSB of the string's address in register B.</div></div>
									<div class="assembly-row-combined model1"><div>2A7E-2A7F</div><div>LD B,00H</div><div>Zero register B.</div></div>
									<div class="assembly-row-combined model1"><div>2A80</div><div>ADD HL,BC</div><div>Add the string's length in BC to the string's address in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2A81</div><div>LD B,H</div><div>Load register B with the MSB of the string's ending address in register H.</div></div>
									<div class="assembly-row-combined model1"><div>2A82</div><div>LD C,L</div><div>Load register C with the LSB of the string's ending address in register L.</div></div>
									<div class="assembly-row-combined model1"><div>2A83-2A85</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#285A" class="memory-link">CALL 285AH</a></div><div>Go save the string's length (held in A) and the string's starting address (held in DE).</div></div>
									<div class="assembly-row-combined model1"><div>2A86</div><div>LD L,A</div><div>Load register L with the string's length (i.e., the number of characters to move) held in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2A87-2A89</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#29CE" class="memory-link">CALL 29CEH</a></div><div>Go move L characers frm BC to DE.</div></div>
									<div class="assembly-row-combined model1"><div>2A8A</div><div>POP DE</div><div>Clean up the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2A8B-2A8D</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#29DE" class="memory-link">CALL 29DEH</a></div><div>Go update the temporary string work area.</div></div>
									<div class="assembly-row-combined model1"><div>2A8E-2A90</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2884" class="memory-link">JP 2884H</a></div><div>Jump to 2884H.</div></div>
								</div>
							</div>

							<br><h2 id="2a91-2a99-level-ii">2A91-2A99 - LEVEL II BASIC RIGHT$ ROUTINE<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2A91-2A93</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2ADF" class="memory-link">CALL 2ADFH</a></div><div>Go check the syntax. The character at the location of the current BASIC program pointer in HL must be a <span class="code">)</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2A94</div><div>POP DE</div><div>Get the string's VARPTR from the stack and put it in DE.</div></div>
									<div class="assembly-row-combined model1"><div>2A95</div><div>PUSH DE</div><div>Save the string's VARPTR in DE to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2A96</div><div>LD A,(DE)</div><div>Load register A with the string's length (held at the location of the string's VARPTR in DE).</div></div>
									<div class="assembly-row-combined model1"><div>2A97</div><div>SUB B</div><div>Subtract the new string's length in register B from the string's length in register A to isolate the number of bytes.</div></div>
									<div class="assembly-row-combined model1"><div>2A98-2A99</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2A65" class="memory-link">JR 2A65H</a></div><div>Jump to the <span class="code">LEFT$(</span> code.</div></div>
								</div>
							</div>

							<br><h2 id="2a9a-2ac4-level-ii">2A9A-2AC4 - LEVEL II BASIC MID$ ROUTINE<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2A9A</div><div>EX DE,HL</div><div>Load HL with the value of the current BASIC program pointer (held in DE).</div></div>
									<div class="assembly-row-combined model1"><div>2A9B</div><div>LD A,(HL)</div><div>Load register A with the terminal character, currently held at the location of the current BASIC program pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2A9C-2A9E</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2AE2" class="memory-link">CALL 2AE2H</a></div><div>GOSUB to 2AE2H to get the string's position in register B and the string's VARPTR in DE.</div></div>
									<div class="assembly-row-combined model1"><div>2A9F</div><div>INC B</div><div>We
 need to set the status flags to correspond to the position value so we 
first bump the value of the string's position in register B ...</div></div>
									<div class="assembly-row-combined model1"><div>2AA0</div><div>DEC B</div><div>... and then we decrement the value of the string's position in register B.</div></div>
									<div class="assembly-row-combined model1"><div>2AA1-2AAJ</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1E4A" class="memory-link">JP Z,1E4AH</a></div><div>If the starting position (held in B) is 0, display <span class="code">?FC ERROR</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2AA4</div><div>PUSH BC</div><div>Save the value of the string's starting position (held in register B) to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2AA5-2AA6</div><div>LD E,0FFH</div><div>Load register E with the default string's length of 256 in case no number of bytes are given.</div></div>
									<div class="assembly-row-combined model1"><div>2AA7-2AA8</div><div>CP 29H</div><div>More syntax checking. Here we need to test for a <span class="code">)</span> at the location of the current BASIC program pointer.</div></div>
									<div class="assembly-row-combined model1"><div>2AA9-2AAA</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2AB0" class="memory-link">JR Z,2AB0H</a></div><div>Jump to 2AB0H if the character at the location of the current BASIC program pointer in register A is a <span class="code">)</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2AAB-2AAC</div><div>RST 08H ‚áí 2CH</div><div>If it wasn't a <span class="code">)</span>, it had best be a <span class="code">,</span>
 so we need to test the character at the location of the current BASIC 
program pointer in HL by calling the COMPARE SYMBOL routine at RST 08H.<br><br><span class="bold nobottomborder">NOTE:</span>
 The RST 08H routine compares the symbol in the input string pointed to 
by HL register to the value in the location following the RST 08 call.<ul><li>If
 there is a match, control is returned to the next execution address 
(i.e, the RST 08H instruction + 2) with the next symbol in the A 
Register and HL incremented by one.</li><li>If the two characters do not match, a syntax error message is given and control returns to the Input Phase).</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2AAD-2AAF</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2B1C" class="memory-link">CALL 2B1CH</a></div><div>Go
 evaluate the expression at the location of the current BASIC program 
pointer in HL and return with the integer result in DE. Now the byte 
count is in DE as an integer.</div></div>
									<div class="assembly-row-combined model1"><div>2ABO-2AB1</div><div>RST 08H ‚áí 29H</div><div>Since the character at the location of the current BASIC program pointer in HL must be a <span class="code">)</span>, call the COMPARE SYMBOL routine at RST 08H.<br><br><span class="bold nobottomborder">NOTE:</span>
 The RST 08H routine compares the symbol in the input string pointed to 
by HL register to the value in the location following the RST 08 call.<ul><li>If
 there is a match, control is returned to the next execution address 
(i.e, the RST 08H instruction + 2) with the next symbol in the A 
Register and HL incremented by one.</li><li>If the two characters do not match, a syntax error message is given and control returns to the Input Phase).</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2AB2</div><div>POP AF</div><div>Get the value of the string'starting s position from the stack and put it in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2AB3</div><div>EX (SP),HL</div><div>Exchange the value of the current BASIC program pointer in HL with the value of the string's VARPTR to the stack.</div></div>
									<div class="assembly-row-combined model1" id="2A69"><div>2AB4-2AB6</div><div>LD BC,2A69H</div><div>Load BC with 2A69H as the return address (which is in the <span class="code">LEFT$</span> routine).</div></div>
									<div class="assembly-row-combined model1"><div>2AB7</div><div>PUSH BC</div><div>Save the return address in BC to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2AB8</div><div>DEC A</div><div>Decrement the value of the string's position in register A so that we have a starting position minus 1.</div></div>
									<div class="assembly-row-combined model1"><div>2AB9</div><div>CP (HL)</div><div>Compare the string's length at the location of the string's VARPTR in HL with the value of the string's position in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2ABA-2ABB</div><div>LD B,00H</div><div>Zero register B.</div></div>
									<div class="assembly-row-combined model1"><div>2ABC</div><div>RET NC</div><div>Return if the string's position in register A is greater than the string's length at the location of the string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1" id="2ABD"><div>2ABD</div><div>LD C,A</div><div>Load register C with the string's position in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2ABE</div><div>LD A,(HL)</div><div>Load register A with the string's length at the location of the string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2ABF</div><div>SUB C</div><div>Subtract the value of the string's position in register C from the string's length in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2AC0</div><div>CP E</div><div>Compare the new string's length in register E with the adjusted string's length in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2AC1</div><div>LD B,A</div><div>Load register B with the adjusted string's length in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2AC2</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2A69" class="memory-link">RET C</a></div><div>Return to 2A69H if the new string's length in register E is greater than the string's length in register A.</div></div>
									<div class="assembly-row-combined model1" id="2AC3"><div>2AC3</div><div>LD B,E</div><div>Load register B with the new string's length in register E.</div></div>
									<div class="assembly-row-combined model1"><div>2AC4</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2A69" class="memory-link">RET</a></div><div>Return to 2A69H.</div></div>
								</div>
							</div>

							<br><h2 id="2ac5-2ade-level-ii">2AC5-2ADE - LEVEL II BASIC <span class="code">VAL</span> ROUTINE<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2AC5-2AC7</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2A07" class="memory-link">CALL 2A07H</a></div><div>Go get the string's length in register A and the string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2AC8-2ACA</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#27F8" class="memory-link">JP Z,27F8H</a></div><div>Jump to 27F8H if the string's length in register A is equal to zero.</div></div>
									<div class="assembly-row-combined model1"><div>2ACB</div><div>LD E,A</div><div>Load register E with the string's length at the location of the string's VARPTR in HL. </div></div>
									<div class="assembly-row-combined model1"><div>2ACC</div><div>INC HL</div><div>Bump the value of the string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2ACD</div><div>LD A,(HL)</div><div>Load register A with the LSB of the string's address at the location of the string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2ACE</div><div>INC HL</div><div>Bump the value of the string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2ACF</div><div>LD H,(HL)</div><div>Load register H with the MSB of the string's address at the location of the string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2ADO</div><div>LD L,A</div><div>Load register L with the LSB of the string's address in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2AD1</div><div>PUSH HL</div><div>Save the value of the string's address in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2AD2</div><div>ADD HL,DE</div><div>Add the string's length in DE to the string's address in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2AD3</div><div>LD B,(HL)</div><div>Load register B with the last character of the string at the location of the string pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2AD4</div><div>LD (HL),D</div><div>Save the zero in register D at the location of the string pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2AD5</div><div>EX (SP),HL</div><div>Exchange the string's ending address in HL with the string's address to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2AD6</div><div>PUSH BC</div><div>Save the last character of the string in register B to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2AD7</div><div>LD A,(HL)</div><div>Load register A with the character at the location of the string pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2AD8-2ADA</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0E65" class="memory-link">CALL 0E65H</a></div><div>Call
 the ASCII TO DOUBLE routine at 0E65H (which converts the ASCII string 
pointed to by HL to its double precision equivalent; with output left in
 REG 1).</div></div>
									<div class="assembly-row-combined model1"><div>2ADB</div><div>POP BC</div><div>Get the last character of the string from the stack and put it in register B.</div></div>
									<div class="assembly-row-combined model1"><div>2ADC</div><div>POP HL</div><div>Get the string's ending address from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2ADD</div><div>LD (HL),B</div><div>Save the character in register B at the location of the string pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2ADE</div><div>RET</div><div>Return.</div></div>
								</div>
							</div>

							<br><h2 id="2adf-2a6-string">2ADF-2A6 - STRING ROUTINE<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<p>This is called by <span class="code">LEFT$</span>, <span class="code">MID$</span>, and <span class="code">RIGHT$</span>
 to test for the ending ")" character. On entry, the stack has the 
string address, byte count, and return address. On exit the stack has 
the string address, DE and B each have the byte count.</p>
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2ADF</div><div>EX DE,HL</div><div>Load HL with the value of the current BASIC program pointer in DE.</div></div>
									<div class="assembly-row-combined model1"><div>2AE0-2AE1</div><div>RST 08H ‚áí 29H</div><div>Since the character at the location of the current BASIC program pointer in HL must be a <span class="code">)</span>, call the COMPARE SYMBOL routine at RST 08H.<br><br><span class="bold nobottomborder">NOTE:</span>
 The RST 08H routine compares the symbol in the input string pointed to 
by HL register to the value in the location following the RST 08 call.<ul><li>If
 there is a match, control is returned to the next execution address 
(i.e, the RST 08H instruction + 2) with the next symbol in the A 
Register and HL incremented by one.</li><li>If the two characters do not match, a syntax error message is given and control returns to the Input Phase).</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2AE2</div><div>POP BC</div><div>Get the return address from the stack and put it in BC.</div></div>
									<div class="assembly-row-combined model1"><div>2AE3</div><div>POP DE</div><div>Get the number of bytes to isolate from the string (from the stack) and put it in DE.</div></div>
									<div class="assembly-row-combined model1"><div>2AE4</div><div>PUSH BC</div><div>Save the return address in BC to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2AE5</div><div>LD B,E</div><div>Load register B with the number of bytes in register E.</div></div>
									<div class="assembly-row-combined model1"><div>2AE6</div><div>RET</div><div>Return.</div></div>
								</div>
							</div>

							<br><h2 id="2ae7h-aee-disk">2AE7H- AEE - DISK ROUTINE<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2AE7-2AE8</div><div>CP 7AH</div><div>Check
 to see if the character at the location of the current BASIC program 
pointer in register A is equal to 7AH (which is a lower case z).</div></div>
									<div class="assembly-row-combined model1"><div>2AE9-2AEB</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1997" class="memory-link">JP NZ,1997H</a></div><div>Display a <span class="code">?SN ERROR</span> message if the character at the location of the current BASIC program pointer in register A isn't equal to 7AH.</div></div>
									<div class="assembly-row-combined model1"><div>2AEC-2AEE</div><div><a href="#41D9" class="memory-link">JP 41D9H</a></div><div>Jump to the DOS link at 41D9H to let disk BASIC handle <span class="code">TAB</span>-<span class="code">MID$</span>.</div></div>
								</div>
							</div>

							<br><h2 id="2aef-2af7-level-ii">2AEF-2AF7 - LEVEL II BASIC <span class="code">INP</span> ROUTINE<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2AEF-2AF1</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2B1F" class="memory-link">CALL 2B1FH</a></div><div>Go
 evaluate the expression at the location of the current BASIC program 
pointer in HL and return with the port number in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2AF2-2AF4</div><div>LD (4094H),A</div><div>Save the value of the port number (from register A) into 4094H.</div></div>
									<div class="assembly-row-combined model1"><div>2AF5-2AF7</div><div><a href="#4093" class="memory-link">CALL 4093H</a></div><div>Go get the value from the port, execute an IN xx instruction, and return to the execution driver.<br>Note: 4093H-4095H holds INP routine.</div></div>
								</div>
							</div>

							<br><h2 id="2af8-2b00-level-ii">2AF8-2B00 - LEVEL II BASIC <span class="code">OUT</span> ROUTINE<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2AF8-2AFA</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#27F8" class="memory-link">JP 27F8H</a></div><div>Go
 evaluate the expression at the location of the current BASIC program 
pointer in HL and return with the port number saved in memory.</div></div>
									<div class="assembly-row-combined model1"><div>2AFB-2AFD</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2B0E" class="memory-link">CALL 2B0EH</a></div><div>Go
 evaluate the expression at the location of the current BASIC program 
pointer in HL and return with value to send to the port in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2AFE-2B00</div><div><a href="#4096" class="memory-link">JP 4096H</a></div><div>Go send the value in register A, execute an OUT xx instruction to the port, and return.<br>Note: 4096H-4098H holds OUT routine.</div></div>
								</div>
							</div>

							<br><h2 id="2b01-2b0d-evaluate">2B01-2B0D - EVALUATE EXPRESSION ROUTINE - This evaluates an expression and leaves the result in DE as an integer.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2B01</div><div>RST 10H</div><div>We need the next character in the BASIC program so call the EXAMINE NEXT SYMBOL routine at RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The
 RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2B02-2B04</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2337" class="memory-link">CALL 2337H</a></div><div>Go evaluate the expression at the location of the current BASIC program pointer in HL and return with the result in REG 1.</div></div>
								</div>
							</div>

							<br><h2 id="2b05-this-routine">2B05 - This routine takes the 
value from the ACC, converts it to an integer value and places the 
result in the DE register pair. The Z flag will be set if the result in 
DE is smaller than or equal to 255 (FFH). (DE = INT (ACC)).<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2B05</div><div>PUSH HL</div><div>Save the value of the current BASIC program pointer in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2B06-2B08</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0A7F" class="memory-link">CALL 0A7FH</a></div><div>Call
 the CONVERT TO INTEGER routine at 0A7FH (where the contents of REG 1 
are converted from single or double precision to integer and deposited 
into HL).</div></div>
									<div class="assembly-row-combined model1"><div>2B09</div><div>EX DE,HL</div><div>Load DE with the integer result in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2B0A</div><div>POP HL</div><div>Get the value of the current BASIC program pointer from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2B0B</div><div>LD A,D</div><div>Load register A with the MSB of the integer result in register D.</div></div>
									<div class="assembly-row-combined model1"><div>2B0C</div><div>OR A</div><div>Test the value of the MSB in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2B0D</div><div>RET</div><div>Return.</div></div>
								</div>
							</div>

							<br><h2 id="2b0e-2b16-evaluate">2B0E-2B16 - EVALUATE EXPRESSION ROUTINE - <span class="code">OUT</span> continues here<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2B0E-2B10</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2B1C" class="memory-link">CALL 2B1CH</a></div><div>GOSUB
 to 2B1CH to evaluate the expression at the location of the current 
BASIC program pointer in HL and return with the 8-bit value in register 
A.</div></div>
									<div class="assembly-row-combined model1"><div>2B11-2B13</div><div>LD (4094H),A</div><div>Save the 8-bit value in register A in the DOS address of 4094H.</div></div>
									<div class="assembly-row-combined model1"><div>2B14-2B16</div><div>LD (4097H),A</div><div>Save the 8-bit value in register A in the DOS address of 4097H.</div></div>
								</div>
							</div>

							<br><h2 id="2b17-2b1a-check">2B17-2B1A - CHECK SYNTAX ROUTINE - This checks to see if the next character is a <span class="code">"</span> and contnues on to 2B1CH if it is, and errors out if it isn't.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2B17-2B18</div><div>RST 08H ‚áí 2EH</div><div>Since
 the character at the location of the current BASIC program pointer in 
HL must be a ",", call the COMPARE SYMBOL routine at RST 08H.<br><br><span class="bold nobottomborder">NOTE:</span>
 The RST 08H routine compares the symbol in the input string pointed to 
by HL register to the value in the location following the RST 08 call.<ul><li>If
 there is a match, control is returned to the next execution address 
(i.e, the RST 08H instruction + 2) with the next symbol in the A 
Register and HL incremented by one.</li><li>If the two characters do not match, a syntax error message is given and control returns to the Input Phase).</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2B19-2B1A</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2B1C" class="memory-link">JR 2B1CH</a></div><div>Jump forward to 2B1CH.</div></div>
								</div>
							</div>

							<br><h2 id="2blb-2b28-evaluate">2BlB-2B28 - EVALUATE EXPRESSION ROUTINE - This is called by <span class="code">PRINT TAB</span>.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2B1B</div><div>RST 10H</div><div>We need the next character in the BASIC program so call the EXAMINE NEXT SYMBOL routine at RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The
 RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
								</div>
							</div>

							<br><h2 id="2b1c-this-routine">2B1C - This routine converts a 
numeric ASCII string pointed to by the HL into a hexadecimal value and 
places the result in the A register.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<p> If the result is larger than 255 (FFH) then an FC ERROR 
(Illegal function call) will be generated. After execution the HL will 
point to the delimiter. If the delimiter is a zero byte or a colon (3AH)
 then the Z flag will be set. Any other delimiter will cause the Z flag 
to be reset.</p>
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2B1C-2B1E</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2337" class="memory-link">CALL 2337H</a></div><div>GOSUB
 to 2337H to evaluate the expression at the location of the current 
BASIC program pointer in HL and return with the result in REG l.</div></div>
									<div class="assembly-row-combined model1"><div>2B1F-2B21</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2B05" class="memory-link">CALL 2B05H</a></div><div>GOSUB to 2B05H to convert the result in REG 1 to an integer and return with the integer result in DE.</div></div>
									<div class="assembly-row-combined model1"><div>2B22-2B24</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1E4A" class="memory-link">JP NZ,1E4AH</a></div><div>If the result is greater than 255, display a <span class="code">?FC ERROR</span> message.</div></div>
									<div class="assembly-row-combined model1"><div>2B25</div><div>DEC HL</div><div>Decrement the value of the current BASIC program pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2B26</div><div>RST 10H</div><div>We need the next character in the BASIC program so call the EXAMINE NEXT SYMBOL routine at RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The
 RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2B27</div><div>LD A,E</div><div>Load register A with the 8-bit result in register E.</div></div>
									<div class="assembly-row-combined model1"><div>2B28</div><div>RET</div><div>Return.</div></div>
								</div>
							</div>

							<br><h2 id="2b29-2b2d-level-ii">2B29-2B2D - LEVEL II BASIC <span class="code">LLIST</span> ROUTINE<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<p>This routine sets the output device flag to PRINTER and then flows through to the <span class="code">LIST</span> command.</p>
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2B29-2B2A</div><div>LD A,01H</div><div>Load register A with the printer output device code.</div></div>
									<div class="assembly-row-combined model1"><div>2B2B-2B2D</div><div>LD (409CH),A</div><div>Save the value in register A as the current output device flag.<br>Note: 409CH holds the current output device flag: -1=cassette, 0=video and 1=printer.</div></div>
								</div>
							</div>

							<br><h2 id="2b2e-2b74-level-ii">2B2E-2B74 - LEVEL II BASIC <span class="code">LIST</span> ROUTINE.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<p>On entry the stack has the return address, then the first 
basic line number to be listed, then the last basic line number to be 
listed.</p>
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2B2E</div><div>POP BC</div><div>Get the return address from the stack and put it in BC.</div></div>
									<div class="assembly-row-combined model1"><div>2B2F-2B31</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1B10" class="memory-link">CALL 1B10H</a></div><div>Go evaluate the range of line numbers given at the location of the current BASIC program pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2B32</div><div>PUSH BC</div><div>Save the address of the first BASIC line (held in BC) to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2B33-2B35</div><div>LD HL,FFFFH</div><div>Load HL with a -1. This is because the below loop starts with a INC HL, so as to turn the first line number into 0.</div></div>
									<div class="assembly-row-combined model1"><div>2B36-2B38</div><div>LD (40A2H),HL</div><div>Save the value in HL as the current BASIC line number.<br><b>NOTE:</b>40A2H-40A3H holds the current BASIC line number.</div></div>
									<div class="assembly-row-combined model1"><div>2B39</div><div>POP HL</div><div>Get the address of the first BASIC line to be listed (from the stack) and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2B3A</div><div>POP DE</div><div>Get the value of the last BASIC line number to be listed (from the stack) and put it in DE.</div></div>
									<div class="assembly-row-combined model1"><div>2B3B</div><div>LD C,(HL)</div><div>Load register C with the LSB of the next BASIC line pointer at the location of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2B3C</div><div>INC HL</div><div>Bump the value of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2B3D</div><div>LD B,(HL)</div><div>Load register B with the MSB of the next BASIC line pointer at the location of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2B3E</div><div>INC HL</div><div>Bump the value of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2B3F</div><div>LD A,B</div><div>Load register A with the MSB of the next BASIC line pointer in register B.</div></div>
									<div class="assembly-row-combined model1"><div>2B40</div><div>OR C</div><div>Combine
 the LSB of the next BASIC line pointer in register C with the MSB of 
the next BASIC line pointer in register A. This will let us test for the
 end of the BASIC program.</div></div>
									<div class="assembly-row-combined model1"><div>2B4l-2B43</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1A19" class="memory-link">JP Z,1A19H</a></div><div>Jump to 1A19H if this is the end of the BASIC program.</div></div>
									<div class="assembly-row-combined model1"><div>2B44-2B46</div><div><a href="#41DF" class="memory-link">CALL 41DFH</a></div><div>Go call the DOS link at 41DFH.<br>In NEWDOS 2.1, this is called from LIST processing.</div></div>
									<div class="assembly-row-combined model1"><div>2B47-2B49</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1D9B" class="memory-link">CALL 1D9BH</a></div><div>Go scan the keyboard to see if the BREAK key or the shift-@ key was pressed.</div></div>
									<div class="assembly-row-combined model1"><div>2B4A</div><div>PUSH BC</div><div>Save the address of the next BASIC line in BC to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2B4B</div><div>LD C,(HL)</div><div>Load register C with the LSB of the BASIC line number at the location of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2B4C</div><div>INC HL</div><div>Bump the value of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2B4D</div><div>LD B,(HL)</div><div>Load register B with the MSB of the BASIC line number at the location of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2B4E</div><div>INC HL</div><div>Bump the value of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2B4F</div><div>PUSH BC</div><div>Save the BASIC line number in BC to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2B50</div><div>EX (SP),HL</div><div>Exchange the value of the memory pointer in HL with the value of the BASIC line number to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2B51</div><div>EX DE,HL</div><div>Exchange the value of the BASIC line number in HL with the value of the last BASIC line number in DE.</div></div>
									<div class="assembly-row-combined model1"><div>2B52</div><div>RST 18H</div><div>Now
 we need to compare the BASIC line number in DE with the last BASIC line
 number in HL, so we call the COMPARE DE:HL routine at RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The
 RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2B53</div><div>POP BC</div><div>Get the value of the memory pointer from the stack and put it in BC.</div></div>
									<div class="assembly-row-combined model1"><div>2B54-2B56</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1A18" class="memory-link">JP C,1A18H</a></div><div>Jump to 1A18H if the BASIC line number in DE is greater than the last BASIC line number in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2B57</div><div>EX (SP),HL</div><div>Exchange the value of the last BASIC line number in HL with the address of the next BASIC line to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2B58</div><div>PUSH HL</div><div>Save the address of the next BASIC line in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2B59</div><div>PUSH BC</div><div>Save the memory pointer in BC to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2B5A</div><div>EX DE,HL</div><div>Load HL with the BASIC line number in DE.</div></div>
									<div class="assembly-row-combined model1"><div>2B5B-2B5D</div><div>LD (40ECH),HL</div><div>Save the BASIC line number in HL.<br>Note: 40ECH-40EDH holds EDIT line number.</div></div>
									<div class="assembly-row-combined model1"><div>2B5E-2B60</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0FAF" class="memory-link">CALL 0FAFH</a></div><div>Call
 the HL TO ASCII routine at 0FAFH (which converts the value in the HL 
(assumed to be an integer) to ASCII and display it at the current cursor
 position on the video screen) to display the current BASIC line number.</div></div>
									<div class="assembly-row-combined model1"><div>2B61-2B62</div><div>LD A,20H</div><div>Load register A with a space.</div></div>
									<div class="assembly-row-combined model1"><div>2B63</div><div>POP HL</div><div>Get the value of the memory pointer from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2B64-2B66</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#032A" class="memory-link">CALL 032AH</a></div><div>Go send the space in register A to the current output device.</div></div>
									<div class="assembly-row-combined model1"><div>2B67-2B69</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2B7E" class="memory-link">CALL 2B7EH</a></div><div>GOSUB
 to 2B7EH move the BASIC line at the location of the memory pointer in 
HL into the input buffer and untokenize the BASIC line.</div></div>
									<div class="assembly-row-combined model1"><div>2B6A-2B6C</div><div>LD HL,(40A7H)</div><div>Load HL with the starting address of the input buffer.<br>Note: 40A7H-40A8H holds the input Buffer pointer.</div></div>
									<div class="assembly-row-combined model1"><div>2B6D-2B6F</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2B75" class="memory-link">CALL 2B75H</a></div><div>Since
 we need to send the BASIC line in the input buffer to the current 
output device we call the PRINT MESSAGE routine at 2B75H which writes 
string pointed to by HL to the current output device.</div></div>
									<div class="assembly-row-combined model1"><div>2B70-2B72</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#20FE" class="memory-link">CALL 20FEH</a></div><div>Go send a carriage return to the current output device.</div></div>
									<div class="assembly-row-combined model1"><div>2B73-2B74</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2B33" class="memory-link">JR 2B33H</a></div><div>Loop back to 2B33H until the listing is complete.</div></div>
								</div>
							</div>

							<br><h2 id="2b75-2b7d-display">2B75-2B7D - DISPLAY MESSAGE ROUTINE<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
								<div class="assembly-table">
								<p>This is the PRINT MESSAGE routine which writes string pointed
 to by HL to the current output device. String must be terminated by a 
byte of zeros. This call is different from 28A7H because it does not use
 the literal string pool area, but it does use the same display routine 
and it takes the same DOS Exit at 41C1H. Uses all registers. This 
routine can be called without loading the BASIC utility, if a C9H (RET) 
is stored in 41C1H. </p>
								<p>This routine outputs a string to device indicated by device 
type flag stored at 409CH. String must end with zero byte. On entry, HL 
registers must point to address of start of string. Calls routine at 
032AH.</p>
								<div class="card-item">
									<div class="assembly-row-combined model1"><div>2B75</div><div>LD A,(HL)</div><div>Load register A with the character at the location of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2B76</div><div>OR A</div><div>Check to see if the character in register A is an end of the string character (00H).</div></div>
									<div class="assembly-row-combined model1"><div>2B77</div><div>RET Z</div><div>Return if the character in register A is an end of the string character.</div></div>
									<div class="assembly-row-combined model1" id="2B78"><div>2B78-2B7A</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#032A" class="memory-link">CALL 032AH</a></div><div>Go send the character in register A to the current output device.</div></div>
									<div class="assembly-row-combined model1"><div>2B7B</div><div>INC HL</div><div>Bump the value of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2B7C-2B7D</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2B75" class="memory-link">JR 2B75H</a></div><div>Loop back to 2B75H until all of the characters have been sent to the current output device.</div></div>
								</div>
							</div>

							<br><h2 id="2b7e-2bc5">2B7E-2BC5 - UNTOKENIZE ROUTINE<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<p>This routine is called by <span class="code">LIST</span> and <span class="code">EDIT</span>. It moves the line pointed to by HL to the input buffer area and then expands each token into the appropriate key word.</p>
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2B7E</div><div>PUSH HL</div><div>Save the BASIC line pointer in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2B7F-2B81</div><div>LD HL,(40A7H)</div><div>Load HL with the starting address of the input buffer.<br>Note: 40A7H-40A8H holds the input Buffer pointer.</div></div>
									<div class="assembly-row-combined model1"><div>2B82</div><div>LD B,H</div><div>Load register B with the MSB of the input buffer pointer in register H.</div></div>
									<div class="assembly-row-combined model1"><div>2B83</div><div>LD C,L</div><div>Load register C with the LSB of the input buffer pointer in register L.</div></div>
									<div class="assembly-row-combined model1"><div>2B84</div><div>POP HL</div><div>Get the value of the BASIC line pointer from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model3"><div>*2B85-2B87</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#069A" class="memory-link">JP 069AH</a></div><div>JUMP to 069AH to clear A and all flags, load the data flag (at 409FH) with 0, load D with 255 (a buffer), and JUMP to 2B8DH.<br>Difference
 between M1 and M3 ROMs: This change is to the LIST command. JP 069AH in
 the Model III replaces LD D,0FFH followed by JR 2B8CH in the Model I.</div></div>
									<div class="assembly-row-combined model3"><div>*2B88</div><div>NOP</div><div>No Operation</div></div>
									<div class="assembly-row-combined model1"><div>2B89</div><div>INC BC</div><div>Bump the value of the input buffer pointer in BC.</div></div>
									<div class="assembly-row-combined model1"><div>2B8A</div><div>DEC D</div><div>Decrement the character count in register D.</div></div>
									<div class="assembly-row-combined model1"><div>2B8B</div><div>RET Z</div><div>Return if 256 characters have been moved into the input buffer.</div></div>
									<div class="assembly-row-combined model3" id="2B8C"><div>*2B8C</div><div>INC HL</div><div>Move one byte forward in the text.<br>Difference
 between M1 and M3 ROMs: Another change to LIST. In the Model I three 
instructions occupied this area: LD A,(HL); OR A; INC HL. In the Model 
III the INC HL instruction is moved to the beginning of the three.</div></div>
									<div class="assembly-row-combined model3" id="2B8D"><div>*2B8D</div><div>LD A,(HL)</div><div>Load register A with the character at the location of the BASIC line pointer in HL.</div></div>
									<div class="assembly-row-combined model3" id="2B8E"><div>*2B8D</div><div>OR A</div><div>Set the status flags to enable us to check to see if the character in register A is an end of the BASIC line character.</div></div>
									<div class="assembly-row-combined model1"><div>2B8F</div><div>LD (BC),A</div><div>Save the character at the location of the input buffer pointer (held in register A) to the memory location held by BC.</div></div>
									<div class="assembly-row-combined model1"><div>2B90</div><div>RET Z</div><div>Return if the character in register A is an end of the BASIC line character.</div></div>
									<div class="assembly-row-combined model3" id="2B91"><div>*2B91-2B93</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-4.htm#302D" class="memory-link">JP 302DH</a></div><div>Jump to 302DH, which JUMPS to <a href="https://www.trs-80.com/sub-disassem-rom-m3-part-4.htm#377B" class="memory-link">377B</a>.</div></div>
									<p class="debug-note">Difference between M1 and M3 ROMs: The 
final change to LIST - a JP P,2B89H instruction in the Model I is 
changed to a JP 302DH instruction in the Model III.</p>
									<div class="assembly-row-combined model1" id="2B94"><div>2B94-2B95</div><div>CP FBH</div><div>Check to see if the character in register A is a <span class="code">'</span> token.</div></div>
									<div class="assembly-row-combined model1"><div>2B96-2B97</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2BA0" class="memory-link">JR NZ,2BA0H</a></div><div>Jump forward to 2BA0H if the character in register A isn't a <span class="code">'</span> token.</div></div>
									<div class="assembly-row-combined model1"><div>2B98</div><div>DEC BC</div><div>The
 next bunch of opcodes is to backspace the expanded buffer pointer by 4 
and then adjust the count of characters in the buffer.  First, decrement
 the value of the input buffer pointer in BC.</div></div>
									<div class="assembly-row-combined model1"><div>2B99</div><div>DEC BC</div><div>Decrement the value of the input buffer pointer in BC.</div></div>
									<div class="assembly-row-combined model1"><div>2B9A</div><div>DEC BC</div><div>Decrement the value of the input buffer pointer in BC.</div></div>
									<div class="assembly-row-combined model1"><div>2B9B</div><div>DEC BC</div><div>Decrement the value of the input buffer pointer in BC.</div></div>
									<div class="assembly-row-combined model1"><div>2B9C</div><div>INC D</div><div>Bump the value of the character counter in register D.</div></div>
									<div class="assembly-row-combined model1"><div>2B9D</div><div>INC D</div><div>Bump the value of the character counter in register D.</div></div>
									<div class="assembly-row-combined model1"><div>2B9E</div><div>INC D</div><div>Bump the value of the character counter in register D.</div></div>
									<div class="assembly-row-combined model1"><div>2B9F</div><div>INC D</div><div>Bump the value of the character counter in register D.</div></div>
									<div class="assembly-row-combined model1"><div>2BA0-2BA1</div><div>CP 95H</div><div>Check to see if the character in register A is an <span class="code">ELSE</span> token.</div></div>
									<div class="assembly-row-combined model1"><div>2BA2-2BA4</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0B24" class="memory-link">CALL Z,0B24H</a></div><div>If it was an <span class="code">ELSE</span>
 we need to backspace the expanded buffer pointer so ... go back to 
0B24H to decrement the value of the input buffer pointer if the 
character in register A is an ELSE token.</div></div>
									<div class="assembly-row-combined model1"><div>2BA5-2BA6</div><div>SUB 7FH</div><div>Subtract 7F to get the number of the entry we are looking for in token list.</div></div>
									<div class="assembly-row-combined model1"><div>2BA7</div><div>PUSH HL</div><div>Save the value of the BASIC line pointer in HL to the stack. </div></div>
									<div class="assembly-row-combined model1"><div>2BA8</div><div>LD E,A</div><div>Load register E with the character in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2BA9-2BAB</div><div>LD HL,1650H</div><div>Load HL with the starting address of the reserved words list.</div></div>
									<div class="assembly-row-combined model1"><div>2BAC</div><div>LD A,(HL)</div><div>Load register A with the character at the location of the reserved words list pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2BAD</div><div>OR A</div><div>Test the value of the character in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2BAE</div><div>INC HL</div><div>Bump the value of the reserved words list pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2BAF-2BB1</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2BAC" class="memory-link">JP P,2BACH</a></div><div>Jump back to 2BACH if the character at the location of the reserved words pointer in register A doesn't have bit 7 set.</div></div>
									<div class="assembly-row-combined model1"><div>2BB2</div><div>DEC E</div><div>Decrement the value of the token in register E.</div></div>
									<div class="assembly-row-combined model1"><div>2BB3-2BB4</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2BAC" class="memory-link">JR NZ,2BACH</a></div><div>Jump back to 2BACH if this isn't the reserved word for the token.</div></div>
									<div class="assembly-row-combined model1"><div>2BB5-2BB6</div><div>AND 7FH</div><div>Reset bit 7 of the character in register A by ANDing it against 0111 1111.</div></div>
									<div class="assembly-row-combined model1"><div>2BB7</div><div>LD (BC),A</div><div>Save the character in register A at the location of the input buffer pointer in BC.</div></div>
									<div class="assembly-row-combined model1"><div>2BB8</div><div>INC BC</div><div>Bump the value of the input buffer pointer in BC.</div></div>
									<div class="assembly-row-combined model1"><div>2BB9</div><div>DEC D</div><div>Decrement the value of the character counter in register D.</div></div>
									<div class="assembly-row-combined model1"><div>2BBA-2BBC</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#28D8" class="memory-link">JP Z,28D8H</a></div><div>Jump back to 28D8H if the maximum number of characters have been put into the input buffer.</div></div>
									<div class="assembly-row-combined model1"><div>2BBD</div><div>LD A,(HL)</div><div>Load register A with the character at the location of the reserved words pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2BBE</div><div>INC HL</div><div>Bump the reserved words pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2BBF</div><div>OR A</div><div>Test the value of the character in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2BC0-2BC2</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2BB7" class="memory-link">JP P,2BB7H</a></div><div>Jump back to 2BB7H if bit 7 of the character in register A isn't set.</div></div>
									<div class="assembly-row-combined model1"><div>2BC3</div><div>POP HL</div><div>Get the value of the BASIC line pointer from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2BC4-2BC5</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2B8C" class="memory-link">JR 2B8CH</a></div><div>Jump back to 2B8CH.</div></div>
									<div class="assembly-row-combined model1"><div>2BC6-2BF4</div><div></div><div>LEVEL II BASIC DELETE ROUTINE</div></div>
									<div class="assembly-row-combined model1"><div>2BC6-2BC8</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1B10" class="memory-link">CALL 1B10H</a></div><div>GOSUB to 1B10H to evaluate the line numbers at the location of the current BASIC program pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2BC9</div><div>POP DE</div><div>Get the value of the last BASIC line number to be deleted (in binary) from the stack and put it in DE.</div></div>
									<div class="assembly-row-combined model1"><div>2BCA</div><div>PUSH BC</div><div>Save the address of the first BASIC line to be deleted in BC to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2BCB</div><div>PUSH BC</div><div>Save the address of the first BASIC line to be deleted in BC to the stack AGAIN!.</div></div>
									<div class="assembly-row-combined model1"><div>2BCC-2BCE</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1B2C" class="memory-link">CALL 1B2CH</a></div><div>GOSUB
 to 1B2CH to the SEARCH FOR LINE NUMBER routine which looks for the line
 number specified in DE so as to get the address of the last line to be 
deleted.Returns C/Z with the line found in BC, NC/Z with line number is 
too large and HL/BC having the next available location, or NC/NZ with 
line number not found, and BC has the first available one after that.</div></div>
									<div class="assembly-row-combined model1" id="2BD6"><div>2BCF-2BD0</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2BD6" class="memory-link">JR NC,2BD6H</a></div><div>Goto 2BD6H to show a <span class="code">?FC ERROR</span>
 if the SEARCH FOR LINE NUMBER routine returns a NC, that means that the
 line searched for (in this case, the last line to be deleted) does not 
exist; and if that's the case, jump to 2BDH6.</div></div>
									<div class="assembly-row-combined model1"><div>2BD1</div><div>LD D,H</div><div>Load register D with the MSB of the last BASIC line's address in register H.</div></div>
									<div class="assembly-row-combined model1"><div>2BD2</div><div>LD E,L</div><div>Load register E with the LSB of the last BASIC line's address in register L.</div></div>
									<div class="assembly-row-combined model1"><div>2BD3</div><div>EX (SP),HL</div><div>Exchange the last BASIC line's address in HL with the first BASIC line's address to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2BD4</div><div>PUSH HL</div><div>Save the first BASIC line's address in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2BD5</div><div>RST 18H</div><div>Now
 we need to check to see if the first BASIC line's address in HL is 
greater than or equal to the last BASIC line's address in DE, so we call
 the COMPARE DE:HL routine at RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The
 RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2BD6-2BD8</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1E4A" class="memory-link">JP NC,1E4AH</a></div><div>Display a <span class="code">?FC ERROR</span> message if the first BASIC lines address in HL is greater than or equal to the last BASIC line's address in DE.</div></div>
									<div class="assembly-row-combined model1"><div>2BD9-2BDB</div><div>LD HL,1929H</div><div>Load HL with the starting address of the BASIC READY message.</div></div>
									<div class="assembly-row-combined model1"><div>2BDC-2BDE</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#28A7" class="memory-link">CALL 28A7H</a></div><div>We need to display the Level II BASIC READY message, so we call the WRITE MESSAGE routine at 28A7H.<br><span class="bold">NOTE:</span><br><ul><li>The routine at 28A7 displays the message pointed to by HL on current system output device (usually video).</li><li>The string to be displayed must be terminated by a byte of machine zeros or a carriage return code 0D.</li><li>If terminated with a carriage return, control is returned to the caller after taking the DOS exit at 41D0H (JP 5B99H).</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2BDF</div><div>POP BC</div><div>Get the first BASIC line's address from the stack and put it in BC.</div></div>
									<div class="assembly-row-combined model1"><div>2BE0-2BE2</div><div>LD HL,1AE8H</div><div>Load HL with the return address.</div></div>
									<div class="assembly-row-combined model1"><div>2BE3</div><div>EX (SP),HL</div><div>Exchange the value of the return address in HL with the value of the last BASIC line's address to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2BE4</div><div>EX DE,HL</div><div>Load DE with the last BASIC line's address in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2BE5-2BE7</div><div>LD HL,(40F9H)</div><div>Load HL with the end of the BASIC program pointer.<br><ul><li>Note: 40F9H-40FAH holds the starting address of the simple variable storage area.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2BE8</div><div>LD A,(DE)</div><div>Load register A with the character at the location of the memory pointer in DE.</div></div>
									<div class="assembly-row-combined model1"><div>2BE9</div><div>LD (BC),A</div><div>Save the character in register A at the location of the memory pointer in BC.</div></div>
									<div class="assembly-row-combined model1"><div>2BEA</div><div>INC BC</div><div>Bump the value of the memory pointer in BC.</div></div>
									<div class="assembly-row-combined model1"><div>2BEB</div><div>INC DE</div><div>Bump the value of the memory pointer in DE.</div></div>
									<div class="assembly-row-combined model1"><div>2BEC</div><div>RST 18H</div><div>Now
 we need to check to see if the memory pointer in DE equals the end of 
the BASIC program pointer in HL, so we call the COMPARE DE:HL routine at
 RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The 
RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2BED-2BEE</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2BE8" class="memory-link">JR NZ,2BE8H</a></div><div>Loop back to 2BE8H until the memory pointer in DE equals the end of the BASIC program pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2BD3</div><div>EX (SP),HL</div><div>Exchange the last BASIC line's address in HL with the first BASIC line's address to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2BD4</div><div>PUSH HL</div><div>Save the first BASIC line's address in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2BD5</div><div>RST 18H</div><div>Now
 we need to check to see if the first BASIC line's address in HL is 
greater than or equal to the last BASIC line's address in DE, so we call
 the COMPARE DE:HL routine at RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The
 RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2BD6-2BD8</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1E4A" class="memory-link">JP NC,1E4AH</a></div><div>Display a <span class="code">?FC ERROR</span> if the first BASIC lines address in HL is greater than or equal to the last BASIC line's address in DE.</div></div>
									<div class="assembly-row-combined model1"><div>2BD9-2BDB</div><div>LD HL,1929H</div><div>Load HL with the starting address of the BASIC READY message.</div></div>
									<div class="assembly-row-combined model1"><div>2BDC-2BDE</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#28A7" class="memory-link">CALL 28A7H</a></div><div>We need to display the Level II BASIC READY message, so we call the WRITE MESSAGE routine at 28A7H.<br><span class="bold">NOTE:</span><br><ul><li>The routine at 28A7 displays the message pointed to by HL on current system output device (usually video).</li><li>The string to be displayed must be terminated by a byte of machine zeros or a carriage return code 0D.</li><li>If terminated with a carriage return, control is returned to the caller after taking the DOS exit at 41D0H (JP 5B99H).</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2BDF</div><div>POP BC</div><div>Get the first BASIC line's address from the stack and put it in BC.</div></div>
									<div class="assembly-row-combined model1"><div>2BE0-2BE2</div><div>LD HL,1AE8H</div><div>Load HL with the return address.</div></div>
									<div class="assembly-row-combined model1"><div>2BE3</div><div>EX (SP),HL</div><div>Exchange the value of the return address in HL with the value of the last BASIC line's address to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2BE4</div><div>EX DE,HL</div><div>Load DE with the last BASIC line's address in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2BE5-2BE7</div><div>LD HL,(40F9H)</div><div>Load HL with the end of the BASIC program pointer.<br><ul><li>Note: 40F9H-40FAH holds the starting address of the simple variable storage area.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2BE8</div><div>LD A,(DE)</div><div>Load register A with the character at the location of the memory pointer in DE.</div></div>
									<div class="assembly-row-combined model1"><div>2BE9</div><div>LD (BC),A</div><div>Save the character in register A at the location of the memory pointer in BC.</div></div>
									<div class="assembly-row-combined model1"><div>2BEA</div><div>INC BC</div><div>Bump the value of the memory pointer in BC.</div></div>
									<div class="assembly-row-combined model1"><div>2BEB</div><div>INC DE</div><div>Bump the value of the memory pointer in DE.</div></div>
									<div class="assembly-row-combined model1"><div>2BEC</div><div>RST 18H</div><div>Now
 we need to check to see if the memory pointer in DE equals the end of 
the BASIC program pointer in HL, so we call the COMPARE DE:HL routine at
 RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The 
RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2BED-2BEE</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2BE8" class="memory-link">JR NZ,2BE8H</a></div><div>Loop until the memory pointer in DE equals the end of the BASIC program pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2BEF</div><div>LD H,B</div><div>Load register H with the MSB of the memory pointer in register B.</div></div>
									<div class="assembly-row-combined model1"><div>2BF0</div><div>LD L,C</div><div>Load register L with the LSB of the memory pointer in register C.</div></div>
									<div class="assembly-row-combined model1"><div>2BF1-2BF3</div><div>LD (40F9H),HL</div><div>Save the value in HL as the new end of the BASIC program pointer.<br><ul><li>Note: 40F9H-40FAH holds the starting address of the simple variable storage area.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2BF4</div><div>RET</div><div>Return.</div></div>
								</div>
							</div>

							<br><h2 id="2bf5-2c1e-level-ii">2BF5-2C1E - LEVEL II BASIC CSAVE ROUTINE<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2BF5-2BF7</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0284" class="memory-link">CALL 0284H</a></div><div>Calls the WRITE LEADER routine at 0284H (which writes a Level II leader on the cassette unit set in register A).</div></div>
									<div class="assembly-row-combined model1"><div>2BF8</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2337" class="memory-link">CALL 2337H</a></div><div>2BFAH Go evaluate the rest of the <span class="code">CSAVE</span> expression at the location of the current BASIC program pointer in HL and return with the result in REG l.</div></div>
									<div class="assembly-row-combined model1"><div>2BFB</div><div>PUSH HL</div><div>Save the value of the current BASIC program pointer in HL to the stack so we can get it back at the end of the routine.</div></div>
									<div class="assembly-row-combined model1"><div>2BFC-2BFE</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2A13" class="memory-link">CALL 2A13H</a></div><div>Go get the starting address of the filename into DE.</div></div>
									<div class="assembly-row-combined model1"><div>2BFF-2C00</div><div>LD A,D3H</div><div>Load register A with the filename header byte (=D3H which is a "S" with the sign bit on).</div></div>
									<div class="assembly-row-combined model1"><div>2C01-2C03</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0264" class="memory-link">CALL 0264H</a></div><div>the
 WRITE ONE BYTE TO CASSETTE routine at 0264H (which writes the byte in 
the A register to the cassette drive selected in the A register), which 
in this case the filename header byte.</div></div>
									<div class="assembly-row-combined model1"><div>2C04-2C06</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0261" class="memory-link">CALL 0261H</a></div><div>Go write the filename header byte in register A twice more.</div></div>
									<div class="assembly-row-combined model1"><div>2C07</div><div>LD A,(DE)</div><div>Load register A with the first character of the filename at the location of the filename pointer in DE.</div></div>
									<div class="assembly-row-combined model1"><div>2C08-2C0A</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0264" class="memory-link">CALL 0264H</a></div><div>the
 WRITE ONE BYTE TO CASSETTE routine at 0264H (which writes the byte in 
the A register to the cassette drive selected in the A register), which 
in this case is the filename.</div></div>
									<div class="assembly-row-combined model1"><div>2C0B-2C0D</div><div>LD HL,(40A4H)</div><div>Load HL with the start of the BASIC program pointer<br><b>NOTE:</b> 40A4H-40A5H holds the starting address of BASIC program text also known as the PROGRAM STATEMENT TABLE (PST).</div></div>
									<div class="assembly-row-combined model1"><div>2C0E</div><div>EX DE,HL</div><div>Load DE with the start of the BASIC program pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2C0F-2C11</div><div>LD HL,(40F9H)</div><div>Load HL with the end of the BASIC program pointer.<br><ul><li>Note: 40F9H-40FAH holds the starting address of the simple variable storage area.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2C12</div><div>LD A,(DE)</div><div>We
 are going to loop from DE (start of program) to HL (end of program) 
now.  Load register A with the character at the location of the memory 
pointer in DE.</div></div>
									<div class="assembly-row-combined model1"><div>2C13</div><div>INC DE</div><div>Bump the value of the memory pointer in DE.</div></div>
									<div class="assembly-row-combined model1"><div>2C14-2C16</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0264" class="memory-link">CALL 0264H</a></div><div>the
 WRITE ONE BYTE TO CASSETTE routine at 0264H (which writes the byte in 
the A register to the cassette drive selected in the A register).</div></div>
									<div class="assembly-row-combined model1"><div>2C17</div><div>RST 18H</div><div>Now
 we need to check to see if the memory pointer in DE is equal to the end
 of the BASIC program pointer in HL, so we call the COMPARE DE:HL 
routine at RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The
 RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2C18-2C19</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2C12" class="memory-link">JR NZ,2C12H</a></div><div>Loop back to 2C12H until the memory pointer in DE is equal to the end of the BASIC program pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2C1A-2C1C</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#01F8" class="memory-link">CALL 01F8H</a></div><div>All done!  GOSUB 01F8H to turn the cassette recorder off.</div></div>
									<div class="assembly-row-combined model1"><div>2C1D</div><div>POP HL</div><div>Get the value of the current BASIC program pointer from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2C1E</div><div>RET</div><div>Return.</div></div>
								</div>
							</div>

							<br><h2 id="2c1f-2ca4-level-ii">2C1F-2CA4 - LEVEL II BASIC CLOAD ROUTINE<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<p class="debug-note">Difference between M1 and M3 ROMs:Another
 change that originated in the "new" ROM Model I modified the CLOAD 
command (changed the order of portions of the CLOAD routine, disallowed 
CLOAD from cassette drive #2, etc.).</p>
									<div class="assembly-row-combined model1"><div>2C1F</div><div>SUB 0B2H</div><div>Test for CLOAD?</div></div>
									<div class="assembly-row-combined model1"><div>2C21</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2C25" class="memory-link">JR Z,2C25H</a></div><div>Jump to 2C25H if it is CLOAD?</div></div>
									<div class="assembly-row-combined model1"><div>2C23</div><div>XOR A</div><div>Signal CLOAD (not CLOAD?)</div></div>				<div class="assembly-row-combined model1" id="232F"><div>2C24</div><div>LD BC,232FH</div><div>CPL A=-1 if CLOAD?, 0000 if CLOAD</div></div>
									<div class="assembly-row-combined model1"><div>2C27</div><div>PUSH AF</div><div>Increment HL to the filname of the <span class="code">CLOAD</span>/<span class="code">CLOAD?</span> flag</div></div>
									<div class="assembly-row-combined model1"><div>2C28</div><div>LD A,(HL)</div><div>Set the next element from the code string, which should be the filename</div></div>
									<div class="assembly-row-combined model1"><div>2C29</div><div>OR A</div><div>Set status flags</div></div>
									<div class="assembly-row-combined model1"><div>2C2A</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2C33" class="memory-link">JR Z,2C33H</a></div><div>If it is the EOL, jump to 2C33H</div></div>
									<div class="assembly-row-combined model1"><div>2C2C</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2337" class="memory-link">CALL 2337H</a></div><div>Call 2337H to get the filename.</div></div>
									<div class="assembly-row-combined model1"><div>2C2F</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2A13" class="memory-link">CALL 2A13H</a></div><div>Call 2A13H to get the address of the filename into DE</div></div>
									<div class="assembly-row-combined model1"><div>2C32</div><div>LD A,(DE)</div><div>Get the filename</div></div>
									<div class="assembly-row-combined model1"><div>2C33</div><div>LD L,A</div><div>Move the filename into Register L</div></div>
									<div class="assembly-row-combined model1"><div>2C34</div><div>POP AF</div><div>Restore the <span class="code">CLOAD</span>/<span class="code">CLOAD?</span> flag</div></div>
									<div class="assembly-row-combined model1"><div>2C35</div><div>OR A</div><div>Set the status register according to that flag</div></div>
									<div class="assembly-row-combined model1"><div>2C36</div><div>LD H,A</div><div>H will now hold <span class="code">CLOAD</span>/<span class="code">CLOAD?</span> flag, and L will hold the filename</div></div>
									<div class="assembly-row-combined model1"><div>2C37</div><div>LD (4121H),HL</div><div>Put the flag and filename into REG 1.</div></div>
									<div class="assembly-row-combined model1"><div>2C3A</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1B4D" class="memory-link">CALL Z,1B4DH</a></div><div>If the flag is a CLOAD, call the NEW routine at 1B4DH.</div></div>
									<div class="assembly-row-combined model1"><div>2C3D</div><div>LD HL,0000H</div><div>Cause the drive to be selected</div></div>
									<div class="assembly-row-combined model1"><div>2C40</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0293" class="memory-link">CALL 0293H</a></div><div>Call 2093H to get the leader and sync byte from the cassette.</div></div>
									<div class="assembly-row-combined model1"><div>2C43</div><div>LD HL,(4121H)</div><div>Restore the <span class="code">CLOAD</span>/<span class="code">CLOAD?</span> flag and filename</div></div>
									<div class="assembly-row-combined model1"><div>2C46</div><div>EX DE,HL</div><div>Load DE with the CLOAD/CLOAD? flag and load the filename into HL.</div></div>
									<div class="assembly-row-combined model1"><div>2C47-2C48</div><div>LD B,03H</div><div>Load register B with the number of bytes for the filename header to match against (which is 3 ... 3 S's with the sign bit on).</div></div>
									<div class="assembly-row-combined model1"><div>2C49-2C4B</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0235" class="memory-link">CALL 0235H</a></div><div>Calls
 the READ ONE BYTE FROM CASSETTE routine at 0235H (which reads one byte 
from the cassette drive specified in register A, and returns the byte in
 register A).</div></div>
									<div class="assembly-row-combined model1"><div>2C4C-2C4D</div><div>SUB 0D3H</div><div>Check to see if the character in register A is a filename header byte.</div></div>
									<div class="assembly-row-combined model1"><div>2C4E-2C4F</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2C47" class="memory-link">JR NZ,2C47H</a></div><div>Loop if the character in register A isn't a filename header byte.</div></div>
									<div class="assembly-row-combined model1"><div>2C50-2C51</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2C49" class="memory-link">DJNZ 2C49H</a></div><div>Loop back to 2C49H until three filename header bytes (3 S's with the sign bit on) have been read.</div></div>
									<div class="assembly-row-combined model1"><div>2C52-2C54</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0235" class="memory-link">CALL 0235H</a></div><div>Now
 that the header is out of the way, let's start working on the filename.
  GOSUB to 0235H to the READ ONE BYTE FROM CASSETTE (which reads one 
byte from the cassette drive specified in register A, and returns the 
byte in register A).</div></div>
									<div class="assembly-row-combined model1"><div>2C55</div><div>INC E</div><div>We
 need to test to see if a filename was even given so we have to increase
 and decrease E to set flags ... Bump the value of the filename in 
register E.</div></div>
									<div class="assembly-row-combined model1"><div>2C56</div><div>DEC E</div><div>Decrement the value of the filename in register E.</div></div>
									<div class="assembly-row-combined model1"><div>2C57-2C58</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2C5C" class="memory-link">JR Z,2C5CH</a></div><div>Jump to 2C5CH if no filename was specified.</div></div>
									<div class="assembly-row-combined model1"><div>2C59</div><div>CP E</div><div>If
 we are here, then the user has supplied a filename which is held in 
Register E AND we have the first byte from the tape in Register A, so we
 need to compare the filename specified in register E with the character
 in register A.</div></div>
								</div>
							</div>

							<br><h2 id="2ca5-bcd-message">2CA5 - "BCD" message string.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2C5A-2C5B</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2C93" class="memory-link">JR NZ,2C93H</a></div><div>Jump
 to 2C93H (to skip to the end of that file) if the filename specified in
 register E doesn't match the byte read from tape in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2C5C-2C5E</div><div>LD HL,(40A4H)</div><div>If
 we are here, the filename on tape matches the filename given so lets 
start loading.  Load HL with the start of the BASIC program pointer<br><b>NOTE:</b> 40A4H-40A5H holds the starting address of BASIC program text also known as the PROGRAM STATEMENT TABLE (PST).</div></div>
								</div>
							</div>

							<br><h2 id="this-loop-is-going">This loop is going to read a 
byte, compare it to the next byte in the program memory, jump away if it
 doesn't match AND CLOAD? was chosen, write (or overwrite) that byte to 
memory, check for a zero, and loop back if no zero was found.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2C5F-2C60</div><div>LD B,03H</div><div>Load register B with the number of zeros to look for to stop the load (which is 3).</div></div>
									<div class="assembly-row-combined model1"><div>2C61-2C63</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0235" class="memory-link">CALL 0235H</a></div><div>Calls
 the READ ONE BYTE FROM CASSETTE routine at 0235H (which reads one byte 
from the cassette drive specified in register A, and returns the byte in
 register A).</div></div>
									<div class="assembly-row-combined model1"><div>2C64</div><div>LD E,A</div><div>Load register E with the character in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2C65</div><div>SUB (HL)</div><div>Compare
 the character we just read from the tape (held in register A) with the 
character at the location of the memory pointer in HL by subtracting 
them.</div></div>
									<div class="assembly-row-combined model1"><div>2C66</div><div>AND D</div><div>Combine the subtracted result in register A with the value of the <span class="code">CLOAD</span>/<span class="code">CLOAD?</span> flag in register D.</div></div>
									<div class="assembly-row-combined model1"><div>2C67-2C68</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2C8A" class="memory-link">JR NZ,2C8AH</a></div><div>Jump to 2C8AH if <span class="code">CLOAD?</span> was selected but the bytes don't match.</div></div>
									<div class="assembly-row-combined model1"><div>2C69</div><div>LD (HL),E</div><div>At this point either <span class="code">CLOAD?</span> was selected and the bytes match, or <span class="code">CLOAD</span>
 was selected.  Either way, save the character we read from the tape 
(held in register E) to the location of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2C6A-2C6C</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#196C" class="memory-link">CALL 196CH</a></div><div>Go check for an <span class="code">?OM ERROR</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2C6D</div><div>LD A,(HL)</div><div>Load register A with the character at the location of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2C6E</div><div>OR A</div><div>Check to see if the byte just read in register A is equal to zero.</div></div>
									<div class="assembly-row-combined model1"><div>2C6F</div><div>INC HL</div><div>Bump the value of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2C70-2C71</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2C5F" class="memory-link">JR NZ,2C5FH</a></div><div>Loop if the byte in register A isn't equal to zero (meaning that it isn't end of program or end of statement).</div></div>
									<div class="assembly-row-combined model1"><div>2C72-2C74</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#022C" class="memory-link">CALL 022CH</a></div><div>Call
 the BLINK ASTERISK routine at 022CH which alternatively displays and 
clears an asterisk in the upper right hand corner of the video display.</div></div>
									<div class="assembly-row-combined model1"><div>2C75-2C76</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2C61" class="memory-link">DJNZ 2C61H</a></div><div>Do that loop until three zeros in a row have been read from the cassette recorder.</div></div>
									<div class="assembly-row-combined model1"><div>2C77-2C79</div><div>LD (40F9H),HL</div><div>By
 this point, HL will have been incremented all the way through the 
program.  Save the value of the memory pointer in HL as the new end of 
the BASIC program pointer.<br><ul><li>Note: 40F9H-40FAH holds the starting address of the simple variable storage area.</li></ul></div></div>
									<div class="assembly-row-combined model3"><div>*2C7A-2C7C</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#01F8" class="memory-link">CALL 01F8H</a></div><div>GOSUB to 01F8H to turn off the tape.<br>Difference
 between M1 and M3 ROMs: Also part of CLOAD, this change turns off the 
tape before printing READY on the video display. In the Model I, the 
code from 2C7AH - 2C82H consisted of the instructions LD HL,1929H; CALL 
28A7H, CALL 01F8H. In the Model III the CALL to 01F8H has been moved to 
the beginning of these instructions.</div></div>
									<div class="assembly-row-combined model3"><div>*2C7D-2C7F</div><div>LD HL,1929H</div><div>Load HL with the starting address of the BASIC READY message.</div></div>
									<div class="assembly-row-combined model3"><div>*2C80-2C82</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#28A7" class="memory-link">CALL 28A7H</a></div><div>We need to display the Level II BASIC READY message, so we call the WRITE MESSAGE routine at 28A7H.<br><span class="bold">NOTE:</span><br><ul><li>The routine at 28A7 displays the message pointed to by HL on current system output device (usually video).</li><li>The string to be displayed must be terminated by a byte of machine zeros or a carriage return code 0D.</li><li>If terminated with a carriage return, control is returned to the caller after taking the DOS exit at 41D0H (JP 5B99H).</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2C83-2C85</div><div>LD HL,(40A4H)</div><div>Load HL with the start of the BASIC program pointer<br><b>NOTE:</b> 40A4H-40A5H holds the starting address of BASIC program text also known as the PROGRAM STATEMENT TABLE (PST).</div></div>
									<div class="assembly-row-combined model1"><div>2C86</div><div>PUSH HL</div><div>Save the start of the BASIC program pointer in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2C87-2C89</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1AE8" class="memory-link">JP 1AE8H</a></div><div>Jump to 1AE8H to reinitialize the BASIC interpreter and continue.</div></div>
									<div class="assembly-row-combined model3"><div>*2C8A-2C8C</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-4.htm#31BD" class="memory-link">CALL 31BDH</a></div><div>GOSUB to 31BDH to reset the cassette I/O.<br>Difference
 between M1 and M3 ROMs: This is part of the CLOAD? routine used when a 
bad byte has been read from the tape. In the Model I, a LD HL, 2CA5H 
instruction is found here (loads HL with the starting address of the 
"BAD" message), while the Model III uses a CALL 31BDH instruction, which
 does some housekeeping in addition to pointing HL to the "BAD" message.</div></div>
									<div class="assembly-row-combined model1"><div>2C8D-2C8F</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#28A7" class="memory-link">CALL 28A7H</a></div><div>We need to display the <span class="code">BAD</span> message, so we call the WRITE MESSAGE routine at 28A7H.<br><span class="bold">NOTE:</span><br><ul><li>The routine at 28A7 displays the message pointed to by HL on current system output device (usually video).</li><li>The string to be displayed must be terminated by a byte of machine zeros or a carriage return code 0D.</li><li>If terminated with a carriage return, control is returned to the caller after taking the DOS exit at 41D0H (JP 5B99H).</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2C90-2C92</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1AE8" class="memory-link">JP 1AE8H</a></div><div>Jump to 1AE8H to reinitialize the BASIC interpreter and continue.</div></div>
									<div class="assembly-row-combined model1"><div>2C93-2C95</div><div>LD (3C3EH),A</div><div>Go display the filename on the video display.</div></div>
									<div class="assembly-row-combined model1"><div>2C96-2C97</div><div>LD B,03H</div><div>Load register B with the number of zeros to be found to stop the search.</div></div>
									<div class="assembly-row-combined model1"><div>2C98-2C9A</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0235" class="memory-link">CALL 0235H</a></div><div>Calls
 the READ ONE BYTE FROM CASSETTE routine at 0235H (which reads one byte 
from the cassette drive specified in register A, and returns the byte in
 register A).</div></div>
									<div class="assembly-row-combined model1"><div>2C9B</div><div>OR A</div><div>Check to see if the character in register A is equal to zero.</div></div>
									<div class="assembly-row-combined model1"><div>2C9C-2C9D</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2C96" class="memory-link">JR NZ,2C96H</a></div><div>Loop if the character in register A isn't equal to zero.</div></div>
									<div class="assembly-row-combined model1"><div>2C9E-2C9F</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2C98" class="memory-link">DJNZ 2C98H</a></div><div>Loop until three zeros in a row have been read from the cassette recorder.</div></div>
									<div class="assembly-row-combined model1"><div>2CA0-2CA2</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0296" class="memory-link">CALL 0296H</a></div><div>Calls
 the READ CASSETTE LEADER routine at 0296 (which reads from the cassette
 recorder selected in register A until the end-of-leader marker of A5H 
is found; and flashes the cursor while doing this).</div></div>
									<div class="assembly-row-combined model1"><div>2CA3-2CA4</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2C47" class="memory-link">JR 2C47H</a></div><div>Jump back to 2C47H.</div></div>
								</div>
							</div>

							<br><h2 id="2ca5-2ca9-message">2CA5-2CA9 - MESSAGE STORAGE LOCATION<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2CA5-2CA9</div><div>"BAD"</div><div>The BAD message is stored here.</div></div>
								</div>
							</div>

							<br><h2 id="2caa-2cb0-level-ii">2CAA-2CB0 - LEVEL II BASIC <span class="code">PEEK</span> ROUTINE - On entry, REG 1 to have the peek location, and on exit Reg 1 to have the peeked value.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2CAA-2CAC</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0A7F" class="memory-link">CALL 0A7FH</a></div><div>Call
 the CONVERT TO INTEGER routine at 0A7FH (where the contents of REG 1 
are converted from single or double precision to integer and deposited 
into HL).</div></div>
									<div class="assembly-row-combined model1"><div>2CAD</div><div>LD A,(HL)</div><div>Load register A with the value at the location of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2CAE-2CB0</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#27F8" class="memory-link">JP 27F8H</a></div><div>Go save the 8-bit value in register A as the current result in REG 1.</div></div>
								</div>
							</div>

							<br><h2 id="2cb1-2cbc-level-ii">2CB1-2CBC - LEVEL II BASIC <span class="code">POKE</span> ROUTINE<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2CB1-2CB3</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2B02" class="memory-link">CALL 2B02H</a></div><div>Go evaluate the expression at the location of the current BASIC program pointer in HL and return with the integer result in DE.</div></div>
									<div class="assembly-row-combined model1"><div>2CB4</div><div>PUSH DE</div><div>Save the address the user wants to POKE to (held in DE) to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2CB5-2CB6</div><div>RST 08H ‚áí 2EH</div><div>Since the character at the location of the current BASIC program pointer in HL must be a <span class="code">,</span>, call the COMPARE SYMBOL routine at RST 08H.<br><br><span class="bold nobottomborder">NOTE:</span>
 The RST 08H routine compares the symbol in the input string pointed to 
by HL register to the value in the location following the RST 08 call.<ul><li>If
 there is a match, control is returned to the next execution address 
(i.e, the RST 08H instruction + 2) with the next symbol in the A 
Register and HL incremented by one.</li><li>If the two characters do not match, a syntax error message is given and control returns to the Input Phase).</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2CB7-2CB9</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2B1C" class="memory-link">CALL 2B1CH</a></div><div>GOSUB
 to 2B1CH to evaluate the expression at the location of the current 
BASIC program pointer in HL and return with the 8-bit value in register 
A.</div></div>
									<div class="assembly-row-combined model1"><div>2CBA</div><div>POP DE</div><div>Get the address the user wants to POKE to from the stack and put it in DE.</div></div>
									<div class="assembly-row-combined model1"><div>2CBB</div><div>LD (DE),A</div><div>Save the value the user wanted to poke (held in register A) in the location that the user wants to POKE to (held in DE).</div></div>
									<div class="assembly-row-combined model1"><div>2CBC</div><div>RET</div><div>Return.</div></div>
								</div>
							</div>

							<br><h2 id="2cbd-2e52-level-ii">2CBD-2E52 - LEVEL II BASIC <span class="code">USING</span> ROUTINE<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2CBD-2CBF</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2338" class="memory-link">CALL 2338H</a></div><div>Go evaluate the string expression at the location of the current BASIC program pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2CC0-2CC2</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0AF4" class="memory-link">CALL 0AF4H</a></div><div>Go make sure the expression that was just evaluated was a string.</div></div>
									<div class="assembly-row-combined model1"><div>2CC3-2CC4</div><div>RST 08H ‚áí 3BH</div><div>Since
 the character at the location of the current BASIC program pointer in 
HL must be a ";", call the COMPARE SYMBOL routine at RST 08H.<br><br><span class="bold nobottomborder">NOTE:</span>
 The RST 08H routine compares the symbol in the input string pointed to 
by HL register to the value in the location following the RST 08 call.<ul><li>If
 there is a match, control is returned to the next execution address 
(i.e, the RST 08H instruction + 2) with the next symbol in the A 
Register and HL incremented by one.</li><li>If the two characters do not match, a syntax error message is given and control returns to the Input Phase).</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2CC5</div><div>EX DE,HL</div><div>Load DE with the value of the current BASIC program pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2CC6-2CC8</div><div>LD HL,(4121H)</div><div>Load HL with the USING string's VARPTR.</div></div>
									<div class="assembly-row-combined model1"><div>2CC9-2CCA</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2CD3" class="memory-link">JR 2CD3H</a></div><div>Jump down to 2CD3H to continue.</div></div>
									<div class="assembly-row-combined model1"><div>2CCB-2CCD</div><div>LD A,(40DEH)</div><div>Load register A with the value of the READ/INPUT flag.<br>Note: 40DEH holds READ flag.</div></div>
									<div class="assembly-row-combined model1"><div>2CCE</div><div>OR A</div><div>Check to see if the READ/INPUT flag in register A indicates INPUT.</div></div>
									<div class="assembly-row-combined model1"><div>2CCF-2CD0</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2CDD" class="memory-link">JR Z,2CDDH</a></div><div>Jump down to 2CDDH if the READ/INPUT flag in register A indicates INPUT.</div></div>
									<div class="assembly-row-combined model1"><div>2CD1</div><div>POP DE</div><div>Restore the current BASIC program pointer (from the stack) into DE.</div></div>
									<div class="assembly-row-combined model1"><div>2CD2</div><div>EX DE,HL</div><div>Load HL with the value of the current BASIC program pointer in DE.  D will wind up being the length of the string</div></div>
									<div class="assembly-row-combined model1"><div>2CD3</div><div>PUSH HL</div><div>Save the USING string's VARPTR in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2CD4</div><div>XOR A</div><div>Zero register A.</div></div>
									<div class="assembly-row-combined model1"><div>2CD5-2CD7</div><div>LD (40DEH),A</div><div>Clear the READ/INPUT flag.<br>Note: 40DEH holds READ flag.</div></div>
									<div class="assembly-row-combined model1"><div>2CD8</div><div>CP D</div><div>Check to see if the value in D is equal to zero (by checking it against A which was XOR'd to 0 above).</div></div>
									<div class="assembly-row-combined model1"><div>2CD9</div><div>PUSH AF</div><div>Save the value in AF (the difference) to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2CDA</div><div>PUSH DE</div><div>Save the value in DE (the address of the next input symbol from the code string) to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2CDB</div><div>LD B,(HL)</div><div>Load register B with the USING string's length at the location of the USING string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2CDC</div><div>OR B</div><div>Check to see if the USING string's length in register B is equal to zero.</div></div>
									<div class="assembly-row-combined model1"><div>2CDD-2CDF</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1E4A" class="memory-link">JP Z,1E4AH</a></div><div>Display a <span class="code">?FC ERROR</span> if the USING string's length in register B is equal to zero.</div></div>
									<div class="assembly-row-combined model1"><div>2CE0</div><div>INC HL</div><div>Bump the value of the USING string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2CE1</div><div>LD C,(HL)</div><div>Load register C with the LSB of the USING string's address at the location of the USING string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2CE2</div><div>INC HL</div><div>Bump the value of the USING string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2CE3</div><div>LD H,(HL)</div><div>Load register H with the MSB of the USING string's address at the location of the USING string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2CE4</div><div>LD L,C</div><div>Load register L with the LSB of the USING string's address in register C.</div></div>
									<div class="assembly-row-combined model1"><div>2CE5-2CE6</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2D03" class="memory-link">JR 2D03H</a></div><div>Jump down to 2D03H to analyze the field description.</div></div>
									<div class="assembly-row-combined model1"><div>2CE7</div><div>LD E,B</div><div>Load register E with the USING string's length in register B.</div></div>
									<div class="assembly-row-combined model1"><div>2CE8</div><div>PUSH HL</div><div>Save the value of the current USING string pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2CE9-2CEA</div><div>LD C,02H</div><div>Load register C with the number of %'s substring length.</div></div>
									<div class="assembly-row-combined model1"><div>2CEB</div><div>LD A,(HL)</div><div>Load register A with the character at the location of the USING string pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2CEC</div><div>INC HL</div><div>Bump the value of the USING string pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2CED-2CEE</div><div>CP 25H</div><div>Check to see if the character in register A is a %.</div></div>
									<div class="assembly-row-combined model1"><div>2CEF-2CF1</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2E17" class="memory-link">JP Z,2E17H</a></div><div>Jump down to 2E17H if the character in register A is a %.</div></div>
									<div class="assembly-row-combined model1"><div>2CF2-2CF3</div><div>CP 20H</div><div>Check to see if the character in register A is a space.</div></div>
									<div class="assembly-row-combined model1"><div>2CF4-2CF5</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2CF9" class="memory-link">JR NZ,2CF9H</a></div><div>Jump down a few opcodes to 2CF9H if the character in register A isn't a space.</div></div>
									<div class="assembly-row-combined model1"><div>2CF6</div><div>INC C</div><div>Bump the % substring length in register C.</div></div>
									<div class="assembly-row-combined model1"><div>2CF7-2CF8</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2CEB" class="memory-link">DJNZ 2CEBH</a></div><div>Decrement the USING string's length in register B.</div></div>
									<div class="assembly-row-combined model1"><div>2CF9</div><div>POP HL</div><div>At
 this point we have either exhausted the input or found a non-blank 
character.  In either case ... get the value of the USING string pointer
 from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2CFA</div><div>LD B,E</div><div>Load register B with the USING string's length.</div></div>
									<div class="assembly-row-combined model1"><div>2CFB-2CFC</div><div>LD A,25H</div><div>Load register A with a %.</div></div>
									<div class="assembly-row-combined model1"><div>2CFD-2CFF</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2E49" class="memory-link">CALL 2E49H</a></div><div>Go print a <span class="code">+</span> after printing a single <span class="code">%</span> if necessary.</div></div>
									<div class="assembly-row-combined model1"><div>2D00-2D02</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#032A" class="memory-link">CALL 032AH</a></div><div>Go print the character in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2D03</div><div>XOR A</div><div>Zero register A and clear the flags.</div></div>
									<div class="assembly-row-combined model1"><div>2D04</div><div>LD E,A</div><div>Zero register E.</div></div>
									<div class="assembly-row-combined model1"><div>2D05</div><div>LD D,A</div><div>Zero register D.</div></div>
									<div class="assembly-row-combined model1"><div>2D06-2D08</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2E49" class="memory-link">CALL 2E49H</a></div><div>Go print a leading <span class="code">+</span> if necessary.</div></div>
									<div class="assembly-row-combined model1"><div>2D09</div><div>LD D,A</div><div>Zero register D.</div></div>
									<div class="assembly-row-combined model1"><div>2D0A</div><div>LD A,(HL)</div><div>Load register A with the character (i.e., the field description) at the location of the USING string pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2D0B</div><div>INC HL</div><div>Bump the value of the USING string pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2D0C-2D0D</div><div>CP 21H</div><div>Check to see if the character in register A is a <span class="code">!</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2D0E-2D10</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2E14" class="memory-link">JP Z,2E14H</a></div><div>Jump if the character in register A is a <span class="code">!</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2D11-2D12</div><div>CP 23H</div><div>Check to see if the character in register A is a <span class="code">#</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2D13-2D14</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2D4C" class="memory-link">JR Z,2D4CH</a></div><div>Jump if the character in register A is a <span class="code">#</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2D15</div><div>DEC B</div><div>Decrement the value of the string's length in register B.</div></div>
									<div class="assembly-row-combined model1"><div>2D16-2D18</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2DFE" class="memory-link">JP Z,2DFEH</a></div><div>Jump if this is the end of the USING string.</div></div>
									<div class="assembly-row-combined model1"><div>2D19-2D1A</div><div>CP 2BH</div><div>Check to see if the character in register A is a <span class="code">+</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2D1B-2D1C</div><div>LD A,08H</div><div>Set the flag in register A to force a leading <span class="code">+</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2D1D-2D1E</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2D06" class="memory-link">JR Z,2D06H</a></div><div>Jump if the character in register A was a <span class="code">+</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2D1F</div><div>DEC HL</div><div>Decrement the value of the USING string pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2D20</div><div>LD A,(HL)</div><div>Load register A with the character at the location of the USING string pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2D21</div><div>INC HL</div><div>Bump the value of the USING string pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2D22-2D23</div><div>CP 2EH</div><div>Check to see if the character in register A is a <span class="code">.</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2D24-2D25</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2D66" class="memory-link">JR Z,2D66H</a></div><div>Jump if the character in register A is a <span class="code">.</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2D26-2D27</div><div>CP 25H</div><div>Check to see if the character in register A is a <span class="code">%</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2D28-2D29</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2CE7" class="memory-link">JR Z,2CE7H</a></div><div>Jump if the character in register A is a <span class="code">%</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2D2A</div><div>CP (HL)</div><div>Compare the character in register A with the character at the location of the USING string pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2D2B-2D2C</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2CFD" class="memory-link">JR NZ,2CFDH</a></div><div>Jump if the character in register A isn't equal to the character at the location of the USING string pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2D2D-2D2E</div><div>CP 24H</div><div>Check to see if the character in register A is a <span class="code">$</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2D2F-2D30</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2D45" class="memory-link">JR Z,2D45H</a></div><div>Jump if the character in register A is a <span class="code">$</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2D31-2D32</div><div>CP 2AH</div><div>Check to see if the character in register A is a <span class="code">*</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2D33-2D34</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2CFD" class="memory-link">JR NZ,2CFDH</a></div><div>Jump if the character in register A isn't a <span class="code">*</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2D35</div><div>LD A,B</div><div>Load register A with the USING string's length in register B.</div></div>
									<div class="assembly-row-combined model1"><div>2D36-2D37</div><div>CP 02H</div><div>Check to see if the USING string's length in register A is at least two.</div></div>
									<div class="assembly-row-combined model1"><div>2D38</div><div>INC HL</div><div>Bump the value of the USING string pointer in HL.</div></div>
									<div class="assembly-row-combined model1" id="2D3E"><div>2D39-2D3A</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2D3E" class="memory-link">JR C,2D3EH</a></div><div>Jump to 2D3EH if the USING string's length in register A isn't at least two.</div></div>
									<div class="assembly-row-combined model1"><div>2D3B</div><div>LD A,(HL)</div><div>Load register A with the character at the location of the USING string pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2D3C-2D3D</div><div>CP 24H</div><div>Check to see if the character in register A is a string.</div></div>
									<div class="assembly-row-combined model1"><div>2D3E-2D3F</div><div>LD A,20H</div><div>Set the <span class="code">**</span> edit flag in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2D40-2D41</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2D49" class="memory-link">JR NZ,2D49H</a></div><div>Jump if the character in register A isn't a <span class="code">$</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2D42</div><div>DEC B</div><div>Decrement the value of the USING string's length in register.</div></div>
									<div class="assembly-row-combined model1"><div>2D43</div><div>INC E</div><div>Bump the number of characters to the left of the decimal point in register E.</div></div>
									<div class="assembly-row-combined model1"><div>2D44-2D45</div><div>FE AF</div><div>Z-80 Trick to skip over a <span class="code">XOR A</span> if passing through by processing it as a <span class="code">CP AFH</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2D45</div><div>XOR A</div><div>This is <span class="code">$</span> processing for PRINT USING.</div></div>
									<div class="assembly-row-combined model1"><div>2D46-2D47</div><div>ADD A,10H</div><div>Mask the value of the edit flag in register A for leading <span class="code">$</span>'s.</div></div>
									<div class="assembly-row-combined model1"><div>2D48</div><div>INC HL</div><div>Bump the value of the USING string pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2D49</div><div>INC E</div><div>Bump the number of characters to the left of the decimal point in register E.</div></div>
									<div class="assembly-row-combined model1"><div>2D4A</div><div>ADD A,D</div><div>Combine the value of the edit flag in register D with the value of the edit flag in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2D4B</div><div>LD D,A</div><div>Load register D with the value of the edit flag in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2D4C</div><div>INC E</div><div>Bump the number of characters to the left of the decimal point in register E.</div></div>
									<div class="assembly-row-combined model1"><div>2D4D-2D4E</div><div>LD C,00H</div><div>Zero the number of characters to the right of the decimal point in register C.</div></div>
									<div class="assembly-row-combined model1"><div>2D4F</div><div>DEC B</div><div>Decrement the value of the string's length in register B.</div></div>
									<div class="assembly-row-combined model1"><div>2D50-2D51</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2D99" class="memory-link">JR Z,2D99H</a></div><div>Jump if this is the end of the string.</div></div>
									<div class="assembly-row-combined model1"><div>2D52</div><div>LD A,(HL)</div><div>Load register A with the character at the location of the USING string pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2D53</div><div>INC HL</div><div>Bump the value of the USING string pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2D54-2D55</div><div>CP 2EH</div><div>Check to see if the character in register A is a <span class="code">.</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2D56-2D57</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2D70" class="memory-link">JR Z,2D70H</a></div><div>Jump if the character in register A is a <span class="code">.</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2D58-2D59</div><div>CP 23H</div><div>Check to see if the character in register A is a <span class="code">#</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2D5A-2D</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2D4C" class="memory-link">JR Z,2D4CH</a></div><div>5BH Jump if the character in register A is a <span class="code">#</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2D5C-2D5D</div><div>CP 2CH</div><div>Check to see if the character in register A is a <span class="code">,</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2D5E-2D5F</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2D7A" class="memory-link">JR NZ,2D7AH</a></div><div>Jump if the character in register A isn't a <span class="code">,</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2D60</div><div>LD A,D</div><div>Load register A with the value of the edit flag in register D.</div></div>
									<div class="assembly-row-combined model1"><div>2D61-2D62</div><div>OR 40H</div><div>Mask the edit flag in register A for <span class="code">,</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2D63</div><div>LD D,A</div><div>Load register D with the value of the edit flag in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2D64-2D65</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2D4C" class="memory-link">JR 2D4CH</a></div><div>Jump to 2D4CH.</div></div>
									<div class="assembly-row-combined model1"><div>2D66</div><div>LD A,(HL)</div><div>Load register A with the character at the location of the USING string pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2D67-2D68</div><div>CP 23H</div><div>Check to see if the character in register A is a <span class="code">#</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2D69-2D6A</div><div>LD A,2EH</div><div>Load register A with a decimal point.</div></div>
									<div class="assembly-row-combined model1"><div>2D6B-2D6C</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2CFD" class="memory-link">JR NZ,2CFDH</a></div><div>Jump if the character in register A wasn't a <span class="code">#</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2D6D-2D6E</div><div>LD C,01H</div><div>Load register C with the number of characters to the right of the decimal point.</div></div>
									<div class="assembly-row-combined model1"><div>2D6F</div><div>INC HL</div><div>Bump the value of the USING string pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2D70</div><div>INC C</div><div>Bump the number of characters to the right of the decimal point in register C.</div></div>
									<div class="assembly-row-combined model1"><div>2D71</div><div>DEC B</div><div>Decrement the value of the string's length in register B.</div></div>
									<div class="assembly-row-combined model1"><div>2D72-2D73</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2D99" class="memory-link">JR Z,2D99H</a></div><div>Jump if this is the end of the string.</div></div>
									<div class="assembly-row-combined model1"><div>2D74</div><div>LD A,(HL)</div><div>Load register A with the character at the location of the USING string pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2D75</div><div>INC HL</div><div>Bump the value of the USING string pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2D76-2D77</div><div>CP 23H</div><div>Check to see if the character in register A is a <span class="code">#</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2D78-2D79</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2D70" class="memory-link">JR Z,2D70H</a></div><div>Jump if the character in register A is a <span class="code">#</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2D7A</div><div>PUSH DE</div><div>Save the value of the edit flag and the count of the characters to the left of the decimal point in DE to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2D7B-2D7D</div><div>LD DE,2D97H</div><div>Load DE with the return address.</div></div>
									<div class="assembly-row-combined model1"><div>2D7E</div><div>PUSH DE</div><div>Save the value of the return address in DE to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2D7F</div><div>LD D,H</div><div>Load register D with the MSB of the USING string pointer m register H.</div></div>
									<div class="assembly-row-combined model1"><div>2D80</div><div>LD E,L</div><div>Load register E with the LSB of the USING string pointer in register L.</div></div>
									<div class="assembly-row-combined model1"><div>2D81-2D82</div><div>CP 5BH</div><div>Check to see if the character in register A is an up arrow.</div></div>
									<div class="assembly-row-combined model1"><div>2D83</div><div>RET NZ</div><div>Return if the character in register A isn't an up arrow.</div></div>
									<div class="assembly-row-combined model1" id="2D84"><div>2D84</div><div>CP (HL)</div><div>Check to see if the character at the location of the USING string pointer in HL is an up arrow.</div></div>
									<div class="assembly-row-combined model1"><div>2D85</div><div>RET NZ</div><div>Return to 2D97 if the character at the location of the USING string pointer in HL isn't an up arrow (meaning we do not have a <span class="code">[[</span> format).</div></div>
									<div class="assembly-row-combined model1" id="2D86"><div>2D86</div><div>INC HL</div><div>Bump the value of the USING string pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2D87</div><div>CP (HL)</div><div>Check to see if there is a third up arrow at the location of the USING string pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2D88</div><div>RET NZ</div><div>Return to 2D97 if the character at the location of the USING string pointer in HL isn't an up arrow (meaning we do not have a <span class="code">[[[</span> format).</div></div>
									<div class="assembly-row-combined model1" id="2D89"><div>2D89</div><div>INC HL</div><div>Bump the value of the USING string pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2D8A</div><div>CP (HL)</div><div>Check to see if the character at the location of the USING string pointer in HL is a fourth up arrow.</div></div>
									<div class="assembly-row-combined model1"><div>2D8B</div><div>RET NZ</div><div>Return to 2D97 if the character at the location of the USING string pointer in HL isn't an up arrow (meaning we do not have a <span class="code">[[[[</span> format).</div></div>
									<div class="assembly-row-combined model1" id="2D8C"><div>2D8C</div><div>INC HL</div><div>Bump the value of the USING string pointer in HL.  If we are here we have a <span class="code">#.##[[[[</span> format.</div></div>
									<div class="assembly-row-combined model1"><div>2D8D</div><div>LD A,B</div><div>Load register A with the value of the USING string's length in register B.</div></div>
									<div class="assembly-row-combined model1"><div>2D8E-2D8F</div><div>SUB 04H</div><div>Check to see if there are at least 4 characters left in the USING string.</div></div>
									<div class="assembly-row-combined model1"><div>2D90</div><div>RET C</div><div>Return to 2D97 if there aren't at least four characters left in the USING string.</div></div>
									<div class="assembly-row-combined model1" id="2D91"><div>2D91</div><div>POP DE</div><div>If there are at least 4 characters left, then clean up the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2D92</div><div>POP DE</div><div>Get the edit flag and the count of the characters to the left of the decimal point from the stack and put it in DE.</div></div>
									<div class="assembly-row-combined model1"><div>2D93</div><div>LD B,A</div><div>Load register B with the USING string's length in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2D94</div><div>INC D</div><div>Set the exponential notation flag in register D.</div></div>
									<div class="assembly-row-combined model1"><div>2D95</div><div>INC HL</div><div>Bump the value of the USING string pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2D96</div><div>CA</div><div>Z-80 Trick! By putting the CA opcode here, the next 2 bytes are ignored if passing through, but remain in effect if jumped to.</div></div>
									<div class="assembly-row-combined model1"><div>2D97</div><div>EX DE,HL</div><div>(Ignored if passing through) Load HL with the value of the USING string pointer in DE.</div></div>
									<div class="assembly-row-combined model1"><div>2D98</div><div>POP DE</div><div>(Ignored
 if passing through) Get the edit flag and the count of the characters 
to the left of the decimal point from the stack and put it in DE.</div></div>
									<div class="assembly-row-combined model1"><div>2D99</div><div>LD A,D</div><div>Load register A with the value of the edit flag in register D.</div></div>
									<div class="assembly-row-combined model1"><div>2D9A</div><div>DEC HL</div><div>Decrement the value of the USING string pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2D9B</div><div>INC E</div><div>Bump the number of characters to the left of the decimal point in register E.</div></div>
									<div class="assembly-row-combined model1"><div>2D9C-2D9D</div><div>AND 08H</div><div>Check to see if the sign flag is set in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2D9E-2D9F</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2DB5" class="memory-link">JR NZ,2DB5H</a></div><div>Jump to 2DB5H if the sign flag has already been processed.</div></div>
									<div class="assembly-row-combined model1"><div>2DA0</div><div>DEC E</div><div>Decrement the number of characters to the left of the decimal point in register E.</div></div>
									<div class="assembly-row-combined model1"><div>2DA1</div><div>LD A,B</div><div>Load register A with the USING string's length in register B.</div></div>
									<div class="assembly-row-combined model1"><div>2DA2</div><div>OR A</div><div>Check to see if this is the end of the string.</div></div>
									<div class="assembly-row-combined model1"><div>2DA3-2DA4</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2DB5" class="memory-link">JR Z,2DB5H</a></div><div>Jump to 2DB5H if this is the end of the string.</div></div>
									<div class="assembly-row-combined model1"><div>2DA5</div><div>LD A,(HL)</div><div>Load register A with the character at the location of the USING string pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2DA6-2DA7</div><div>SUB 2DH</div><div>Check to see if the character in register A is a - .</div></div>
									<div class="assembly-row-combined model1"><div>2DA8-2DA9</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2DB0" class="memory-link">JR Z,2DB0H</a></div><div>Jump to 2DB0H if the character in register A is a - .</div></div>
									<div class="assembly-row-combined model1"><div>2DAA-2DAB</div><div>CP 0FEH</div><div>Check to see if the character in register A is a +.</div></div>
									<div class="assembly-row-combined model1"><div>2DAC-2DAD</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2DB5" class="memory-link">JR NZ,2DB5H</a></div><div>Jump to 2DB5H if the character in register A isn't a +.</div></div>
									<div class="assembly-row-combined model1"><div>2DAE-2DAF</div><div>LD A,08H</div><div>Set the edit flag for a + character.</div></div>
									<div class="assembly-row-combined model1"><div>2DB0-2DB1</div><div>ADD A,04H</div><div>Set the edit flag for a - character.</div></div>
									<div class="assembly-row-combined model1"><div>2DB2</div><div>ADD A,D</div><div>Combine the value of the edit flag in register D with the value of the edit flag in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2DB3</div><div>LD D,A</div><div>Load register D with the value of the edit flag in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2DB4</div><div>DEC B</div><div>Decrement the value of the USING string's length in register B.</div></div>
									<div class="assembly-row-combined model1"><div>2DB5</div><div>POP HL</div><div>Get the value of the current BASIC program pointer from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2DB6</div><div>POP AF</div><div>Load register A with the character at the location of the current BASIC program pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2DB7-2DB8</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2E09" class="memory-link">JR Z,2E09H</a></div><div>Jump if this is the end of the BASIC statement.</div></div>
									<div class="assembly-row-combined model1"><div>2DB9</div><div>PUSH BC</div><div>Save the count of the characters to the right of the decimal point and the USING string's length in BC to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2DBA</div><div>PUSH DE</div><div>Save the edit flag and the number of characters to the left of the decimal point in DE to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2DBB-2DBD</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2337" class="memory-link">CALL 2337H</a></div><div>Go evaluate the expression at the location of the current BASIC program pointer and return with the result in REG 1.</div></div>
									<div class="assembly-row-combined model1"><div>2DBE</div><div>POP DE</div><div>Get the edit flag and the number of characters to the left of the decimal point from the stack and put it in DE.</div></div>
									<div class="assembly-row-combined model1"><div>2DBF</div><div>POP BC</div><div>Get the number of characters to the right of the decimal point and the USING string's length from the stack and put it in BC.</div></div>
									<div class="assembly-row-combined model1"><div>2DC0</div><div>PUSH BC</div><div>Save the number of characters to the right of the decimal point and the USING string's length m BC to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2DC1</div><div>PUSH HL</div><div>Save the value of the current BASIC program pointer in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2DC2</div><div>LD B,E</div><div>Load register B with the number of characters to the left of the decimal point in register E.</div></div>
									<div class="assembly-row-combined model1"><div>2DC3</div><div>LD A,B</div><div>Load register A with the number of characters to the left of the decimal point in register B.</div></div>
									<div class="assembly-row-combined model1"><div>2DC4</div><div>ADD A,C</div><div>Add
 the number of characters to the right of the decimal point in register C
 to the number of characters to the left of the decimal point in 
register A.</div></div>
									<div class="assembly-row-combined model1"><div>2DC5-2DC6</div><div>CP 19H</div><div>Check to see if the total number of characters in register A is greater than 24.</div></div>
									<div class="assembly-row-combined model1"><div>2DC7-2DC9</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1E4A" class="memory-link">JP NC,1E4AH</a></div><div>Display a FC ERROR message if the total number of characters in register A is greater than 24.</div></div>
									<div class="assembly-row-combined model1"><div>2DCA</div><div>LD A,D</div><div>Load register A with the value of the edit flag in register D.</div></div>
									<div class="assembly-row-combined model1"><div>2DCB-2DCC</div><div>OR 80H</div><div>Set the edit flag in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2DCD-2DCF</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0FBE" class="memory-link">CALL 0FBEH</a></div><div>Call
 the FLOATING TO ASCII routine at 0FBEH (whcih converts a single or 
double precision number in REG 1 to its ASCII equivalent which will be 
stored at the buffer pointed to by HL using the format codes in the A, 
B, and C registers.</div></div>
									<div class="assembly-row-combined model1"><div>2DD0-2DD2</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#28A7" class="memory-link">CALL 28A7H</a></div><div>We need to display the ASCII string, so we call the WRITE MESSAGE routine at 28A7H.<br><span class="bold">NOTE:</span><br><ul><li>The routine at 28A7 displays the message pointed to by HL on current system output device (usually video).</li><li>The string to be displayed must be terminated by a byte of machine zeros or a carriage return code 0D.</li><li>If terminated with a carriage return, control is returned to the caller after taking the DOS exit at 41D0H (JP 5B99H).</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2DD3</div><div>POP HL</div><div>Get the value of the current BASIC program pointer from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2DD4</div><div>DEC HL</div><div>Decrement the value of the current BASIC program pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2DD5</div><div>RST 10H</div><div>We need the next character in the BASIC program so call the EXAMINE NEXT SYMBOL routine at RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The
 RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2DD6</div><div>SCF</div><div>Set the Carry flag.</div></div>
									<div class="assembly-row-combined model1"><div>2DD7-2DD8</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2DE6" class="memory-link">JR Z,2DE6H</a></div><div>Jump
 if the character at the location of the current BASIC program pointer 
in register A is an end of the BASIC statement character.</div></div>
									<div class="assembly-row-combined model1"><div>2DD9-2DDB</div><div>LD (40DEH),A</div><div>Save the character at the location of the current BASIC program pointer in register A.<br>Note: 40DEH holds READ flag.</div></div>
									<div class="assembly-row-combined model1"><div>2DDC-2DDD</div><div>CP 3BH</div><div>Check to see if the character at the location of the current BASIC program pointer in register A is a semicolon.</div></div>
									<div class="assembly-row-combined model1"><div>2DDE-2DDF</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2DE5" class="memory-link">JR Z,2DE5H</a></div><div>Jump if the character at the location of the current BASIC program pointer in register A is a semicolon.</div></div>
									<div class="assembly-row-combined model1"><div>2DE0-2DE1</div><div>CP 2CH</div><div>Check to see if the character at the location of the current BASIC program pointer in register A is a comma.</div></div>
									<div class="assembly-row-combined model1"><div>2DE2-2DE4</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1997" class="memory-link">JP NZ,1997H</a></div><div>Go
 to the Level II BASIC error routine and display an SN ERROR message if 
the character at the location of the current BASIC program pointer in 
register A isn't a comma.</div></div>
									<div class="assembly-row-combined model1"><div>2DE5</div><div>RST 10H</div><div>We need the next character in the BASIC program so call the EXAMINE NEXT SYMBOL routine at RST 10H.<br><span class="nobottomborder bold">NOTE:</span><ul><li>The
 RST 10H routine loads the next character from the string pointed to by 
the HL register into the A-register and clears the CARRY flag if it is 
alphabetic, or sets it if is alphanumeric.</li><li>Blanks and control codes 09H and 0BH are ignored causing the following character to be loaded and tested.</li><li>The
 HL register will be incremented before loading any character therfore 
on the first call the HL register should contain the string address 
minus one.</li><li>The string must be terminated by a byte of zeros.</li></ul></div></div>
									<div class="assembly-row-combined model1"><div>2DE6</div><div>POP BC</div><div>Get the USING string's length from the stack and put it in register B.</div></div>
									<div class="assembly-row-combined model1"><div>2DE7</div><div>EX DE,HL</div><div>Load DE with the value of the current BASIC program pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2DE8</div><div>POP HL</div><div>Get the USING string's VARPTR from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2DE9</div><div>PUSH HL</div><div>Save the USING string's VARPTR in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2DEA</div><div>PUSH AF</div><div>Save the character at the location of the current BASIC program pointer in register A to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2DEB</div><div>PUSH DE</div><div>Save the value of the current BASIC program pointer in DE to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2DEC</div><div>LD A,(HL)</div><div>Load register A with the USING string's length at the location of the USING string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2DED</div><div>SUB B</div><div>Compare the USING string's length in register B with the USING string's length in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2DEE</div><div>INC HL</div><div>Bump the value of the USING string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2DEF</div><div>LD C,(HL)</div><div>Load register C with the LSB of the USING string's address at the location of the USING string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2DF0</div><div>INC HL</div><div>Bump the value of the USING string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2DF1</div><div>LD H,(HL)</div><div>Load register H with the MSB of the USING string's address at the location of the USING string's VARPTR in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2DF2</div><div>LD L,C</div><div>Load register L with the LSB of the USING string's address in register C.</div></div>
									<div class="assembly-row-combined model1"><div>2DF3-2DF4</div><div>LD D,00H</div><div>Zero register D.</div></div>
									<div class="assembly-row-combined model1"><div>2DF5</div><div>LD E,A</div><div>Load register E with the USING string's offset in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2DF6</div><div>ADD HL,DE</div><div>Add the USING string's offset in DE to the USING string's address in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2DF7</div><div>LD A,B</div><div>Load register A with the USING string's length in register B.</div></div>
									<div class="assembly-row-combined model1"><div>2DF8</div><div>OR A</div><div>Check to see if this is the end of the USING string.</div></div>
									<div class="assembly-row-combined model1"><div>2DF9-2DFB</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2D03" class="memory-link">JP NZ,2D03H</a></div><div>Jump to 2D03H if this isn't the end of the USING string.</div></div>
									<div class="assembly-row-combined model1"><div>2DFC-2DFD</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2E04" class="memory-link">JR 2E04H</a></div><div>Jump to 2E04H if this is the end of the USING string.</div></div>
									<div class="assembly-row-combined model1"><div>2DFE-2E00</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2E49" class="memory-link">CALL 2E49H</a></div><div>GOSUB to 2E49H print a <span class="code">+</span> if necessary.</div></div>
									<div class="assembly-row-combined model1"><div>2E01-2E03</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#032A" class="memory-link">CALL 032AH</a></div><div>Go send the character in register A to the current output device.</div></div>
									<div class="assembly-row-combined model1"><div>2E04</div><div>POP HL</div><div>Get the value of the current BASIC program pointer from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2E05</div><div>POP AF</div><div>Get the character at the location of the current BASIC program pointer from the stack and put it in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2E06-2E08</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2CCB" class="memory-link">JP NZ,2CCBH</a></div><div>Jump back to 2CCBH if this isn't the end of the BASIC statement.</div></div>
									<div class="assembly-row-combined model1" id="20FE"><div>2E09-2E0B</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#20FE" class="memory-link">CALL C,20FEH</a></div><div>GOSUB to 20FEH to send a carriage return to the current output device if necessary.</div></div>
									<div class="assembly-row-combined model1"><div>2E0C</div><div>EX (SP),HL</div><div>Exchange the value of the current BASIC program pointer in HL with the value of the USING string's VARPTR to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2E0D-2E0F</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#29DD" class="memory-link">CALL 29DDH</a></div><div>Go get the USING string's address in DE.</div></div>
									<div class="assembly-row-combined model1"><div>2E10</div><div>POP HL</div><div>Get the value of the current BASIC program pointer from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2E11-2E13</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2169" class="memory-link">JP 2169H</a></div><div>Return to 2169H.</div></div>
									<div class="assembly-row-combined model1" id="2E14"><div>2E14-2E15</div><div>LD C,01H</div><div>Continue processing a <span class="code">!</span> in the <span class="code">USING</span> format by loading register C with the number of characters to be printed.</div></div>
									<div class="assembly-row-combined model1"><div>2E16-2E17</div><div>3E F1</div><div>Z-80 Trick.  By putting a 3E in front of the F1 (which is <span class="code">POP AF</span>, to clear the stack) that <span class="code">POP AF</span> gets skipped if flowing down in the code.</div></div>
									<div class="assembly-row-combined model1"><div>2E17</div><div>POP AF</div><div>(Skipped if passing down) Clear the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2E18</div><div>DEC B</div><div>Decrement the value of the string's length in register B.</div></div>
									<div class="assembly-row-combined model1"><div>2E19-2E1B</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2E49" class="memory-link">CALL 2E49H</a></div><div>Go print a <span class="code">+</span> if register D is not zero.</div></div>
									<div class="assembly-row-combined model1"><div>2E1C</div><div>POP HL</div><div>Get the value of the current BASIC program pointer from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2E1D</div><div>POP AF</div><div>Get the character at the location of the current BASIC program pointer from the stack and put it in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2E1E-2E1F</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2E09" class="memory-link">JR Z,2E09H</a></div><div>Jump
 back to 2E09H if the character at the location of the current BASIC 
program pointer in register A is an end of the BASIC statement 
character.</div></div>
									<div class="assembly-row-combined model1"><div>2E20</div><div>PUSH BC</div><div>Save the USING string's length and the number of characters to be printed in BC to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2E21-2E23</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2337" class="memory-link">CALL 2337H</a></div><div>Go evaluate the expression at the location of the current BASIC program pointer in HL and return with the result in REG 1</div></div>
									<div class="assembly-row-combined model1"><div>2E24-2E26</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0AF4" class="memory-link">CALL 0AF4H</a></div><div>Go make sure the current result in REG 1 is a string.</div></div>
									<div class="assembly-row-combined model1"><div>2E27</div><div>POP BC</div><div>Get the USING string's length and the number of characters to be printed from the stack and put it in BC.</div></div>
									<div class="assembly-row-combined model1"><div>2E28</div><div>PUSH BC</div><div>Save the USING string's length and the number of characters to be printed in BC to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2E29</div><div>PUSH HL</div><div>Save the value of the current BASIC program pointer in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2E2A-2E2C</div><div>LD HL,(4121H)</div><div>Load HL with the string's VARPTR in REG 1.</div></div>
									<div class="assembly-row-combined model1"><div>2E2D</div><div>LD B,C</div><div>Load register B with the number of characters to be printed in register C.</div></div>
									<div class="assembly-row-combined model1"><div>2E2E-2E2F</div><div>LD C,00H</div><div>Zero register C.</div></div>
									<div class="assembly-row-combined model1"><div>2E30</div><div>PUSH BC</div><div>Save the length of the string to be printed in register B to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2E31-2E33</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2A68" class="memory-link">CALL 2A68H</a></div><div>Go evaluate the string to be printed.</div></div>
									<div class="assembly-row-combined model1"><div>2E34-2E36</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#28AA" class="memory-link">CALL 28AAH</a></div><div>Go send the string to the current output device.</div></div>
									<div class="assembly-row-combined model1"><div>2E37-2E39</div><div>LD HL,(4121H)</div><div>Load HL with the string's VARPTR in REG 1.</div></div>
									<div class="assembly-row-combined model1"><div>2E3A</div><div>POP AF</div><div>Get the length of the string to be printed from the stack and put it in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2E3B</div><div>SUB (HL)</div><div>Subtract
 the string's length at the location of the string's VARPTR in HL from 
the length of the string to be printed in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2EJC</div><div>LD B,A</div><div>Load register B with the number of spaces to be printed in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2EJD-2EJE</div><div>LD A,20H</div><div>Load register A with a space.</div></div>
									<div class="assembly-row-combined model1"><div>2E3F</div><div>INC B</div><div>Bump the number of spaces in register B.</div></div>
									<p class="debug-note">This loop will print all the spaces needed and then jump to 2DD3H</p>
									<div class="assembly-row-combined model1"><div>2E40</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2DD3" class="memory-link">DEC B</a></div><div>Decrement the number of spaces in register B.</div></div>
									<div class="assembly-row-combined model1"><div>2E41-2E43</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2DD3" class="memory-link">JP Z,2DD3H</a></div><div>Jump back to 2DD3H if all of the spaces have been printed.</div></div>
									<div class="assembly-row-combined model1"><div>2E44-2E46</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#032A" class="memory-link">CALL 032AH</a></div><div>Go send a space to the current output device.</div></div>
									<div class="assembly-row-combined model1"><div>2E47-2E48</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2E40" class="memory-link">JR 2E40H</a></div><div>Jump back to 2E40H.</div></div>
									<div class="assembly-row-combined model1"><div>2E49</div><div>PUSH AF</div><div>Save the value in register A to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2E4A</div><div>LD A,D</div><div>Load register A with the value in register D.</div></div>
									<div class="assembly-row-combined model1"><div>2E4B</div><div>OR A</div><div>Check to see if register A is equal to zero.</div></div>
									<div class="assembly-row-combined model1"><div>2E4C-2E4D</div><div>LD A,2BH</div><div>Load register A with a <span class="code">+</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2E4E-2E50</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#032A" class="memory-link">CALL NZ,032AH</a></div><div>Go send a <span class="code">+</span> to the current output device if register D is non-zero.</div></div>
									<div class="assembly-row-combined model1"><div>2E51</div><div>POP AF</div><div>Get the value from the stack and put it in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2E52</div><div>RET</div><div>Return.</div></div>
								</div>
							</div>

							<br><h2 id="2e53-2ffa-level-ii">2E53-2FFA - LEVEL II BASIC <span class="code">EDIT</span> ROUTINE<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2E53-2E55</div><div>LD (409AH),A</div><div>Reset the error flag.<br>Note: 409AH holds the RESUME flag.</div></div>
									<div class="assembly-row-combined model1"><div>2E56-2E58</div><div>LD HL,(40EAH)</div><div>Load HL with the line number where the error occurred.<br>Note: 40EAH-40EBH holds the line number with error.</div></div>
									<div class="assembly-row-combined model1"><div>2E59</div><div>OR H</div><div>OR register A with the MSB of the error line number in register H.</div></div>
									<div class="assembly-row-combined model1"><div>2E5A</div><div>AND L</div><div>Combine
 the LSB of the error line number in register L with the MSB of the 
error line number in register A.  It will be FFH if execution had not 
begun.</div></div>
									<div class="assembly-row-combined model1"><div>2E5B</div><div>INC A</div><div>Bump the combined value of the error line number in register A.  If execution had not begin, this will turn A from FFH into 00H</div></div>
									<div class="assembly-row-combined model1"><div>2E5C</div><div>EX DE,HL</div><div>Load DE with the line number with the error (held in HL).</div></div>
									<div class="assembly-row-combined model1"><div>2E5D</div><div>RET Z</div><div>If there was no line number, return if Level II BASIC.</div></div>
									<div class="assembly-row-combined model1" id="2E5E"><div>2E5E-2E5F</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2E64" class="memory-link">JR 2E64H</a></div><div>Jump to 2E64H.</div></div>
									<p class="debug-note">Now that the above code is out of the way
 (it was the code which would enter EDIT if there was an error in a line
 number), let us actually process the <span class="code">EDIT</span> command.</p>
									<div class="assembly-row-combined model1"><div>2E60-2E62</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1E4F" class="memory-link">CALL 1E4FH</a></div><div>Get the first line number by calling 1E4F - returns in in DE.</div></div>
									<div class="assembly-row-combined model1"><div>2E63</div><div>RET NZ</div><div>If the zero flag got set, there was no line number, so return.</div></div>
									<div class="assembly-row-combined model1" id="2E64"><div>2E64</div><div>POP HL</div><div>Clean up the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2E65</div><div>EX DE,HL</div><div>Load HL with the line number to be edited in DE.</div></div>
									<div class="assembly-row-combined model1"><div>2E66-2E68</div><div>LD (40ECH),HL</div><div>Save the value of the line number to be edited (in HL) to the memory location that cares about such things.<br>Note: 40ECH-40EDH holds EDIT line number.</div></div>
									<div class="assembly-row-combined model1"><div>2E69</div><div>EX DE,HL</div><div>Load DE with the line number to be edited in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2E6A-2E6C</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1B2C" class="memory-link">CALL 1B2CH</a></div><div>Call
 the SEARCH FOR LINE NUMBER routine at 1B2CH which looks for the line 
number specified in DE. Returns C/Z with the line found in BC, NC/Z with
 line number is too large and HL/BC having the next available location, 
or NC/NZ with line number not found, and BC has the first available one 
after that.</div></div>
									<div class="assembly-row-combined model1"><div>2E6D-2E6F</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1ED9" class="memory-link">JP NC,1ED9H</a></div><div>If the BASIC line number doesn't exist, display a <span class="code">?UL ERROR</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2E70</div><div>LD H,B</div><div>At this point, the line number has been found.  Load register H with the MSB of the memory pointer in register B.</div></div>
									<div class="assembly-row-combined model1"><div>2E71</div><div>LD L,C</div><div>Load register L with the LSB of the memory pointer in register C.</div></div>
									<div class="assembly-row-combined model1"><div>2E72</div><div>INC HL</div><div>Bump the value of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2E73</div><div>INC HL</div><div>Bump the value of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2E74</div><div>LD C,(HL)</div><div>Load register C with the LSB of the BASIC line number at the location of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2E75</div><div>INC HL</div><div>Bump the value of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2E76</div><div>LD B,(HL)</div><div>Load register B with the MSB of the BASIC line number at the location of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2E77</div><div>INC HL</div><div>Bump the value of the memory pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2E78</div><div>PUSH BC</div><div>Save the value of the BASIC line number in BC to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2E79-2E7B</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2B7E" class="memory-link">CALL 2B7EH</a></div><div>Go move the BASIC line we are working on into the input buffer and expand it.</div></div>
									<div class="assembly-row-combined model1"><div>2E7C</div><div>POP HL</div><div>Get the value of the BASIC line number from the stack and put it in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2E7D</div><div>PUSH HL</div><div>Save the value of the BASIC line number in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2E7E-2E80</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0FAF" class="memory-link">CALL 0FAFH</a></div><div>Convert
 the line number to ASCII and print it out by calling the HL TO ASCII 
routine at 0FAFH (which converts the value in the HL (assumed to be an 
integer) to ASCII and display it at the current cursor position on the 
video screen).</div></div>
									<div class="assembly-row-combined model1"><div>2E81-2E82</div><div>LD A,20H</div><div>Load register A with a space.</div></div>
									<div class="assembly-row-combined model1"><div>2E83-2E85</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#032A" class="memory-link">CALL 032AH</a></div><div>Go display the space in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2E86-2E88</div><div>LD HL,(40A7H)</div><div>Load HL with the starting address of the expended version of the current line from the input buffer.<br>Note: 40A7H-40A8H holds the input Buffer pointer.</div></div>
									<div class="assembly-row-combined model1"><div>2E89-2E8A</div><div>LD A,0EH</div><div>Load register A with the "turn on the cursor" character.</div></div>
									<div class="assembly-row-combined model1"><div>2E8B-2E8D</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#032A" class="memory-link">CALL 032AH</a></div><div>Go turn on the cursor.</div></div>
									<div class="assembly-row-combined model1"><div>2E8E</div><div>PUSH HL</div><div>Save the value of the input buffer pointer (in HL) to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2E8F-2E90</div><div>LD C,FFH</div><div>Load
 register C with the number of characters examined so far with FFH 
because the next line is going to INC it by 1 to make it 0.</div></div>
									<div class="assembly-row-combined model1"><div>2E91</div><div>INC C</div><div>Bump the number of characters examined so far in register C.</div></div>
									<div class="assembly-row-combined model1"><div>2E92</div><div>LD A,(HL)</div><div>Load register A with the character at the location of the input buffer pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2E93</div><div>OR A</div><div>Check to see if the character in register A is an end of the BASIC line character.</div></div>
									<div class="assembly-row-combined model1"><div>2E94</div><div>INC HL</div><div>Bump the value of the input buffer pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2E95-2E96</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2E91" class="memory-link">JR NZ,2E91H</a></div><div>Loop back to 2E91H until the end of the BASIC line has been found.</div></div>
									<div class="assembly-row-combined model1"><div>2E97</div><div>POP HL</div><div>At this point, C will be the maximum number of characters in the line at issue.  Put the start of the expended buffer into HL.</div></div>
									<div class="assembly-row-combined model1"><div>2E98</div><div>LD B,A</div><div>Zero register B.  B will ultimately contain the count of characters inserted.</div></div>
									<div class="assembly-row-combined model1"><div>2E99-2E9A</div><div>LD D,00H</div><div>Zero register D.</div></div>
									<div class="assembly-row-combined model1"><div>2E9B-2E9D</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0384" class="memory-link">CALL 0384H</a></div><div>Go scan the keyboard.</div></div>
									<div class="assembly-row-combined model1"><div>2D9E-2E9F</div><div>SUB 30H</div><div>We need to test to see if the character was alphabetic or alphanumeric so we subtract 30H from it.</div></div>
									<div class="assembly-row-combined model1" id="2EB0"><div>2EA0-2EA1</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2EB0" class="memory-link">JR C,2EB0H</a></div><div>Jump down to 2EB0H if the character in register A is alphabetic.</div></div>
									<div class="assembly-row-combined model1"><div>2EA2-2EA3</div><div>CP 0AH</div><div>Check to see if the character is register A is numeric.</div></div>
									<div class="assembly-row-combined model1" id="2EB0"><div>2EA4-2EA5</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2EB0" class="memory-link">JR NC,2EB0H</a></div><div>Jump to 2EB0H if the character in register A isn't numeric.</div></div>
									<div class="assembly-row-combined model1"><div>2EA6</div><div>LD E,A</div><div>Load register E with the binary value of the character in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2EA7</div><div>LD A,D</div><div>Load register A with the value in register D.</div></div>
									<div class="assembly-row-combined model1"><div>2EA8</div><div>RLCA</div><div>Multiply the value in register A by two (so now A has multiplied by 2).</div></div>
									<div class="assembly-row-combined model1"><div>2EA9</div><div>RLCA</div><div>Multiply the value in register A by two (so now A has multiplied by 4).</div></div>
									<div class="assembly-row-combined model1"><div>2EAA</div><div>ADD A,D</div><div>Add the value in register D to the value in register A (so now A has multiplied by 5).</div></div>
									<div class="assembly-row-combined model1"><div>2EAB</div><div>RLCA</div><div>Multiply the value in register A by two (so now A has multiplied by 10).</div></div>
									<div class="assembly-row-combined model1"><div>2EAC</div><div>ADD A,E</div><div>Add the value in register E to the value in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2EAD</div><div>LD D,A</div><div>Load register D with the value in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2EAE-2EAF</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2E9B" class="memory-link">JR 2E9BH</a></div><div>Loop until a nonnumeric character is pressed.</div></div>
									<div class="assembly-row-combined model1"><div>2EB0</div><div>PUSH HL</div><div>Save the value of the input buffer pointer in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2EB1-2EB3</div><div>LD HL,2E99H</div><div>Load HL with the return address of 2E99H.</div></div>
									<div class="assembly-row-combined model1"><div>2EB4</div><div>EX (SP),HL</div><div>Exchange the value of the return address in HL with the value of the input buffer pointer to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2EB5</div><div>DEC D</div><div>We
 need to test if the command was preceded by a number so we need to set 
the flags by first ... decrementing the numeric value in register D ...</div></div>
									<div class="assembly-row-combined model1"><div>2EB6</div><div>INC D</div><div>... and then incrementing the numeric value in register D.</div></div>
									<div class="assembly-row-combined model1"><div>2EB7-2EB9</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2EBB" class="memory-link">JP NZ,2EBBH</a></div><div>Jump to 2EBBH if a numeric value preceded the command (i.e., register D isn't equal to zero).</div></div>
									<div class="assembly-row-combined model1"><div>2EBA</div><div>INC D</div><div>Load register D with a one.</div></div>
									<div class="assembly-row-combined model1"><div>2EBB-2EBC</div><div>CP 0D8H</div><div>Check to see if the character in register A is a <span class="code">backspace</span> character.</div></div>
									<div class="assembly-row-combined model1"><div>2EBD-2EBF</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2FD2" class="memory-link">JP Z,2FD2H</a></div><div>Jump if the character in register A is a <span class="code">backspace</span> character.</div></div>
									<div class="assembly-row-combined model1"><div>2EC0-2EC1</div><div>CP 0DDH</div><div>Check to see if the character in register A is a <span class="code">carriage return</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2EC2-2EC4</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2FE0" class="memory-link">JP Z,2FE0H</a></div><div>Jump if the character in register A is a <span class="code">carriage return</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2EC5-2EC6</div><div>CP 0F0H</div><div>Check to see if the character in register A is a <span class="code">space</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2EC7-2EC8</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2F0A" class="memory-link">JR Z,2F0AH</a></div><div>Jump if the character in register A is a <span class="code">space</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2EC9-2ECA</div><div>CP 31H</div><div>Check to see if the character in register A is lowercase.</div></div>
									<div class="assembly-row-combined model1" id="2ECF"><div>2ECB-2ECC</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2ECF" class="memory-link">JR C,2ECFH</a></div><div>Jump if the character in register A isn't lowercase.</div></div>
									<div class="assembly-row-combined model1"><div>2ECD-2ECE</div><div>SUB 20H</div><div>Convert the lowercase character in register A to uppercase.</div></div>
									<div class="assembly-row-combined model1"><div>2ECF-2ED0</div><div>CP 21H</div><div>Check to see if the character in register A is a <span class="code">Q</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2ED1-2ED3</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2FF6" class="memory-link">JP Z,2FF6H</a></div><div>Jump if the character in register A is a <span class="code">Q</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2ED4-2ED5</div><div>CP 1CH</div><div>Check to see if the character in register A is an <span class="code">L</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2ED6-2ED7</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2F40" class="memory-link">JP Z,2F40H</a></div><div>Jump if the character in register A is an <span class="code">L</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2ED9-2EDA</div><div>CP 23H</div><div>Check to see if the character in register A is an <span class="code">S</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2EDB-2EDC</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2F1C" class="memory-link">JR Z,2F1CH</a></div><div>Jump if the character in register A is an <span class="code">S</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2EDD-2EDE</div><div>CP 19H</div><div>Check to see if the character in register A is an <span class="code">I</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2EDF-2EE1</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2F7D" class="memory-link">JP Z,2F7DH</a></div><div>Jump if the character in register A is an <span class="code">I</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2EE2-2EE3</div><div>CP 14H</div><div>Check to see if the character in register A is a <span class="code">D</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2EE4-2EE6</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2F4A" class="memory-link">JP Z,2F4AH</a></div><div>Jump if the character in register A is a <span class="code">D</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2EE7-2EE8</div><div>CP 13H</div><div>Check to see if the character in register A is a <span class="code">C</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2EE9-2EEB</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2F65" class="memory-link">JP Z,2F65H</a></div><div>Jump if the character in register A is a <span class="code">C</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2EEC-2EED</div><div>CP 15H</div><div>Check to see if the character in register A is an <span class="code">E</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2EEE-2EF0</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2FE3" class="memory-link">JP Z,2FE3H</a></div><div>Jump if the character in register A is an <span class="code">E</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2EF1-2EF2</div><div>CP 28H</div><div>Check to see if the character in register A is an <span class="code">X</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2EF3-2EF5</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2F78" class="memory-link">JP Z,2F78H</a></div><div>Jump if the character in register A is an <span class="code">X</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2EF6-2EF7</div><div>CP 1BH</div><div>Check to see if the character in register A is a <span class="code">K</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2EF8-2EF9</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2F16" class="memory-link">JR Z,2F16H</a></div><div>Jump if the character in register A is a <span class="code">K</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2EFA-2EFB</div><div>CP 18H</div><div>Check to see if the character in register A is an <span class="code">H</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2EFC-2EFE</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2F75" class="memory-link">JP Z,2F75H</a></div><div>Jump if the character in register A is an <span class="code">H</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2EFF-2F00</div><div>CP 11H</div><div>Check to see if the character in register A is an <span class="code">A</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2F01</div><div>RET NZ</div><div>Return if the character in register A isn't an <span class="code">A</span>.</div></div>
								</div>
							</div>

							<br><h2 id="2f02-span">2F02 - <span class="code">EDIT</span> Command - Cancel and Restore Logic.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1" id="2F02"><div>2F02</div><div>POP BC</div><div>Clean up the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2F03</div><div>POP DE</div><div>Get the BASIC line number from the stack and put it in DE.</div></div>
									<div class="assembly-row-combined model1"><div>2F04-2F06</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#20FE" class="memory-link">CALL 20FEH</a></div><div>Go print a carriage return on the video display if necessary.</div></div>
									<div class="assembly-row-combined model1"><div>2F07-2F09</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2E65" class="memory-link">JP 2E65H</a></div><div>Jump back to 2E65H to re-enter the <span class="code">EDIT</span> routine.</div></div>
								</div>
							</div>

							<br><h2 id="2f0a-this-routine">2F0A - This routine prints a string of text to the display, printer or tape.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<p>This routin uses 032AH to do this.  HL must point to the 
first character of the string. (409CH must be set before calling this 
routine, see 32AH). String must be delimited with a zero byte.<br>Note: 409CH holds the current output device flag: -1=cassette, 0=video and 1=printer.</p>
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2F0A</div><div>LD A,(HL)</div><div>Load register A with the character at the location of the input buffer pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2F0B</div><div>OR A</div><div>Check to see if the character in register A is an end of the BASIC line character.</div></div>
									<div class="assembly-row-combined model1"><div>2F0C</div><div>RET Z</div><div>Return if the character in register A is an end of the BASIC line character.</div></div>
									<div class="assembly-row-combined model1" id="2F0D"><div>2F0D</div><div>INC B</div><div>Bump the character position in register B.</div></div>
									<div class="assembly-row-combined model1"><div>2F0E-2F10</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#032A" class="memory-link">CALL 032AH</a></div><div>Go display the character in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2F11</div><div>INC HL</div><div>Bump the value of the input buffer pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2F12</div><div>DEC D</div><div>Decrement the number of times to perform the operation in register D.</div></div>
									<div class="assembly-row-combined model1"><div>2F13-2F14</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2F0A" class="memory-link">JR NZ,2F0AH</a></div><div>Loop until done.</div></div>
									<div class="assembly-row-combined model1"><div>2F15</div><div>RET</div><div>Return.</div></div>
								</div>
							</div>

							<br><h2 id="2f16-span">2F16 - <span class="code">EDIT</span> Command - KILL Logic.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2F16</div><div>PUSH HL</div><div>Save the value of the input buffer pointer in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2F17-2F19</div><div>LD HL,2F5FH</div><div>Load HL with the return address of 2F5FH (which will print the final <span class="code">!</span>).</div></div>
									<div class="assembly-row-combined model1"><div>2F1A</div><div>EX (SP),HL</div><div>Exchange the value of the return address in HL with the value of the input buffer pointer to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2F1B</div><div>SCF</div><div>Set the KILL/SEARCH flag for KILL since CARRY flag signals KILL.</div></div>
									<div class="assembly-row-combined model1"><div>2F1C</div><div>PUSH AF</div><div>Save the KILL/SEARCH flag to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2F1D-2F1F</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0384" class="memory-link">CALL 0384H</a></div><div>Go scan the keyboard for the character to locate.</div></div>
									<div class="assembly-row-combined model1"><div>2F20</div><div>LD E,A</div><div>Load register E with the character to locate in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2F21</div><div>POP AF</div><div>Get the KILL/SEARCH flag from the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2F22</div><div>PUSH AF</div><div>Save the KILL/SEARCH flag to the stack.</div></div>
									<div class="assembly-row-combined model1" id="2F5F"><div>2F23-2F25</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2F5F" class="memory-link">CALL C,2F5FH</a></div><div>If KILL (because the CARRY flag was set) then GOSUB to 2F5FH to print a <span class="code">!</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2F26</div><div>LD A,(HL)</div><div>Load register A with the character at the location of the input buffer pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2F27</div><div>OR A</div><div>Check to see if the character in register A is an end of the BASIC line character.</div></div>
									<div class="assembly-row-combined model1"><div>2F28-2F2A</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2F3E" class="memory-link">JP Z,2F3EH</a></div><div>Jump down to 2F3EH if the character in register A is an end of the BASIC line character.</div></div>
									<div class="assembly-row-combined model1"><div>2F2B-2F2D</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#032A" class="memory-link">CALL 032AH</a></div><div>Go display the character in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2F2E</div><div>POP AF</div><div>Get the KILL/SEARCH flag from the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2F2F</div><div>PUSH AF</div><div>Save the KILL/SEARCH flag to the stack.</div></div>
									<div class="assembly-row-combined model1" id="2FA1"><div>2F30-2F32</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2FA1" class="memory-link">CALL C,2FA1H</a></div><div>If the CARRY flag is set, that means we are in KILL mode so GOSUB to 2FA1H to delete the character from the input buffer.</div></div>
									<div class="assembly-row-combined model1" id="2F37"><div>2F33-2F34</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2F37" class="memory-link">JR C,2F37H</a></div><div>Jump to 2F37H if KILL.</div></div>
									<div class="assembly-row-combined model1"><div>2F35</div><div>INC HL</div><div>If we are here, it must be SEARCH!  So bump to the next character.</div></div>
									<div class="assembly-row-combined model1"><div>2F36</div><div>INC B</div><div>Bump the value of the character position counter in register B.</div></div>
									<div class="assembly-row-combined model1"><div>2F37</div><div>LD A,(HL)</div><div>Regardless
 of whether we are SEARCH or KILL, load register A with the character at
 the location of the current input buffer pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2F38</div><div>CP E</div><div>Check to see if the character in register A is the same as the character to be located in register E.</div></div>
									<div class="assembly-row-combined model1"><div>2F39-2F3A</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2F26" class="memory-link">JR NZ,2F26H</a></div><div>Loop back to 2F26H until the character to be located is found.</div></div>
									<div class="assembly-row-combined model1"><div>2F3B</div><div>DEC D</div><div>Decrement the number of times to perform the operation in register D.</div></div>
									<div class="assembly-row-combined model1"><div>2F3C-2F3D</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2F26" class="memory-link">JR NZ,2F26H</a></div><div>Loop until done.</div></div>
									<div class="assembly-row-combined model1"><div>2F3E</div><div>POP AF</div><div>Get the KILL/SEARCH flag from the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2F3F</div><div>RET</div><div>Return.</div></div>
								</div>
							</div>

							<br><h2 id="2f40-span">2F40 - <span class="code">EDIT</span> Command - LIST Logic.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2F40-2F42</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2B75" class="memory-link">CALL 2B75H</a></div><div>Since
 we need to display the line being edited we call the PRINT MESSAGE 
routine at 2B75H which writes string pointed to by HL to the current 
output device..</div></div>
									<div class="assembly-row-combined model1"><div>2F43-2F45</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#20FE" class="memory-link">CALL 20FEH</a></div><div>Go display a carriage return if necessary.</div></div>
									<div class="assembly-row-combined model1"><div>2F46</div><div>POP BC</div><div>Get the BASIC line number from the stack and put it in BC.</div></div>
									<div class="assembly-row-combined model1"><div>2F47-2F49</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2E7C" class="memory-link">JP 2E7CH</a></div><div>Jump to 2E7CH (to print the current line number and await the next EDIT command).</div></div>
								</div>
							</div>

							<br><h2 id="2f4a-span">2F4A - <span class="code">EDIT</span> Command - DELETE Logic.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2F4A</div><div>LD A,(HL)</div><div>Load register A with the character at the location of the input buffer pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2F4B</div><div>OR A</div><div>Check to see if the character in register A is an end of the BASIC line character.</div></div>
									<div class="assembly-row-combined model1"><div>2F5C</div><div>RET Z</div><div>Return if the character in register A is an end of the BASIC line character.</div></div>
									<div class="assembly-row-combined model1" id="2F4D"><div>2F4D-2F4E</div><div>LD A,21H</div><div>Load register A with an <span class="code">!</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2F4F-2F51</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#032A" class="memory-link">CALL 032AH</a></div><div>Go display the <span class="code">!</span> in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2F52</div><div>LD A,(HL)</div><div>Load register A with the character at the location of the input buffer pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2F53</div><div>OR A</div><div>Check to see if the character in register A is an end of the BASIC line character.</div></div>
									<div class="assembly-row-combined model1"><div>2F54-2F5B</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2F5F" class="memory-link">JR Z,2F5FH</a></div><div>Jump to 2F5FH if the character in register A is an end of the BASIC line character.</div></div>
									<div class="assembly-row-combined model1"><div>2F56-2F58</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#032A" class="memory-link">CALL 032AH</a></div><div>Go display the character in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2F59-2F5B</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2FA1" class="memory-link">CALL 2FA1H</a></div><div>Go delete the character from the input buffer.</div></div>
									<div class="assembly-row-combined model1"><div>2F5C</div><div>DEC D</div><div>Decrement the number of times to perform the operation in register D.</div></div>
									<div class="assembly-row-combined model1"><div>2F5D-2F5E</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2F52" class="memory-link">JR NZ,2F52H</a></div><div>Loop until done.</div></div>
									<div class="assembly-row-combined model1"><div>2F5F-2F60</div><div>LD A,21H</div><div>Load register A with an <span class="code">!</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2F61-2F63</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#032A" class="memory-link">CALL 032AH</a></div><div>Go display the ! in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2F64</div><div>RET</div><div>Return.</div></div>
								</div>
							</div>

							<br><h2 id="2f65-span">2F65 - <span class="code">EDIT</span> Command - CHANGE Logic.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2F65</div><div>LD A,(HL)</div><div>Load register A with the character at the location of the input buffer pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2F66</div><div>OR A</div><div>Check to see if the character in register A is an end of the BASIC line character.</div></div>
									<div class="assembly-row-combined model1"><div>2F67</div><div>RET Z</div><div>Return if the character in register A is an end of the BASIC line character.</div></div>
									<div class="assembly-row-combined model1" id="2F68"><div>2F68-2F6A</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0384" class="memory-link">CALL 0384H</a></div><div>Go get the character to put in the input buffer from the keyboard.</div></div>
									<div class="assembly-row-combined model1"><div>2F6B</div><div>LD (HL),A</div><div>Save the character in register A at the memory location of the input buffer pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2F6C-2F6E</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#032A" class="memory-link">CALL 032AH</a></div><div>Go display the character in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2F6F</div><div>INC HL</div><div>Bump the value of the input buffer pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2F70</div><div>INC B</div><div>Bump the character position in register B.</div></div>
									<div class="assembly-row-combined model1"><div>2F71</div><div>DEC D</div><div>Decrement the number of times to perform the operation in register D.</div></div>
									<div class="assembly-row-combined model1"><div>2F72-2F73</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2F65" class="memory-link">JR NZ,2F65H</a></div><div>Loop until done.</div></div>
									<div class="assembly-row-combined model1"><div>2F74</div><div>RET</div><div>Return.</div></div>
								</div>
							</div>

							<br><h2 id="2f75-span">2F75 - <span class="code">EDIT</span> Command - HACK/INSERT Logic.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2F75-2F76</div><div>LD (HL),00H</div><div>Zero the location of the input buffer pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2F77</div><div>LD C,B</div><div>Load register C with the character position in register B.</div></div>
									<div class="assembly-row-combined model1"><div>2F78-2F79</div><div>LD D,0FFH</div><div>Load register D with the number of times to perform the operation.</div></div>
									<div class="assembly-row-combined model1"><div>2F7A-2F7C</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2F0A" class="memory-link">CALL 2F0AH</a></div><div>GOSUB to 2F0AH to display the register BASIC line if necessary.</div></div>
									<div class="assembly-row-combined model1"><div>2F7D-2F7F</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0384" class="memory-link">CALL 0384H</a></div><div>Go get the character to be inserted from the keyboard.</div></div>
									<div class="assembly-row-combined model1"><div>2F80</div><div>OR A</div><div>Check to see if a key was pressed.</div></div>
									<div class="assembly-row-combined model1"><div>2F81-2F83</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2F7D" class="memory-link">JP Z,2F7DH</a></div><div>Loop back to 2F7DH until a key is pressed.</div></div>
									<div class="assembly-row-combined model1"><div>2F84-2F85</div><div>CP 08H</div><div>Check to see if the character in register A is a <span class="code">backspace character</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2F86-2F87</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2F92" class="memory-link">JR Z,2F92H</a></div><div>Jump to 2F92H if the character in register A is a <span class="code">backspace character</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2F88-2F89</div><div>CP 0DH</div><div>Check to see if the character in register A is a  <span class="code">carriage return</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2F8A-2F8C</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2FE0" class="memory-link">JP Z,2FE0H</a></div><div>Jump to 2FE0H if the character in register A is a <span class="code">carriage return</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2F8D-2F8E</div><div>CP 1BH</div><div>Check to see if the character in register A is a  <span class="code">shift up arrow</span>.</div></div>
									<div class="assembly-row-combined model1"><div>2F8F</div><div>RET Z</div><div>Return if the character in register A is <span class="code">shift up arrow</span>.</div></div>
									<div class="assembly-row-combined model1" id="2F90"><div>2F90-2F91</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2FB0" class="memory-link">JR NZ,2FB0H</a></div><div>Jump to 2FB0H to ass the new character to the current line.</div></div>
								</div>
							</div>

							<br><h2 id="2f92-span">2F92 - <span class="code">EDIT</span> Command - BACKSPACE CURSOR Logic.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2F92-2F93</div><div>LD A,08H</div><div>Load register A with a backspace the cursor character.</div></div>
									<div class="assembly-row-combined model1"><div>2F94</div><div>DEC B</div><div>Decrement the character position in register B.</div></div>
									<div class="assembly-row-combined model1"><div>2F95</div><div>INC B</div><div>Bump the character position in register B.</div></div>
									<div class="assembly-row-combined model1"><div>2F96-2F97</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2FB7" class="memory-link">JR Z,2FB7H</a></div><div>Jump forward to 2FB7H if this is the first character of the BASIC line.</div></div>
									<div class="assembly-row-combined model1"><div>2F98-2F9A</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#032A" class="memory-link">CALL 032AH</a></div><div>Go backspace the cursor on the video display.</div></div>
									<div class="assembly-row-combined model1"><div>2F9B</div><div>DEC HL</div><div>Decrement the value of the input buffer pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2F9C</div><div>DEC B</div><div>Decrement the character position in register B.</div></div>
									<div class="assembly-row-combined model1"><div>2F9D-2F9F</div><div>LD DE,2F7DH</div><div>Load DE with a return address of 2F7DH.</div></div>
									<div class="assembly-row-combined model1"><div>2FA0</div><div>PUSH DE</div><div>Save the value of the return address in DE to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2FA1</div><div>PUSH HL</div><div>Save the value of the input buffer pointer in HL to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2FA2</div><div>DEC C</div><div>Decrement the character position in register C.</div></div>
									<div class="assembly-row-combined model1"><div>2FA3</div><div>LD A,(HL)</div><div>Load register A with the character at the location of the input buffer pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2FA4</div><div>OR A</div><div>Check to see if the character in register A is an end of the BASIC line character.</div></div>
									<div class="assembly-row-combined model1"><div>2FA5</div><div>SCF</div><div>Set the Carry flag to signal that the character was deleted.</div></div>
									<div class="assembly-row-combined model1"><div>2FA6-2FA8</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#0890" class="memory-link">JP Z,0890H</a></div><div>Jump to 0890H if the character in register A is an end of the BASIC line character.</div></div>
									<div class="assembly-row-combined model1"><div>2FA9</div><div>INC HL</div><div>Bump the value of the input buffer pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2FAA</div><div>LD A,(HL)</div><div>Load register A with the character at the location of the input buffer pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2FAB</div><div>DEC HL</div><div>Decrement the value of the input buffer pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2FAC</div><div>LD (HL),A</div><div>Save the character in register A at the location of the current input buffer pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2FAD</div><div>INC HL</div><div>Bump the value of the input buffer pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2FAE-2FAF</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2FA3" class="memory-link">JR 2FA3H</a></div><div>Loop back to 2FA3H until the line has been moved down.</div></div>
								</div>
							</div>

							<br><h2 id="2fb0-span">2FB0 - <span class="code">EDIT</span> Command - ADD A CHARACTER Logic.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2FB0</div><div>PUSH AF</div><div>Save the character to be inserted in register A to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2FB1</div><div>LD A,C</div><div>Load register A with the number of characters in the input buffer in register C.</div></div>
									<div class="assembly-row-combined model1"><div>2FB2-2FB3</div><div>CP FFH</div><div>Check for the maximum BASIC line length.</div></div>
									<div class="assembly-row-combined model1" id="2FB9"><div>2FB4-2FB5</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2FB9" class="memory-link">JR C,2FB9H</a></div><div>Jump forward to 2FB9H if the maximum BASIC line length hasn't been reached.</div></div>
									<div class="assembly-row-combined model1"><div>2FB6</div><div>POP AF</div><div>Get the character to be inserted from the stack and put it in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2FB7-2FB8</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2F7D" class="memory-link">JR 2F7DH</a></div><div>Jump back to 2F7DH.</div></div>
									<div class="assembly-row-combined model1"><div>2FB9</div><div>SUB B</div><div>Subtract
 the character position in register B from the number of characters in 
the input buffer in register A.  This should give the current byte 
position.</div></div>
									<div class="assembly-row-combined model1"><div>2FBA</div><div>INC C</div><div>Bump the number of characters in the input buffer in register C.</div></div>
									<div class="assembly-row-combined model1"><div>2FBB</div><div>INC B</div><div>Bump the character position in register B.</div></div>
									<div class="assembly-row-combined model1"><div>2FBC</div><div>PUSH BC</div><div>Save the character position and the number of characters in the input buffer in BC to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2FBD</div><div>EX DE,HL</div><div>Load DE with the input buffer pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2FBE</div><div>LD L,A</div><div>Load register L with the character count in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2FBF-2FC0</div><div>LD H,00H</div><div>Zero register H.</div></div>
									<div class="assembly-row-combined model1"><div>2FC1</div><div>ADD HL,DE</div><div>Add the value of the input buffer pointer in DE to the character count in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2FC2</div><div>LD B,H</div><div>Load register B with the MSB of the end of the BASIC line pointer in register H.</div></div>
									<div class="assembly-row-combined model1"><div>2FC3</div><div>LD C,L</div><div>Load register C with the LSB of the end of the BASIC line pointer in register L.</div></div>
									<div class="assembly-row-combined model1"><div>2FC4</div><div>INC HL</div><div>Bump the value of the end of the BASIC line pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2FC5-2FC7</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1958" class="memory-link">CALL 1958H</a></div><div>Go move the BASIC line up one character.</div></div>
									<div class="assembly-row-combined model1"><div>2FC8</div><div>POP BC</div><div>Get the character position and the number of characters in the input buffer from the stack and put it in BC.</div></div>
									<div class="assembly-row-combined model1"><div>2FC9</div><div>POP AF</div><div>Get the character to be inserted from the stack and put it in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2FCA</div><div>LD (HL),A</div><div>Save the character in register A at the location of the current input buffer pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2FCB-2FCD</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#032A" class="memory-link">CALL 032AH</a></div><div>Go display the character in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2FCE</div><div>INC HL</div><div>Bump the value of the input buffer pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2FCF-2FD1</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2F7D" class="memory-link">JP 2F7DH</a></div><div>Jump back to 2F7DH.</div></div>
								</div>
							</div>

							<br><h2 id="2fd2-span">2FD2 - <span class="code">EDIT</span> Command - BACKSPACE Logic.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2FD2</div><div>LD A,B</div><div>Load register A with the number of times to backspace in register B.</div></div>
									<div class="assembly-row-combined model1"><div>2FD3</div><div>OR A</div><div>Check to see if this is the start of the BASIC line.</div></div>
									<div class="assembly-row-combined model1"><div>2FD4</div><div>RET Z</div><div>Return if this is the start of the BASIC line.</div></div>
									<div class="assembly-row-combined model1" id="2FD5"><div>2FD5</div><div>DEC B</div><div>Decrement the character position in register B.</div></div>
									<div class="assembly-row-combined model1"><div>2FD6</div><div>DEC HL</div><div>Decrement the value of the input buffer pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2FD7-2FD8</div><div>LD A,08H</div><div>Load register A with a backspace the cursor character.</div></div>
									<div class="assembly-row-combined model1"><div>2FD9-2FDB</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-1.htm#032A" class="memory-link">CALL 032AH</a></div><div>Go backspace the cursor on the video display.</div></div>
									<div class="assembly-row-combined model1"><div>2FDC</div><div>DEC D</div><div>Decrement the number of times to perform the operation in register D.</div></div>
									<div class="assembly-row-combined model1"><div>2FDD-2FDE</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2FD2" class="memory-link">JR NZ,2FD2H</a></div><div>Loop until done.</div></div>
									<div class="assembly-row-combined model1"><div>2FDF</div><div>RET</div><div>Return.</div></div>
									<div class="assembly-row-combined model1" id="2FE0"><div>2FE0-2FE2</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#2B75" class="memory-link">CALL 2B75H</a></div><div>Since
 we need to display the rest of the BASIC line, we call the PRINT 
MESSAGE routine at 2B75H which writes string pointed to by HL to the 
current output device..</div></div>
									<div class="assembly-row-combined model1"><div>2FE3-2FES</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-3.htm#20FE" class="memory-link">CALL 20FEH</a></div><div>Go display a carriage return if necessary.</div></div>
									<div class="assembly-row-combined model1"><div>2FE6</div><div>POP BC</div><div>Clean up the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2FE7</div><div>POP DE</div><div>Get the BASIC line number (in binary) from the stack and put it in DE.</div></div>
									<div class="assembly-row-combined model1"><div>2FE8</div><div>LD A,D</div><div>Load register A with the MSB of the BASIC line number in register D.</div></div>
									<div class="assembly-row-combined model1"><div>2FE9</div><div>AND E</div><div>Combine the LSB of the BASIC line number in register E with the MSB of the BASIC line number in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2FEA</div><div>INC A</div><div>Bump the combined BASIC line number in register A.</div></div>
									<div class="assembly-row-combined model1"><div>2FEB-2FED</div><div>LD HL,(40A7H)</div><div>Load HL with the starting address of the input buffer.<br>Note: 40A7H-40A8H holds the input Buffer pointer.</div></div>
									<div class="assembly-row-combined model1"><div>2FEE</div><div>DEC HL</div><div>Decrement the value of the input buffer pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2FEF</div><div>RET Z</div><div>Return if this is the Level II BASIC command mode.</div></div>
									<div class="assembly-row-combined model1" id="2FF0"><div>2FF0</div><div>SCF</div><div>Set the Carry flag to signal a BASIC program statement.</div></div>
									<div class="assembly-row-combined model1"><div>2FF1</div><div>INC HL</div><div>Bump the value of the input buffer pointer in HL.</div></div>
									<div class="assembly-row-combined model1"><div>2FF2</div><div>PUSH AF</div><div>Save the command mode flag in AF to the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2FF3-2FF5</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1A98" class="memory-link">JP 1A98H</a></div><div>Jump to the Level II BASIC READY routine.</div></div>
								</div>
							</div>

							<br><h2 id="2ff6-span">2FF6 - <span class="code">EDIT</span> Command - QUIT Logic.<button class="clipboard-copy-button" title="Copy link to this section">üìã</button></h2>
							<div class="card-item">
								<div class="assembly-table">
									<div class="assembly-row-combined model1"><div>2FF6</div><div>POP BC</div><div>Clean up the stack.</div></div>
									<div class="assembly-row-combined model1"><div>2FF7</div><div>POP DE</div><div>Get the BASIC line number from the stack and put it in DE.</div></div>
									<div class="assembly-row-combined model1"><div>2FF8-2FFA</div><div><a href="https://www.trs-80.com/sub-disassem-rom-m3-part-2.htm#1A19" class="memory-link">JP 1A19H</a></div><div>Jump to the Level II BASIC READY routine.</div></div>
									<div class="assembly-row-combined model1"><div>2FFB-2FFF</div><div>DE C3 C3 44 B2</div><div>Garbage Code.</div></div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</main>
		</div>
	</div>
	<!-- Fancybox JavaScript -->
	<script src="Model%20III%20ROM%20Explained%20-%20Part%203_files/fancybox.umd.js"></script>
	<!-- Initialize Fancybox -->
	<script>
		Fancybox.bind("[data-fancybox]", {
			Toolbar: {
				display: {
					left: ["infobar"],
					middle: [],
					right: ["slideshow", "thumbs", "close"],
				},
			},
			Thumbs: {
				autoStart: false,
			},
		});
	</script>
	<!-- Last Modified Date -->
	<script>
		document.write("<p style='text-align:right; padding: 10px 20px; font-style: italic; font-size: 0.85em; color: #666;'>Last edited: " + document.lastModified + "</p>");
	</script><p style="text-align:right; padding: 10px 20px; font-style: italic; font-size: 0.85em; color: #666;">Last edited: 12/20/2025 22:17:41</p>

<div id="mobile-overlay" class="mobile-menu-overlay"></div></body></html>